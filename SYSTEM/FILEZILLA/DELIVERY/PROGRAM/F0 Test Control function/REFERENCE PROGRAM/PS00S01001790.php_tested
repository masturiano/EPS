<?php
# ======================================================================================
# [DATE]  : 2013.02.13			[AUTHOR]  : MIS)L.Acera
# [SYS_ID]: GPRISM			[SYSTEM]  : CIM
# [SUB_ID]:				[SUBSYS]  : 
# [PRC_ID]:				[PROCESS] : 
# [PGM_ID]: PS00S01001790.php		[PROGRAM] : Multi-Chip Track-Out(LSI)
# [MDL_ID]:				[MODULE]  : 
# --------------------------------------------------------------------------------------
# [COMMENT]
#
# --------------------------------------------------------------------------------------
# [UPDATE_LOG]
# 
# [UPDATE_PERSON]		[UPDATE]			[COMMENT]
# ====================	==================	============================================
# --------------------------------------------------------------------------------------
#******************************************************************
#
# PROGRAM SETTINGS
#
#******************************************************************
$g_Version = "2.0";
$g_PrgCD = "PS00S01001790";
#******************************************************************
#
# SET GLOBAL VARIABLE $gw_scr FROM <FORM> CONTENTS
#
#******************************************************************
if ($REQUEST_METHOD == "GET") {
	$gw_scr = cnv_formstr($_GET);
} else {
	$gw_scr = cnv_formstr($_POST);
}
#******************************************************************
#
# SET LANGUAGE AND ENCODING
#
#******************************************************************
$g_lang_path    = $gw_scr['g_lang_path'];
$g_CharSet      = $gw_scr['g_CharSet'];
$g_usrId        = $gw_scr['usrId'];
$g_menuNo1      = $gw_scr['menuNo1'];
$g_menuNo2      = $gw_scr['menuNo2'];
$g_menuNo3      = $gw_scr['menuNo3'];
$g_menuNo4      = $gw_scr['menuNo4'];
#******************************************************************
#
# READ COMMON EXTERNAL FUNCTIONS
#
#******************************************************************
#------------------------------------------------------------------
# use among entire programs
#------------------------------------------------------------------
require_once (getenv("GPRISM_HOME") . "/DirList_pf.php");		# global variables of path list
require_once (getenv("GPRISM_HOME") . "/Func/Check.php");		# Input check
require_once ($g_func_dir . "/global.php");				# global variables
require_once ($g_func_dir . "/db_op.php");				# DB control
require_once ($g_func_dir . "/xdb_op.php");				# wrapper functions of DB control
require_once ($g_func_dir . "/xpt_err_msg.php");			# format of error message
require_once ($g_Mfunc_dir . "/xgt_dvsn.php");				#for printer changes
#------------------------------------------------------------------
# for tracking
#------------------------------------------------------------------
require_once ($g_func_dir . "/xgn_cd.php");				# get common code from name
require_once ($g_func_dir . "/xgn_prd.php");				# get prd_nm from prd_cd
require_once ($g_func_dir . "/xgc_prd.php");				# get prd_cd from prd_nm
require_once ($g_func_dir . "/xgn_pkg.php");				# get pkg_cd & pkg_nm from prd_cd
require_once ($g_func_dir . "/xgt_stp_cls.php");			# get stp_cls_2 & stp_cls_4 from stp_cd
require_once ($g_func_dir . "/xgt_lot.php");				# get lot_bas_tbl info from lot_id
require_once ($g_func_dir . "/xgt_nio.php");				# get next io
require_once ($g_func_dir . "/xgt_npr.php");				# get next process
require_once ($g_func_dir . "/xgt_stp.php");				# get shp_cd
require_once ($g_func_dir . "/xck_upd.php");				# check upd_lev
require_once ($g_func_dir . "/xck_lio.php");				# check last io in current process
require_once ($g_func_dir . "/xck_rnk.php");				# check rank pattern
require_once ($g_func_dir . "/xgt_use_equ.php");			# get usable equ_cd for specified lot
require_once ($g_func_dir . "/xgt_ctg.php");				# get category info
require_once ($g_func_dir . "/xpt_qul_rep.php");			# print quality report
require_once ($g_func_dir . "/xgt_prt_wip.php");			# get parts wip info
require_once ($g_func_dir . "/xgt_cd_cnt.php");				# numbering code
require_once ($g_func_dir . "/xgt_lp2.php");				# get default printer
require_once ($g_func_dir . "/xgt_lp2_cd.php");				# get printer info
require_once ($g_func_dir . "/xpt_1sec_dts.php");			# one second difference
#------------------------------------------------------------------
# VERB
#------------------------------------------------------------------
require_once ($g_func_dir . "/ioin.php");				# track-In
require_once ($g_func_dir . "/ioot.php");				# track-Out
require_once ($g_func_dir . "/ioab.php");				# Close
require_once ($g_func_dir . "/iohd.php");				# Hold
require_once ($g_func_dir . "/iosp.php");				# Split
require_once ($g_func_dir . "/iomg.php");				# Merge
require_once ($g_func_dir . "/iomv.php");				# Move
require_once ($g_func_dir . "/prpt.php");				# Move(Process)
require_once ($g_func_dir . "/prpc.php");				# ditto
require_once ($g_func_dir . "/prgt.php");				# ditto
require_once ($g_func_dir . "/iomo.php");				# Multi-Merge(Delete Component Lot)
require_once ($g_func_dir . "/iomi.php");				# Multi-Merge(Create Lot aft Merge)
require_once ($g_func_dir . "/mtcs.php");				# Material Consumption
require_once ($g_func_dir . "/mthd.php");				# Material Hold
require_once ($g_func_dir . "/mtin.php");				# Material Track-In
require_once ($g_func_dir . "/mtot.php");				# Material Track-Out
require_once ($g_func_dir . "/rtcg.php");
#------------------------------------------------------------------
# local functions
#------------------------------------------------------------------
require_once ($g_func_dir . "/cs_xgn_man.php");				# get user name(and check login user)
require_once ($g_func_dir . "/cs_xck_thd_jdg.php");			# threshold judgement & regist non_std_ctg_log
require_once ($g_func_dir . "/cs_xexc_hold_rsv.php");			# hold reserve check & execute lot hold
require_once ($g_func_dir . "/cs_xck_fifo_lot.php");			# check FIFO
require_once ($g_func_dir . "/cs_xck_jig.php");				# check jig
require_once ($g_func_dir . "/cs_xck_trk_snd_lot.php");			# check SPACE
require_once ($g_func_dir . "/cs_xck_abn_snd_lot.php");			# check SPACE
require_once ($g_func_dir . "/cs_xck_staff_ctrl.php");			# For Staff Process control
require_once ($g_func_dir . "/cs_xck_train_validate.php");      	# For Training Validation	
require_once ($g_func_dir . "/cs_xck_prt_ctrl.php");			# check parts control
require_once ($g_func_dir . "/cs_xck_prt_time.php");
require_once ($g_func_dir . "/cs_xpt_etag_lsi.php");
require_once($g_func_dir . "/cs_xpt_etag_db.php");
require_once ($g_func_dir . "/cs_xgt_par_dat.php");
require_once ($g_func_dir . "/cs_xck_baking.php");
require_once ($g_func_dir . "/cs_xgt_po_no.php");
require_once ($g_func_dir . "/cs_xgt_inhrt_po_data.php");               #for split changes
#------------------------------------------------------------------
# for screen
#------------------------------------------------------------------
require_once ($g_lang_dir . "/buttonM.php");				# button name
require_once ($g_lang_dir . "/PS00S01001790M.php");			# message
require_once ($g_Gfunc_dir . "/xpt_screen.php");			# create screen
#******************************************************************
#
# DEFINITION
#
#******************************************************************
#------------------------------------------------------------------
# for display
#------------------------------------------------------------------
define("INI_MLOT_CNT",				3);
define("INI_SLOT_CNT",				2);
define("MAX_LOT_CNT",				10);
define("MAX_BAD_BLC",				8);
define("MAX_BAD_COL",				4);
define("MAX_BAD",				constant("MAX_BAD_BLC") * constant("MAX_BAD_COL"));
define("INI_SL_CNT",				1);
define("INI_MGZN_CNT",				4);
define("MAX_MGZN_CNT",				10);
#------------------------------------------------------------------
# category division
#------------------------------------------------------------------
define("CE_CHP_BAD",				"CESEM01");
define("CE_LTINF",				"CE00S02");		# Lot Information
define("CE_HOLDINF",				"CE00S03");
define("CE_SUBSTRATE",				"CE00S17");
#------------------------------------------------------------------
# category code
#------------------------------------------------------------------
define("CT_ABNINF",				"CT00S0000013");
define("CT_SLINFO",				"CT00S0000098");
define("CT_UVLIMIT",				"CT00S0000099");
define("CT_MNFC",				"CT00S0000100");
define("CT_APPID",				"CT00S0000102");
define("CT_BAKING",				"CT00S0000105");
define("CT_SUBUSAGE",				"CT00S0000106");
define("CT_MAINLOT",				"CT00S0000251");
define("CT_SUBLOT",				"CT00S0000153");
define("CT_PRDFIN",				"CT00S0000154");
define("CT_PLATENO",				"CT00S0000141");
define("CT_SECNO",				"CT00S0000021");
define("CT_EXLOTID",				"CT00S0000149");
define("CT_ADJ",				"CT00S0000150");
define("CT_SLNO",				"CT00S0000151");
define("CT_SUBSTRATE",				"CT00S0000152");
#------------------------------------------------------------------
# tag
#------------------------------------------------------------------
define("TG_MA",					"MA");			# User ID
define("TG_EQ",					"EQ");	 		# Equipment Code
define("TG_LT",					"LT");			# Lot ID
define("TG_LP",					"LP");			# Printer Code
#------------------------------------------------------------------
# etc
#------------------------------------------------------------------
define("AU_STROK",				"AUSEM01");
define("AW_SEC_DIGIT",				"AW11S0000009");
define("AW_SEC_DIFFPLNT",			"AW11S0000010");
define("AW_MTL_CONSUMPTION",                    "AW00S0000011");
define("CNTDVS_SECNO_PRFX",			"SECRET_");
define("M_S_DVS",				serialize(array(1 => "s")));
#------------------------------------------------------------------
# E9
#------------------------------------------------------------------
define("E9_DB"	,				"E931S169");
define("E9_ALW",				serialize(array(
						"E911S820",     #DIE BOND PREPARATION 2
                                                "E911S830",     #DIE BOND PREPARATION 3
                                                "E911S130",     #DIE BOND PREPARATION
                                                "E911S140",     #DIE BONDING
                                                "E911S150"      #DIE BONDING2

/*	constant("E9_DB"),
	"E931S170",
	"E931S183", #(MAT) DIE BOND PREPARATION
	"E911S130", #DIE BOND PREPARATION
	"E931S087", #(QFN) DIE BOND PREPARATION 3
	"E931S006", #(IPD) DIE BOND PREPARATION
	"E931S133", #(SOB) DIE BOND PREPARATION
	"E931S083", #(QFN) DIE BOND PREPARATION
	"E931S085", #(QFN) DIE BOND PREPARATION 2
	"E941S007", #(TR) DIE BOND PREPARATION
	"E931S171", #(QFN) WAITING FOR DIE BOND
	"E931S165", #(IPD) WAITING FOR DIE BOND
	"E931S168", #(MAT) WAITING FOR DIE BOND
	"E931S177", #(SOB) WAITING FOR DIE BOND
	"E941S034", #(TR) WAITING FOR DIE BOND
	"E931S205", #(IPD) DIE BOND PREPARATION 2
	"E931S206"  #(IPD) DIE BONDING 2*/
)));
define("E9_WFR",                                serialize(array(
						"E911S820",     #DIE BOND PREPARATION 2
                                                "E911S830",     #DIE BOND PREPARATION 3
                                                "E911S130",     #DIE BOND PREPARATION
                                                "E911S140",     #DIE BONDING
                                                "E911S150"      #DIE BONDING2


                                        /*        "E931S167",
                                                "E931S168",
						"E931S087", #(QFN) DIE BOND PREPARATION 3
						"E931S085", #(QFN) DIE BOND PREPARATION 2
        "E931S087", #(QFN) DIE BOND PREPARATION 3
        "E931S006", #(IPD) DIE BOND PREPARATION
        "E931S133", #(SOB) DIE BOND PREPARATION
        "E931S083", #(QFN) DIE BOND PREPARATION
        "E931S085", #(QFN) DIE BOND PREPARATION 2
        "E941S007", #(TR) DIE BOND PREPARATION
        "E931S171", #(QFN) WAITING FOR DIE BOND
"E931S165", #(IPD) WAITING FOR DIE BOND
"E931S168", #(MAT) WAITING FOR DIE BOND
"E931S177", #(SOB) WAITING FOR DIE BOND
"E941S034", #(TR) WAITING FOR DIE BOND*/

)));
#------------------------------------------------------------------
# for judgement
#------------------------------------------------------------------
define("CU_HOLD",				"CUSEM998");		# Cause Code : Auto Hold
### for quality report
define("P0_LOTTRC",				"P0SEM001");
define("REP_ABN_LOT",				"REPORT_OF_ABN_LOT");
### popup window for judgement results
define("PRG_CD_CHD",				"PS00S02000380");
define("WDS_TOP",				0);
define("WDS_LFT",				200);
define("WDS_WID",				700);
define("WDS_HEI",				700);
#------------------------------------------------------------------
# material management
#------------------------------------------------------------------
define("PGM_MTMNG",				"PS00S04000030");
define("CE_USEMAT",				"CESEM15");
#------------------------------------------------------------------
# for jig control
#------------------------------------------------------------------
define("CE_MGZN",				"CE00S04");
define("CT_MGZN",				"CT00S0000024");
define("JI_MGZN",				"JI00S001");
define("SH_MGZN",				"SH00S998");
#------------------------------------------------------------------
# for material hold
#------------------------------------------------------------------
define("CUS_MTMNG",				"CUSEM997");
define("CMT_THAW",				"MATERIAL THAWING TIME NG");
define("CMT_LIFE",				"MATERIAL LIFE TIME NG");
define("CMT_EXP",				"MATERIAL EXPIRED TIME NG");
define("RMN_H_LIFE",				3);
define("RMN_H_EXP",				3);

#------------------------------------------------------------------
# for display
#------------------------------------------------------------------
define("MAX_CHP_BAD_BLC",                       4);
define("MAX_CHP_BAD_COL",                       5);
define("MAX_CHP_BAD",                           constant("MAX_CHP_BAD_BLC") * constant("MAX_CHP_BAD_COL"));

#------------------------------------------------------------------
# for SPACE
#------------------------------------------------------------------
define("SPC_WARN_ABN",				"ABN");
define("SPC_WARN_PCS",				"PCS");
define("SPC_WARN_MBN",				"MBN");
define("SPC_WARN_CON",				"CON");
define("SPC_WARN_ABNPCS",			"ABNPCS");
define("SPC_ERRCD_NRM",				"xxxxx1");
define("SPC_ERRCD_ABN",				"xxxxx2");
define("SPC_ERRCD_PCS",				"xxxxx3");
define("SPC_ERRCD_ABNPCS",			"xxxxx4");
define("CU_ABNPCS",				"CUSEM007");
define("CU_MBN",				"CUSEM005");
define("CU_AUTO",				"CUSEM998");
#------------------------------------------------------------------
# approved user group
#------------------------------------------------------------------
define("DG_APRV",				serialize(array(
                                        'DG00S110',
                                        'DG00S170',
                                        'DG00S210',
                                        'DG00S250',
                                        'DG00S290',
                                        'DG00S330',
                                        'DG00S370',
                                        'DG00S410'

)));
##------------------------------------------------------------------
#Printer Modifications
##------------------------------------------------------------------
define("PGMID_PRINT",     			"PS00S06000400");       
##------------------------------------------------------------------
#For parent lot id
##------------------------------------------------------------------
define("CT_PARENTLOT",				"CT00S0000263");
#******************************************************************
#
# FUNCTIONS
#
#******************************************************************
#==================================================================
# convert form data
#==================================================================
function cnv_formstr($w_req)
{
	reset($w_req);
	while(list($key, $val) = each($w_req)){
		if(is_array($val)){
			$w_arr = cnv_formstr($val);
			$w_scr[$key] = $w_arr;
		} else {
			if(get_magic_quotes_gpc()){
				$val = stripslashes($val);
			}
			$w_scr[$key] = $val;
		}
	}

	return $w_scr;
}
###################################################################
#####                                                         #####
##### FIRST PROCESS                                           #####
#####                                                         #####
###################################################################
#==================================================================
# initialize
#==================================================================
function main_init()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	set_init(1);
	#------------------------------------------------------------------
    	# get division code from menu registration info.
    	#------------------------------------------------------------------
        $w_rtn = xgt_dvsn($w_dvsn_cd, $w_fct_cd, $w_rdg_cd);
        if($w_rtn != 0){
            $g_err_lv = 0;
            $g_msg = xpt_err_msg($g_msg, "", __LINE__);
            return 4000;
        }

        $gw_scr['s_dvsn_cd'] = trim($w_dvsn_cd);
	scr_mode_chg(1);

	#------------------------------------------------------------------
	# get default printer
	#------------------------------------------------------------------
	$w_rtn = xgt_lp2(2, $w_lbl_cd, $w_lbl_nm, $_, $_);
	if($w_rtn != 0){
		$gw_scr['s_prnt_lv'] = 0;
		$gw_scr['s_prnt_msg'] = xpt_err_msg($g_msg, "", __LINE__);

		$g_msg    = "";
		$g_err_lv = "";
	}

	$gw_scr['s_lbl_cd'] = $w_lbl_cd;
	$gw_scr['s_lbl_nm'] = $w_lbl_nm;

	return 0;
}

###################################################################
#####                                                         #####
##### MODE1                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode1
#==================================================================
function main_md1()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "CHECK":
		main_md1_chk();
		break;
	case "ERASE":
		main_init();
		break;
	}

	return 0;
}

#==================================================================
# mode1 [Check] process
#==================================================================
function main_md1_chk()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	# for warning message
	$w_warn = array();

	#------------------------------------------------------------------
	# input check
	#------------------------------------------------------------------
	$w_rtn = check_input(1);
	if($w_rtn != 0){
		return 4000;
	}

	#------------------------------------------------------------------
	# get user name
	#------------------------------------------------------------------
	$w_rtn = cs_xgn_man($gw_scr['s_usr_id'], $w_usr_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_usr_id'], __LINE__);
		return 4000;
	}


	#------------------------------------------------------------------
	# get lot_bas_tbl
	#------------------------------------------------------------------
	$w_rtn = xgt_lot($gw_scr['s_lot_id'], $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_lot_id'], __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# check state
	#------------------------------------------------------------------
	$w_rtn = ioot_st_check($w_lot_bas['LOT_ST_DVS']);
	$w_equ_cd = trim($w_lot_bas['EQU_CD']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_lot_id'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# get stp_cls
	#------------------------------------------------------------------
	$w_rtn = xgt_stp_cls($w_lot_bas['STP_CD'], $w_stpcls, $_);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['STP_CD'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check allowed step
	#------------------------------------------------------------------
	if(!in_array($w_stpcls, unserialize(constant("E9_ALW")))){
		list($g_msg, $g_err_lv) = msg("err_Disabled");
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_lot_id'], __LINE__);
		return 4000;
	}

	#Training Validation Checking
        $w_rtn = cs_xck_train_validate($gw_scr['s_usr_id'], $w_lot_bas['LOT_ID'], $w_lot_bas['EQU_CD'], $w_lot_bas['STP_CD'], $w_allow);
        if ($w_rtn != 0) {
                $g_err_lv = 0;
                $g_msg = xpt_err_msg($g_msg, $gw_scr['s_usr_id'], __LINE__);
                return 4000;
        }else {
                if(!$w_allow){
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, $gw_scr['s_urs_id'], __LINE__);
                        return 4000;
                }
        }

	#------------------------------------------------------------------
	# get prd_nm
	#------------------------------------------------------------------
	$w_rtn = xgn_prd($w_lot_bas['PRD_CD'], $w_m_prd_nm, $_);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRD_CD'], __LINE__);
		return 4000;
	}
	$w_m_prd_cd = trim($w_lot_bas['PRD_CD']);


        ### パッケージ名の獲得
        $w_rtn = xgn_pkg($w_lot_bas['PRD_CD'], 1, $w_pkg_cd, $w_pkg_nm);
        if($w_rtn != 0){
                $g_err_lv = 0;
                $g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRD_CD'], __LINE__);
                return 4000;
        }


        #------------------------------------------------------------------
        # check UV_IRRADIATION expiration
        #------------------------------------------------------------------
        $w_rtn = get_lotinf($w_lot_bas['LOT_ID'],
                                                constant("CE_LTINF"),
                                                constant("CT_SUBSTRATE"),
                                                $w_lf_qty);
        if($w_rtn != 0) return 4000;

        #------------------------------------------------------------------
        # 装置名の獲得
        #------------------------------------------------------------------
        $w_rtn = xgn_cd($w_lot_bas['EQU_CD'], 1, $w_equ_nm);
        if($w_rtn != 0){
                $g_err_lv = 0;
                $g_msg = xpt_err_msg($g_msg, $gw_scr['s_equ_cd'], __LINE__);
                return 4000;
        }

	#------------------------------------------------------------------
	# get stp_nm
	#------------------------------------------------------------------
	$w_rtn = xgn_cd($w_lot_bas['STP_CD'], 1, $w_stp_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['STP_CD'], __LINE__);
		return 4000;
	}

	$w_stp_cd     	= trim($w_lot_bas['STP_CD']);
	$w_prd_cd 	= trim($w_lot_bas['PRD_CD']);
	$w_lot_no     	= trim($w_lot_bas['LOT_NO']);
	$w_lot_no_str 	= trim($w_lot_bas['LOT_NO_STR']);
	$w_chp_qty    	= $w_lot_bas['CHP_QTY'];
	$w_real_qty   	= $w_lot_bas['CHP_QTY'];
	$w_upd_lev    	= $w_lot_bas['UPD_LEV'];
	$w_pre_exst   	= 1;

	$w_trt_qty      = $w_lot_bas['CHP_QTY'];


	#------------------------------------------------------------------
	# get after Multi-Merge TypeCode/Name
	#------------------------------------------------------------------
	$w_rtn = get_aft_prd($gw_scr['s_lot_id'], $w_prd_cd_fin, $w_prd_nm_fin);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# get sub-Lot info
	#------------------------------------------------------------------
	$w_rtn = get_sub_lot($gw_scr['s_lot_id'], $w_arr_s_lot_id);
	if($w_rtn != 0) return 4000;

	for($i=1; $i<=count($w_arr_s_lot_id); $i++){
		#------------------------------------------------------------------
		# get lot_bas_tbl
		#------------------------------------------------------------------
		$w_rtn = xgt_lot($w_arr_s_lot_id[$i], $w_lot_bas);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $w_arr_s_lot_id[$i], __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# check state
		#------------------------------------------------------------------
		$w_rtn = ioin_st_check($w_lot_bas);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $w_arr_s_lot_id[$i], __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# get stp_cls
		#------------------------------------------------------------------
		$w_rtn = xgt_stp_cls($w_lot_bas['STP_CD'], $w_stpcls, $_);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $w_lot_bas['STP_CD'], __LINE__);
			return 4000;
		}
		#------------------------------------------------------------------
		# check allowed step
		#------------------------------------------------------------------
		if(!in_array($w_stpcls, unserialize(constant("E9_WFR")))){
			list($g_msg, $g_err_lv) = msg("err_Disabled");
			$g_msg = xpt_err_msg($g_msg, $w_arr_s_lot_id[$i], __LINE__);
			return 4000;
		}

		if($i == 1){
			#------------------------------------------------------------------
			# get prd_nm
			#------------------------------------------------------------------
			$w_rtn = xgn_prd($w_lot_bas['PRD_CD'], $w_s_prd_nm, $_);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRD_CD'], __LINE__);
				return 4000;
			}
			$w_s_prd_cd = trim($w_lot_bas['PRD_CD']);

			#------------------------------------------------------------------
			# get reject category
			#------------------------------------------------------------------
			$w_s_bad_ctg_cnt = 0;
		}

		$w_list_s_lot_id[$i]     = trim($w_lot_bas['LOT_ID']);
		$w_list_s_stp_cd[$i]     = trim($w_lot_bas['STP_CD']);
		$w_list_s_lot_no[$i]     = trim($w_lot_bas['LOT_NO']);
		$w_list_s_lot_no_str[$i] = trim($w_lot_bas['LOT_NO_STR']);
		$w_list_s_chp_qty[$i]    = $w_lot_bas['CHP_QTY'];
		$w_list_s_real_qty[$i]   = $w_lot_bas['CHP_QTY'];
		$w_list_s_upd_lev[$i]    = $w_lot_bas['UPD_LEV'];
		$w_list_s_pre_exst[$i]   = 1;
	}

	$w_s_inp_cnt = constant("INI_SLOT_CNT");
	if(count($w_list_s_lot_id) > constant("INI_SLOT_CNT")){
		$w_s_inp_cnt = count($w_list_s_lot_id) + 1;
	}

	#------------------------------------------------------------------
	# get after D/B step
	#------------------------------------------------------------------
	$w_rtn = get_aftdb_rtinf($w_prd_cd, $w_s_prd_cd, $w_prd_cd_fin, $w_rtinf);
	if($w_rtn != 0) return 4000;


        #------------------------------------------------------------------
        # get reject category
        #------------------------------------------------------------------
        $w_m_bad_ctg_cnt = 0;
        $w_rtn = xgt_ctg($w_rtinf['PRD_CD'],
                                        $w_rtinf['STP_CD'],
                                        array(1 => constant("CE_CHP_BAD")),
                                                $w_list_m_bad_ctg_cd,
                                                $w_list_m_bad_lst_no,
                                                $w_list_m_bad_ctg_nm,
                                                $w_list_m_bad_ctg_dvs,
                                                $w_list_m_bad_num_flg,
                                                $w_m_bad_ctg_cnt, null, 1);
        if($w_rtn != 0){
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
        }

	#------------------------------------------------------------------
	# get D/B step name
	#------------------------------------------------------------------
	$w_rtn = xgn_cd($w_rtinf['STP_CD'], 1, $w_nxt_stp_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# get D/B shop code
	#------------------------------------------------------------------
	$w_rtn = xgt_stp($w_rtinf['STP_CD'], $w_nxt_shp_cd);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_rtinf['STP_CD'], __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# get printer name
	#------------------------------------------------------------------
	$w_rtn = xgt_lp2_cd($gw_scr['s_lbl_cd'], $_, $_, $w_lbl_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_lbl_cd'], __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# set screen array variable
	#------------------------------------------------------------------
	$gw_scr['s_usr_nm']     	= trim($w_usr_nm);
	$gw_scr['s_stp_nm']     	= trim($w_nxt_stp_nm);
	$gw_scr['s_prd_nm_fin'] 	= trim($w_prd_nm_fin);
	$gw_scr['s_prd_cd_fin'] 	= trim($w_prd_cd_fin);
	$gw_scr['s_lbl_nm']     	= trim($w_lbl_nm);

	$gw_scr['s_equ_cd']    		= $w_equ_cd;
	$gw_scr['s_equ_nm']             = $w_equ_nm;
	$gw_scr['s_ex_lot_id'] 		= $w_ex_lot_id;

	$gw_scr['s_m_inp_cnt'] 		= $gw_scr['s_hdn_m_inp_cnt'] = $w_m_inp_cnt;
	$gw_scr['s_m_prd_cd']          	= $w_m_prd_cd;
	$gw_scr['s_m_prd_nm']          	= trim($w_m_prd_nm);
	$gw_scr['s_lot_id']     	= trim($gw_scr['s_lot_id']);
	$gw_scr['s_prd_nm']     	= $w_m_prd_nm;
	$gw_scr['s_pkg_nm']             = $w_pkg_nm;
	$gw_scr['s_prd_cd']     	= $w_m_prd_cd;
	$gw_scr['s_stp_cd']     	= $w_stp_cd;
	$gw_scr['s_lot_no']     	= $w_lot_no;
	$gw_scr['s_lot_no_str'] 	= $w_lot_no_str;
	$gw_scr['s_chp_qty']    	= $w_chp_qty;
	$gw_scr['s_trt_qty']    	= $w_trt_qty;
	$gw_scr['s_upd_lev']   		= $w_upd_lev;
	$gw_scr['s_real_qty']   	= $w_real_qty;
	$gw_scr['s_pre_exst']   	= $w_pre_exst;
        $gw_scr['s_inp_chp_qty']        = $w_chp_qty;
	$gw_scr['s_inp_sub_qty']	= $w_lf_qty['CTG_DAT_VAL'];	

        $gw_scr['s_list_bad_ctg_nm']	= $w_list_m_bad_ctg_nm;
        $gw_scr['s_list_bad_ctg_qty']	= array();
        $gw_scr['s_list_bad_ctg_dvs']	= $w_list_m_bad_ctg_dvs;
        $gw_scr['s_list_bad_ctg_cd']	= $w_list_m_bad_ctg_cd;
        $gw_scr['s_list_bad_num_flg']	= $w_list_m_bad_num_flg;

	$gw_scr['s_s_inp_cnt'] 		= $gw_scr['s_hdn_s_inp_cnt'] = $w_s_inp_cnt;
	$gw_scr['s_s_prd_cd']          	= $w_s_prd_cd;
	$gw_scr['s_s_prd_nm']          	= trim($w_s_prd_nm);
	$gw_scr['s_list_s_lot_id']     	= $w_list_s_lot_id;
	$gw_scr['s_list_s_prd_nm']    	= $w_list_s_prd_nm;
	$gw_scr['s_list_s_prd_cd']     	= $w_list_s_prd_cd;
	$gw_scr['s_list_s_stp_cd']     	= $w_list_s_stp_cd;
	$gw_scr['s_list_s_lot_no']     	= $w_list_s_lot_no;
	$gw_scr['s_list_s_lot_no_str'] 	= $w_list_s_lot_no_str;
	$gw_scr['s_list_s_chp_qty']    	= $w_list_s_chp_qty;
	$gw_scr['s_list_s_upd_lev']    	= $w_list_s_upd_lev;
	$gw_scr['s_list_s_real_qty']   	= $w_list_s_real_qty;
	$gw_scr['s_list_s_pre_exst']   	= $w_list_s_pre_exst;

	$gw_scr['s_m_bad_ctg_cnt'] 	= $w_m_bad_ctg_cnt;
	$gw_scr['s_s_bad_ctg_cnt'] 	= $w_s_bad_ctg_cnt;

	$gw_scr['s_nxt_rt_cd']     	= trim($w_rtinf['RT_CD']);
	$gw_scr['s_nxt_prc_cd']    	= trim($w_rtinf['PRC_CD']);
	$gw_scr['s_nxt_stp_cd']    	= trim($w_rtinf['STP_CD']);
	$gw_scr['s_nxt_io_blc_cd'] 	= trim($w_rtinf['IO_BLC_CD']);
	$gw_scr['s_nxt_shp_cd']    	= trim($w_nxt_shp_cd);

	if(count($w_warn) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_warn);
	}

	scr_mode_chg(2);

	return 0;
}

###################################################################
#####                                                         #####
##### MODE2                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode2
#==================================================================
function main_md2()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "CHECK":
		main_md2_chk();
		break;
	case "ERASE":
		set_init(2);
		main_md1_chk();
		break;
	case "REDISP_M":
		main_md2_rdsp("m");
		break;
	case "REDISP_S":
		main_md2_rdsp("s");
		break;
	case "BADDTL_M":
		main_md2_dtl("m");
		break;
	case "BADDTL_S":
		main_md2_dtl("s");
		break;
	case "BACK":
		set_init(2);
		scr_mode_chg(1);
		break;
	}

	return 0;
}

#==================================================================
# mode2 [check]
#==================================================================
function main_md2_chk()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_warn = array();

	$w_dvs = unserialize(constant("M_S_DVS"));
	#------------------------------------------------------------------
	# DO NOT be changed the number of Lots by [check] process
	#------------------------------------------------------------------
	$gw_scr['s_m_inp_cnt'] = $gw_scr['s_hdn_m_inp_cnt'];
	$gw_scr['s_s_inp_cnt'] = $gw_scr['s_hdn_s_inp_cnt'];

	#------------------------------------------------------------------
	# keeping checked state
	#------------------------------------------------------------------
	$w_need_aprv = 0;
	for($d=1; $d<=count($w_dvs); $d++){
		$dvs = $w_dvs[$d];
		for($i=1; $i<=$gw_scr['s_s_inp_cnt']; $i++){
			$gw_scr['s_list_s_hdn_comp_flg'][$i] = "";
			if($gw_scr['s_list_s_comp_flg'][$i] == "1"){
				$gw_scr['s_list_s_hdn_comp_flg'][$i] = 1;
				### need to approval
				if($dvs == "s") {
					if($gw_scr['s_list_s_adj_qty'][$i]  != ""){
						$w_need_aprv = 1;
					}
				} else {
					 $w_need_aprv = 1;
				}
			}
		}
	}

       	#------------------------------------------------------------------
       	# get lot_bas_tbl
       	#------------------------------------------------------------------
       	$w_rtn = xgt_lot($gw_scr['s_lot_id'], $w_lot_bas);
       	if($w_rtn != 0){
                 $g_err_lv = 0;
                 $g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
                 return 4000;
       	}

        ### check UV Irradiation time
        $w_rtn = chk_uv($w_lot_bas);
        if($w_rtn != 0) return 4000;

        ### check has already been reserved by other Lot
        $w_rtn = chk_rsvd($gw_scr['s_lot_id'], constant("CT_MAINLOT"));
        if($w_rtn != 0) return 4000;

	# Get PO
	$w_rtn = cs_xgt_po_no($gw_scr['s_lot_id'], $r_dat, 0);
	$w_po_no = $r_dat[0];

	#------------------------------------------------------------------
	# check input
	#------------------------------------------------------------------
	$w_rtn = check_input(2);
	if($w_rtn != 0) return 4000;

	$slcnt = 0;
	$w_list_sl_m_lot_id = array();
	$w_spc_equ_hold_lot = "";
	$w_s_chp_qty_tot = 0;
	$w_list_ex_sl_no = array();
	$w_list_sl_no = array();
	for($d=1; $d<=count($w_dvs); $d++){
		$dvs = $w_dvs[$d];
		$w_itm = itm("MainLot");
		if($dvs == "s") $w_itm = itm("SubLot");
		### set to 'variable variable'($$) about sum of pass qty
		### as a result set to following variable : $w_m_sum_pas_qty / $w_s_sum_pas_qty
		$w_var_sumqty = "w_".$dvs."_sum_pas_qty";
		$$w_var_sumqty = 0;
		for($i=1; $i<=$gw_scr['s_s_inp_cnt']; $i++){
			$w_compflg = $gw_scr['s_list_s_comp_flg'][$i];
			$w_lot_id  = $gw_scr['s_list_s_lot_id'][$i];
		
			$w_adj_qty = $gw_scr['s_list_s_adj_qty'][$i];
			$w_chp_qty = $gw_scr['s_list_s_chp_qty'][$i];
			$w_trt_qty = $gw_scr['s_list_s_trt_qty'][$i];

			#------------------------------------------------------------------
	                # check if work in progress
	                #------------------------------------------------------------------
			if($i != 1){ // Check Main Lot
				$w_exst = 0;
        		        $w_rtn = chk_in($w_lot_id, $w_exst);
	        	        if($w_rtn != 0) return 4000;
        	        	if($w_exst > 0){
		                        list($g_msg, $g_err_lv) = msg("err_Wrkd_MainLot");
		                        $g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
        		                return 4000;
		                }
			}

			# Check PO No
			if($w_lot_id != ""){
				$w_rtn = cs_xgt_po_no($w_lot_id, $r_dat, 0);
				if($w_po_no != $r_dat[0]){
                	                list($g_msg, $g_err_lv) = msg("err_diff_po");
                        	        $g_msg = xpt_err_msg($g_msg, $w_po_no ." - ". $r_dat[0], __LINE__);
                                	return 4000;
	                        }
			}
			if($dvs == "s" && $w_compflg==1) {
		                $w_adj_qty = $w_chp_qty - $w_trt_qty;
				$gw_scr['s_list_s_adj_qty'][$i] = $w_adj_qty;
			} else {
				$w_adj_qty = $gw_scr['s_list_s_adj_qty'][$i];
			}
			$w_pas_qty = $gw_scr['s_list_s_trt_qty'][$i];
			$w_bad_qty = $gw_scr['s_list_s_bad_qty'][$i];
			$w_upd_lev = $gw_scr['s_list_s_upd_lev'][$i];
			$w_pre_exst = $gw_scr['s_list_s_pre_exst'][$i];
			$w_srlz_baddtl = $gw_scr['s_list_s_srlz_baddtl'][$i];
			$w_baddtl  = array();
			if($w_srlz_baddtl != ""){
				$w_baddtl = uunserialize($w_srlz_baddtl);
			}

			if($w_lot_id == ""){
				$gw_scr['s_list_s_lot_no'][$i]      = "";
				$gw_scr['s_list_s_lot_no_str'][$i]  = "";
				$gw_scr['s_list_s_adj_qty'][$i]     = "";
				$gw_scr['s_list_s_chp_qty'][$i]     = "";
				$gw_scr['s_list_s_trt_qty'][$i]     = "";
				$gw_scr['s_list_s_pas_qty'][$i]     = "";
				$gw_scr['s_list_s_bad_qty'][$i]     = "";
				$gw_scr['s_list_s_upd_lev'][$i]     = "";
				$gw_scr['s_list_s_srlz_baddtl'][$i] = "";
				$gw_scr['s_list_s_pre_exst'][$i]    = "";
				continue;
			}

			#------------------------------------------------------------------
			# check SPC/Equip Hold Info for all specified Lot
			#------------------------------------------------------------------
			$w_rtn = chk_spc_equ($w_lot_id, $w_spc_equinf);
			if($w_rtn != 0) return 4000;
			if($w_spc_equinf != ""){
				if($w_spc_equ_hold_lot == ""){
					$w_spc_equ_hold_lot = $w_spc_equinf . "_" . $w_lot_id;
				}
				list($w_msg, $w_lv) = msg("err_Warn_".$w_spc_equinf);
				$w_warn[] = xpt_err_msg($w_msg, $w_lot_id, __LINE__);
			}
			$gw_scr['s_list_s_spc_equinf'][$i] = $w_spc_equinf;


			if($gw_scr['s_ex_lot_id'] != "" && $dvs == "m" && $i == 1) continue;

			#------------------------------------------------------------------
			#------------------------------------------------------------------
                        if($dvs == "s"
                        && ($i == 1 && $w_trt_qty == "")
                        ){
                                list($g_msg, $g_err_lv) = msg("err_Need_InLot");
                                $g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
                                return 4000;
                        }

			#------------------------------------------------------------------
			# if new input line
			#------------------------------------------------------------------
			if($w_pre_exst == "" && $w_lot_id != ""){
				# error if not set last flag
				$w_newok = 0;
				for($j=1; $j<=$gw_scr['s_s_inp_cnt']; $j++){
					if($gw_scr['s_list_s_pre_exst'][$j] != "1") continue;
					if($gw_scr['s_list_s_comp_flg'][$j] == "1"){
						$w_newok = 1;
						break;
					}
				}
				if($w_newok == 0){
					list($g_msg, $g_err_lv) = msg("err_NewInp");
					$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
					return 4000;
				}
				#------------------------------------------------------------------
				# get lot_bas_tbl
				#------------------------------------------------------------------
				$w_rtn = xgt_lot($w_lot_id, $w_lot_bas);
				if($w_rtn != 0){
					$g_err_lv = 0;
					$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
					return 4000;
				}
				$w_chp_qty = $w_lot_bas['CHP_QTY'];

				#------------------------------------------------------------------
				# Lot state check
				#------------------------------------------------------------------
				$w_rtn = ioin_st_check($w_lot_bas);
				if($w_rtn != 0){
					$g_err_lv = 0;
					$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
					return 4000;
				}

				#------------------------------------------------------------------
				# check specified Lot has been already Track-In
				#------------------------------------------------------------------

				$w_rtn = chk_rsvd($w_lot_id, constant("CT_SUBLOT"));
				if($w_rtn != 0) return 4000;

        			### check UV Irradiation time
        			$w_rtn = chk_uv($w_lot_bas);
       				if($w_rtn != 0) return 4000;

				#------------------------------------------------------------------
				# validity check component product
				#------------------------------------------------------------------
				if($gw_scr['s_s_prd_cd'] != trim($w_lot_bas['PRD_CD'])){
					list($g_msg, $g_err_lv) = msg("err_Dis_PrdCdMcp");
					$w_tg = get_tg($w_itm, $w_lot_id, $w_lot_bas['PRD_CD']);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}

				### set to screen variable
				$gw_scr['s_list_s_lot_no'][$i]     = trim($w_lot_bas['LOT_NO']);
				$gw_scr['s_list_s_lot_no_str'][$i] = trim($w_lot_bas['LOT_NO_STR']);
				$gw_scr['s_list_s_chp_qty'][$i]    = $w_chp_qty;
				$gw_scr['s_list_s_upd_lev'][$i]    = $w_lot_bas['UPD_LEV'];
			}

			#------------------------------------------------------------------
			# qty check
			#------------------------------------------------------------------
			### error if pass qty '0'
			if($w_pas_qty == "0"){
				list($g_msg, $g_err_lv) = msg("err_AllReject");
				$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
				return 4000;
			}
			### error if input adj qty
			if($w_compflg == "" && $w_adj_qty != ""){
				list($g_msg, $g_err_lv) = msg("err_NoInp_Adj");
				$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
				return 4000;
			}

			### abs(stock qty - input qty) = adj qty
			if($w_compflg == "1"){
				if($dvs == "m"){
					if(abs($w_chp_qty - $w_trt_qty) != $w_adj_qty){
						list($g_msg, $g_err_lv) = msg("err_Dis_StkAdjInp");
						$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
						return 4000;
					}
                                }elseif($dvs == "s"){
					$w_adj_qty = $w_chp_qty - $w_trt_qty;
                                	if($w_chp_qty < $w_trt_qty){
                                        	list($g_msg, $g_err_lv) = msg("err_Inp_Ovr_Stk");
                                        	$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
                                        	return 4000;
                                	}

                                        if($w_chp_qty !=  ($w_trt_qty + $w_adj_qty)){
                                                list($g_msg, $g_err_lv) = msg("err_Dis_StkAdjInp");
                                                $g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
                                                return 4000;
                                        }
				} else {
					if($w_chp_qty != $w_trt_qty){
						list($g_msg, $g_err_lv) = msg("err_Off_CompFlg");
						$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
						return 4000;
					}
				}
			} else {
				if($w_chp_qty < $w_trt_qty){
					list($g_msg, $g_err_lv) = msg("err_Inp_Ovr_Stk");
					$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
					return 4000;
				}
				if($dvs == "m"
				&& $w_chp_qty == $w_trt_qty
				&& $w_compflg == ""
				){
					list($g_msg, $g_err_lv) = msg("err_On_CompFlg");
					$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
					return 4000;
				}

                                if($dvs == "s"
                                && $w_chp_qty == $w_trt_qty
                                && $w_compflg == ""
                                ){
                                        list($g_msg, $g_err_lv) = msg("err_On_CompFlg");
                                        $g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
                                        return 4000;
                                }

			}
			
			#------------------------------------------------------------------
		        # slice no check (Updated)
		        #------------------------------------------------------------------
		        $w_list_ex_sl_no[$i] = $gw_scr['s_list_s_slc_no'][$i];
		        $w_rtn = chk_slno($gw_scr['s_list_s_slc_no'][$i], $w_slno, $w_slcnt);
		        if($w_rtn != 0) return 4000;
		        $w_list_sl_no[$i] = $w_slno;

			### error if rej qty <> sum of rej dtla
			if($gw_scr['s_s_bad_ctg_cnt'] > "0"){
				if($w_bad_qty != array_sum($w_baddtl)){
					list($g_msg, $g_err_lv) = msg("err_Dis_BadDtl");
					$g_msg = xpt_err_msg($g_msg, $w_itm."/".$w_lot_id, __LINE__);
					return 4000;
				}
			}
			$w_s_chp_qty_tot += $w_trt_qty;
			### exclude if Lot has space/equip hold info
			if($w_spc_equinf == ""){
				$$w_var_sumqty += $w_trt_qty;
			}

			### for use slice
			if($dvs == "m" && $w_trt_qty != ""){
				$slcnt++;
				$w_list_sl_m_lot_id[$slcnt] = $w_lot_id;
			}
		}
	}


        if($w_s_chp_qty_tot < $gw_scr['s_pas_chp_qty']){
               list($g_msg, $g_err_lv) = msg("err_TtlSub_InpQty");
               $g_msg = xpt_err_msg($g_msg, $w_s_chp_qty_tot ." < ". $gw_scr['s_pas_chp_qty'], __LINE__);
               return 4000;
        }

	#------------------------------------------------------------------
	# Need Approved
	#------------------------------------------------------------------
	if($w_need_aprv == 1 && $gw_scr['s_aprv_usr_id'] == ""){
		$gw_scr['s_need_aprv'] = 1;
		$gw_scr['s_need_aprv_err'] = 1;
		list($g_msg, $g_err_lv) = msg("err_Need_Aprv");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	### no need approved
	if($w_need_aprv == 0 && $gw_scr['s_aprv_usr_id'] != ""){
		list($g_msg, $g_err_lv) = msg("err_NoNeed_Aprv");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# error if not match multi-chip component count
	#------------------------------------------------------------------
	### get prd_fct
	$w_sql = <<<_SQL
SELECT
	MOM1.PRD_CD_MCP AS M_PRD_CD_MCP,
	MOM1.PRD_FCT    AS M_PRD_FCT,
	MOM2.PRD_CD_MCP AS S_PRD_CD_MCP,
	MOM2.PRD_FCT    AS S_PRD_FCT
FROM
	MCP_ORG_MST MOM1,
	MCP_ORG_MST MOM2
WHERE
	MOM1.PRD_CD_FIN = '{$gw_scr['s_prd_cd_fin']}'
	AND MOM1.PRD_CD_MCP = '{$gw_scr['s_m_prd_cd']}'
	AND MOM1.M_PRD_FLG = '1'
	AND MOM1.DEL_FLG = '0'
	AND MOM2.PRD_CD_FIN = MOM1.PRD_CD_FIN
	AND MOM2.PTN = MOM1.PTN
	AND MOM2.PRD_CD_MCP = '{$gw_scr['s_s_prd_cd']}'
	AND MOM2.DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "MCP_ORG_MST", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	$w_m_prd_fct = $w_row['M_PRD_FCT'];
	$w_s_prd_fct = $w_row['S_PRD_FCT'];

	### check in consideration of prd_fct
#	if((1 * $w_m_prd_fct) != ($w_s_sum_pas_qty * $w_s_prd_fct)){
#		list($g_msg, $g_err_lv) = msg("err_Dis_AftQty");
#		if($w_spc_equ_hold_lot != ""){
#			list($w_inf, $w_lot) = explode("_", $w_spc_equ_hold_lot);
#			list($w_msg, $w_lv) = msg("err_Exc_Follow");
#			$g_msg .= sprintf($w_msg, $w_inf, $w_lot);
#		}
#		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
#		return 4000;
#	}

	#------------------------------------------------------------------
	# get reject category (after D/B)
	#------------------------------------------------------------------
	$w_rtn = xgt_ctg($gw_scr['s_prd_cd_fin'],
					$gw_scr['s_nxt_stp_cd'],
					array(1 => constant("CE_CHP_BAD")),
					$_, $_, $_, $_, $_,
					$w_aft_bad_ctg_cnt, null, 1);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check magainze control
	#------------------------------------------------------------------
	$w_rtn = cs_xck_jig_srch($gw_scr['s_nxt_prc_cd'],
							$gw_scr['s_nxt_stp_cd'],
							$gw_scr['s_prd_cd_fin'],
							constant("JI_MGZN"),
							$w_prt_grp_b, $w_prt_grp_a, $w_jig_chg_id);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	$w_mgzn_flg = 0;
	if($w_prt_grp_a != ""){
		$w_mgzn_flg = 1;
	}

	#------------------------------------------------------------------
	# check material consumption
	#------------------------------------------------------------------
	$w_rtn = cs_xck_prt_ctrl($gw_scr['s_prd_cd_fin'],
							$gw_scr['s_nxt_stp_cd'],
							$w_prt_ctrl,
							$_, $_, $_, $_, $_, $_, $_);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check approved user authority
	#------------------------------------------------------------------
	if($w_need_aprv == 1){
		$w_rtn = chk_authority($gw_scr['s_aprv_usr_id'], $gw_scr['s_aprv_pass']);
		if($w_rtn != 0) return 4000;
	}


        #------------------------------------------------------------------
        # qty check
        #------------------------------------------------------------------
        ### output
        if($gw_scr['s_inp_chp_qty'] != ($gw_scr['s_pas_chp_qty'] + $gw_scr['s_rej_chp_qty'])){
                list($g_msg, $g_err_lv) = msg("err_Dis_OutBad");
                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                return 4000;
        }


        if($gw_scr['s_inp_sub_qty'] != ($gw_scr['s_pas_sub_qty'] + $gw_scr['s_rej_sub_qty'])){
                list($g_msg, $g_err_lv) = msg("err_Dis_SubBad");
                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                return 4000;
        }

        if($gw_scr['s_rej_chp_qty'] > 0){
                $w_total_rej= 0;
                for($i=1; $i <= count($gw_scr['s_list_bad_ctg_qty']);$i++) {
                        $w_total_rej = $w_total_rej + $gw_scr['s_list_bad_ctg_qty'][$i];
                }

                if($gw_scr['s_rej_chp_qty'] != $w_total_rej){
                                list($g_msg, $g_err_lv) = msg("err_Dis_BadDtl");
                                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                return 4000;
                }
        }

	$gw_scr['s_list_s_slc_no']    = $w_list_sl_no;
        $gw_scr['s_list_s_slc_hdn'] = $w_list_ex_sl_no;


	$gw_scr['s_mgzn_flg']         = $w_mgzn_flg;
	$gw_scr['s_prt_ctrl']         = $w_prt_ctrl;
	$gw_scr['s_list_sl_m_lot_id'] = $w_list_sl_m_lot_id;
	$gw_scr['s_sl_inp_cnt']       = $slcnt;
	$gw_scr['s_aft_prd_nm']       = $gw_scr['s_prd_nm_fin'];
	$gw_scr['s_aft_lot_no_str']   = $gw_scr['s_lot_no_str'];
	$gw_scr['s_aft_bad_ctg_cnt']  = $w_aft_bad_ctg_cnt;

	$gw_scr['s_need_aprv'] = $w_need_aprv;

	if(count($w_warn) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_warn);
	}

	scr_mode_chg(3);

	return 0;
}

#==================================================================
# mode2 [ReDisp]
#==================================================================
function main_md2_rdsp($w_dvs)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_s_elem = "s_".$w_dvs."_inp_cnt";
	$w_h_elem = "s_hdn_".$w_dvs."_inp_cnt";
	#------------------------------------------------------------------
	# trim
	#------------------------------------------------------------------
	$gw_scr[$w_s_elem] = trim($gw_scr[$w_s_elem]);
	#------------------------------------------------------------------
	# require check
	#------------------------------------------------------------------
	if($gw_scr[$w_s_elem] == ""){
		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		$g_msg = xpt_err_msg($g_msg, itm("InpLotCnt"), __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# check number
	#------------------------------------------------------------------
	if(!check_num($gw_scr[$w_s_elem])){
		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
		$w_tg = get_tg(itm("InpLotCnt"), $gw_scr[$w_s_elem]);
		$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# check range
	#------------------------------------------------------------------
	if($gw_scr[$w_s_elem] < 1
	|| $gw_scr[$w_s_elem] > constant("MAX_LOT_CNT")
	){
		list($g_msg, $g_err_lv) = msg("err_Inp_Over");
		$w_tg = get_tg(itm("InpLotCnt"), $gw_scr[$w_s_elem]);
		$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# cannot set less than currently displayed Lot count
	#------------------------------------------------------------------
	$lotcnt = 0;
	for($i=1; $i<=$gw_scr[$w_h_elem]; $i++){
		if($gw_scr['s_list_'.$w_dvs.'_upd_lev'][$i] != "") $lotcnt++;
	}

	if($gw_scr[$w_s_elem] < $lotcnt){
		list($g_msg, $g_err_lv) = msg("err_Inp_Less");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$gw_scr[$w_h_elem] = $gw_scr[$w_s_elem];

	return 0;
}

#==================================================================
# mode2 [...](reject details)
#==================================================================
function main_md2_dtl($d)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_dvs = unserialize(constant("M_S_DVS"));
	
	#------------------------------------------------------------------
	# keeping checked state
	#------------------------------------------------------------------
	for($e=1; $e<=count($w_dvs); $e++){
		$dvs = $w_dvs[$e];
		for($i=1; $i<=$gw_scr['s_s_inp_cnt']; $i++){
			$gw_scr['s_list_s_hdn_comp_flg'][$i] = "";
			if($gw_scr['s_list_s_comp_flg'][$i] == "1"){
				$gw_scr['s_list_s_hdn_comp_flg'][$i] = 1;
			}
		}
	}

	### selected row
	$i = $gw_scr['s_list_row'];

	$w_stp_cd = $gw_scr['s_list_'.$d.'_stp_cd'][$i];
	if($w_stp_cd == ""){
		if($gw_scr['s_list_'.$d.'_lot_id'][$i] == ""){
			list($g_msg, $g_err_lv) = msg("err_Inp_LotID");
			$g_msg = xpt_err_msg($g_msg, $i.itm("Line"), __LINE__);
			return 4000;
		}
		$w_rtn = xgt_lot($gw_scr['s_list_'.$d.'_lot_id'][$i], $w_lot_bas);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $gw_scr['s_list_'.$d.'_lot_id'][$i], __LINE__);
			return 4000;
		}
		$w_stp_cd = $w_lot_bas['STP_CD'];
	}

	$w_rej_lot_id  = $gw_scr['s_list_'.$d.'_lot_id'][$i];
	$w_rej_lot_no  = $gw_scr['s_list_'.$d.'_lot_no'][$i];
	$w_rej_trt_qty = $gw_scr['s_list_'.$d.'_trt_qty'][$i];
	$w_rej_bad_qty = $gw_scr['s_list_'.$d.'_bad_qty'][$i];
	$w_rej_prd_nm  = $gw_scr['s_'.$d.'_prd_nm'];
	$w_rej_prd_cd  = $gw_scr['s_'.$d.'_prd_cd'];
	$w_rej_stp_cd  = $w_stp_cd;

	#------------------------------------------------------------------
	# get category
	#------------------------------------------------------------------
	$w_rtn = xgt_ctg($w_rej_prd_cd,
					$w_rej_stp_cd,
					array(1 => constant("CE_CHP_BAD")),
					$w_list_bad_ctg_cd,
					$w_list_bad_lst_no,
					$w_list_bad_ctg_nm,
					$w_list_bad_ctg_dvs,
					$w_list_bad_num_flg,
					$w_ctg_cnt, null, 1);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# auto-input if has been already been inputted
	#------------------------------------------------------------------
	if($gw_scr['s_list_'.$d.'_srlz_baddtl'][$i] != ""){
		$w_baddtl = uunserialize($gw_scr['s_list_'.$d.'_srlz_baddtl'][$i]);
		for($i=1; $i<=$w_ctg_cnt; $i++){
			$ctgcd = $w_list_bad_ctg_cd[$i];
			if($w_baddtl[$ctgcd]){
				$w_list_bad_ctg_qty[$i] = $w_baddtl[$ctgcd];
			}
		}
	}

	$gw_scr['s_rej_lot_id']  = $w_rej_lot_id;
	$gw_scr['s_rej_prd_nm']  = $w_rej_prd_nm;
	$gw_scr['s_rej_prd_cd']  = $w_rej_prd_cd;
	$gw_scr['s_rej_lot_no']  = $w_rej_lot_no;
	$gw_scr['s_rej_stp_cd']  = $w_rej_stp_cd;
	$gw_scr['s_rej_trt_qty'] = $w_rej_trt_qty;
	$gw_scr['s_rej_bad_qty'] = $w_rej_bad_qty;

	$gw_scr['s_bad_ctg_cnt'] = $w_ctg_cnt;
	$gw_scr['s_list_bad_ctg_cd']  = $w_list_bad_ctg_cd;
	$gw_scr['s_list_bad_lst_no']  = $w_list_bad_lst_no;
	$gw_scr['s_list_bad_ctg_nm']  = $w_list_bad_ctg_nm;
	$gw_scr['s_list_bad_ctg_dvs'] = $w_list_bad_ctg_dvs;
	$gw_scr['s_list_bad_num_flg'] = $w_list_bad_num_flg;
	$gw_scr['s_list_bad_ctg_qty'] = $w_list_bad_ctg_qty;

	$gw_scr['s_sel_dvs'] = $d;

	scr_mode_chg(6);
}

###################################################################
#####                                                         #####
##### MODE3                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode3
#==================================================================
function main_md3()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "CHECK":
		main_md3_chk();
		break;
	case "REDISP_MGZN":
		main_md3_rdsp();
		break;
	case "AFTDTL":
		main_md3_dtl();
		break;
	case "ERASE":
		set_init(3);
		break;
	case "BACK":
		set_init(3);
		scr_mode_chg(2);
		break;
	}

	return 0;
}

#==================================================================
# mode3 [check] process
#==================================================================
function main_md3_chk()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# DO NOT be changed the number of Line by [check] process
	#------------------------------------------------------------------
	$gw_scr['s_mgzn_row'] = $gw_scr['s_hdn_mgzn_row'];

	#------------------------------------------------------------------
	# input check
	#------------------------------------------------------------------
	$w_rtn = check_input(3);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# slice no check
	#------------------------------------------------------------------
#	for($i=1; $i<=$gw_scr['s_sl_inp_cnt']; $i++){
#		$w_list_ex_sl_no[$i] = $gw_scr['s_list_sl_no'][$i];
#		$w_rtn = chk_slno($gw_scr['s_list_sl_no'][$i], $w_slno, $w_slcnt);
#		if($w_rtn != 0) return 4000;
#		$w_list_sl_no[$i] = $w_slno;
#	}

	#------------------------------------------------------------------
	# qty check
	#------------------------------------------------------------------
	### output
	if($gw_scr['s_inp_chp_qty'] != ($gw_scr['s_pas_chp_qty'] + $gw_scr['s_rej_chp_qty'])){
		list($g_msg, $g_err_lv) = msg("err_Dis_OutBad");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

        if($gw_scr['s_inp_sub_qty'] != ($gw_scr['s_pas_sub_qty'] + $gw_scr['s_rej_sub_qty'])){
                list($g_msg, $g_err_lv) = msg("err_Dis_SubBad");
                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                return 4000;
        }

	### reject
	if($gw_scr['s_aft_bad_ctg_cnt'] > "0"){
		if($gw_scr['s_aft_srlz_baddtl'] != ""){
			$w_baddtl = uunserialize($gw_scr['s_aft_srlz_baddtl']);
			if($gw_scr['s_rej_chp_qty'] != array_sum($w_baddtl)){
				list($g_msg, $g_err_lv) = msg("err_Dis_BadDtl");
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
		}
	}

        if($gw_scr['s_rej_chp_qty'] > 0){
		$w_total_rej= 0;
		for($i=1; $i <= count($gw_scr['s_list_bad_ctg_qty']);$i++) {
			$w_total_rej = $w_total_rej + $gw_scr['s_list_bad_ctg_qty'][$i]; 
		}
	
                if($gw_scr['s_rej_chp_qty'] != $w_total_rej){
                                list($g_msg, $g_err_lv) = msg("err_Dis_BadDtl");
                                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                return 4000;
                }
        }

	#------------------------------------------------------------------
	# magazine check
	#------------------------------------------------------------------
	if($gw_scr['s_mgzn_flg'] == "1"){
		### duplicate check
		for($i=1; $i<=$gw_scr['s_hdn_mgzn_row']; $i++){
			if($gw_scr['s_list_mgzn_id'][$i] == "") continue;
			for($j=($i+1); $j<=$gw_scr['s_hdn_mgzn_row']; $j++){
				if($gw_scr['s_list_mgzn_id'][$i] == $gw_scr['s_list_mgzn_id'][$j]){
					list($g_msg, $g_err_lv) = msg("err_Inp_Dup");
					$w_tg = get_tg(itm("FinMgznId"), $gw_scr['s_list_mgzn_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
			}
		}
		$cnt = 0;
		$w_arr_mgznid = array();
		for($i=1; $i<=$gw_scr['s_hdn_mgzn_row']; $i++){
			if($gw_scr['s_list_mgzn_id'][$i] == "") continue;
			$cnt++;
			$w_arr_mgznid[$cnt] = $gw_scr['s_list_mgzn_id'][$i];
		}

		$w_rtn = cs_xck_jig_chk_out($gw_scr['s_nxt_prc_cd'],
									$gw_scr['s_nxt_stp_cd'],
									$gw_scr['s_prd_cd_fin'],
									$gw_scr['s_lot_id'],
									constant("JI_MGZN"),
									constant("SH_MGZN"),
									$w_arr_mgznid);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	#------------------------------------------------------------------
	# SPACE check
	#------------------------------------------------------------------
	$w_spcchk_lot_id      = $gw_scr['s_lot_id'];
	$w_spcchk_in_chp_qty  = $gw_scr['s_inp_chp_qty'];
	$w_spcchk_out_chp_qty = $gw_scr['s_inp_chp_qty'];

	# for space
	$w_baddtl = array();
	if($gw_scr['s_list_m_srlz_baddtl'][1] != ""){
		$w_baddtl = uunserialize($gw_scr['s_list_m_srlz_baddtl'][1]);
	}
	if($gw_scr['s_ex_lot_id'] != ""){
		if($gw_scr['s_list_m_srlz_baddtl'][2] != ""){
			$w_baddtl = uunserialize($gw_scr['s_list_m_srlz_baddtl'][2]);
		}
	}
	$w_spcchk_rej_chp_qty = array();
	foreach($w_baddtl as $ctgcd => $qty){
		if($qty == "") $qty = "0";
		$w_spcchk_rej_chp_qty[$ctgcd] = $qty;
	}

	$w_rtn = chk_space4out($w_spcchk_lot_id,
						"Y",
						$gw_scr['s_equ_cd'],
						"",
						$gw_scr['s_usr_id'],
						$w_spcchk_in_chp_qty,
						$w_spcchk_out_chp_qty,
						"",
						"",
						$w_spcchk_rej_chp_qty,
						array(),
						"",
						$w_spc_err_cd, $w_spc_err_nm, $w_spc_err_msg);
	if($w_rtn != 0) return 4000;

	### abend if error-code is undefined
	if($w_spc_err_cd != constant("SPC_ERRCD_NRM")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABN")
	&& $w_spc_err_cd != constant("SPC_ERRCD_PCS")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABNPCS")
	){
		list($g_msg, $g_err_lv) = msg("err_Space");
		$g_msg = xpt_err_msg($g_msg, $w_spc_err_cd, __LINE__);
		return 4000;
	}


#	$gw_scr['s_list_sl_no']    = $w_list_sl_no;
#	$gw_scr['s_list_ex_sl_no'] = $w_list_ex_sl_no;

	
	$w_warn = array();
	#Add in warning for the ABN on track-out
	#echo $w_spc_err_msg;
	$w_arr_space_msg_buff = explode(" ",$w_spc_err_msg);
	if( $w_arr_space_msg_buff[4] == "100000"){
		#check if there is a ABN violation
		if($w_arr_space_msg_buff[8] != 0){
			list($w_msg, $w_lv) = msg("warn_ABN_Exec");
			$w_warn[] = $w_msg;
		}
	}
	
	if(count($w_warn) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_warn);
	} else {
		if($g_msg == ""){
			list($g_msg, $g_err_lv) = msg("guid_Execute");
		}
	}
	$g_msg = xpt_err_msg($g_msg, "", "");
	
	#list($g_msg, $g_err_lv) = msg("guid_Execute");
	#$g_msg = xpt_err_msg($g_msg, "", "");

	scr_mode_chg(4);

	return 0;
}

#==================================================================
# mode3 [...](reject details)
#==================================================================
function main_md3_dtl()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_rej_lot_id  = "";
	$w_rej_prd_nm  = $gw_scr['s_prd_nm_fin'];
	$w_rej_prd_cd  = $gw_scr['s_prd_cd_fin'];
	$w_rej_lot_no  = "";
	$w_rej_stp_cd  = $gw_scr['s_nxt_stp_cd'];
	$w_rej_trt_qty = $gw_scr['s_inp_chp_qty'];
	$w_rej_bad_qty = $gw_scr['s_rej_chp_qty'];

	#------------------------------------------------------------------
	# get category
	#------------------------------------------------------------------
	$w_rtn = xgt_ctg($w_rej_prd_cd,
					$w_rej_stp_cd,
					array(1 => constant("CE_CHP_BAD")),
					$w_list_bad_ctg_cd,
					$w_list_bad_lst_no,
					$w_list_bad_ctg_nm,
					$w_list_bad_ctg_dvs,
					$w_list_bad_num_flg,
					$w_ctg_cnt, null, 1);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# auto-input if has been already been inputted
	#------------------------------------------------------------------
	if($gw_scr['s_aft_srlz_baddtl'] != ""){
		$w_baddtl = uunserialize($gw_scr['s_aft_srlz_baddtl']);
		for($i=1; $i<=$w_ctg_cnt; $i++){
			$ctgcd = $w_list_bad_ctg_cd[$i];
			if($w_baddtl[$ctgcd]){
				$w_list_bad_ctg_qty[$i] = $w_baddtl[$ctgcd];
			}
		}
	}

	$gw_scr['s_rej_lot_id']  = itm("NotSet");
	$gw_scr['s_rej_prd_nm']  = $w_rej_prd_nm;
	$gw_scr['s_rej_prd_cd']  = $w_rej_prd_cd;
	$gw_scr['s_rej_lot_no']  = $w_rej_lot_no;
	$gw_scr['s_rej_stp_cd']  = $w_rej_stp_cd;
	$gw_scr['s_rej_trt_qty'] = $w_rej_trt_qty;
	$gw_scr['s_rej_bad_qty'] = $w_rej_bad_qty;

	$gw_scr['s_bad_ctg_cnt'] = $w_ctg_cnt;
	$gw_scr['s_list_bad_ctg_cd']  = $w_list_bad_ctg_cd;
	$gw_scr['s_list_bad_lst_no']  = $w_list_bad_lst_no;
	$gw_scr['s_list_bad_ctg_nm']  = $w_list_bad_ctg_nm;
	$gw_scr['s_list_bad_ctg_dvs'] = $w_list_bad_ctg_dvs;
	$gw_scr['s_list_bad_num_flg'] = $w_list_bad_num_flg;
	$gw_scr['s_list_bad_ctg_qty'] = $w_list_bad_ctg_qty;

	scr_mode_chg(6);

	return 0;
}

#==================================================================
# mode3 [redisp]
#==================================================================
function main_md3_rdsp()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# trim
	#------------------------------------------------------------------
	$gw_scr['s_mgzn_row'] = trim($gw_scr['s_mgzn_row']);
	#------------------------------------------------------------------
	# require check
	#------------------------------------------------------------------
	if($gw_scr['s_mgzn_row'] == ""){
		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		$g_msg = xpt_err_msg($g_msg, itm("NumDsp"), __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# check number
	#------------------------------------------------------------------
	if(!check_num($gw_scr['s_mgzn_row'])){
		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
		$g_msg = xpt_err_msg($g_msg, itm("NumDsp"), __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# check range
	#------------------------------------------------------------------
	if($gw_scr['s_mgzn_row'] < 1
	|| $gw_scr['s_mgzn_row'] > constant("MAX_MGZN_CNT")
	){
		list($g_msg, $g_err_lv) = msg("err_Inp_Over");
		$g_msg = xpt_err_msg($g_msg, itm("NumDsp"), __LINE__);
		return 4000;
	}

	$gw_scr['s_hdn_mgzn_row'] = $gw_scr['s_mgzn_row'];

	return 0;
}

###################################################################
#####                                                         #####
##### MODE4                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode4
#==================================================================
function main_md4()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "EXECUTE":
		main_md4_exe();
		break;
	case "BACK":
		set_init(4);
		scr_mode_chg(3);
		break;
	}

	return 0;
}

#==================================================================
# mode2 [Execute] process
#==================================================================
function main_md4_exe()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_warn = array();
	#------------------------------------------------------------------
	# start transaction
	#------------------------------------------------------------------
	db_begin();

	#------------------------------------------------------------------
	# execute
	#------------------------------------------------------------------
	$w_rtn = main_exe($w_new_lot_id,
					$w_m_ioab,
					$w_s_ioab,
					$w_ioabflg,
					$w_jdghold,
					$w_spchold,
					$w_holdrsv);
	if($w_rtn != 0){
		db_rollback();
		return 4000;
	}

	#------------------------------------------------------------------
	# commit
	#------------------------------------------------------------------
	db_commit();
#	db_rollback();

	#------------------------------------------------------------------
	# show warning if component Lot close(IOAB)
	#------------------------------------------------------------------
	if(count($w_m_ioab) > 0){
		list($w_msg, $w_lv) = msg("end_AllReject");
		$w_warn[] = xpt_err_msg($w_msg, implode("/", $w_m_ioab), __LINE__);
	}
	if(count($w_s_ioab) > 0){
		list($w_msg, $w_lv) = msg("end_AllReject");
		$w_warn[] = xpt_err_msg($w_msg, implode("/", $w_s_ioab), __LINE__);
	}

	#------------------------------------------------------------------
	# print Label
	#------------------------------------------------------------------
	if($w_ioabflg != 1
	&& count($w_jdghold) == 0
	&& count($w_spcholf) == 0
	){
#		$w_rtn = cs_xpt_etag_lsi(1,array($w_new_lot_id), $gw_scr['s_lbl_cd']);
		$w_rtn = cs_xpt_etag_db($w_new_lot_id, $gw_scr['s_lbl_cd']);
		if($w_rtn != 0){
			$gw_scr['s_prnt_lv']  = 0;
			$gw_scr['s_prnt_msg'] = xpt_err_msg($g_msg, "", __LINE__);
			$g_err_lv = "";
			$g_msg    = "";
		}
	}
	#------------------------------------------------------------------
	# [Multi-Lot] show warning if Lot close(IOAB)
	#------------------------------------------------------------------
	if($w_ioabflg == 1){
		list($g_msg, $g_err_lv) = msg("end_AllReject");
		$g_msg = xpt_err_msg($g_msg, $w_new_lot_id, __LINE__);
	}
	elseif(count($w_jdghold) > 0){
		# set pop up window info.
		$gw_scr['s_err_opn_js_flg'] = 1;
		$gw_scr['s_err_opn_lot_id'] = $w_jdghold['LOT_ID'];
		$gw_scr['s_err_opn_stp_cd'] = $w_jdghold['STP_CD'];
		$gw_scr['s_jdg_hold']       = 1;
		$gw_scr['s_jdg_rls_setday'] = $w_jdghold['SET_DAY'];
		$gw_scr['s_qul_rep_flg']    = $w_jdghold['REP_FLG'];

		# print quality report sheet
		if($gw_scr['s_qul_rep_flg'] == 1){
#			$w_rtn = xpt_qul_rep($gw_scr['s_lot_id']);
			if($w_rtn != 0){
				$gw_scr['s_prnt_lv']  = 0;
				$gw_scr['s_prnt_msg'] = xpt_err_msg($g_msg, $gw_scr['s_lot_id'], __LINE__);
				$g_err_lv = "";
				$g_msg    = "";
			}
		}

		list($g_msg, $g_err_lv) = msg("end_JdgNG_Hold");
		$g_msg = xpt_err_msg($g_msg, $w_new_lot_id, __LINE__);
	}
	elseif(count($w_spchold) > 0){
		list($g_msg, $g_err_lv) = msg("end_".$w_spchold[1]."_Hold");
		$g_msg = xpt_err_msg($g_msg, $w_new_lot_id, __LINE__);
	}
	elseif(count($w_holdrsv) > 0){
		$g_err_lv = 3;
		for($i=1; $i<=count($w_holdrsv); $i++){
			if($i >= 2) $g_msg .= "<br>";
			list($w_msg, $w_lv) = msg("end_Rsv_Hold");
			$g_msg .= $w_msg . "(" . $w_holdrsv[$i]['LOT_ID'] . ")";
			$g_msg .= "<br>";
			$g_msg .= $w_holdrsv[$i]['MSG'];
		}
	}

	$gw_scr['s_aft_lot_id'] = $w_new_lot_id;

	if($g_msg == ""){
		list($g_msg, $g_err_lv) = msg("end_Execute");
		$g_msg = xpt_err_msg($g_msg, $w_new_lot_id, "");
	}
	if($gw_scr['s_prnt_msg'] == ""){
		list($gw_scr['s_prnt_msg'], $gw_scr['s_prnt_lv']) = msg("end_Print");
	}

	scr_mode_chg(5);

	return 0;
}

###################################################################
#####                                                         #####
##### MODE5                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode5
#==================================================================
function main_md5()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "BACK":
		main_init();
		break;
	}

	return 0;
}

###################################################################
#####                                                         #####
##### MODE6                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode6
#==================================================================
function main_md6()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "CNFM":
		main_md6_cnfm();
		break;
	case "BACK":
		if($gw_scr['s_rej_lot_id'] == itm("NotSet")){
			scr_mode_chg(3);
		} else {
			scr_mode_chg(2);
		}
		break;
	}

	return 0;
}

#==================================================================
# mode6 [confirm]
#==================================================================
function main_md6_cnfm()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$r   = $gw_scr['s_list_row'];
	$dvs = $gw_scr['s_sel_dvs'];

	#------------------------------------------------------------------
	# check input
	#------------------------------------------------------------------
	$w_rtn = check_input(6);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# error if total of bad qty greater than stock qty
	#------------------------------------------------------------------
	$w_ttl = 0;
	for($i=1; $i<=$gw_scr['s_bad_ctg_cnt']; $i++){
		if($gw_scr['s_list_bad_ctg_qty'][$i] == "0"
		|| $gw_scr['s_list_bad_ctg_qty'][$i] == ""
		){
			continue;
		}
		$w_ttl += $gw_scr['s_list_bad_ctg_qty'][$i];
	}
	if($w_ttl > $gw_scr['s_rej_trt_qty']){
		list($g_msg, $g_err_lv) = msg("err_TtlBad_OvrStkQty");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}


	#------------------------------------------------------------------
	# set array
	#------------------------------------------------------------------
	$w_baddtl = array();
	for($i=1; $i<=$gw_scr['s_bad_ctg_cnt']; $i++){
		$ctgcd = $gw_scr['s_list_bad_ctg_cd'][$i];
		$w_baddtl[$ctgcd] = $gw_scr['s_list_bad_ctg_qty'][$i];
	}

	if($gw_scr['s_rej_lot_id'] == itm("NotSet")){
		$gw_scr['s_aft_srlz_baddtl'] = userialize($w_baddtl);
		scr_mode_chg(3);
	} else {
		$gw_scr['s_list_s_srlz_baddtl'][$r] = userialize($w_baddtl);
		scr_mode_chg(2);
	}

	return 0;
}

#==================================================================
# execute process
#==================================================================
function main_exe(&$r_new_lot_id,
				&$r_m_ioab,
				&$r_s_ioab,
				&$r_ioabflg,
				&$r_mcp_jdghold,
				&$r_spchold,
				&$r_holdrsv)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	#------------------------------------------------------------------
	# db lock
	#------------------------------------------------------------------
	$w_rtn = db_lock("LOT_NUM_TBL");
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "LOT_NUM_TBL", __LINE__);
		return 4000;
	}
	$w_rtn = db_lock("CD_USE_CNT_TBL");
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "CD_USE_CNT_TBL", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check SPACE
	#------------------------------------------------------------------
	$w_spcchk_lot_id      = $gw_scr['s_lot_id'];
	$w_spcchk_in_chp_qty  = $gw_scr['s_inp_chp_qty'];
	$w_spcchk_out_chp_qty = $gw_scr['s_inp_chp_qty'];

	# for space
	$w_baddtl = array();
	if($gw_scr['s_list_m_srlz_baddtl'][1] != ""){
		$w_baddtl = uunserialize($gw_scr['s_list_m_srlz_baddtl'][1]);
		
	}
	if($gw_scr['s_ex_lot_id'] != ""){
		if($gw_scr['s_list_m_srlz_baddtl'][2] != ""){
			$w_baddtl = uunserialize($gw_scr['s_list_m_srlz_baddtl'][2]);
			
		}
	}
	
	

	$w_spcchk_rej_chp_qty = array();
	foreach($w_baddtl as $ctgcd => $qty){
		if($qty == "") $qty = "0";
		$w_spcchk_rej_chp_qty[$ctgcd] = $qty;
	}

	$w_rtn = chk_space4out($w_spcchk_lot_id,
						"N",
						$gw_scr['s_equ_cd'],
						"",
						$gw_scr['s_usr_id'],
						$w_spcchk_in_chp_qty,
						$w_spcchk_out_chp_qty,
						"",
						"",
						$w_spcchk_rej_chp_qty,
						array(),
						"",
						$w_spc_err_cd, $w_spc_err_nm, $w_spc_err_msg);
	if($w_rtn != 0) return 4000;

	### abend if error-code is undefined
	if($w_spc_err_cd != constant("SPC_ERRCD_NRM")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABN")
	&& $w_spc_err_cd != constant("SPC_ERRCD_PCS")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABNPCS")
	){
		list($g_msg, $g_err_lv) = msg("err_Space");
		$g_msg = xpt_err_msg($g_msg, $w_spc_err_cd, __LINE__);
		return 4000;
	}

	#-=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=-
	# SUB LOT
	#-=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=-
	$w_rtn = main_exe_chld_lot("s", $r_s_ioab, $w_s_lot_bas);
	if($w_rtn != 0) return 4000;


        #-=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=-
        # MAIN LOT
        #-=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=-
        $w_rtn = main_exe_m_lot("m", $r_m_ioab, $w_m_lot_bas);
        if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# IOMI
	#------------------------------------------------------------------
	$w_mcp_lot_bas = $w_m_lot_bas;
	$w_rtn = main_verb_iomi($gw_scr['s_prd_cd_fin'],
							$gw_scr['s_nxt_rt_cd'],
							$gw_scr['s_nxt_prc_cd'],
							$gw_scr['s_nxt_io_blc_cd'],
							$w_mcp_lot_bas);
	if($w_rtn != 0) return 4000;

	$r_new_lot_id = trim($w_mcp_lot_bas['LOT_ID']);

	### inherit lot_inf_tbl
	$w_rtn = inhrt_lotinf4mi($gw_scr['s_usr_id'],
							$w_mcp_lot_bas['LOT_ID'],
							array(1 => $w_m_lot_bas['LOT_ID'], $w_s_lot_bas['LOT_ID']));
	if($w_rtn != 0) return 4000;

	# Ensure PO CTG_CD is inherited to child.
        $w_rtn = cs_xgt_inhrt_po_data($gw_scr['s_usr_id'],$w_m_lot_bas, $w_mcp_lot_bas['LOT_ID']);
        if ($w_rtn != 0) {
                   //db_rollback();
                   $g_err_lv = 0;
                   $g_msg  = xpt_err_msg($g_msg, "Error inheriting PO data from " . $w_m_lot_bas['LOT_ID'] ." to " . $w_mcp_lot_bas['LOT_ID'], __LINE__);
                   return 4000;
        }


	#------------------------------------------------------------------
	# IOMO
	#------------------------------------------------------------------
	$w_rtn = main_verb_iomo($w_mcp_lot_bas, $w_m_lot_bas);
	if($w_rtn != 0) return 4000;
	$w_rtn = main_verb_iomo($w_mcp_lot_bas, $w_s_lot_bas);
	if($w_rtn != 0) return 4000;
	#------------------------------------------------------------------
	# check SPACE(for in)
	#------------------------------------------------------------------
	$w_rtn = chk_space4in($gw_scr['s_usr_id'],
						$w_mcp_lot_bas['LOT_ID'],
						"N",
						$w_mcp_lot_bas['PRD_CD'],
						$w_mcp_lot_bas['STP_CD'],
						$gw_scr['s_equ_cd'],
						$w_mcp_lot_bas['CHP_QTY'],
						"",
						"",
						$w_spc_err_cd, $w_spc_err_nm, $w_spc_err_msg);
	if($w_rtn != 0) return 4000;

	### abend if error code is not xxxxx1
	if($w_spc_err_cd != constant("SPC_ERRCD_NRM")){
		list($g_msg, $g_err_lv) = msg("err_Space");
		$g_msg = xpt_err_msg($g_msg, $w_spc_err_msg, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# IOIN
	#------------------------------------------------------------------
	$w_rtn = main_verb_ioin($gw_scr['s_usr_id'],
							$gw_scr['s_equ_cd'],
							null,
							$w_mcp_lot_bas);
	if($w_rtn != 0) return 4000;

	# for space
	$w_baddtl = array();
	$w_chk_ctg = FALSE;
	if($gw_scr['s_aft_srlz_baddtl'] != ""){
		$w_baddtl = uunserialize($gw_scr['s_aft_srlz_baddtl']);
		$w_chk_ctg = TRUE;
	}
	
	if(!$w_chk_ctg){
		#------------------------------------------------------------------
		# get category
		#------------------------------------------------------------------
		$w_rtn = xgt_ctg($gw_scr['s_prd_cd_fin'],
				$gw_scr['s_nxt_stp_cd'],
				array(1 => constant("CE_CHP_BAD")),
				$w_list_bad_ctg_cd,
				$w_list_bad_lst_no,
				$w_list_bad_ctg_nm,
				$w_list_bad_ctg_dvs,
				$w_list_bad_num_flg,
				$w_ctg_cnt, null, 1);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
		
		for($i=1; $i<=$w_ctg_cnt; $i++){
			$ctgcd = $w_list_bad_ctg_cd[$i];
			$w_baddtl[$ctgcd] = "0";
		}		
	}
	

	$w_spcchk_rej_chp_qty = array();
	foreach($w_baddtl as $ctgcd => $qty){
		if($qty == "") $qty = "0";
		$w_spcchk_rej_chp_qty[$ctgcd] = $qty;
	}

	#------------------------------------------------------------------
	# check SPACE(for out)
	#------------------------------------------------------------------
	$w_rtn = chk_space4out($w_mcp_lot_bas['LOT_ID'],
						"N",
						$gw_scr['s_equ_cd'],
						"",
						$gw_scr['s_usr_id'],
						$gw_scr['s_inp_chp_qty'],
						($gw_scr['s_inp_chp_qty'] - $gw_scr['s_rej_chp_qty']),
						"",
						"",
						$w_spcchk_rej_chp_qty,
						array(),
						"",
						$w_spc_err_cd, $w_spc_err_nm, $w_spc_err_msg);
	if($w_rtn != 0) return 4000;
	### abend if error-code is undefined
	if($w_spc_err_cd != constant("SPC_ERRCD_NRM")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABN")
	&& $w_spc_err_cd != constant("SPC_ERRCD_PCS")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABNPCS")
	){
		list($g_msg, $g_err_lv) = msg("err_Space");
		$g_msg = xpt_err_msg($g_msg, $w_spc_err_cd, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# IOOT prep
	#------------------------------------------------------------------
	$w_arr_ctg_dvs  = array();
	$w_arr_ctg_cd   = array();
	$w_arr_ctg_qty  = array();
	$w_arr_ctg_txt  = array();
	$w_arr_ctg_slid = array();
	$w_arr_jdg_cd   = array();
	$w_arr_jdg_val  = array();
	$ctgcnt = 0;

	$w_baddtl = $gw_scr['s_list_bad_ctg_nm'];
	if(count($w_baddtl) > 0){
		for($i=1; $i <= count($w_baddtl); $i++){
			if($gw_scr['s_list_bad_ctg_qty'][$i] == "" || $gw_scr['s_list_bad_ctg_qty'][$i] == "0") continue;
			$ctgcnt++;
			$w_arr_ctg_dvs[$ctgcnt]  = constant("CE_CHP_BAD");
			$w_arr_ctg_cd[$ctgcnt]   = $gw_scr['s_list_bad_ctg_cd'][$i];
			$w_arr_ctg_qty[$ctgcnt]  = $gw_scr['s_list_bad_ctg_qty'][$i];
			$w_arr_ctg_txt[$ctgcnt]  = null;
			$w_arr_ctg_slid[$ctgcnt] = " ";
			### for standard judgement
			$w_arr_jdg_cd[$ctgcnt]  = $gw_scr['s_list_bad_ctg_cd'][$i];
			$w_arr_jdg_val[$ctgcnt] = $gw_scr['s_list_bad_ctg_qty'][$i];
		}
	}

	#------------------------------------------------------------------
	# IOOT
	#------------------------------------------------------------------
	$w_rtn = main_verb_ioot($gw_scr['s_usr_id'],
							$w_arr_ctg_dvs,
							$w_arr_ctg_cd,
							$w_arr_ctg_qty,
							$w_arr_ctg_txt,
							$w_arr_ctg_slid,
							$w_mcp_lot_bas['SL_QTY'],
							($w_mcp_lot_bas['CHP_QTY'] - $gw_scr['s_rej_chp_qty']),
							$w_mcp_lot_bas['LF_QTY'],
							$gw_scr['s_cmt'],
							$w_mcp_lot_bas);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# material consumption
	#------------------------------------------------------------------
	if($gw_scr['s_prt_ctrl'] == "1"){
		$w_rtn = main_exe_usemat($w_mcp_lot_bas['LOT_ID'],
								$w_mcp_lot_bas['STP_CD'],
								$w_mcp_lot_bas['PRD_CD']);
		if($w_rtn != 0) return 4000;
	}
	#------------------------------------------------------------------
	# insert use slice info.
	#------------------------------------------------------------------
	$w_rtn = convert_date($g_cpu_dts, $w_converted_date);
	for($i=1; $i<=$gw_scr['s_s_inp_cnt']; $i++){
		$w_usesl_lot_id = $gw_scr['s_list_s_lot_id'][$i];
		if($w_usesl_lot_id != ""){
			$w_usesl = explode(",", $gw_scr['s_list_s_slc_no'][$i]);
			for($j=0; $j<count($w_usesl); $j++){
				$w_rtn = ins_lotinf($gw_scr['s_usr_id'],
								$w_mcp_lot_bas['LOT_ID'],
								constant("CE_LTINF"),
								constant("CT_SLNO"),
								$w_usesl[$j],
								$w_usesl_lot_id,
								$w_converted_date,
								"IOOT");
				if($w_rtn != 0) return 4000;
			}
		}
	}
	#------------------------------------------------------------------
	# Lot information parent lot id
	#------------------------------------------------------------------
	$w_rtn = ins_lotinf($gw_scr['s_usr_id'],
							$w_mcp_lot_bas['LOT_ID'],
							constant("CE_LTINF"),
							constant("CT_PARENTLOT"),
							" ",
							$w_mcp_lot_bas['LOT_ID'],
							null,
							"IOOT");
	if($w_rtn != 0) return 4000;
	
	#------------------------------------------------------------------
	# insert Substrate Info.
	#------------------------------------------------------------------
	$w_rtn = ins_lotinf($gw_scr['s_usr_id'],
						$w_mcp_lot_bas['LOT_ID'],
						constant("CE_LTINF"),
						constant("CT_SUBSTRATE"),
						" ",
						null,
						$gw_scr['s_pas_sub_qty'],
						"IOOT");
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# IOAB (Lot close due to all reject)
	#------------------------------------------------------------------
	if($w_mcp_lot_bas['CHP_QTY'] == 0){
		$w_rtn = main_verb_ioab($gw_scr['s_usr_id'],
								null,
								$w_mcp_lot_bas);
		if($w_rtn != 0) return 4000;

		$r_ioabflg = 1;

		return 0;
	}

	#------------------------------------------------------------------
	# magazine control
	#------------------------------------------------------------------
	$w_rtn = main_exe_mgzn($w_mcp_lot_bas);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# standard judgement
	#------------------------------------------------------------------
	$w_rtn = main_exe_thd_jdg($gw_scr['s_usr_id'],
							$gw_scr['s_inp_chp_qty'],
							($gw_scr['s_inp_chp_qty'] - $gw_scr['s_rej_chp_qty']),
							$w_arr_jdg_cd,
							$w_arr_jdg_val,
							$w_mcp_lot_bas,
							$w_hold_exe_flg,
							$r_mcp_jdghold);
	if($w_rtn != 0) return 4000;

	if($w_hodl_exe_flg == 1){
		return 0;
	}

	#------------------------------------------------------------------
	# SPACE
	#------------------------------------------------------------------
	$w_rtn = main_exe_spc($gw_scr['s_usr_id'],
						$w_spc_err_cd,
						"",
						$w_mcp_lot_bas,
						$w_hold_exe_flg,
						$r_spchold);
	if($w_rtn != 0) return 4000;

	if($w_hold_exe_flg == 1){
		return 0;
	}

	#------------------------------------------------------------------
	# material limit check
	#------------------------------------------------------------------
	$w_rtn = main_exe_mthd($gw_scr['s_usr_id'],
						$w_mcp_lot_bas['STP_CD'],
						$w_exe_mthd, $w_exp, $w_life, $w_thaw);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# IOMV
	#------------------------------------------------------------------
	$w_rtn = main_verb_iomv($gw_scr['s_usr_id'], null, $w_mcp_lot_bas);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# if execute material hold, also device Lot hold
	#------------------------------------------------------------------
	if($w_exe_mthd == 1){
		$w_rtn = main_exe_iohd_by_mthd($w_mcp_lot_bas['LOT_ID'], $w_mcp_lot_bas['UPD_LEV'],
								$w_exp, $w_life, $w_thaw);
		if($w_rtn != 0) return 4000;

		$r_mthd_flg = 1;
	#------------------------------------------------------------------
	# not execute material hold
	#------------------------------------------------------------------
	} else {
		#------------------------------------------------------------------
		# check hold reserve and execute Lot hold
		#------------------------------------------------------------------
		$w_rtn = cs_xexc_hold_rsv($gw_scr['s_usr_id'],
								  $w_mcp_lot_bas,
								  $w_hold_exe_flg,
								  $w_rls_set_day,
								  $w_rsn,
								  $w_infrm);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
		### if execute hold, set the return value
		if($w_hold_exe_flg == 1){
			$holdcnt = 0;
			$holdcnt++;
			$r_holdrsv[$holdcnt] = array
			(
				'LOT_ID'	=> trim($w_lot_bas['LOT_ID']),
				'MSG'		=> sprintf(itm("RsvHoldInfo"), $w_rsn, $w_infrm, $w_rls_set_day)
			);
		}
	}


	return 0;
}

function convert_date($date, &$r_date){
	
	$r_date = "";
        $cur_date = $date;
        $r_date = str_replace("-", "", $cur_date);
        $r_date = str_replace(" ", ".", $r_date);
        $r_date = str_replace(":", "", $r_date);
        $r_date = substr($r_date, 0, -2);
        return 0;

}

#======================================================================
# execution of child Lot
#======================================================================
function main_exe_chld_lot($d, &$r_ioab, &$r_lot_bas)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$r_ioab = array();
	$r_lot_bas = array();

	$w_mcnt = 0;
	$w_arr_lot_bas = array();
	
	// new code	
	$w_rtn = get_sub_lot($gw_scr['s_lot_id'], $w_sub_lot);
        $w_rtn = xgt_lot($w_sub_lot[1], $w_tmp_main_lot_bas);
                
	for($i=1; $i<=$gw_scr['s_'.$d.'_inp_cnt']; $i++){
		if($gw_scr['s_list_'.$d.'_lot_id'][$i]  == "") continue;

		if($gw_scr['s_list_'.$d.'_trt_qty'][$i] == ""
		){
			continue;
		}

		#------------------------------------------------------------------
		# get lot_bas_tbl
		#------------------------------------------------------------------
		$w_rtn = xgt_lot($gw_scr['s_list_'.$d.'_lot_id'][$i], $w_lot_bas);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $gw_scr['s_list_'.$d.'_lot_id'][$i], __LINE__);
			return 4000;
		}
		#------------------------------------------------------------------
		# check upd_lev
		#------------------------------------------------------------------
		$w_rtn = xck_upd($gw_scr['s_list_'.$d.'_upd_lev'][$i], $w_lot_bas['UPD_LEV']);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $gw_scr['s_list_'.$d.'_lot_id'][$i], __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# Re-Check space/equip Hold Info
		#------------------------------------------------------------------
		if($gw_scr['s_list_'.$d.'_spc_equinf'][$i] == ""){
			$w_rtn = chk_spc_equ($gw_scr['s_list_'.$d.'_lot_id'][$i], $w_spc_equinf);
			if($w_rtn != 0) return 4000;
			if($w_spc_equinf != ""){
				list($g_msg, $g_err_lv) = msg("err_Upd_".$w_spc_equinf);
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
		}

		$w_trt_qty = $gw_scr['s_list_'.$d.'_chp_qty'][$i];
		$w_pas_qty = $gw_scr['s_list_'.$d.'_trt_qty'][$i];
		$w_adj_qty = $w_trt_qty - $w_pas_qty;

		#------------------------------------------------------------------
		# IOSP
		#------------------------------------------------------------------
		if($gw_scr['s_list_'.$d.'_hdn_comp_flg'][$i] != "1"
		&& $w_trt_qty > $w_pas_qty
		){
			### if exists ex-Lot and input qty = 1, NOT execute IOSP/IOIN/IOOT
			$spcnt = 1;
			$w_arr_sl_qty[$spcnt]  = $w_lot_bas['SL_QTY'];
			$w_arr_chp_qty[$spcnt] = $gw_scr['s_list_'.$d.'_trt_qty'][$i];
			$w_arr_lf_qty[$spcnt]  = $w_lot_bas['LF_QTY'];
			$w_arr_lot_no[$spcnt]  = $w_lot_bas['LOT_NO'];
			$w_arr_sec_no[$spcnt]  = $w_lot_bas['SECRET_NO'];

			$w_rtn = main_verb_iosp($gw_scr['s_usr_id'],
									$spcnt,
									$w_arr_sl_qty,
									$w_arr_chp_qty,
									$w_arr_lf_qty,
									$w_arr_lot_no,
									$w_arr_sec_no,
									$w_lot_bas,
									$w_new_lot_id,
									$w_new_upd_lev);
			if($w_rtn != 0) return 4000;

			### inherit lot_inf_tbl
			$w_rtn = inhrt_lotinf4sp($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								$w_new_lot_id[1]);
			if($w_rtn != 0) return 4000;

			# Ensure PO CTG_CD is inherited to child.
        		$w_rtn = cs_xgt_inhrt_po_data($gw_scr['s_usr_id'],$w_lot_bas, $w_new_lot_id);
		        if ($w_rtn != 0) {
	                   db_rollback();
	                   $g_err_lv = 0;
	                   $g_msg  = xpt_err_msg($g_msg, $w_rtn, __LINE__);
	                   return 4000;
        		}

			### get lot_bas_tbl about new Lot
			$w_lot_bas = array();
			$w_rtn = xgt_lot($w_new_lot_id[1], $w_lot_bas);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, $w_new_lot_id[1], __LINE__);
				return 4000;
			}
		}

		// new code
		if($gw_scr['s_list_'.$d.'_lot_id'][$i] != "" & trim($gw_scr['s_list_'.$d.'_lot_id'][$i]) != trim($w_sub_lot[1])) {
                        # RTCG
                        if(trim($w_lot_bas['PRD_CD']) == trim($w_tmp_main_lot_bas['PRD_CD']) && $w_lot_bas['RT_CD'] != trim($w_tmp_main_lot_bas['RT_CD'])){

                                $w_rtn = rtcg_st_check(trim($w_tmp_main_lot_bas['RT_CD']), $w_lot_bas);
                                if ($w_rtn != 0) {
                                        $g_err_lv = 0;
                                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                        return $w_rtn;
                                }

                                $w_rtn = rtcg(
                                                trim($w_lot_bas['LOT_ID']),
                                                $gw_scr['s_usr_id'],
                                                $w_lot_bas['UPD_LEV'],
                                                "",
                                                trim($w_tmp_main_lot_bas['RT_CD']),
                                                $w_lot_bas);
                                if ($w_rtn != 0) {
                                                $g_err_lv = 0;
                                                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                                return $w_rtn;
                                }
                        }
			$w_rtn = check_lot_is_valid($w_tmp_main_lot_bas, $w_lot_bas, $w_status);

                        if($w_status == false){
                                list($g_msg, $g_err_lv) = msg("err_not_valid_lot");
                                $g_msg = xpt_err_msg($g_msg, $gw_scr['s_list_'.$d.'_lot_id'][$i], __LINE__);
                                return 4000;
                        }
		}

		#------------------------------------------------------------------
		# IOIN
		#------------------------------------------------------------------
		if($w_lot_bas['LOT_ST_DVS'] == "WT"){
			$w_rtn = main_verb_ioin($gw_scr['s_usr_id'],
									$gw_scr['s_equ_cd'],
									null,
									$w_lot_bas);
			if($w_rtn != 0) return 4000;
		}

		#------------------------------------------------------------------
		# IOOT prep
		#------------------------------------------------------------------
		$w_arr_ctg_dvs  = array();
		$w_arr_ctg_cd   = array();
		$w_arr_ctg_qty  = array();
		$w_arr_ctg_txt  = array();
		$w_arr_ctg_slid = array();
		$w_arr_jdg_cd   = array();
		$w_arr_jdg_val  = array();
		$ctgcnt = 0;


	        ### if filled Adj Qty
        	if($gw_scr['s_list_'.$d.'_adj_qty'][$i] != ""
        	&& $gw_scr['s_list_'.$d.'_adj_qty'][$i] != "0"
        	){
                	$w_chk_chp_qty = $gw_scr['s_list_'.$d.'_chp_qty'][$i];
                	$w_chk_trt_qty = $gw_scr['s_list_'.$d.'_trt_qty'][$i];
                	$w_chk_adj_qty = $gw_scr['s_list_'.$d.'_adj_qty'][$i];
                	if(abs($w_chk_chp_qty - $w_chk_trt_qty) != $w_chk_adj_qty){
                        	list($g_msg, $g_err_lv) = msg("err_Dis_StkAdjInp");
                        	$g_msg = xpt_err_msg($g_msg, $gw_scr['s_list_'.$d.'_lot_id'][$i], __LINE__);
                        	return 4000;
                	}
                	$ctgcnt++;
                	$w_arr_ctg_dvs[$ctgcnt]  = constant("CE_CHP_BAD");
                	$w_arr_ctg_cd[$ctgcnt]   = constant("CT_ADJ");
                	$w_arr_ctg_qty[$ctgcnt]  = ($w_chk_chp_qty - $w_chk_trt_qty);
                	$w_arr_ctg_txt[$ctgcnt]  = null;
                	$w_arr_ctg_slid[$ctgcnt] = " ";
        	}

                #------------------------------------------------------------------
                # IOOT
                #------------------------------------------------------------------
                $w_rtn = main_verb_ioot($gw_scr['s_usr_id'],
                                                                $w_arr_ctg_dvs,
                                                                $w_arr_ctg_cd,
                                                                $w_arr_ctg_qty,
                                                                $w_arr_ctg_txt,
                                                                $w_arr_ctg_slid,
                                                                $w_lot_bas['SL_QTY'],
                                                                $w_pas_qty,
                                                                $w_lot_bas['LF_QTY'],
                                                                null,
                                                                $w_lot_bas);
                if($w_rtn != 0) return 4000;


	        #------------------------------------------------------------------
        	#
        	#------------------------------------------------------------------
        	if($w_pas_qty == 0){
                	$w_rtn = main_verb_ioab($gw_scr['s_usr_id'],
                                                                null,
                                                                $w_lot_bas);
                	if($w_rtn != 0) return 4000;

                	$r_ioab[] = trim($w_lot_bas['LOT_ID']);

                        ### next loop
                	continue;
        	}

        	#------------------------------------------------------------------
        	# IOMV
        	#------------------------------------------------------------------
        	$w_rtn = main_verb_iomv($gw_scr['s_usr_id'], null, $w_lot_bas);
        	if($w_rtn != 0) return 4000;

                $w_mgcnt++;
                $w_arr_lot_bas[$w_mgcnt] = $w_lot_bas;

	}


        #------------------------------------------------------------------
        # IOMG
        #------------------------------------------------------------------
        if($w_mgcnt >= 2){
                for($i=1; $i<=$w_mgcnt; $i++){
                        $w_arr_mg_lot['lot_id'][$i]     = $w_arr_lot_bas[$i]['LOT_ID'];
                        $w_arr_mg_lot['lot_no'][$i]     = $w_arr_lot_bas[$i]['LOT_NO'];
                        $w_arr_mg_lot['lot_no_str'][$i] = $w_arr_lot_bas[$i]['LOT_NO_STR'];
                        $w_arr_mg_lot['lot_st_dvs'][$i] = $w_arr_lot_bas[$i]['LOT_ST_DVS'];
                        $w_arr_mg_lot['chp_qty'][$i]    = $w_arr_lot_bas[$i]['CHP_QTY'];
                        $w_arr_mg_lot['lf_qty'][$i]     = 0;
                        $w_arr_mg_lot['secret_no'][$i]  = $w_arr_lot_bas[$i]['SECRET_NO'];
                        $w_arr_mg_lot['sl_qty'][$i]     = $w_arr_lot_bas[$i]['SL_QTY'];
                        $w_arr_mg_lot['cmt'][$i]        = null;
                        $w_arr_mg_lot['upd_lev'][$i]    = $w_arr_lot_bas[$i]['UPD_LEV'];
                }

                $w_mg_lot_bas = $w_arr_lot_bas[1];
                $w_rtn = main_verb_iomg($gw_scr['s_usr_id'],
                                                                $w_arr_mg_lot,
                                                                $w_mg_lot_bas);
                if($w_rtn != 0) return 4000;

                ### inherit lot_inf_tbl
                $w_rtn = inhrt_lotinf4mg($gw_scr['s_usr_id'],
                                                                $w_arr_mg_lot['lot_id']);
                if($w_rtn != 0) return 4000;

                $w_lot_bas = $w_mg_lot_bas;
        } else {
                $w_lot_bas = $w_arr_lot_bas[1];
        }

	#------------------------------------------------------------------
	# 1秒加算
       	#------------------------------------------------------------------
	sleep(1);
	xpt_1sec_dts();

        #------------------------------------------------------------------
        # IOIN
        #------------------------------------------------------------------
        if($w_lot_bas['LOT_ST_DVS'] == "WT"){
               	$w_rtn = main_verb_ioin($gw_scr['s_usr_id'],
                                                $gw_scr['s_equ_cd'],
                                                null,
                                                $w_lot_bas);
                if($w_rtn != 0) return 4000;
        }


	if($w_pas_qty < 0){
		list($g_msg, $g_err_lv) = msg("err_Unexpected");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

        #------------------------------------------------------------------
        # IOOT prep
        #------------------------------------------------------------------
        $w_arr_ctg_dvs  = array();
        $w_arr_ctg_cd   = array();
        $w_arr_ctg_qty  = array();
        $w_arr_ctg_txt  = array();
        $w_arr_ctg_slid = array();
        $w_arr_jdg_cd   = array();
        $w_arr_jdg_val  = array();
        $ctgcnt = 0;

	#------------------------------------------------------------------
	# IOOT
	#------------------------------------------------------------------
	$w_rtn = main_verb_ioot($gw_scr['s_usr_id'],
						$w_arr_ctg_dvs,
						$w_arr_ctg_cd,
						$w_arr_ctg_qty,
						$w_arr_ctg_txt,
						$w_arr_ctg_slid,
						$w_lot_bas['SL_QTY'],
						$w_lot_bas['CHP_QTY'],
						$w_lot_bas['LF_QTY'],
						null,
						$w_lot_bas);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# IOMV
	#------------------------------------------------------------------
	$w_rtn = main_verb_iomv($gw_scr['s_usr_id'], null, $w_lot_bas);
	if($w_rtn != 0) return 4000;


	$r_lot_bas = $w_lot_bas;

	return 0;
}

#==================================================================
#  check lot is valid
#==================================================================
function check_lot_is_valid($w_main_lot_bas, $w_lot_bas, &$r_data)
{
        global $g_msg;
        global $g_err_lv;

        $r_data = false;

        if(trim($w_main_lot_bas['PRD_CD']) == trim($w_lot_bas['PRD_CD']) &&
                 trim($w_main_lot_bas['PRC_CD']) == trim($w_lot_bas['PRC_CD']) &&
                 trim($w_main_lot_bas['RT_CD'])  == trim($w_lot_bas['RT_CD']) &&
                 trim($w_main_lot_bas['STP_CD']) == trim($w_lot_bas['STP_CD'])){

                 $r_data = true;

        }

        return 0;
}



#======================================================================
# execution of Main Lot
#======================================================================
function main_exe_m_lot($d, &$r_ioab, &$r_lot_bas)
{
        global $gw_scr;
        global $g_msg;
        global $g_err_lv;

        $r_ioab = array();
        $r_lot_bas = array();


        #------------------------------------------------------------------
        # get LOT_BAS_TBL
        #------------------------------------------------------------------
        $w_rtn = xgt_lot($gw_scr['s_lot_id'], $w_lot_bas);
        if($w_rtn != 0){
                $g_err_lv = 0;
                $g_msg = xpt_err_msg($g_msg, $gw_scr['s_lot_id'], __LINE__);
                return 4000;
        }

        #------------------------------------------------------------------
        # IOOT
        #------------------------------------------------------------------
        $w_rtn = main_verb_ioot($gw_scr['s_usr_id'],
                                                          $w_arr_ctg_dvs,
                                                          $w_arr_ctg_cd,
                                                          $w_arr_ctg_qty,
                                                          $w_arr_ctg_txt,
                                                          $w_arr_ctg_slid,
                                                          $w_lot_bas['SL_QTY'],
                                                          $w_lot_bas['CHP_QTY'],
                                                          $w_lot_bas['LF_QTY'],
                                                          null,
                                                          $w_lot_bas);
        if($w_rtn != 0) return 4000;

        #------------------------------------------------------------------
        # delete ex-Lot inf
        #------------------------------------------------------------------
        $w_rtn = upd_lotinf($gw_scr['s_usr_id'],
                                                          $gw_scr['s_lot_id'],
                                                          constant("CE_LTINF"),
                                                          constant("CT_SUBSTRATE"),
                                                          " ",
                                                          "IOOT"
                                                          );
        if($w_rtn != 0) return 4000;
        #------------------------------------------------------------------
        # delete Main-Lot inf / sub-Lot inf / Product after merge
        #------------------------------------------------------------------
        ### Main-Lot inf
        $w_rtn = upd_ctgtbl($gw_scr['s_usr_id'],
                                                          $gw_scr['s_lot_id'],
                                                          constant("CE_LTINF"),
                                                          constant("CT_MAINLOT"),
                                                          " ", 1);
        if($w_rtn != 0) return 4000;

        ### sub-Lot inf
        $w_rtn = upd_ctgtbl($gw_scr['s_usr_id'],
                                                          $gw_scr['s_lot_id'],
                                                          constant("CE_LTINF"),
                                                          constant("CT_SUBLOT"),
                                                          " ", 1);
        if($w_rtn != 0) return 4000;

        ### Product af merge
        $w_rtn = upd_ctgtbl($gw_scr['s_usr_id'],
                                                          $gw_scr['s_lot_id'],
                                                          constant("CE_LTINF"),
                                                          constant("CT_PRDFIN"),
                                                          " ");
        if($w_rtn != 0) return 4000;

        #------------------------------------------------------------------
        # IOAB (Lot Close due to all reject)
        #------------------------------------------------------------------
        if($w_lot_bas['CHP_QTY'] == 0){
                 $w_rtn = main_verb_ioab($gw_scr['s_usr_id'],
                                                          null,
                                                          $w_lot_bas);
                  if($w_rtn != 0) return 4000;

                  $r_ioab[] = trim($w_lot_bas['LOT_ID']);

                  ### next loop
                  continue;
        }

        #------------------------------------------------------------------
        # IOMV
        #------------------------------------------------------------------
        $w_rtn = main_verb_iomv($gw_scr['s_usr_id'], null, $w_lot_bas);
        if($w_rtn != 0) return 4000;


        $r_lot_bas = $w_lot_bas;

        return 0;
}

#======================================================================
# check use material(available time, expiration time, thawing time)
#======================================================================
function main_exe_chkmat($w_lot_bas,&$r_is_hold)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	
	$r_is_hold = 0;
	
	$w_mcnt      = get_session_value('s_mat_cnt', constant("PGM_MTMNG"));
	$w_prt_cd    = get_session_value('s_list_prt_cd', constant("PGM_MTMNG"));
	$w_mt_lot_id = get_session_value('s_list_mt_lot_id', constant("PGM_MTMNG"));

	### error if no input
	if($w_mcnt == 0){
		list($g_msg, $g_err_lv) = msg("err_Inp_MatMng");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	
	$w_exe_hold_msg=array();
	
	for($i=1; $i<=$w_mcnt; $i++){
		$w_rtn = cs_xck_prt_time($w_prt_cd[$i],
								$w_mt_lot_id[$i],
								$gw_scr['s_nxt_shp_cd'],
								$w_thaw_dts,
								$w_life_dts,
								$w_exp_dts);		
		if($w_rtn != 0){
			return 4000;
		}

		$w_exp_rslt = 0;
		$w_life_rslt = 0;
		### check expiration
		if($w_exp_dts != ""){
			chk_exp_time($w_exp_dts, $w_exp_rslt);
			if($w_exp_rslt == 1){
				$w_hold_cmt = constant("CMT_EXP");
				#------------------------------------------------------------------
				# MTHD
				#------------------------------------------------------------------
				$w_rtn = main_verb_mthd($gw_scr['s_usr_id'],
										$w_prt_cd[$i],
										$gw_scr['s_nxt_shp_cd'],
										$gw_scr['s_equ_cd'],
										$w_mt_lot_id[$i],
										$w_hold_cmt);
				if($w_rtn != 0){
					return 4000;
				}				
				list($w_msg, $w_err_lv) = msg("warn_Hold_ExpTime");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_mt_lot_id[$i], $w_exp_dts);
				$w_exe_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
		}
		### check available
		if($w_life_dts != ""){
			chk_life_time($w_life_dts, $w_life_rslt);
			if ($w_exp_rslt == 0 && $w_life_rslt == 1) {
				$w_hold_cmt = constant("CMT_LIFE");
				#------------------------------------------------------------------
				# MTHD
				#------------------------------------------------------------------
				$w_rtn = main_verb_mthd($gw_scr['s_usr_id'],
										$w_prt_cd[$i],
										$gw_scr['s_nxt_shp_cd'],
										$gw_scr['s_equ_cd'],
										$w_mt_lot_id[$i],
										$w_hold_cmt);
				if($w_rtn != 0){
					return 4000;
				}
				list($w_msg, $w_err_lv) = msg("warn_Hold_LifeTime");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_mt_lot_id[$i], $w_life_dts);
				$w_exe_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);				
			}
		}
		### check thawing time
		if($w_thaw_dts != ""){
			$w_rtn = chk_thaw_time($w_prt_cd[$i],
									$w_mt_lot_id[$i],
									$gw_scr['s_equ_cd'],
									$w_thaw_dts);
			if($w_rtn != 0){
				return 4000;
			}
		}
	}
	if (count($w_exe_hold_msg) > 0) {
		$r_is_hold = 1;
		$g_err_lv = 3;
		$g_msg = xpt_err_msg(implode("<br>", $w_exe_hold_msg), "", "");
	}
	
	return 0;
}
#======================================================================
# execution of using materials
#======================================================================
function main_exe_usemat($w_lot_id, $w_stp_cd, $w_prd_cd, $w_noexe = null) {
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_mcnt      = get_session_value('s_max_rows',       constant("PGM_MTMNG"));
	$w_prt_cd    = get_session_value('s_list_prt_cd',    constant("PGM_MTMNG"));
	$w_mt_lot_id = get_session_value('s_list_mt_lot_id', constant("PGM_MTMNG"));
	$w_use_qty   = get_session_value('s_list_use_qty',   constant("PGM_MTMNG"));

	$w_mtcs_flg = 0;
	for ($m = 1; $m <= $w_mcnt; $m++) {
		if ($w_prt_cd[$m]  == "") continue;
		if ($w_use_qty[$m] == "") continue;


                #---------------------------
                # get shop code
                #---------------------------
                $w_rtn = xgt_stp($w_stp_cd, $w_shp_cd);
                if ($w_rtn != 0) {
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return $w_rtn;
                }


                $w_rtn = get_prt_mst($w_prt_cd[$m],$w_prt_mst);
                if($w_rtn != 0){
                         $g_err_lv = 0;
                         $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                         return $w_rtn;
                }

		#------------------------------------------------------------------
	        # NEW: get division by main flag
        	#------------------------------------------------------------------
	        $w_rtn = xgt_dvsn($w_dvsn_cd, $w_fct_cd, $w_rdg_cd);
        	if($w_rtn != 0){
	                $g_err_lv = 0;
                	$g_msg = xpt_err_msg($g_msg, "", __LINE__);
        	        return 4000;
	        }

		$w_rtn = get_prt_inf($w_prt_cd[$m], constant("AW_MTL_CONSUMPTION"),$w_dvsn_cd,$w_prt_inf_mst);
                if ($w_rtn != 0) {
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
                }

                if($w_prt_mst['PRT_DVS'] == 'AT') {
                        $w_rtn = xgt_prt_wip2($w_prt_cd[$m],
                                                        trim($w_shp_cd),
                                                        "",
                                                        $w_mt_lot_id[$m],
                                                        $w_prt_wip);
                        if($w_rtn != 0){
                                $g_err_lv = 0;
                                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                return $w_rtn;
                        }

                } else {

                        #------------------------------------------------------------------
                        # get parts WIP info
                        #------------------------------------------------------------------
                        $w_rtn = xgt_prt_wip($w_prt_cd[$m], $w_shp_cd, "", $w_mt_lot_id[$m],
                                $w_prt_wip);
                        if ($w_rtn != 0) {
                                $g_err_lv = 0;
                                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                return 4000;
                        }
                }
/*
		#---------------------------
		# get shop code
		#---------------------------
		$w_rtn = xgt_stp($w_stp_cd, $w_shp_cd);
		if ($w_rtn != 0) {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return $w_rtn;
		}

		#------------------------------------------------------------------
		# get parts WIP info
		#------------------------------------------------------------------
		$w_rtn = xgt_prt_wip($w_prt_cd[$m], $w_shp_cd, "", $w_mt_lot_id[$m],
				$w_prt_wip);
		if ($w_rtn != 0) {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
*/
		if(is_null($w_noexe) && $w_prt_inf_mst['NUM'] != 1){
			$w_rtn = main_verb_mtcs($w_lot_id, $w_prt_cd[$m], $w_stp_cd, "",
					$w_prd_cd, $w_use_qty[$m], $w_prt_wip);
			if ($w_rtn != 0) {
				return 4000;
			}
		}

		$w_mtcs_flg = 1;
	} # end for

	# abend if no input
	if ($w_mtcs_flg == 0) {
		list($g_msg, $g_err_lv) = msg("err_Inp_Mtcs");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# get prt_information
#==================================================================
function get_prt_inf($w_prt_cd, $w_aw_cd, $w_dvsn, &$r_dat)
{
        global $g_msg;
        global $g_err_lv;

        $r_dat  = array();

        $w_sql = <<<_SQL
SELECT
        TXT_DAT,
        NUM_DAT
FROM
        PRT_INF_MST
WHERE
        PRT_CD = '{$w_prt_cd}'
        AND DAT_CD = '{$w_aw_cd}'
        AND DVSN_CD = '{$w_dvsn}'
        AND DEL_FLG = '0'
_SQL;

        $w_stmt = db_res_set($w_sql);
        $w_rtn = db_do($w_stmt);
        if($w_rtn != 0){
                list($g_msg, $g_err_lv) = msg("err_Sel");
                $g_msg = xpt_err_msg($g_msg, "PRT_INF_MST", __LINE__);
                return 4000;
        }

        $cnt = 0;
        while($w_row = db_fetch_row($w_stmt)){
                $cnt++;
                $r_dat["TXT"] = trim($w_row['TXT_DAT']);
                $r_dat["NUM"] = trim($w_row['NUM_DAT']);
        }

        return 0;
}

function get_prt_mst($w_prt_cd, &$r_prt_wip) {
        global $g_msg;

        $w_sql = "SELECT "
                        .       "* "
                        . "FROM "
                        .       "PRT_BAS_MST "
                        . "WHERE "
                        .       "PRT_CD = '" . $w_prt_cd . "' "
                        .       " AND DEL_FLG = '0' ";
        $w_stmt = db_res_set($w_sql);
        $w_rtn = db_do($w_stmt);
        if($w_rtn != 0){
                $g_msg = xgt_prt_wip_msg("error_1");
                return $w_rtn;
        }

        $r_prt_wip = db_fetch_row($w_stmt);

        if(!$r_prt_wip){
                db_res_free($w_stmt);
                $g_msg = xgt_prt_wip_msg("error_2");
                return 4000;
        }

        db_res_free($w_stmt);

        return 0;
}


function xgt_prt_wip2($w_prt_cd, $w_shp_cd, $w_equ_cd, $w_mt_lot_id, &$r_prt_wip) {
        global $g_msg;

        if($w_equ_cd == ""){
                $w_equ_cd = " ";
        }
        if($w_mt_lot_id == ""){
                $w_mt_lot_id = " ";
        }

        $w_sql = "SELECT "
                        .       "* "
                        . "FROM "
                        .       "PRT_WIP_TBL "
                        . "WHERE "
                        .       "PRT_CD = '" . $w_prt_cd . "' "
                        .       "AND PRT_ST_DVS = 'WT'  "
                        .       "AND EQU_CD = '" . $w_equ_cd . "' "
                        .       "AND MT_LOT_ID = '" . $w_mt_lot_id . "' ";

        $w_stmt = db_res_set($w_sql);
        $w_rtn = db_do($w_stmt);
        if($w_rtn != 0){
                $g_msg = xgt_prt_wip_msg("error_1");
                return $w_rtn;
        }

        $r_prt_wip = db_fetch_row($w_stmt);

        if(!$r_prt_wip){
                db_res_free($w_stmt);
                $g_msg = xgt_prt_wip_msg("error_2");
                return 4000;
        }

        db_res_free($w_stmt);

        return 0;
}


#=========================================================================
# check expiration time
#=========================================================================
function chk_exp_time($w_exp_dts, &$r_rslt)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	$r_rslt = 0;

	# expiration time convert to sec
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $w_exp_dts);
	$w_exp_time = mktime($h,$i,$s,$m,$d,$y);

	# current time convert to sec
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $g_cpu_dts);
	$w_cpu_time = mktime($h,$i,$s,$m,$d,$y);

	# if expirtaion time < current time
	if($w_exp_time < $w_cpu_time){
		$r_rslt = 1;
	} else {
		# show warning if expiration time minus alerting remaining time < current time
		$w_remain_time = $w_exp_time - (constant("RMN_H_EXP") * 60 * 60);
		if($w_remain_time < $w_cpu_time){
			$r_rslt = 2;
		}
	}
	return 0;
}
#=========================================================================
# check available time
#=========================================================================
function chk_life_time($w_life_dts, &$r_rslt)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	$r_rslt = 0;

	# available time convert to sec
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $w_life_dts);
	$w_life_time = mktime($h,$i,$s,$m,$d,$y);

	# current time convert to sec
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $g_cpu_dts);
	$w_cpu_time = mktime($h,$i,$s,$m,$d,$y);

	# if available time < current time
	if($w_life_time < $w_cpu_time){
		$r_rslt = 1;
	} else {
		# show warning if available time minus alrting remaining time < current time
		$w_remain_time = $w_life_time - (constant("RMN_H_LIFE") * 60 * 60);
		if($w_remain_time < $w_cpu_time){
			$r_rslt = 2;
		}
	}

	return 0;
}
#=========================================================================
# check thawing time
#=========================================================================
function chk_thaw_time($w_prt_cd, $w_mt_lot_id, $w_equ_cd, $w_thaw_dts)
{
	global $g_msg;
	global $g_err_lv;

	# thawing time convert to sec
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $w_thaw_dts);
	$w_thaw_time = mktime($h,$i,$s,$m,$d,$y);

	#----------------------------------------------
	# get charging start time
	#----------------------------------------------
	$w_sql = <<<_SQL
SELECT
	CRT_DTS AS CHRG_DTS
FROM
	EQU_PRT_TBL
WHERE
	MT_LOT_ID = '{$w_mt_lot_id}'
	AND EQU_CD = '{$w_equ_cd}'
	AND PRT_CD = '{$w_prt_cd}'
	AND NO_USE_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "EQU_PRT_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	# error if no charge
	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_Equ_NoCharge");
		$g_msg = xpt_err_msg($g_msg, $w_mt_lot_id, __LINE__);
		return 4000;
	}

	$w_chrg_dts = $w_row['CHRG_DTS'];
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $w_chrg_dts);
	$w_chrg_time = mktime($h,$i,$s,$m,$d,$y);

	# error if charging start time < thawing time
	if($w_chrg_time < $w_thaw_time){
		list($g_msg, $g_err_lv) = msg("err_Ovr_ChrgThaw");
		$w_srch = array("%MTLOTID%", "%TIME%");
		$w_rplc = array($w_mt_lot_id, $w_thaw_dts);
		$g_msg = str_replace($w_srch, $w_rplc, $g_msg);
		return 4000;
	}

	return 0;
}

#==================================================================
# get ex-LotID
#==================================================================
function get_ex_lotid($w_lot_id, &$r_ex_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	$r_ex_lot_id = "";
	$w_ctgdvs    = constant("CE_LTINF");
	$w_ctgcd     = constant("CT_EXLOTID");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if($w_row){
		$r_ex_lot_id = trim($w_row['CTG_DAT_TXT']);
	}

	return 0;
}

#==================================================================
# get reserve Main-lot
#==================================================================
function get_rsv_mlot($w_lot_id, &$r_arr_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	$r_arr_lot_id = array();
	$w_ctgdvs = constant("CE_LTINF");
	$w_ctgcd  = constant("CT_MAINLOT");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	CTG_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
ORDER BY
	CTG_DAT_TXT
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	$cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$r_arr_lot_id[$cnt] = trim($w_row['CTG_DAT_TXT']);
	}
	db_res_free($w_stmt);

	return 0;
}


#==================================================================
# get after Multi-Merge Type Code/Name
#==================================================================
function get_aft_prd($w_lot_id, &$r_prd_cd_fin, &$r_prd_nm_fin)
{
	global $g_msg;
	global $g_err_lv;

	$r_prd_cd_fin = "";
	$r_prd_nm_fin = "";
	$w_ctgdvs = constant("CE_LTINF");
	$w_ctgcd  = constant("CT_PRDFIN");

	$w_sql = <<<_SQL
SELECT
	CTG.CTG_DAT_TXT AS PRD_CD,
	PRD.PRD_NM AS PRD_NM
FROM
	CTG_TBL CTG,
	PRD_MST PRD
WHERE
	CTG.LOT_ID = '{$w_lot_id}'
	AND CTG.CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG.CTG_CD = '{$w_ctgcd}'
	AND CTG.DEL_FLG = '0'
	AND PRD.PRD_CD = CTG.CTG_DAT_TXT
	AND PRD.DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_Get_AftPrd");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$r_prd_cd_fin = trim($w_row['PRD_CD']);
	$r_prd_nm_fin = trim($w_row['PRD_NM']);

	return 0;
}

#==================================================================
# get sub-Lot
#==================================================================
function get_sub_lot($w_lot_id, &$r_arr_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	$r_arr_lot_id = array();
	$w_ctgdvs = constant("CE_LTINF");
	$w_ctgcd  = constant("CT_SUBLOT");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	CTG_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
ORDER BY
	CTG_DAT_TXT
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	$cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$r_arr_lot_id[$cnt] = trim($w_row['CTG_DAT_TXT']);
	}
	db_res_free($w_stmt);

	if($cnt == 0){
		list($g_msg, $g_err_lv) = msg("err_Get_SubLot");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# get prd_inf_mst
#==================================================================
function get_prdinf($w_prd_cd, $w_dat_cd, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	*
FROM
	PRD_INF_MST
WHERE
	PRD_CD = '{$w_prd_cd}'
	AND DAT_CD = '{$w_dat_cd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRD_INF_MST", __LINE__);
		return 4000;
	}

	$r_dat = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	return 0;

}

#==================================================================
# VERB::IOIN
#==================================================================
function main_verb_ioin($w_usr_id, $w_equ_cd, $w_cmt, &$w_lot_bas)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# check Lot state
	#------------------------------------------------------------------
	$w_rtn = ioin_st_check($w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	if($w_equ_cd == ""){
		#------------------------------------------------------------------
		# get usable equ_cd
		#------------------------------------------------------------------
		$w_rtn = xgt_use_equ($w_lot_bas, $w_equ_cd);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	#------------------------------------------------------------------
	# check equ_cd
	#------------------------------------------------------------------
	$w_rtn = ioin_equ_check($w_equ_cd, $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# IOIN
	#------------------------------------------------------------------
	$w_rtn = ioin($w_lot_bas['LOT_ID'],
				  $w_usr_id,
				  $w_lot_bas['UPD_LEV'],
				  $w_equ_cd,
				  $w_cmt,
				  $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::IOSP
#==================================================================
function main_verb_iosp($w_usr_id,
						$w_array_cnt,
						$w_arr_sl_qty,
						$w_arr_chp_qty,
						$w_arr_lf_qty,
						$w_arr_lot_no,
						$w_arr_secret_no,
						&$w_lot_bas,
						&$r_new_lot_id,
						&$r_new_upd_lev)
{
	global $g_msg;
	global $g_err_lv;

	$w_rtn = iosp_st_check($w_lot_bas['LOT_ST_DVS']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$w_cmt = "";

	for($i=1; $i<=$w_array_cnt; $i++){
		$w_sp_sl_qty[$i]    = $w_arr_sl_qty[$i];
		$w_sp_chp_qty[$i]   = $w_arr_chp_qty[$i];
		$w_sp_lf_qty[$i]    = $w_arr_lf_qty[$i];
		$w_sp_lot_no[$i]    = $w_arr_lot_no[$i];
		$w_sp_secret_no[$i] = $w_arr_secret_no[$i];
		$w_sp_cmt[$i]       = $w_cmt;
	}

	$w_rtn = iosp(
				$w_usr_id,
				$w_lot_bas['LOT_ID'],
				$w_lot_bas['UPD_LEV'],
				$w_cmt,
				$w_lot_bas['LOT_NO'],
				$w_array_cnt,
				$w_sp_sl_qty,
				$w_sp_chp_qty,
				$w_sp_lf_qty,
				$w_sp_lot_no,
				$w_sp_secret_no,
				$w_sp_cmt,
				$w_new_lot_id,
				$w_new_del_flg,
				$w_new_upd_lev,
				$w_lot_bas
				);

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, '', __LINE__);
		return 4000;
	}

	$r_new_lot_id  = $w_new_lot_id;
	$r_new_upd_lev = $w_new_upd_lev;

	return 0;
}

#==================================================================
# VERB::IOMG
#==================================================================
function main_verb_iomg($w_usr_id, $w_arr_mg_lot, &$w_lot_bas) {
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# calc after merge
	#------------------------------------------------------------------
	$w_sum_sl_qty = array_sum($w_arr_mg_lot['sl_qty']);
	$w_sum_chp_qty = array_sum($w_arr_mg_lot['chp_qty']);
	$w_sum_lf_qty = array_sum($w_arr_mg_lot['lf_qty']);

	$w_array_cnt = count($w_arr_mg_lot['lot_id']);

	#------------------------------------------------------------------
	# check Lot state
	#------------------------------------------------------------------
	for ($i = 1; $i <= $w_array_cnt; $i++) {
		if ($w_arr_mg_lot['lot_id'][$i] == "") {
			continue;
		}
		$w_rtn = iomg_st_check($w_arr_mg_lot['lot_st_dvs'][$i]);
		if ($w_rtn != 0) {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	#------------------------------------------------------------------
	# IOMG
	#------------------------------------------------------------------
	$w_rtn = iomg($w_usr_id, $w_sum_sl_qty, $w_sum_chp_qty, $w_sum_lf_qty,
			$w_arr_mg_lot['lot_no_str'][1], $w_arr_mg_lot['lot_no'][1],
			$w_arr_mg_lot['secret_no'][1], $w_array_cnt,
			$w_arr_mg_lot['lot_id'], $w_arr_mg_lot['upd_lev'],
			$w_arr_mg_lot['cmt'], $w_lot_bas);

	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::IOOT
#==================================================================
function main_verb_ioot($w_usr_id, $w_ctg_dvs_cd, $w_ctg_cd,
						$w_ctg_qty, $w_ctg_dat_txt, $w_ctg_slid, $w_sl_qty_ok,
						$w_chp_qty_ok, $w_lf_qty_ok, $w_cmt, &$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# check Lot state
	#------------------------------------------------------------------
	$w_rtn = ioot_st_check($w_lot_bas['LOT_ST_DVS']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check last io block
	# return:	$w_lot_st_dvs	lot state division
	#			$w_io_blc_cd	io block code
	#			$w_stp_cd		step code
	#			$w_stp_no		step no
	#------------------------------------------------------------------
	$w_rtn = xck_lio(
					$w_lot_bas['PRC_CD'],
					$w_lot_bas['IO_BLC_CD'],
					$w_lot_bas['PLT_DVS_CD'],
					$w_lot_st_dvs,
					$w_io_blc_cd,
					$w_stp_cd,
					$w_stp_no);

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, '', __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# set registration details into CTG_LOG
	#------------------------------------------------------------------
	$w_ctg_flg = 0;
	if(is_array($w_ctg_cd)){
		for($i=1; $i<=count($w_ctg_cd); $i++){
			$w_arr_cnt = $i;
			$w_arr_ctg_dvs_cd[$i] = $w_ctg_dvs_cd[$i];
			$w_arr_ctg_cd[$i]     = $w_ctg_cd[$i];
			$w_arr_txt[$i]        = $w_ctg_dat_txt[$i];
			$w_arr_equ_cd[$i]     = $w_lot_bas['EQU_CD'];
			$w_arr_sl_id[$i]      = $w_ctg_slid[$i];
			$w_arr_qty[$i]        = $w_ctg_qty[$i];
		}
		$w_ctg_flg = 1;
	}

	if($w_ctg_flg == 0){
		$w_arr_cnt = 0;
		$w_arr_ctg_dvs_cd = '';
		$w_arr_ctg_cd     = '';
		$w_arr_equ_cd     = '';
		$w_arr_sl_id      = '';
		$w_arr_qty        = '';
		$w_arr_txt        = '';
	}

	#------------------------------------------------------------------
	# IOOT
	#------------------------------------------------------------------
	$w_rtn = ioot(
				$w_lot_bas['LOT_ID'],			# Lot ID
				$w_usr_id,						# User ID
				$w_lot_bas['UPD_LEV'],			# Update lev
				$w_cmt,							# Comment
				$w_lot_st_dvs,					# Lot state division
				$w_sl_qty_ok,					# pass slice qty
				$w_chp_qty_ok,					# pass chip qty
				$w_lf_qty_ok,					# pass lf qty
				$w_lot_bas['SECRET_NO'],		# date code
				$w_arr_cnt,						# category count
				$w_arr_ctg_dvs_cd,				# (array)category division code
				$w_arr_ctg_cd,					# (array)category code
				$w_arr_equ_cd,					# (array)equ_cd for ctg_log
				$w_arr_sl_id,					# (array)slice ID for ctg_log
				$w_arr_qty,						# category qty
				$w_arr_txt,						# category text
				$w_lot_bas);					# [return]lot_bas_tbl

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, '', __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::Next Step Transfer(IOMV or PRPT/PRPC/PRGT)
#==================================================================
function main_verb_iomv($w_usr_id, $w_cmt, &$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	switch($w_lot_bas['LOT_ST_DVS']){
	case "OW":
		#------------------------------------------------------------------
		# get next io block
		#------------------------------------------------------------------
		$w_rtn = xgt_nio(
						$w_lot_bas['PRC_CD'],
						$w_lot_bas['IO_BLC_CD'],
						$w_lot_bas['STP_NO'],
						$w_lot_bas['PLT_DVS_CD'],
						$w_io_blc_cd,				# [return]next io block code
						$w_stp_cd,					# [return]next step code
						$w_stp_no);					# [return]next step no


		$w_nxt_verb = "IOMV";

		break;
	case "EW":
		#------------------------------------------------------------------
		# get next process
		#------------------------------------------------------------------
		$w_rtn = xgt_npr(
						$w_lot_bas['RT_CD'],
						$w_lot_bas['PRC_CD'],
						$w_lot_bas['PLT_DVS_CD'],
						$w_prc_cd,					# [return]next process code
						$w_io_blc_cd,				# [return]next io block code
						$w_stp_cd,					# [return]next step code
						$w_stp_no);					# [return]next step no

		if($w_rtn == 0){
			$w_nxt_verb = "PRPT";
		} else {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return 4000;
		}

		break;
	}


	switch($w_nxt_verb){
	case "IOMV":
		#------------------------------------------------------------------
		# IOMV
		#------------------------------------------------------------------
		$w_rtn = iomv(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_io_blc_cd,
					$w_stp_cd,
					$w_stp_no,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		break;
	case "PRPT":
		#------------------------------------------------------------------
		# PRPT
		#------------------------------------------------------------------
		$w_rtn = prpt(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		#------------------------------------------------------------------
		# PRPC
		#------------------------------------------------------------------
		$w_rtn = prpc(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_prc_cd,
					$w_io_blc_cd,
					$w_stp_cd,
					$w_stp_no,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		#------------------------------------------------------------------
		# PRGT
		#------------------------------------------------------------------
		$w_rtn = prgt(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		break;

	} # end switch

	return 0;
}

#==================================================================
# VERB::IOAB
#==================================================================
function main_verb_ioab($w_usr_id,
						$w_cmt,
						&$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	$w_cus_cd = " ";

	#------------------------------------------------------
	# IOAB
	#------------------------------------------------------
	$w_rtn = ioab( 
				$w_lot_bas['LOT_ID'],		# Lot ID
				$w_usr_id,					# User ID
				$w_lot_bas['UPD_LEV'],		# Update lev.
				$w_cus_cd,					# cause code
				$w_cmt,						# comment
				$w_lot_bas);				# [return]lot_bas_tbl

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::IOHD
#==================================================================
function main_verb_iohd($w_usr_id, $w_hld_can_dts, $w_cus_cd, $w_cmt, &$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------
	# check Lot state
	#------------------------------------------------------
	$w_rtn = iohd_st_check($w_lot_bas['LOT_ST_DVS']);
	if ($w_rtn) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# IOHD
	#------------------------------------------------------
	$w_rtn = iohd(
				$w_lot_bas['LOT_ID'],
				$w_usr_id,
				$w_lot_bas['UPD_LEV'],
				$w_hld_can_dts,
				$w_cus_cd,
				$w_cmt,
				$w_lot_bas);

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#=========================================================================
# VERB::IOMI
#=========================================================================
function main_verb_iomi($w_mcp_prd_cd,
						$w_new_rt_cd,
						$w_new_prc_cd,
						$w_new_io_blc_cd,
						&$w_lot_bas)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_cmt = "";

	$w_rtn = iomi($gw_scr['s_usr_id'],
				  $w_mcp_prd_cd,
				  $w_new_prc_cd,
				  $w_new_io_blc_cd,
				  $w_new_rt_cd,
				  $w_lot_bas['SL_QTY'],
				  $w_lot_bas['CHP_QTY'],
				  $w_lot_bas['LF_QTY'],
				  $w_cmt,
				  $w_lot_bas);

	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return $w_rtn;
	}

	return 0;
}

#=========================================================================
# VERB::IOMO
#=========================================================================
function main_verb_iomo($w_mc_lot_bas, &$w_lot_bas)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_rtn = iomo_st_check($w_lot_bas['LOT_ST_DVS']);
	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$w_cmt = "";

	$w_rtn = iomo($w_lot_bas['LOT_ID'],
				  $gw_scr['s_usr_id'],
				  $w_lot_bas['UPD_LEV'],
				  $w_cmt,
				  $w_mc_lot_bas['PRD_CD'],
				  $w_mc_lot_bas['RT_CD'],
				  $w_mc_lot_bas['PRC_CD'],
				  $w_mc_lot_bas['IO_BLC_CD'],
				  $w_mc_lot_bas['STP_CD'],
				  $w_mc_lot_bas['SHP_CD'],
				  $w_mc_lot_bas['LOT_ID'],
				  $w_mc_lot_bas['LOT_NO'],
				  $w_mc_lot_bas['LOT_ST_DVS'],
				  $w_mc_lot_bas['SL_QTY'],
				  $w_mc_lot_bas['CHP_QTY'],
				  $w_mc_lot_bas['LF_QTY'],
				  $w_lot_bas);

	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return $w_rtn;
	}

	return 0;
}

#==================================================================
# VERB::MTIN
#==================================================================
function main_verb_mtin($w_usr_id, $w_lot_id, $w_mt_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# get Parts WIP info
	#------------------------------------------------------------------
	$w_sql = <<<_SQL
SELECT
	*
FROM
	PRT_WIP_TBL
WHERE
	MT_LOT_ID = '{$w_mt_lot_id}'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRT_WIP_TBL", __LINE__);
		return 4000;
	}
	$w_prtwip = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	#------------------------------------------------------------------
	# check the material state
	#------------------------------------------------------------------
	$w_rtn = mtin_st_check($w_prtwip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# MTIN
	#------------------------------------------------------------------
	$w_rtn = mtin($w_lot_id,
				  $w_mt_lot_id,
				  " ",
				  $w_usr_id,
				  $w_prtwip['UPD_LEV'],
				  "",
				  $w_prtwip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::MTOT
#==================================================================
function main_verb_mtot($w_usr_id, $w_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# get the magazine info
	#------------------------------------------------------------------
	$w_rtn = get_mgzn($w_lot_id, $w_arr_mag_id);
	if($w_rtn != 0){
		return 4000;
	}

	#------------------------------------------------------------------
	# get the parts WIP info
	#------------------------------------------------------------------
	$w_tmpsql = <<<_SQL
SELECT
	*
FROM
	PRT_WIP_TBL
WHERE
	MT_LOT_ID = '%s'
_SQL;

	#------------------------------------------------------------------
	# MTOT for all acquired magazine ID
	#------------------------------------------------------------------
	for($i=1; $i<=count($w_arr_mag_id); $i++){
		#------------------------------------------------------------------
		# get the PRT_WIP_TBL
		#------------------------------------------------------------------
		$w_sql = sprintf($w_tmpsql, $w_arr_mag_id[$i]);
		$w_stmt = db_res_set($w_sql);
		$w_rtn = db_do($w_stmt);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Sel");
			$g_msg = xpt_err_msg($g_msg, "PRT_WIP_TBL", __LINE__);
			return 4000;
		}
		$w_prtwip = db_fetch_row($w_stmt);
		db_res_free($w_stmt);

		#------------------------------------------------------------------
		# check the material state
		#------------------------------------------------------------------
		$w_rtn = mtot_st_check($w_prtwip);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# get the qty of magazine ID
		#------------------------------------------------------------------
		$w_rtn = get_mgid_cnt($w_arr_mag_id[$i], $w_cnt);
		if($w_rtn != 0){
			return 4000;
		}
		if($w_cnt != 1){
			continue; ### skip except 1qty
		}

		#------------------------------------------------------------------
		# MTOT
		#------------------------------------------------------------------
		$w_rtn = mtot($w_lot_id,
					  $w_arr_mag_id[$i],
					  " ",
					  $w_usr_id,
					  $w_prtwip['UPD_LEV'],
					  "",
					  $w_prtwip);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	return 0;
}

#==================================================================
# get magazine info
#==================================================================
function get_mgzn($w_lot_id, &$r_mgzn)
{
	global $g_msg;
	global $g_err_lv;

	$r_mgzn   = array();
	$w_ctgdvs = constant("CE_MGZN");
	$w_ctgcd  = constant("CT_MGZN");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
ORDER BY
	CTG_DAT_TXT
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$r_mgzn[$cnt] = trim($w_row['CTG_DAT_TXT']);
	}

	return 0;
}

#==================================================================
# get qty of magazine ID
#==================================================================
function get_mgid_cnt($w_mgid, &$r_cnt)
{
	global $g_msg;
	global $g_err_lv;

	$r_cnt = 0;
	$w_ce_mag = constant("CE_MGZN");
	$w_ct_mag = constant("CT_MGZN");

	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	LOT_INF_TBL
WHERE
	CTG_CD = '{$w_ct_mag}'
	AND CTG_DVS_CD = '{$w_ce_mag}'
	AND CTG_DAT_TXT = '{$w_mgid}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	if($w_row = db_fetch_row($w_stmt)){
		$r_cnt = $w_row['CNT'];
	}
	db_res_free($w_stmt);

	return 0;
}

#=========================================================================
# VERB::MTCS
#=========================================================================
function main_verb_mtcs($w_lot_id, $w_prt_cd, $w_stp_cd, $w_equ_cd, $w_prd_cd,
		$w_qty, &$r_prt_wip) {
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------
	# check the material state
	#------------------------------------------------------
	$w_rtn = mtcs_st_check($r_prt_wip['PRT_ST_DVS']);
	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# check usable by the shop
	#------------------------------------------------------
	$w_rtn = mtcs_shp_check($w_prt_cd, $w_stp_cd, $w_equ_cd, $w_prd_cd);
	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# MTCS
	#------------------------------------------------------
	$w_rtn = mtcs($w_lot_id, $w_qty, $gw_scr['s_usr_id'],
			$r_prt_wip['UPD_LEV'], " ", $w_cmt, $r_prt_wip);
	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::MTHD
#==================================================================
function main_verb_mthd($w_usr_id, $w_prt_cd, $w_shp_cd, $w_equ_cd, $w_mt_lot_id, $w_cmt)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------
	# get parts WIP info
	#------------------------------------------------------
	$w_rtn = xgt_prt_wip($w_prt_cd,
						$w_shp_cd,
						"",
						$w_mt_lot_id,
						$w_prt_wip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# check the material state
	#------------------------------------------------------
	$w_rtn = mthd_st_check(trim($w_prt_wip['PRT_ST_DVS']));
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_mt_lot_id, __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# MTHD
	#------------------------------------------------------
	$w_rtn = mthd($w_usr_id,
				$w_prt_wip['UPD_LEV'],
				" ",
				$w_cmt,
				$w_prt_wip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_mt_lot_id, __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# magazine control
#==================================================================
function main_exe_mgzn($w_lot_bas)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# search magazine control setting
	#------------------------------------------------------------------
	$w_rtn = cs_xck_jig_srch(trim($w_lot_bas['PRC_CD']),
							 trim($w_lot_bas['STP_CD']),
							 trim($w_lot_bas['PRD_CD']),
							 constant("JI_MGZN"),
							 $w_prt_grp_b, $w_prt_grp_a, $w_jig_chg_id);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	### magazine control step
	if($r_prt_grp_a != ""){
		#------------------------------------------------------------------
		# get current magazine ID
		#------------------------------------------------------------------
		$w_rtn = cs_xck_jig_get_lot(trim($w_lot_bas['LOT_ID']), constant("JI_MGZN"), "2", $w_prt_grp_b,
									$w_prt_grp_a, $w_jig_chg_id, $w_mag_id_b);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	$w_chk = "";
	### new
	if($w_prt_grp_a != "" && $w_prt_grp_b == "" && $w_jig_chg_id == "CHG"){
		$w_chk = 1;
	}
	### change
	if($w_prt_grp_a != "" && $w_prt_grp_b != "" && $w_jig_chg_id == "CHG"){
		$w_chk = 2;
	}
	### hold(not change)
	if($w_prt_grp_a != "" && $w_prt_grp_b != "" && $w_jig_chg_id == "HOLD"){
		$w_chk = 3;
	}
	### delete
    if($w_prt_grp_a == "" && $w_prt_grp_b != "" && $w_jig_chg_id == "CHG"){
		$w_chk = 4;
	}

	### case change or delete
	if($w_chk == 2 || $w_chk == 4){
		#------------------------------------------------------------------
		# MTOT
		#------------------------------------------------------------------
		$w_rtn = main_verb_mtot($gw_scr['s_usr_id'], $w_lot_bas['LOT_ID']);
		if($w_rtn != 0){
			return 4000;
		}

		#------------------------------------------------------------------
		# delete magazine info(DEL_FLG=1)
		#------------------------------------------------------------------
		$w_rtn = del_mgzn($gw_scr['s_usr_id'], "IOOT", $w_lot_bas['LOT_ID']);
		if($w_rtn != 0){
			return 4000;
		}
	}
	### case new or change
	if($w_chk == 1 || $w_chk == 2){
		for($i=1; $i<=$gw_scr['s_mgzn_row']; $i++){
			if($gw_scr['s_list_mgzn_id'][$i] == ""){
				continue;
			}

			#------------------------------------------------------------------
			# MTIN
			#------------------------------------------------------------------
			$w_rtn = main_verb_mtin($gw_scr['s_usr_id'],
									$w_lot_bas['LOT_ID'],
									$gw_scr['s_list_mgzn_id'][$i]);
			if($w_rtn != 0){
				return 4000;
			}

			#------------------------------------------------------------------
			# insert new magaine ID
			#------------------------------------------------------------------
			$w_rtn = ins_mgzn($gw_scr['s_usr_id'],
							$w_lot_bas['LOT_ID'],
							$gw_scr['s_list_mgzn_id'][$i],
							"IOOT");
			if($w_rtn != 0){
				return 4000;
			}
		}
	}


	return 0;
}

#==================================================================
# threshold judgement
#==================================================================
function main_exe_thd_jdg($w_usr_id,
						  $w_trt_qty,
						  $w_pas_qty,
						  $w_arr_jdg_cd,
						  $w_arr_jdg_val,
						  &$w_lot_bas,
						  &$r_hold_flg,
						  &$r_holddat)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# initialize return value
	#------------------------------------------------------------------
	$r_hold_flg = 0;
	$r_holddat  = array();

	#------------------------------------------------------------------
	# check threshold judgement
	#------------------------------------------------------------------
	$w_rtn = cs_xck_thd_jdg($w_usr_id,
							$w_lot_bas['STP_CD'],
							$w_lot_bas['PRD_CD'],
							"",
							$w_trt_qty,
							$w_pas_qty,
							$w_arr_jdg_cd,
							$w_arr_jdg_val,
							$w_lot_bas,
							$w_jdg_ng_flg,
							$w_arr_jdg_rslt);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# if judgement 'OK', return here
	#------------------------------------------------------------------
	if($w_jdg_ng_flg != 1){
		return 0;
	}

	#------------------------------------------------------------------
	# get release date
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_hold_rls($w_lot_bas, $w_hold_can_dts, $w_set_day);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# create comment
	#------------------------------------------------------------------
	$w_hold_cmt = implode(",", array
	(
		$w_arr_jdg_rslt['seq_no'][1],
		$w_arr_jdg_rslt['ctg_cd'][1],
		$w_arr_jdg_rslt['yld'][1],
		$w_arr_jdg_rslt['arith_unt'][1],
		$w_arr_jdg_rslt['ctg_val'][1],
	));

	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	#
	# IOHD
	#
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	$w_rtn = main_verb_iohd($w_usr_id,
							$w_hold_can_dts,
							constant("CU_HOLD"),
							$w_hold_cmt,
							$w_lot_bas);
	if($w_rtn != 0){
		return 4000;
	}

	#------------------------------------------------------------------
	# check whether need to print the quality report sheet
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_par_dat(constant("P0_LOTTRC"),
							constant("REP_ABN_LOT"),
							$w_lot_bas['DVSN_CD_PRC'],
							" ", " ",
							$w_arr_lst_no,
							$w_arr_par_txt,
							$w_arr_par_num,
							$w_par_cnt);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	### error if result is 2 or more
	if($w_par_cnt >= 2){
		list($g_msg, $g_err_lv) = msg("err_Rep_PluralRecord");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$w_qul_rep_flg = 1;
	if($w_arr_par_num[1] == ""){
		$w_qul_rep_flg = 0;
	}

	#------------------------------------------------------------------
	# set return value
	#------------------------------------------------------------------
	$r_hold_flg = 1;
	$r_holddat = array
	(
		'LOT_ID'		=> trim($w_lot_bas['LOT_ID']),
		'STP_CD'		=> trim($w_lot_bas['STP_CD']),
		'SET_DAY'		=> $w_set_day,
		'REP_FLG'		=> $w_qul_rep_flg,
	);

	return 0;
}

#==================================================================
# SPACE
#==================================================================
function main_exe_spc($w_usr_id, $w_spc_err_cd, $w_spc_equinf, $w_lot_bas, &$r_holdexe, &$r_spchold)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$r_holdexe = 0;

	#------------------------------------------------------------------
	# get package code
	#------------------------------------------------------------------
	$w_rtn = xgn_pkg($w_lot_bas['PRD_CD'], 1, $w_pkg_cd, $w_pkg_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRD_CD'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# insert NON_STD_CTG_LOG prep.
	#------------------------------------------------------------------
	$inscnt  = 0;
	$w_ins   = array();
	$w_cuscd = "";
	if($w_spc_err_cd == constant("SPC_ERRCD_ABN")
	|| $w_spc_err_cd == constant("SPC_ERRCD_ABNPCS")
	|| $w_spc_equinf == constant("SPC_WARN_ABN")
	){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM']      = constant("SPC_WARN_ABN");
		$w_ins[$inscnt]['JDGRLT']     = constant("SPC_WARN_ABN");
		$w_ins[$inscnt]['UPD_DTS']    = $g_cpu_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = $w_usr_id;

		$w_cuscd = constant("CU_ABNPCS");
		$r_spchold = array(1 => constant("SPC_WARN_ABN"));
	}

	if($w_spc_err_cd == constant("SPC_ERRCD_PCS")
	|| $w_spc_err_cd == constant("SPC_ERRCD_ABNPCS")
	|| $w_spc_equinf == constant("SPC_WARN_PCS")
	){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM'] = constant("SPC_WARN_PCS");
		$w_ins[$inscnt]['JDGRLT']     = " ";
		$w_ins[$inscnt]['UPD_DTS']    = $g_low_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = " ";

		$w_cuscd = constant("CU_ABNPCS");
		$r_spchold = array(1 => constant("SPC_WARN_PCS"));
	}

	if($w_spc_equinf == constant("SPC_WARN_MBN")){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM'] = constant("SPC_WARN_MBN");
		$w_ins[$inscnt]['JDGRLT']     = " ";
		$w_ins[$inscnt]['UPD_DTS']    = $g_low_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = " ";

		$w_cuscd = constant("CU_MBN");
		$r_spchold = array(1 => constant("SPC_WARN_MBN"));
	}

	if($w_spc_equinf == constant("SPC_WARN_CON")){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM'] = constant("SPC_WARN_CON");
		$w_ins[$inscnt]['JDGRLT']     = " ";
		$w_ins[$inscnt]['UPD_DTS']    = $g_low_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = " ";

		$w_cuscd = constant("CU_AUTO");
		$r_spchold = array(1 => constant("SPC_WARN_CON"));
	}

	### case ABN+PCN
	if($w_spc_err_cd == constant("SPC_ERRCD_ABNPCS")){
		$r_spchold = array(1 => constant("SPC_WARN_ABNPCS"));
	}

	### if not SPC error, return here
	if($inscnt == 0){
		return 0;
	}

	#------------------------------------------------------------------
	# insert NON_STD_CTG_LOG
	#------------------------------------------------------------------
	for($i=1; $i<=$inscnt; $i++){
		$w_nonstd = array
		(
			"DEL_FLG"		=> "0",
			"LOT_ID"		=> $w_lot_bas['LOT_ID'],
			"STP_CD"		=> $w_lot_bas['STP_CD'],
			"PRD_CD"		=> $w_lot_bas['PRD_CD'],
			"LOT_NO_STR"	=> $w_lot_bas['LOT_NO_STR'],
			"PKG_CD"		=> $w_pkg_cd,
			"CTG_LST_NO"	=> $i,
			"CTG_CD_1"		=> constant("CT_ABNINF"),
			"VAL_UNT_FLG_1"	=> 0,
			"CTG_EXP_DVS_1"	=> " ",
			"VAL_1"			=> null,
			"CTG_RLT_1"		=> $w_ins[$i]['ERRNM'],
			"JDG_DTS_1"		=> $g_low_dts,
			"USR_ID_JDG_1"	=> " ",
			"JDG_RLT_1"		=> $w_ins[$i]['JDGRLT'],
			"CTG_CD_2"		=> " ",
			"VAL_UNT_FLG_2"	=> 0,
			"CTG_EXP_DVS_2"	=> " ",
			"VAL_2"			=> null,
			"CTG_RLT_2"		=> " ",
			"JDG_DTS_2"		=> $g_low_dts,
			"USR_ID_JDG_2"	=> " ",
			"JDG_RLT_2"		=> " ",
			"CTG_CD_3"		=> " ",
			"VAL_UNT_FLG_3"	=> 0,
			"CTG_EXP_DVS_3"	=> " ",
			"VAL_3"			=> null,
			"CTG_RLT_3"		=> " ",
			"JDG_DTS_3"		=> $g_low_dts,
			"USR_ID_JDG_3"	=> " ",
			"JDG_RLT_3"		=> " ",
			"CRT_DTS"		=> $g_cpu_dts,
			"USR_ID_CRT"	=> $w_usr_id,
			"UPD_DTS"		=> $w_ins[$i]['UPD_DTS'],
			"USR_ID_UPD"	=> $w_ins[$i]['USR_ID_UPD'],
			"UPD_LEV"		=> 1,
		);

		$w_rtn = db_insert("NON_STD_CTG_LOG", $w_nonstd);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Ins");
			$g_msg = xpt_err_msg($g_msg, "NON_STD_CTG_LOG", __LINE__);
			return 4000;
		}
	}

	#------------------------------------------------------------------
	# get hold release date
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_hold_rls($w_lot_bas, $w_hold_can_dts, $w_set_day);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# create hold comment
	#------------------------------------------------------------------
	$w_hold_cmt = "";
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	#
	# IOHD
	#
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	$w_rtn = main_verb_iohd($w_usr_id,
							$w_hold_can_dts,
							$w_cuscd,
							$w_hold_cmt,
							$w_lot_bas);
	if($w_rtn != 0) return 4000;

	$r_holdexe = 1;

	#------------------------------------------------------------------
	# delete(DEL_FLG=1) the SPC equipment state info in CTG_TBL
	#------------------------------------------------------------------
	if($w_spc_equinf != ""){
		$w_upd = array
		(
			"DEL_FLG"		=> "1",
			"USR_ID_UPD"	=> $w_usr_id,
			"UPD_DTS"		=> $g_cpu_dts,
			"UPD_LEV"		=> 2
		);
		$w_whr = "LOT_ID = '" . $w_lot_bas{'LOT_ID'} . "' "
				. "AND CTG_DVS_CD = '" . constant("CE_HOLDINF") . "' "
				. "AND CTG_CD = '" . constant("CT_ABNINF") . "' "
				. "AND CTG_DAT_TXT = '" . $w_spc_equinf . "' "
				. "AND DEL_FLG = '0'";

		$w_rtn = db_update_one("CTG_TBL", $w_upd, $w_whr);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Upd");
			$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
			return 4000;
		}
	}

	return 0;
}

#======================================================================
# material hold
#
# $r_exe_hold		I/O		hold execute or not
# $r_exp			I/O		expire NG count
# $r_life			I/O		life time NG count
# $r_thaw			I/O		thawing time NG count
#======================================================================
function main_exe_mthd($w_usr_id, $w_stp_cd, &$r_exe_hold, &$r_exp, &$r_life, &$r_thaw)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	# return if NOT need to execute material process
	if($gw_scr['s_prt_ctrl'] != "1") return 0;

	#------------------------------------------------------------------
	# get session value from material program
	#------------------------------------------------------------------
	$w_mcnt                    = get_session_value('s_max_rows',                constant("PGM_MTMNG"));
	$w_list_prt_cd             = get_session_value('s_list_prt_cd',             constant("PGM_MTMNG"));
	$w_list_mt_lot_id          = get_session_value('s_list_mt_lot_id',          constant("PGM_MTMNG"));
	$w_list_use_qty            = get_session_value('s_list_use_qty',            constant("PGM_MTMNG"));
	$w_list_thaw_chrg_hold_flg = get_session_value('s_list_thaw_chrg_hold_flg', constant("PGM_MTMNG"));
	$w_list_thaw_time_hold_flg = get_session_value('s_list_thaw_time_hold_flg', constant("PGM_MTMNG"));
	$w_list_thaw_dts           = get_session_value('s_list_thaw_dts',           constant("PGM_MTMNG"));
	$w_list_life_hold_flg      = get_session_value('s_list_life_hold_flg',      constant("PGM_MTMNG"));
	$w_list_life_dts           = get_session_value('s_list_life_dts',           constant("PGM_MTMNG"));
	$w_list_exp_hold_flg       = get_session_value('s_list_exp_hold_flg',       constant("PGM_MTMNG"));
	$w_list_exp_dts            = get_session_value('s_list_exp_dts',            constant("PGM_MTMNG"));

	$r_exe_hold = 0;
	$r_exp      = 0;
	$r_life     = 0;
	$r_thaw     = 0;
	$w_hold_msg = array();
	for($m=1; $m<=$w_mcnt; $m++){
		if($w_list_prt_cd[$m]  == "") continue;
		if($w_list_use_qty[$m] == "") continue;
		#------------------------------------------------------------------
		# get shop code
		#------------------------------------------------------------------
		$w_rtn = xgt_stp($w_stp_cd, $w_shp_cd);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# MTHD target material
		#------------------------------------------------------------------
		if($w_list_thaw_chrg_hold_flg[$m] == "1"
		|| $w_list_thaw_time_hold_flg[$m] == "1"
		|| $w_list_life_hold_flg[$m]      == "1"
		|| $w_list_exp_hold_flg[$m]       == "1"
		){
			$r_exe_hold = 1;
			# switch message by hold matters
			if($w_list_exp_hold_flg[$m] == "1"){
				$r_exp++;
				list($w_msg, $dmy) = msg("warn_Ovr_ExpTime");
				$w_hold_cmt = constant("CMT_EXP");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_list_mt_lot_id[$m], $w_list_exp_dts[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			elseif($w_list_life_hold_flg[$m] == "1"){
				$r_life++;
				list($w_msg, $dmy) = msg("warn_Ovr_LifeTime");
				$w_hold_cmt = constant("CMT_LIFE");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_list_mt_lot_id[$m], $w_list_life_dts[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			elseif($w_list_thaw_chrg_hold_flg[$m] == "1"){
				$r_thaw++;
				list($w_msg, $dmy) = msg("warn_Equ_NoCharge");
				$w_hold_cmt = constant("CMT_THAW");
				$w_srch = array("%MTLOTID%");
				$w_rplc = array($w_list_mt_lot_id[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			elseif($w_list_thaw_time_hold_flg[$m] == "1"){
				$r_thaw++;
				list($w_msg, $dmy) = msg("warn_Ovr_ChrgThaw");
				$w_hold_cmt = constant("CMT_THAW");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_list_mt_lot_id[$m], $w_list_thaw_dts[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			#------------------------------------------------------------------
			# MTHD
			#------------------------------------------------------------------
			$w_rtn = main_verb_mthd($w_usr_id,
									$w_list_prt_cd[$m],
									$w_shp_cd,
									"",
									$w_list_mt_lot_id[$m],
									$w_hold_cmt);
			if($w_rtn != 0){
				return 4000;
			}
		}
	}

	if(count($w_hold_msg) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_hold_msg);
	}

	return 0;
}

#======================================================================
# device Lot hold by MTHD
#======================================================================
function main_exe_iohd_by_mthd($w_lot_id, $w_upd_lev, $w_exp, $w_life, $w_thaw)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	#------------------------------------------------------------------
	# get LOT_BAS_TBL
	#------------------------------------------------------------------
	$w_rtn = xgt_lot($w_lot_id, $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check update level
	#------------------------------------------------------------------
	$w_rtn = xck_upd($w_upd_lev, $w_lot_bas['UPD_LEV']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# comment
	#------------------------------------------------------------------
	if($w_exp > 0){
		$w_cmt = constant("CMT_EXP");
	}
	elseif($w_life > 0){
		$w_cmt = constant("CMT_LIFE");
	}
	else {
		$w_cmt = constant("CMT_THAW");
	}

	#------------------------------------------------------------------
	# release date
	#------------------------------------------------------------------
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $g_cpu_dts);
	$w_rls_dts = date('Y-m-d', mktime($h,$i,$s,$m,($d + 3),$y));

	#------------------------------------------------------------------
	# IOHD
	#------------------------------------------------------------------
	$w_rtn = main_verb_iohd($gw_scr['s_usr_id'],
							$w_rls_dts,
							constant("CUS_MTMNG"),
							$w_cmt,
							$w_lot_bas);
	if($w_rtn != 0){
		return 4000;
	}

	return 0;
}

#==================================================================
# get next route info
#==================================================================
function get_aftdb_rtinf($w_m_prd_cd, $w_s_prd_cd, $w_prd_cd_fin, &$r_rtinf)
{
	global $g_msg;
	global $g_err_lv;

	if($w_ptn == "") $w_ptn = " ";
	$w_au = constant("AU_STROK");

	$w_sql = <<<_SQL
SELECT
	POM.RT_CD,
	POM.M_RT_FLG_SCH,
	POM.PRD_CD_FIN,
	POM.PRD_CD,
	POM.PRC_CD,
	POM.STP_NO,
	POM.STP_CD,
	POM.IO_BLC_CD,
	POM.PRC_CLS_4,
	STP.SHP_CD
FROM
	MCP_ORG_MST MOM1,
	MCP_ORG_MST MOM2,
	PRD_ORG_MST POM,
	PRC_MST PRC,
	STP_MST STP
WHERE
	MOM1.PRD_CD_FIN = '{$w_prd_cd_fin}'
	AND MOM1.PRD_CD_MCP = '{$w_m_prd_cd}'
	AND MOM1.M_PRD_FLG = '1'
	AND MOM1.DEL_FLG = '0'
	AND MOM2.PRD_CD_FIN = MOM1.PRD_CD_FIN
	AND MOM2.PRD_CD_MCP = '{$w_s_prd_cd}'
	AND MOM2.PTN = MOM1.PTN
	AND MOM2.M_PRD_FLG = '0'
	AND MOM2.DEL_FLG = '0'
	AND POM.PRD_CD = '{$w_prd_cd_fin}'
	AND POM.STP_CD = MOM1.STP_CD
	AND POM.NO_USE_FLG = '0'
	AND POM.DEL_FLG = '0'
	AND PRC.PRC_CD = POM.PRC_CD
	AND PRC.ST_DVS_CD = '{$w_au}'
	AND PRC.DEL_FLG = '0'
	AND STP.STP_CD = POM.STP_CD
	AND STP.DEL_FLG = '0'
ORDER BY
	POM.M_RT_FLG_SCH DESC,
	POM.RT_CD DESC
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRD_ORG_MST", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_Get_RtInf");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$r_rtinf = array_map("trim", $w_row);


	return 0;
}


#==================================================================
# get LOT_INF_TBL
#==================================================================
function get_lotinf($w_lot_id, $w_ctgdvs, $w_ctgcd, &$r_dat)
{
        global $g_msg;
        global $g_err_lv;

        $r_dat = array();

        $w_sql = <<<_SQL
SELECT
        *
FROM
        LOT_INF_TBL
WHERE
        LOT_ID = '{$w_lot_id}'
        AND CTG_DVS_CD = '{$w_ctgdvs}'
        AND CTG_CD = '{$w_ctgcd}'
        AND DEL_FLG = '0'
_SQL;
        $w_stmt = db_res_set($w_sql);
        $w_rtn = db_do($w_stmt);
        if($w_rtn != 0){
                list($g_msg, $g_err_lv) = msg("err_Sel");
                $g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
                return 4000;
        }

        if($w_row = db_fetch_row($w_stmt)){
                foreach($w_row as $key => $val){
                        $w_row[$key] = trim($w_row[$key]);
                }
                $r_dat = $w_row;
        }
        db_res_free($w_stmt);

        return 0;
}

#==================================================================
# check UV irradiation
#==================================================================
function chk_uv($w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	$w_ctgdvs = constant("CE_LTINF");
	$w_ctgcd  = constant("CT_UVLIMIT");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_bas['LOT_ID']}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
_SQL;
	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	### error if cannot get data
	if(!$w_row){
##		list($g_msg, $g_err_lv) = msg("err_Get_UVLimit");
##		$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['LOT_ID']), __LINE__);
##	return 4000;
		return 0;
	}
	### convert to unix time
	$w_epc_cpu_dts  = cnvepc($g_cpu_dts);
	$w_epc_uv_limit = cnvepc($w_row['CTG_DAT_TXT']);
	### error if exceed UV_IRRADIATION expiration
	if($w_epc_cpu_dts >= $w_epc_uv_limit){
		list($g_msg, $g_err_lv) = msg("err_Ovr_UVLimit");
		$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['LOT_ID']), __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# check baking
#==================================================================
function chk_baking($w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	$w_ctgdvs = constant("CE_SUBSTRATE");
	$w_ctgcd  = constant("CT_SUBUSAGE");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT,
	CTG_DAT_VAL
FROM
	CTG_TBL
WHERE
	LOT_ID = '{$w_lot_bas['LOT_ID']}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_Get_BakeDat");
		$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['LOT_ID']), __LINE__);
		return 4000;
	}

	$w_bake_cnt = $w_row['CTG_DAT_VAL'];
	$w_bake_sec = cnvepc(trim($w_row['CTG_DAT_TXT']));
	$w_cpu_sec  = cnvepc($g_cpu_dts);

	if($w_bake_cnt >= 1){
		# OK
	} else {
		list($g_msg, $g_err_lv) = msg("err_Get_BakeCnt");
		$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['LOT_ID']), __LINE__);
		return 4000;
	}

	if($w_bake_sec < $w_cpu_sec){
		if($w_bake_cnt == 1){
			list($g_msg, $g_err_lv) = msg("err_Need_ReBake");
			$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['LOT_ID']), __LINE__);
			return 4000;
		}
		elseif($w_bake_cnt > 1){
			list($g_msg, $g_err_lv) = msg("err_Fin_Rebaked");
			$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['LOT_ID']), __LINE__);
			return 4000;
		}
	}


	return 0;
}


#==================================================================
# validity check for After Type Code
#==================================================================
function chk_prdfin($w_stp_cd,
					$w_prd_cd_fin,
					$w_m_prd_cd_mcp,
					$w_arr_s_prd_cd_mcp,
					$w_ptn,
					&$r_chk)
{
	global $g_msg;
	global $g_err_lv;

	if($w_ptn == "") $w_ptn = " ";
	$w_str_prd_cd_mcp = implode("','", $w_arr_s_prd_cd_mcp);

	#------------------------------------------------------------------
	# get product name for message
	#------------------------------------------------------------------
	$w_sql = <<<_SQL
SELECT
	PRD_CD,
	PRD_NM
FROM
	PRD_MST
WHERE
	PRD_CD IN ('{$w_m_prd_cd_mcp}', '{$w_str_prd_cd_mcp}')
	AND DEL_FLG = '0'
_SQL;
	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRD_MST", __LINE__);
		return 4000;
	}
	$w_prd = array();
	while($w_row = db_fetch_row($w_stmt)){
		$prdcd = trim($w_row['PRD_CD']);
		$w_prd[$prdcd] = trim($w_row['PRD_NM']);
	}
	db_res_free($w_stmt);

	#------------------------------------------------------------------
	# check mcp_org_mst
	#------------------------------------------------------------------
	$w_sql = <<<_SQL
SELECT
	M_PRD_FLG,
	PRD_CD_MCP
FROM
	MCP_ORG_MST
WHERE
	STP_CD = '{$w_stp_cd}'
	AND PRD_CD_FIN = '{$w_prd_cd_fin}'
	AND PTN = '{$w_ptn}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "MCP_ORG_MST", __LINE__);
		return 4000;
	}

	$scnt = 0;
	$w_arr_chk_s_prd_cd = array();
	while($w_row = db_fetch_row($w_stmt)){
		if($w_row['M_PRD_FLG'] == 1){
			$w_chk_m_prd_cd = trim($w_row['PRD_CD_MCP']);
		} else {
			$scnt++;
			$w_arr_chk_s_prd_cd[$scnt] = trim($w_row['PRD_CD_MCP']);
		}
	}

	### invalid main product
	if($w_chk_m_prd_cd != $w_m_prd_cd_mcp){
		list($g_msg, $g_err_lv) = msg("err_Inv_PrdMcp");
		$g_msg = xpt_err_msg($g_msg, $w_prd[$w_m_prd_cd_mcp], __LINE__);
		return 4000;
	}

	### invalid number of sub product
	if(count($w_arr_s_prd_cd_mcp) != count($w_arr_chk_s_prd_cd)){
		list($g_msg, $g_err_lv) = msg("err_Inv_SubCnt");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	for($i=1; $i<=count($w_arr_s_prd_cd_mcp); $i++){
		$w_exst = 0;
		for($j=1; $j<=count($w_arr_chk_s_prd_cd); $j++){
			if($w_arr_s_prd_cd_mcp[$i] == $w_arr_chk_s_prd_cd[$j]){
				$w_exst = 1;
				break;
			}
		}
		### invalid sub product
		if($w_exst == 0){
			list($g_msg, $g_err_lv) = msg("err_Inv_PrdMcp");
			$g_msg = xpt_err_msg($g_msg, $w_prd[$w_arr_s_prd_cd_mcp[$i]], __LINE__);
			return 4000;
		}
	}


	return 0;
}

#==================================================================
# delete(DEL_FLG=1) magazine info
#==================================================================
function del_mgzn($w_usr_id, $w_upd_verb, $w_lot_id)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	$w_ctgdvs = constant("CE_MGZN");
	$w_ctgcd  = constant("CT_MGZN");

	$w_upd = array
	(
		"DEL_FLG"		=> "1",
		"UPD_VERB"		=> $w_upd_verb,
		"UPD_DTS"		=> $g_cpu_dts,
		"USR_ID_UPD"	=> $w_usr_id,
		"UPD_LEV"		=> "2",
	);

	$w_whr = <<<_SQL
LOT_ID = '{$w_lot_id}'
AND CTG_DVS_CD = '{$w_ctgdvs}'
AND CTG_CD = '{$w_ctgcd}'
AND DEL_FLG = '0'
_SQL;

	$w_rtn = db_update_large("LOT_INF_TBL", $w_upd, $w_whr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Upd");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# insert magazine ID
#==================================================================
function ins_mgzn($w_usr_id, $w_lot_id, $w_mgznid, $w_verb)
{
	global $g_msg;
	global $g_err_lv;

	$w_ce_mag = constant("CE_MGZN");
	$w_ct_mag = constant("CT_MGZN");

	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_CD = '{$w_ct_mag}'
	AND CTG_DVS_CD = '{$w_ce_mag}'
	AND CTG_DAT_TXT = '{$w_mgznid}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$w_insflg = 1;
	if($w_row = db_fetch_row($w_stmt)){
		if($w_row['CNT'] > 0){
			$w_insflg = 0;
		}
	}
	db_res_free($w_stmt);

	if($w_insflg == 1){
		$w_rtn = ins_lotinf($w_usr_id,
						 $w_lot_id,
						 $w_ce_mag,
						 $w_ct_mag,
						 " ",
						 $w_mgznid,
						 "",
						 $w_verb);
		if($w_rtn != 0){
			return 4000;
		}
	}

	return 0;
}

#==================================================================
# insert LOT_INF_TBL
#==================================================================
function ins_lotinf($w_usr_id,
					 $w_lot_id,
					 $w_ctg_dvs_cd,
					 $w_ctg_cd,
					 $w_sl_id,
					 $w_ctg_dat_txt,
					 $w_ctg_dat_val,
					 $w_crt_verb)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_arr = array
	(
		"DEL_FLG"		=> "0",
		"LOT_ID"		=> $w_lot_id,
		"CTG_DVS_CD"	=> $w_ctg_dvs_cd,
		"CTG_CD"		=> $w_ctg_cd,
		"SL_ID"			=> $w_sl_id,
		"CTG_DAT_TXT"	=> $w_ctg_dat_txt,
		"CTG_DAT_VAL"	=> $w_ctg_dat_val,
		"CRT_VERB"		=> $w_crt_verb,
		"CRT_DTS"		=> $g_cpu_dts,
		"USR_ID_CRT"	=> $w_usr_id,
		"UPD_VERB"		=> " ",
		"UPD_DTS"		=> $g_low_dts,
		"USR_ID_UPD"	=> " ",
		"UPD_LEV"		=> 1
	);

	$w_rtn = db_insert("LOT_INF_TBL", $w_arr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Ins");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# update(DEL_FLG=1) LOT_INF_TBL
#==================================================================
function upd_lotinf($w_usr_id,
					 $w_lot_id,
					 $w_ctg_dvs_cd,
					 $w_ctg_cd,
					 $w_sl_id,
					 $w_upd_verb,
					 $w_ctg_dat_txt = null,
					 $w_ctg_dat_val = null)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_upd = array
	(
		"DEL_FLG"		=> "1",
		"UPD_VERB"		=> $w_upd_verb,
		"UPD_DTS"		=> $g_cpu_dts,
		"USR_ID_UPD"	=> $w_usr_id,
	);

	if(!is_null($w_ctg_dat_txt)){
		$w_whr_txt = "AND CTG_DAT_TXT = '" . $w_ctg_dat_txt . "' ";
	}
	if(!is_null($w_ctg_dat_val)){
		$w_whr_val = "AND CTG_DAT_VAL = " . $w_ctg_dat_val . " ";
	}

	$w_whr = <<<_SQL
LOT_ID = '{$w_lot_id}'
AND CTG_DVS_CD = '{$w_ctg_dvs_cd}'
AND CTG_CD = '{$w_ctg_cd}'
{$w_whr_txt}
{$w_whr_val}
AND DEL_FLG = '0'
_SQL
;

	$w_rtn = db_update_one("LOT_INF_TBL", $w_upd, $w_whr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Upd");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# insert CTG_TBL
#==================================================================
function ins_ctgtbl($w_usr_id,
					 $w_lot_id,
					 $w_ctg_dvs_cd,
					 $w_ctg_cd,
					 $w_sl_id,
					 $w_ctg_dat_txt,
					 $w_ctg_dat_val)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_arr = array
	(
		"DEL_FLG"		=> "0",
		"LOT_ID"		=> $w_lot_id,
		"CTG_DVS_CD"	=> $w_ctg_dvs_cd,
		"CTG_CD"		=> $w_ctg_cd,
		"SL_ID"			=> $w_sl_id,
		"CTG_DAT_TXT"	=> $w_ctg_dat_txt,
		"CTG_DAT_VAL"	=> $w_ctg_dat_val,
		"CRT_DTS"		=> $g_cpu_dts,
		"USR_ID_CRT"	=> $w_usr_id,
		"UPD_DTS"		=> $g_low_dts,
		"USR_ID_UPD"	=> " ",
		"UPD_LEV"		=> 1
	);

	$w_rtn = db_insert("CTG_TBL", $w_arr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Ins");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# update(DEL_FLG=1) CTG_TBL
#==================================================================
function upd_ctgtbl($w_usr_id,
					 $w_lot_id,
					 $w_ctg_dvs_cd,
					 $w_ctg_cd,
					 $w_sl_id,
					 $w_large = 0,
					 $w_ctg_dat_txt = null,
					 $w_ctg_dat_val = null)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_upd = array
	(
		"DEL_FLG"		=> "1",
		"UPD_DTS"		=> $g_cpu_dts,
		"USR_ID_UPD"	=> $w_usr_id,
	);

	if(!is_null($w_ctg_dat_txt)){
		$w_whr_txt = "AND CTG_DAT_TXT = '" . $w_ctg_dat_txt . "' ";
	}
	if(!is_null($w_ctg_dat_val)){
		$w_whr_val = "AND CTG_DAT_VAL = " . $w_ctg_dat_val . " ";
	}

	$w_whr = <<<_SQL
LOT_ID = '{$w_lot_id}'
AND CTG_DVS_CD = '{$w_ctg_dvs_cd}'
AND CTG_CD = '{$w_ctg_cd}'
AND SL_ID = '{$w_sl_id}'
{$w_whr_txt}
{$w_whr_val}
AND DEL_FLG = '0'
_SQL;

	if($w_large == 0){
		$w_rtn = db_update_one("CTG_TBL", $w_upd, $w_whr);
	} else {
		$w_rtn = db_update_large("CTG_TBL", $w_upd, $w_whr);
	}
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Upd");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# inherit LOT_INF_TBL for IOSP
#==================================================================
function inhrt_lotinf4sp($w_usr_id, $w_old_lot_id, $w_new_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# get data from old Lot
	#------------------------------------------------------------------
	$w_sql = <<<_SQL
SELECT
	*
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_old_lot_id}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$cnt = 0;
	$w_dat = array();
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$w_dat[$cnt] = $w_row;
	}
	db_res_free($w_stmt);

	#------------------------------------------------------------------
	# inherit to new Lot
	#------------------------------------------------------------------
	for($i=1; $i<=$cnt; $i++){
		$w_rtn = ins_lotinf($w_usr_id,
							$w_new_lot_id,
							$w_dat[$i]['CTG_DVS_CD'],
							$w_dat[$i]['CTG_CD'],
							$w_dat[$i]['SL_ID'],
							$w_dat[$i]['CTG_DAT_TXT'],
							$w_dat[$i]['CTG_DAT_VAL'],
							"IOSP");
		if($w_rtn != 0) return 4000;
	}


	return 0;
}

#==================================================================
# inherit LOT_INF_TBL for IOMG
#==================================================================
function inhrt_lotinf4mg($w_usr_id, $w_arr_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# get data from 
	#------------------------------------------------------------------
	$w_tmpsql = <<<_SQL
SELECT
	*
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '%s'
	AND DEL_FLG = '0'
_SQL;

	$w_sql = sprintf($w_tmpsql, $w_arr_lot_id[1]);
	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$cnt = 0;
	$w_prndat = array();
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$w_prndat[$cnt] = $w_row;
	}
	db_res_free($w_stmt);

	$inhrt = 0;
	$w_inhrt = array();
	for($i=2; $i<=count($w_arr_lot_id); $i++){
		$w_sql = sprintf($w_tmpsql, $w_arr_lot_id[$i]);
		$w_stmt = db_res_set($w_sql);
		$w_rtn = db_do($w_stmt);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Sel");
			$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
			return 4000;
		}

		while($w_row = db_fetch_row($w_stmt)){
			### date code
			if(trim($w_row['CTG_CD']) == constant("CT_SECNO")){
				$w_exst = 0;
				for($j=1; $j<=count($w_prndat); $j++){
					if(trim($w_prndat[$j]['CTG_CD']) != constant("CT_SECNO")) continue;
					if(trim($w_row['CTG_DAT_TXT']) == trim($w_prndat[$j]['CTG_DAT_TXT'])){
						$w_exst = 1;
						break;
					}
					if($w_exst == 0){
						$w_rtn = ins_lotinf($w_usr_id,
											$w_arr_lot_id[1],
											$w_row['CTG_DVS_CD'],
											$w_row['CTG_CD'],
											$w_row['SL_ID'],
											$w_row['CTG_DAT_TXT'],
											$w_row['CTG_DAT_VAL'],
											"IOMG");
						if($w_rtn != 0) return 4000;
					}
				}
			}
		}
		db_res_free($w_stmt);
	}


	return 0;
}

#==================================================================
# inherit LOT_INF_TBL for IOMI
#==================================================================
function inhrt_lotinf4mi($w_usr_id, $w_new_lot_id, $w_arr_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# get data from old Lot
	#------------------------------------------------------------------
	$w_tmpsql = <<<_SQL
SELECT
	*
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '%s'
	AND DEL_FLG = '0'
_SQL;

	$cnt = 0;
	$w_chddat = array();
	for($i=1; $i<=count($w_arr_lot_id); $i++){
		$w_sql = sprintf($w_tmpsql, $w_arr_lot_id[$i]);
		$w_stmt = db_res_set($w_sql);
		$w_rtn = db_do($w_stmt);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Sel");
			$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
			return 4000;
		}
		while($w_row = db_fetch_row($w_stmt)){
			$cnt++;
			$w_chddat[$cnt] = $w_row;
		}
		db_res_free($w_stmt);
	}

	#------------------------------------------------------------------
	# inherit to new Lot
	#------------------------------------------------------------------
	for($i=1; $i<=$cnt; $i++){
		### exclude following category
		$w_exctg = array
		(
			constant("CT_SLINFO"),
			constant("CT_BAKING"),
			constant("CT_MNFC"),
			constant("CT_APPID"),
			constant("CT_UVLIMIT"),
		);
		if(in_array(trim($w_chddat[$i]['CTG_CD']), $w_exctg)) continue;

		### insert
		$w_rtn = ins_lotinf($w_usr_id,
							$w_new_lot_id,
							$w_chddat[$i]['CTG_DVS_CD'],
							$w_chddat[$i]['CTG_CD'],
							$w_chddat[$i]['SL_ID'],
							$w_chddat[$i]['CTG_DAT_TXT'],
							$w_chddat[$i]['CTG_DAT_VAL'],
							"IOMI");
		if($w_rtn != 0) return 4000;
	}


	return 0;
}

#==================================================================
# check whether Main-Lot has been already done Track-In
#==================================================================
function chk_in($w_lot_id, &$r_exst)
{
	global $g_msg;
	global $g_err_lv;

	$w_ctgdvs = constant("CE_LTINF");
	$w_ctgcd  = constant("CT_EXLOTID");

	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	LOT_INF_TBL
WHERE
	CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND CTG_DAT_TXT = '{$w_lot_id}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	$r_exst = $w_row['CNT'];

	return 0;
}

#==================================================================
# check whether sub-Lot has been already reserved by other Lot
#==================================================================
function chk_rsvd($w_lot_id, $w_ctgcd)
{
	global $g_msg;
	global $g_err_lv;

	$w_ctgdvs = constant("CE_LTINF");

	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	CTG_TBL
WHERE
	CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND CTG_DAT_TXT = '{$w_lot_id}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if($w_row['CNT'] > 0){
		$w_msglbl = "err_Rsvd_MainLot";
		if($w_ctgcd == constant("CT_SUBLOT")){
			$w_msglbl = "err_Rsvd_SubLot";
		}
		list($g_msg, $g_err_lv) = msg($w_msglbl);
		$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# FIFO
#==================================================================
function chk_fifo($w_lot_bas, &$r_fifo_lot, &$r_msg)
{
	global $g_msg;
	global $g_low_dts;

	#------------------------------------------------------------------
	# get last update datetime
	#------------------------------------------------------------------
	$w_last_dts = "";
	if($w_lot_bas['OUT_DTS_B'] != $g_low_dts){
		$w_last_dts = $w_lot_bas['OUT_DTS_B'];
	}
	elseif($w_lot_bas['UPD_DTS'] != $g_low_dts){
		$w_last_dts = $w_lot_bas['UPD_DTS'];
	}
	else {
		$w_last_dts = $w_lot_bas['CRT_DTS'];
	}
	#------------------------------------------------------------------
	# check FIFO
	#------------------------------------------------------------------
	$w_rtn = cs_xck_fifo_lot($r_fifo_lot,
							$w_lot_bas['PRD_CD'],
							$w_lot_bas['PRC_CD'],
							$w_lot_bas['IO_BLC_CD'],
							$w_last_dts);
	if($w_rtn != 0){
		if(count($r_fifo_lot) > 0){
			$r_msg = $g_msg;
			$g_msg = "";
		} else {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	return 0;
}

#==================================================================
# check the HOLD info by SPACE or Equipment state
#==================================================================
function chk_spc_equ($w_lot_id, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat    = "";
	$w_ctgdvs = constant("CE_HOLDINF");
	$w_ctgcd  = constant("CT_ABNINF");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	CTG_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if($w_row){
		$r_dat = trim($w_row['CTG_DAT_TXT']);
	}

	return 0;
}

#==================================================================
# SPACE
#==================================================================
function chk_space4in($w_usr_id,
					$w_lot_id,
					$w_simm,
					$w_prd_cd,
					$w_stp_cd,
					$w_equ_cd,
					$w_chp_qty,
					$w_sub_qty,
					$w_prg_id,
					&$r_spc_err_cd, &$r_spc_err_nm, &$r_spc_err_msg)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	#------------------------------------------------------------------
	# get inputed value from material consumption
	#------------------------------------------------------------------
	$w_mcnt            = get_session_value('s_max_rows', constant("PGM_MTMNG"));
	$w_list_prt_cd     = get_session_value('s_list_prt_cd', constant("PGM_MTMNG"));
	$w_list_prt_grp_cd = get_session_value('s_list_prt_grp_cd', constant("PGM_MTMNG"));
	$w_list_prt_alt    = get_session_value('s_list_glb_prt_cd', constant("PGM_MTMNG"));
	$w_list_mt_lot_id  = get_session_value('s_list_mt_lot_id', constant("PGM_MTMNG"));
	$w_list_unt_cd     = get_session_value('s_list_unt_cd', constant("PGM_MTMNG"));
	$w_list_use_qty    = get_session_value('s_list_use_qty', constant("PGM_MTMNG"));

	### error if no input
	$w_mat_inp_flg = 0;
	for($i=1; $i<=$w_mcnt; $i++){
		if($w_list_mt_lot_id[$i] != ""){
			$w_mat_inp_flg = 1;
			break;
		}
	}
	if($gw_scr['s_prt_ctrl'] == "1"
	&& ($w_mcnt == "" || $w_mat_inp_flg == 0)
	){
		list($g_msg, $g_err_lv) = msg("err_Inp_MatMng");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$w_arr_mat = array();
	for($i=1; $i<=$w_mcnt; $i++){
		if($w_list_prt_cd[$i]  == "") continue;
		if($w_list_use_qty[$i] == "") continue;
		$w_prtalt = $w_list_prt_alt[$i];
		$w_arr_mat[$w_prtalt] = $w_list_mt_lot_id[$i] . "_" . $w_list_use_qty[$i];
	}

	#------------------------------------------------------------------
	# SPACE check
	#------------------------------------------------------------------
	$w_rtn = cs_xck_trk_snd_lot($w_lot_id,
								$w_simm,
								$w_equ_cd,
								$w_prg_id,
								$w_usr_id,
								$g_cpu_dts,
								$w_chp_qty,
								$w_sub_qty,
								$w_arr_mat,
								$r_spc_err_cd,
								$r_spc_err_nm,
								$r_spc_err_msg);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# SPACE
#==================================================================
function chk_space4out($w_lot_id,
					$w_simm,
					$w_equ_cd,
					$w_pken_prg_id,
					$w_usr_id,
					$w_in_chp_qty,
					$w_out_chp_qty,
					$w_in_bar_or_ring_qty,
					$w_out_bar_or_ring_qty,
					$w_rjct_chp_qty,
					$w_rjct_bar_qty,
					$w_plt_jdg,
					&$r_spc_err_cd, &$r_spc_err_nm, &$r_spc_err_msg)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $gw_scr;

	#------------------------------------------------------------------
	# get the input info from material consumption
	#------------------------------------------------------------------
	$w_mcnt            = get_session_value('s_max_rows', constant("PGM_MTMNG"));
	$w_list_prt_cd     = get_session_value('s_list_prt_cd', constant("PGM_MTMNG"));
	$w_list_prt_alt    = get_session_value('s_list_glb_prt_cd', constant("PGM_MTMNG"));
	$w_list_mt_lot_id  = get_session_value('s_list_mt_lot_id', constant("PGM_MTMNG"));
	$w_list_use_qty    = get_session_value('s_list_use_qty', constant("PGM_MTMNG"));
	### error no input
	if($gw_scr['s_prt_ctrl'] == "1"){
	if($w_mcnt == 0){
		list($g_msg, $g_err_lv) = msg("err_Inp_MatMng");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	}
	$w_arr_mat = array();
	for($i=1; $i<=$w_mcnt; $i++){
		if($w_list_prt_cd[$i]  == "") continue;
		if($w_list_use_qty[$i] == "") continue;
		$w_prtalt = $w_list_prt_alt[$i];
		$w_arr_mat[$w_prtalt] = $w_list_mt_lot_id[$i] . "_" . $w_list_use_qty[$i];
	}

	#------------------------------------------------------------------
	# check SPACE
	#------------------------------------------------------------------
	$w_rtn = cs_xck_abn_snd_lot($w_lot_id,
								$w_simm,
								$w_equ_cd,
								$w_pken_prg_id,
								$w_usr_id,
								$g_cpu_dts,
								$w_in_chp_qty,
								$w_out_chp_qty,
								$w_in_bar_or_ring_qty,
								$w_out_bar_or_ring_qty,
								$w_arr_mat,
								$w_rjct_chp_qty,
								$w_rjct_bar_qty,
								$w_plt_jdg,
								$r_spc_err_cd,
								$r_spc_err_nm,
								$r_spc_err_msg);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}


#==================================================================
# close up blank line & check duplicate line
#==================================================================
function chk_clsup_dup($_, $cnt)
{
	global $gw_scr;
	#------------------------------------------------------------------
	# close up blank line
	#------------------------------------------------------------------
	for($i=1; $i<=$cnt; $i++){
		if($gw_scr['s_list_'.$_.'_lot_id'][$i] != "") continue;
		for($j=($i+1); $j<=$cnt; $j++){
			if($gw_scr['s_list_'.$_.'_lot_id'][$j] == "") continue;
			$gw_scr['s_list_'.$_.'_lot_id'][$i] = $gw_scr['s_list_'.$_.'_lot_id'][$j];
			$gw_scr['s_list_'.$_.'_lot_id'][$j] = "";
			break;
		}
	}

	#------------------------------------------------------------------
	# check duplicate line
	#------------------------------------------------------------------
	for($i=1; $i<=$cnt; $i++){
		if($gw_scr['s_list_'.$_.'_lot_id'][$i] == "") continue;
		for($j=($i+1); $j<=$cnt; $j++){
			if($gw_scr['s_list_'.$_.'_lot_id'][$j] == "") continue;
			if($gw_scr['s_list_'.$_.'_lot_id'][$i] == $gw_scr['s_list_'.$_.'_lot_id'][$j]){
				list($g_msg, $g_err_lv) = msg("err_Dup");
				$g_msg = xpt_err_msg($g_msg, $gw_scr['s_list_'.$_.'_lot_id'][$i], __LINE__);
				return 4000;
			}
		}
	}
	return 0;
}

#==================================================================
# input check
#==================================================================
function check_input($w_mode)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch ($w_mode) {
	#------------------------------------------------------------------
	# MODE1
	#------------------------------------------------------------------
	case 1:
		#------------------------------------------------------------------
		# trim & upper
		#------------------------------------------------------------------
		$gw_scr['s_usr_id']     = strtoupper(trim($gw_scr['s_usr_id']));
		$gw_scr['s_lot_id'] 	= strtoupper(trim($gw_scr['s_lot_id']));

		#------------------------------------------------------------------
		# required
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		if($gw_scr['s_usr_id'] == ""){
			$g_msg = xpt_err_msg($g_msg, itm("UsrId"), __LINE__);
			return 4000;
		}
		if($gw_scr['s_lot_id'] == ""){
			$g_msg = xpt_err_msg($g_msg, itm("MainLot"), __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# tag
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Inp_Tag");
		if(substr($gw_scr['s_usr_id'], 0, 2) != constant("TG_MA")){
			$g_msg = xpt_err_msg($g_msg, itm("UsrId"), __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# prohibited characters
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
		if(!check_eisu($gw_scr['s_usr_id'])){
			$w_tg = get_tg(itm("UsrId"), $gw_scr['s_usr_id']);
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if(!check_err_lot($gw_scr['s_lot_id'])){
			$w_tg = get_tg(itm("LotID"), $gw_scr['s_lot_id']);
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}

		break;
	#------------------------------------------------------------------
	# MODE2
	#------------------------------------------------------------------
	case 2:
		$w_dvs = unserialize(constant("M_S_DVS"));
		#------------------------------------------------------------------
		# trim
		#------------------------------------------------------------------
		for($d=1; $d<=count($w_dvs); $d++){
			$dvs = $w_dvs[$d];
			for($i=1; $i<=$gw_scr['s_hdn_s_inp_cnt']; $i++){
				$gw_scr['s_list_s_lot_id'][$i]  = strtoupper(trim($gw_scr['s_list_s_lot_id'][$i]));
				if($dvs == "s") {
					$gw_scr['s_list_s_adj_qty'][$i] = trim($gw_scr['s_list_s_adj_qty'][$i]);
				} else {
					$gw_scr['s_list_s_adj_qty'][$i] = trim($gw_scr['s_list_s_adj_qty'][$i]);
				}
				$gw_scr['s_list_s_trt_qty'][$i] = trim($gw_scr['s_list_s_trt_qty'][$i]);
				$gw_scr['s_list_s_pas_qty'][$i] = trim($gw_scr['s_list_s_pas_qty'][$i]);
				$gw_scr['s_list_s_bad_qty'][$i] = trim($gw_scr['s_list_s_bad_qty'][$i]);
			}
		}
		$gw_scr['s_aprv_usr_id'] = strtoupper(trim($gw_scr['s_aprv_usr_id']));
		#------------------------------------------------------------------
		# require input
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		for($d=1; $d<=count($w_dvs); $d++){
			$dvs = $w_dvs[$d];
			for($i=1; $i<=$gw_scr['s_hdn_s_inp_cnt']; $i++){
				### error if input qty on blank lot_id line
				if(($gw_scr['s_list_s_adj_qty'][$i] != ""
		  		 || $gw_scr['s_list_s_trt_qty'][$i] != ""
				 || $gw_scr['s_list_s_pas_qty'][$i] != ""
				 || $gw_scr['s_list_s_bad_qty'][$i] != "")
				&& $gw_scr['s_list_s_lot_id'][$i]  == ""
				){
					list($g_msg, $g_err_lv) = msg("err_Inp_LotID");
					$w_itm = itm("MainLot");
					if($dvs == "s") $w_itm = itm("SubLot");
					$w_tg = get_tg($w_itm, $i.itm("Line"));
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}

				if($gw_scr['s_list_s_slc_no'][$i] == "" && $gw_scr["s_list_s_lot_id"][$i] != ""){
                                        $w_tg = get_tg(itm("UseSlNo"), $gw_scr['s_list_s_lot_id'][$i]);
                                        $g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
                                        return 4000;
                                }

				if($gw_scr['s_list_s_slc_no'][$i] != "" && $gw_scr['s_list_s_lot_id'][$i] == ""){
					$gw_scr['s_list_s_slc_no'][$i] = "";
				}
			}
		}

/*
				# continue if no input lot_id
				if($gw_scr['s_list_s_lot_id'][$i] == "") continue;
				# continue if MainLot and ex-LotID has been acquired and 1st line
				if($gw_scr['s_ex_lot_id'] != "" && $dvs == "m" && $i == 1) continue;

				### Input Qty
				if($gw_scr['s_list_s_trt_qty'][$i] == ""
				|| $gw_scr['s_list_s_trt_qty'][$i] == "0"
				){
					$w_tg = get_tg(itm("TrtQty"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
				### Pass Qty
				if($gw_scr['s_list_s_pas_qty'][$i] == ""){
					$w_tg = get_tg(itm("PasQty"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
				### Reject Qty
				if($gw_scr['s_s_bad_ctg_cnt'] > "0"
				&& $gw_scr['s_list_s_bad_qty'][$i] == ""
				){
					$w_tg = get_tg(itm("BadQty"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
			}
		}
*/

		#------------------------------------------------------------------
		# prohibited characters
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
		for($d=1; $d<=count($w_dvs); $d++){
			$dvs = $w_dvs[$d];
			for($i=1; $i<=$gw_scr['s_hdn_s_inp_cnt']; $i++){
				# continue if no input lot_id
				if($gw_scr['s_list_s_lot_id'][$i] == "") continue;
				# continue if MainLot and ex-LotID has been acquired and 1st line
				if($gw_scr['s_ex_lot_id'] != "" && $dvs == "m" && $i == 1) continue;

				if(!check_err_lot($gw_scr['s_list_s_lot_id'][$i])){
					$w_tg = get_tg(itm("LotID"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}

				if($gw_scr['s_list_s_adj_qty'][$i] != ""
				&& !check_num($gw_scr['s_list_s_adj_qty'][$i])
				){
					$w_tg = get_tg(itm("AdjQty"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
				if($gw_scr['s_list_s_trt_qty'][$i] != ""
				&& !check_num($gw_scr['s_list_s_trt_qty'][$i])
				){
					$w_tg = get_tg(itm("TrtQty"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
				if($gw_scr['s_list_s_pas_qty'][$i] != ""
				&& !check_num($gw_scr['s_list_s_pas_qty'][$i])
				){
					$w_tg = get_tg(itm("PasQty"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
				if($gw_scr['s_list_s_bad_qty'][$i] != ""
				&& !check_num($gw_scr['s_list_s_bad_qty'][$i])
				){
					$w_tg = get_tg(itm("BadQty"), $gw_scr['s_list_s_lot_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}

				if(!preg_match("/^[0-9\-\,]+$/", $gw_scr['s_list_s_slc_no'][$i])){
        	                        $w_tg = get_tg(itm("UseSlNo"), $gw_scr['s_list_s_lot_id'][$i]);
	                                $g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
                	                return 4000;
                        	}


			}
		}
		break;
	#------------------------------------------------------------------
	# MODE3
	#------------------------------------------------------------------
	case 3:
		#------------------------------------------------------------------
		# trim
		#------------------------------------------------------------------
#		for($i=1; $i<=$gw_scr['s_sl_inp_cnt']; $i++){
#			$gw_scr['s_list_sl_no'][$i] = trim($gw_scr['s_list_sl_no'][$i]);
#		}
		$gw_scr['s_pas_chp_qty'] = trim($gw_scr['s_pas_chp_qty']);
		$gw_scr['s_rej_chp_qty']  = trim($gw_scr['s_rej_chp_qty']);
		$w_mgzn = 0;
		for($i=1; $i<=$gw_scr['s_hdn_mgzn_row']; $i++){
			$gw_scr['s_list_mgzn_id'][$i] = strtoupper(trim($gw_scr['s_list_mgzn_id'][$i]));
			if($gw_scr['s_list_mgzn_id'][$i] != ""){
				$w_mgzn++;
			}
		}
		$gw_scr['s_cmt'] = trim($gw_scr['s_cmt']);

		#------------------------------------------------------------------
		# require input
		#------------------------------------------------------------------
#		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
#		for($i=1; $i<=$gw_scr['s_sl_inp_cnt']; $i++){
#			if($gw_scr['s_list_sl_no'][$i] == ""){
#				$w_tg = get_tg(itm("UseSlNo"), $gw_scr['s_list_sl_m_lot_id'][$i]);
#				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
#				return 4000;
#			}
#		}
		if($gw_scr['s_pas_chp_qty'] == ""){
			$g_err_lv = 0;
			$w_tg = get_tg(itm("AftMultiLot"), itm("BaseQty"));
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if($gw_scr['s_aft_bad_ctg_cnt'] > "0"
		&& $gw_scr['s_rej_chp_qty'] == ""
		){
			$g_err_lv = 0;
			$w_tg = get_tg(itm("AftMultiLot"), itm("BadQty"));
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if($gw_scr['s_mgzn_flg'] == "1" && $w_mgzn == 0){
			$g_msg = xpt_err_msg($g_msg, itm("FinMgznId"), __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# prohibited characters
		#------------------------------------------------------------------
#		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
#		for($i=1; $i<=$gw_scr['s_sl_inp_cnt']; $i++){
#			if(!preg_match("/^[0-9\-\,]+$/", $gw_scr['s_list_sl_no'][$i])){
#				$w_tg = get_tg(itm("UseSlNo"), $gw_scr['s_list_sl_m_lot_id'][$i]);
#				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
#				return 4000;
#			}
#		}
		if(!check_num($gw_scr['s_pas_chp_qty'])){
			$w_tg = get_tg(itm("AftMulitLot"), itm("BaseQty"));
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if($gw_scr['s_aft_bad_ctg_cnt'] > "0"
		&& !check_num($gw_scr['s_rej_chp_qty'])
		){
			$w_tg = get_tg(itm("AftMultiLot"), itm("BadQty"));
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if($gw_scr['s_mgzn_flg'] == "1"){
			for($i=1; $i<=$gw_scr['s_hdn_mgzn_row']; $i++){
				if($gw_scr['s_list_mgzn_id'][$i] == "") continue;
				if(!check_err_code($gw_scr['s_list_mgzn_id'][$i])){
					$g_msg = xpt_err_msg($g_msg, itm("FinMgznId"), __LINE__);
					return 4000;
				}
			}
		}

		if(!check_err_cmt($gw_scr['s_cmt'])){
			$g_msg = xpt_err_msg($g_msg, itm("Cmt"), __LINE__);
			return 4000;
		}

		break;
	#------------------------------------------------------------------
	# MODE6
	#------------------------------------------------------------------
	case 6:
		#------------------------------------------------------------------
		# trim
		#------------------------------------------------------------------
		for($i=1; $i<=$gw_scr['s_bad_ctg_cnt']; $i++){
			if($gw_scr['s_list_bad_ctg_cd'][$i] == "") continue;
			$gw_scr['s_list_bad_ctg_qty'][$i] = trim($gw_scr['s_list_bad_ctg_qty'][$i]);
		}
		#------------------------------------------------------------------
		# prohibited characters
		#------------------------------------------------------------------
		for($i=1; $i<=$gw_scr['s_bad_ctg_cnt']; $i++){
			if($gw_scr['s_list_bad_ctg_cd'][$i] == "") continue;
			if($gw_scr['s_list_bad_ctg_qty'][$i] != ""){
				### if ADJUST category, allowing minus value (disallow decimal fraction)
				if($gw_scr['s_list_bad_ctg_cd'][$i] == constant("CT_ADJ")){
					if(!preg_match("/^[0-9\-]+$/", $gw_scr['s_list_bad_ctg_qty'][$i])){
						list($g_msg, $g_err_lv) = msg("err_Inp_Char");
						$w_tg = get_tg($gw_scr['s_list_bad_ctg_nm'][$i], $gw_scr['s_list_bad_ctg_qty'][$i]);
						$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
						return 4000;
					}
				} else {
					if(!check_num($gw_scr['s_list_bad_ctg_qty'][$i])){
						list($g_msg, $g_err_lv) = msg("err_Inp_Char");
						$w_tg = get_tg($gw_scr['s_list_bad_ctg_nm'][$i], $gw_scr['s_list_bad_ctg_qty'][$i]);
						$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
						return 4000;
					}
				}
			}
		}

		break;
	}

	$g_msg    = "";
	$g_err_lv = "";

	return 0;
}

#==================================================================
# check approved user authority
#==================================================================
function chk_authority($w_usr_id, $w_pass)
{
	global $g_msg;
	global $g_err_lv;

	$w_sql = <<<_SQL
SELECT
	USM.USR_ID,
	USM.PASSWD,
	UGM.USR_GRP_CD
FROM
	USR_MST USM,
	USR_GRP_MST UGM
WHERE
	USM.USR_ID = '{$w_usr_id}'
	AND USM.DEL_FLG = '0'
	AND UGM.USR_ID = USM.USR_ID
	AND UGM.DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "User Master", __LINE__);
		return 4000;
	}

	$cnt = 0;
	$w_ok = 0;
	$w_dbpass = "";
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		if($cnt == 1){
			$w_dbpass = trim($w_row['PASSWD']);
		}
		$w_grpcd = trim($w_row['USR_GRP_CD']);

		if(in_array($w_grpcd, unserialize(constant("DG_APRV")))){
			$w_ok = 1;
			break;
		}
	}

	### error if not regist
	if($cnt == 0){
		list($g_msg, $g_err_lv) = msg("err_Get_User");
		$g_msg = xpt_err_msg($g_msg, $w_usr_id, __LINE__);
		return 4000;
	}

	### error if wrong password
	if($w_dbpass != $w_pass){
		list($g_msg, $g_err_lv) = msg("err_Wrng_Pass");
		$g_msg = xpt_err_msg($g_msg, itm("LastApprv")."/".$w_usr_id, __LINE__);
		return 4000;
	}

	### error if not approved user
	if($w_ok == 0){
		list($g_msg, $g_err_lv) = msg("err_Not_AprvUsr");
		$g_msg = xpt_err_msg($g_msg, $w_usr_id, __LINE__);
		return 4000;
	}


	return 0;
}

#==================================================================
# check slice no
#==================================================================
function chk_slno($w_slno, &$r_slno, &$r_slcnt)
{
	global $g_msg;
	global $g_err_lv;

	list($g_msg, $g_err_lv) = msg("err_Inp_SlNo");

	$w_arr_slno = explode(",", $w_slno);
	$w_arr = array();

	for($i=0; $i<count($w_arr_slno); $i++){
		$sl = trim($w_arr_slno[$i]);
		#------------------------------------------------------------------
		# include hyphen
		#------------------------------------------------------------------
		if(preg_match("/\-/", $sl)){
			$w_spl = explode("-", $sl);

			### error if exists greater than 2 hyphen ex)1--5, 1-2-5
			if(count($w_spl) > 2){
				$g_msg = xpt_err_msg($g_msg, $sl, __LINE__);
				return 4000;
			}
			### error if empty around hyphen ex)1-, -2
			if($w_spl[0] == "" || $w_spl[1] == ""){
				$g_msg = xpt_err_msg($g_msg, $sl, __LINE__);
				return 4000;
			}
			### error if left value equal or greater than right value ex)6-1, 1-1
			if($w_spl[0] >= $w_spl[1]){
				$g_msg = xpt_err_msg($g_msg, $sl, __LINE__);
				return 4000;
			}

			for($j=(int)$w_spl[0]; $j<=(int)$w_spl[1]; $j++){
				$w_arr[] = sprintf("%02d", $j);
			}
		#------------------------------------------------------------------
		# not include hyphen
		#------------------------------------------------------------------
		} else {
			$w_arr[] = sprintf("%02d", $sl);
		}
	}

	### remove duplicates
	$w_arr = array_unique($w_arr);
	### sort
	sort($w_arr);
	reset($w_arr);


	$r_slcnt = count($w_arr);
	# return comma delimited
	$r_slno = implode(",", $w_arr);

	$g_msg    = "";
	$g_err_lv = "";

	return 0;
}

#==================================================================
# convert to unix time
#==================================================================
function cnvepc($w_dts)
{
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $w_dts);
	return mktime($h,$i,$s,$m,$d,$y);
}

#==================================================================
# initialize
#==================================================================
function set_init($w_mode, $w_rtn = 0)
{
	global $gw_scr;
	global $g_page_stp;
	
	### MODE1
	if($w_mode == 1){
		$gw_scr['s_usr_id']        	= "";
		$gw_scr['s_lot_id'] 		= "";
		$gw_scr['s_m_inp_cnt']     	= constant("INI_MLOT_CNT");
		$gw_scr['s_hdn_m_inp_cnt'] 	= constant("INI_MLOT_CNT");
		$gw_scr['s_s_inp_cnt']     	= constant("INI_SLOT_CNT");
		$gw_scr['s_hdn_s_inp_cnt'] 	= constant("INI_SLOT_CNT");
		$gw_scr['s_sl_inp_cnt']    	= constant("INI_SL_CNT");
		$gw_scr['s_mgzn_row']      	= constant("INI_MGZN_CNT");
		$gw_scr['s_hdn_mgzn_row']  	= constant("INI_MGZN_CNT");

        	$gw_scr['s_prd_nm']             = "";
        	$gw_scr['s_pkg_nm']             = "";
        	$gw_scr['s_prd_cd']             = "";
        	$gw_scr['s_stp_cd']             = "";
        	$gw_scr['s_lot_no']             = "";
		$gw_scr['s_equ_nm']		= "";

		
		$gw_scr['s_inp_chp_qty']   	= "";
		$gw_scr['s_inp_sub_qty']   	= "";
		$gw_scr['s_pas_chp_qty']   	= "";
		$gw_scr['s_rej_chp_qty']   	= "";
		$gw_scr['s_pas_sub_qty']   	= "";
		$gw_scr['s_rej_sub_qty']   	= "";

        	$gw_scr['s_list_bad_ctg_nm']    = array();
        	$gw_scr['s_list_bad_ctg_qty']   = array();
        	$gw_scr['s_list_bad_ctg_dvs']   = array();
        	$gw_scr['s_list_bad_ctg_cd']    = array();
        	$gw_scr['s_list_bad_num_flg']   = array();

	}

	### MODE2
	if($w_mode <= 2){
		$gw_scr['s_usr_nm'] = "";
		$gw_scr['s_stp_nm'] = "";
		$gw_scr['s_prd_nm_fin'] = "";
		$gw_scr['s_prd_cd_fin'] = "";

                $gw_scr['s_inp_chp_qty']        = "";
                $gw_scr['s_inp_sub_qty']        = "";
                $gw_scr['s_pas_chp_qty']        = "";
                $gw_scr['s_rej_chp_qty']        = "";
                $gw_scr['s_pas_sub_qty']        = "";
                $gw_scr['s_rej_sub_qty']        = "";

		$gw_scr['s_equ_cd']    = "";
		$gw_scr['s_ex_lot_id'] = "";

		$w_lot_id = $gw_scr['s_lot_id'];

		$gw_scr['s_m_prd_cd'] = "";
		$gw_scr['s_m_prd_nm'] = "";
		$gw_scr['s_lot_id']       = "";
		$gw_scr['s_prd_nm']       = "";
		$gw_scr['s_lot_no']       = "";
		$gw_scr['s_lot_no_str']   = "";
		$gw_scr['s_chp_qty']      = "";
		$gw_scr['s_adj_qty']      = "";
		$gw_scr['s_trt_qty']      = "";
		$gw_scr['s_pas_qty']      = "";
		$gw_scr['s_bad_qty']      = "";
		$gw_scr['s_real_qty']     = "";
		$gw_scr['s_hdn_comp_flg'] = "";
		$gw_scr['s_prd_cd']       = "";
		$gw_scr['s_stp_cd']       = "";
		$gw_scr['s_upd_lev']      = "";
		$gw_scr['s_spc_equinf']   = array();
		$gw_scr['s_srlz_baddtl']  = array();
		$gw_scr['s_pre_exst']     = array();

		$gw_scr['s_s_prd_cd'] = "";
		$gw_scr['s_s_prd_nm'] = "";
		$gw_scr['s_list_s_lot_id']       = array();
		$gw_scr['s_list_s_prd_nm']       = array();
		$gw_scr['s_list_s_lot_no']       = array();
		$gw_scr['s_list_s_lot_no_str']   = array();
		$gw_scr['s_list_s_chp_qty']      = array();
		$gw_scr['s_list_s_adj_qty']      = array();
		$gw_scr['s_list_s_trt_qty']      = array();
		$gw_scr['s_list_s_pas_qty']      = array();
		$gw_scr['s_list_s_bad_qty']      = array();
		$gw_scr['s_list_s_real_qty']     = array();
		$gw_scr['s_list_s_hdn_comp_flg'] = array();
		$gw_scr['s_list_s_prd_cd']       = array();
		$gw_scr['s_list_s_stp_cd']       = array();
		$gw_scr['s_list_s_upd_lev']      = array();
		$gw_scr['s_list_s_spc_equinf']   = array();
		$gw_scr['s_list_s_srlz_baddtl']  = array();
		$gw_scr['s_list_s_pre_exst']     = array();

		$gw_scr['s_m_bad_ctg_cnt'] = "";
		$gw_scr['s_s_bad_ctg_cnt'] = "";

		$gw_scr['s_nxt_rt_cd']     = "";
		$gw_scr['s_nxt_prc_cd']    = "";
		$gw_scr['s_nxt_stp_cd']    = "";
		$gw_scr['s_nxt_io_blc_cd'] = "";
		$gw_scr['s_nxt_stp_no']    = "";

		$gw_scr['s_lot_id'] = $w_lot_id;

		$gw_scr['s_need_aprv'] = "";
		$gw_scr['s_need_aprv_err'] = "";
		$gw_scr['s_aprv_usr_id'] = "";
		$gw_scr['s_aprv_pass'] = "";

		$gw_scr['s_m_inp_cnt']     = constant("INI_MLOT_CNT");
		$gw_scr['s_hdn_m_inp_cnt'] = constant("INI_MLOT_CNT");
		$gw_scr['s_s_inp_cnt']     = constant("INI_SLOT_CNT");
		$gw_scr['s_hdn_s_inp_cnt'] = constant("INI_SLOT_CNT");
                $gw_scr['s_aft_bad_ctg_cnt']  = "";
                $gw_scr['s_aft_srlz_baddtl'] = "";

		$gw_scr['s_list_s_slc_no']   = array();

	}

	### MODE3
	if($w_mode <= 3){
		$g_page_stp = "";
		$gw_scr['s_mgzn_flg']         = "";
		$gw_scr['s_prt_ctrl']         = "";
		$gw_scr['s_list_sl_m_lot_id'] = array();
		$gw_scr['s_sl_inp_cnt']       = constant("INI_SL_CNT");
		$gw_scr['s_aft_prd_nm']       = "";
		$gw_scr['s_aft_lot_no_str']   = "";
		$gw_scr['s_aft_bad_ctg_cnt']  = "";
		$gw_scr['s_aft_srlz_baddtl'] = "";

#		$gw_scr['s_list_sl_no']   = array();
		$gw_scr['s_pas_chp_qty'] = "";
		$gw_scr['s_rej_chp_qty']  = "";
		$gw_scr['s_list_mgzn_id'] = array();

		$gw_scr['s_cmt'] = "";
	}

	### MODE4
	if($w_mode == 3){
		$gw_scr['s_list_s_slc_no'] = $gw_scr['s_list_s_slc_hdn'];
	}

	return 0;
}
#==================================================================
# screen setting(before disp)
#==================================================================
function scr_bf_setting()
{
	global $gw_scr;
	global $g_mode;

	return;
}
#==================================================================
# screen setting(after disp)
#==================================================================
function scr_af_setting()
{
	global $gw_scr;
	global $g_mode;

	return;
}
#==================================================================
# set space
#==================================================================
function set_space($w_var)
{
	$w_rtn = $w_var;
	if($w_rtn == ""){
		$w_rtn = " ";
	}
	return $w_rtn;
}
#==================================================================
# Array re-index from 1
#==================================================================
function rearray(&$arr)
{
	if(isset($arr[0])){
		$tmp = array();
		$cnt = 0;
		for($i=0; $i<count($arr); $i++){
			$cnt++;
			$tmp[$cnt] = $arr[$i];
		}
		$arr = $tmp;
	}
	return;
}
#==================================================================
# serialize
#==================================================================
function userialize($w_arr)
{
	return bin2hex(serialize($w_arr));
}
#==================================================================
# unserialize
#==================================================================
function uunserialize($w_serial)
{
	return unserialize(pack("H*", $w_serial));
}
#==================================================================
# put an escape character($) if include wild card of SQL
#==================================================================
function str_escape($str){
	return str_replace(array('%', '_', '*'), array('$%', '$_', ''), $str);
}
#==================================================================
# round up to six decimal places
#==================================================================
function ceil_7($w_val){
	$w_str = (string)$w_val;
	list($w_int, $w_dec) = explode(".", $w_str);

	if(strlen($w_dec) > 6){
		if(substr($w_dec, 6, 1) != 0){
			$w_val = $w_val + 0.000001;
		}

		unset($w_int, $w_dec, $w_str);
		$w_str = (string)$w_val;
		list($w_int, $w_dec) = explode(".", $w_str);
		$w_dec = rtrim(substr($w_dec, 0, 6), "0");

		if(strlen($w_dec) > 1){
			$w_rtn_val = $w_int . "." . $w_dec;
		} else {
			$w_rtn_val = $w_int;
		}
	} else {
		$w_rtn_val = $w_val;
	}

	return $w_rtn_val;

}
#==================================================================
# set optional info in error message
#==================================================================
function get_tg()
{
	$w_arr = func_get_args();
	return implode("/", $w_arr);
}
#==================================================================
# simplified Lang function call
#==================================================================
function itm($var)
{
	return PS00S01001790_item($var);
}
function msg($var)
{
	return PS00S01001790_msg($var);
}
#******************************************************************
#******************************************************************
#******************************************************************
#******************************************************************
#******************************************************************
#
# MAIN START
#
#******************************************************************
#==================================================================
# DB connect
#==================================================================
$w_rtn = xdb_op_conndb();
if ($w_rtn != 0) {
	$g_err_lv = 0;
	$g_msg = xpt_err_msg($g_msg, "", __LINE__);
	return;
}
#==================================================================
# session
#==================================================================
if($gw_scr['s_act'] != "DOWNLOAD"){
if($gw_scr['s_rtn_flg']){
	get_session_convert();
}
# get the elements in session mode
get_session_mode();

if($gw_scr['s_cnfm_flg'] != "1" && $gw_scr['s_rtn_flg'] == "1"){
	$g_page_stp = "";
}
}
#==================================================================
# authentification
#==================================================================
if($gw_scr['s_act'] != "DOWNLOAD"){
$refe_flg=1;
require_once (getenv("GPRISM_HOME") . "/renzheng.php");
$bak_s_renzheng_t = $gw_scr['s_renzheng_t'];
$bak_s_renzheng   = $gw_scr['s_renzheng'];
}
#==================================================================
# process of each mode
#==================================================================
### screen setting befor disp
scr_bf_setting();
### check the function exists
$w_func = "main_md" . $g_mode;
if(function_exists($w_func)){
	$w_func();
} else {
	main_init();
}

$gw_scr['s_renzheng']   = $bak_s_renzheng;
$gw_scr['s_renzheng_t'] = $bak_s_renzheng_t;

scr_af_setting();
get_screen(1, null, 1);

#==================================================================
# DB close
#==================================================================
xdb_op_closedb();
?>
