<?php
# ======================================================================================
# [DATE]  : 2017.03.16					[AUTHOR]  : MIS)D.Winston
# [SYS_ID]: GPRISM					[SYSTEM]  : Gprism
# [SUB_ID]:						[SUBSYS]  : 
# [PRC_ID]:						[PROCESS] : 
# [PGM_ID]: PS00S01002310.php				[PROGRAM] : Track-Out(CCD)
# [MDL_ID]:						[MODULE]  : 
# --------------------------------------------------------------------------------------
# [COMMENT]
#
# --------------------------------------------------------------------------------------
# [UPDATE_LOG]
# 
# [UPDATE_PERSON]		[UPDATE]			[COMMENT]
# ====================	==================	============================================
# --------------------------------------------------------------------------------------
#******************************************************************
#
# PROGRAM SETTINGS
#
#******************************************************************
$g_Version = "2.0";
$g_PrgCD = "PS00S01002310";
#******************************************************************
#
# SET GLOBAL VARIABLE $gw_scr FROM <FORM> CONTENTS
#
#******************************************************************
if ($REQUEST_METHOD == "GET") {
	$gw_scr = cnv_formstr($_GET);
} else {
	$gw_scr = cnv_formstr($_POST);
}
#******************************************************************
#
# SET LANGUAGE AND ENCODING
#
#******************************************************************
$g_lang_path = $gw_scr['g_lang_path'];
$g_CharSet   = $gw_scr['g_CharSet'];
$g_usrId     = $gw_scr['usrId'];
$g_menuNo1   = $gw_scr['menuNo1'];
$g_menuNo2   = $gw_scr['menuNo2'];
$g_menuNo3   = $gw_scr['menuNo3'];
$g_menuNo4   = $gw_scr['menuNo4'];
#******************************************************************
#
# READ COMMON EXTERNAL FUNCTIONS
#
#******************************************************************
#------------------------------------------------------------------
# use among entire programs
#------------------------------------------------------------------
require_once (getenv("GPRISM_HOME") . "/DirList_pf.php");		# global variables of path list
require_once (getenv("GPRISM_HOME") . "/Func/Check.php");		# Input check
require_once ($g_func_dir . "/global.php");				# global variables
require_once ($g_func_dir . "/db_op.php");				# DB control
require_once ($g_func_dir . "/xdb_op.php");				# wrapper functions of DB control
require_once ($g_func_dir . "/xpt_err_msg.php");			# format of error message
#------------------------------------------------------------------
# for tracking
#------------------------------------------------------------------
require_once ($g_Mfunc_dir . "/xgt_dvsn.php");				# to get the division by menu
require_once ($g_func_dir . "/xgn_cd.php");				# get common code from name
require_once ($g_func_dir . "/xgn_prd.php");				# get prd_nm from prd_cd
require_once ($g_func_dir . "/xgc_prd.php");				# get prd_cd from prd_nm
require_once ($g_func_dir . "/xgn_pkg.php");				# get pkg_cd & pkg_nm from prd_cd
require_once ($g_func_dir . "/xgt_stp_cls.php");			# get stp_cls_2 & stp_cls_4 from stp_cd
require_once ($g_func_dir . "/xgt_lot.php");				# get lot_bas_tbl info from lot_id
require_once ($g_func_dir . "/xgt_lp2.php");
require_once ($g_func_dir . "/xgt_lp2_cd.php"); 
require_once ($g_func_dir . "/xgt_sp_lot_no_id.php");			# 
require_once ($g_func_dir . "/xgt_nio.php");				# get next io
require_once ($g_func_dir . "/xgt_npr.php");				# get next process
require_once ($g_func_dir . "/xgt_stp.php");				# get shp_cd
require_once ($g_func_dir . "/xck_upd.php");				# check upd_lev
require_once ($g_func_dir . "/xck_lio.php");				# check last io in current process
require_once ($g_func_dir . "/xck_rnk.php");				# check rank pattern
require_once ($g_func_dir . "/xgt_use_equ.php");			# get usable equ_cd for specified lot
require_once ($g_func_dir . "/xgt_ctg.php");				# get category info
require_once ($g_func_dir . "/xpt_qul_rep.php");			# print quality report
require_once ($g_func_dir . "/xgt_prt_wip.php");			# get parts wip info
require_once ($g_func_dir . "/xgt_cd_cnt.php");				# numbering code
require_once ($g_func_dir . "/cs_xpt_wip_tn.php");
require_once ($g_func_dir . "/cs_xpt_ccd_f0_test.php");
require_once ($g_func_dir . "/cs_xpt_scve.php");
require_once ($g_func_dir . "/cs_xgt_inhrt_po_data.php");              	# Ensure PO CTG_CD is inherited to child.

#------------------------------------------------------------------
# VERB
#------------------------------------------------------------------
require_once ($g_func_dir . "/ioin.php");				# track-In
require_once ($g_func_dir . "/ioot.php");				# track-Out
require_once ($g_func_dir . "/iomv.php");				# next step(io) Transfer
require_once ($g_func_dir . "/prpt.php");				# next step(over process) transfer
require_once ($g_func_dir . "/iosd.php");				# verb 
require_once ($g_func_dir . "/iosp.php");				# verb 
require_once ($g_func_dir . "/prpc.php");				# (ditto)
require_once ($g_func_dir . "/prgt.php");				# (ditto)
require_once ($g_func_dir . "/ioab.php");				# Lot close
require_once ($g_func_dir . "/iohd.php");				# Lot hold
require_once ($g_func_dir . "/mtin.php");				# material in
require_once ($g_func_dir . "/mtot.php");				# material out
require_once ($g_func_dir . "/mtcs.php");				# using material consumption
require_once ($g_func_dir . "/mthd.php");				# material hold

#------------------------------------------------------------------
# local functions
#------------------------------------------------------------------
require_once ($g_func_dir . "/cs_xgn_man.php");				# get user name(and check login user)
require_once ($g_func_dir . "/cs_xck_thd_jdg.php");			# threshold judgement & regist non_std_ctg_log
require_once ($g_func_dir . "/cs_xexc_hold_rsv.php");			# hold reserve check & execute lot hold
require_once ($g_func_dir . "/cs_xck_fifo_lot.php");			# check FIFO
require_once ($g_func_dir . "/cs_xck_jig.php");				# check jig
require_once ($g_func_dir . "/cs_xck_abn_snd_lot.php");			# check SPACE
require_once ($g_func_dir . "/cs_xck_pilot_jdg.php");			# check pilot judgement
require_once ($g_func_dir . "/cs_xgt_equ_data.php");			# check equipment interaction data
require_once ($g_func_dir . "/cs_xck_train_validate.php");      	# For Training Validation
require_once ($g_func_dir . "/cs_xck_trc_time.php");			# check trace time
require_once ($g_func_dir . "/cs_xck_prt_ctrl.php");			# check parts control
require_once ($g_func_dir . "/cs_xck_exst_child.php");			# for BP2 Control
require_once ($g_func_dir . "/cs_xgt_par_dat.php");
require_once ($g_func_dir . "/cs_xck_abn_snd_summary.php");		# check SPACE summary (BP2)
require_once ($g_func_dir . "/cs_xck_backfill_abn_snd_lot.php");        # check Backfill
require_once ($g_func_dir . "/cs_xck_backfill_web_service.php"); 	# Check Backfill Web Service Header only.

#------------------------------------------------------------------
# for screen
#------------------------------------------------------------------
require_once ($g_lang_dir . "/buttonM.php");				# button name
require_once ($g_lang_dir . "/PS00S01002310M.php");			# message
require_once ($g_Gfunc_dir . "/xpt_screen.php");			# create screen

#******************************************************************
#
# DEFINITION
#
#******************************************************************
#------------------------------------------------------------------
# for display
#------------------------------------------------------------------
define("MAX_CHP_BAD_BLC",			4);
define("MAX_CHP_BAD_COL",			5);
define("MAX_CHP_BAD",				constant("MAX_CHP_BAD_BLC") * constant("MAX_CHP_BAD_COL"));
define("MAX_BAR_BAD_BLC",			4);
define("MAX_BAR_BAD_COL",			5);
define("MAX_BAR_BAD",				constant("MAX_BAR_BAD_BLC") * constant("MAX_BAR_BAD_COL"));
define("DEF_MGZN_ROW",				4);
#------------------------------------------------------------------
# init value
#------------------------------------------------------------------
#------------------------------------------------------------------
# category division
#------------------------------------------------------------------
define("CE_CHP_BAD",				"CESEM01");
define("CE_LTINF",				"CE00S02");				# Lot Information
define("CE_HOLDINF",				"CE00S03");
define("CE_BLCKCS", 				"CE00S04");
define("CE_MAGJIG", 				"CE00S04");
define("CE_LOT",				"CE00S02");

#------------------------------------------------------------------
# category code
#------------------------------------------------------------------
define("CT_F0_TEST_TRACKIN", 			"CT2100000001");
define("CT_F0_TEST_TRACKOUT", 			"CT2100000001");
define("CT_PP_INPUT",			'CT21S0000003'); 		# Picture Perusal Input
define("CT_PP_FAIL",                    'CT21S0000004');                # Picture Perusal Fail
define("CT_PP_YIELD",                   'CT21S0000005');                # Picture Perusal Yield
define("CT_TEST_PGM",					"CT00S0000254");
define("CT_TEST_FIXTURE",				"CT00S0000255");
define("CT_TEST_TESTER",				"CT00S0000256");

define("CT_SUBQTY",				"CT00S0000152");
define("CT_PHYQTY",				"CT00S0000107");
define("CT_ABNINF",				"CT00S0000013");
define("CT_CRACK",				"CT00S0000145");
define("CT_METAL_WGHT",				"CT00S0000146");
define("CT_UVIRD",				"CT00S0000099");
define("CT_BAKING1",				"CT00S0000143");
define("CT_BAKING2",				"CT00S0000144");
define("CT_BP2CTL",				"CT00S0000158");
define("CT_NOCONSUMEHIST",			"CT00S0000158");
define("MA_QAUSER",				"MASEMQA0001");
define("CT_BAKING_TIME_BAKING",			"CT00S0000148");
define("CT_CALCULATED_PHYSICAL_QTY",		"CT11S0000232");
define("CT_MAGJIG", "CT00S0000024");
define("CT_SUBSTRATE", "CT00S0000152");

define("CT_EXPIRED_DATE",	"CT00S0000099");
define("CT_OK1OK2",		"CT21S0000020");

#------------------------------------------------------------------
### SH
#------------------------------------------------------------------
define("SH_MAGJIG", "SH00S998");
define("SH_BLCKCS", "SH00S990");

#------------------------------------------------------------------
# tag
#------------------------------------------------------------------
define("TG_MA",					"MA");				# User ID
define("TG_LT",					"LT");				# Lot ID

#------------------------------------------------------------------
# for judgement
#------------------------------------------------------------------
define("CU_HOLD",				"CUSEM998");				# Cause Code : Auto Hold

        

define("P0_SCRATCH_CHIP", 		"P000S018");
define("P0_WFR_EXP_LIMIT", 		"P000S017");


### for quality report
define("P0_LOTTRC",				"P0SEM001");
define("REP_ABN_LOT",				"REPORT_OF_ABN_LOT");

### popup window for judgement results
define("PRG_CD_CHD",				"PS00S02000380");
define("WDS_TOP",				0);
define("WDS_LFT",				200);
define("WDS_WID",				700);
define("WDS_HEI",				700);

#------------------------------------------------------------------
# for magazine
#------------------------------------------------------------------
define("CE_MAG",				"CE00S04");
define("CT_MAG",				"CT00S0000024");
define("JI_JIG",				"JI00S001");
define("SH_JIG",				"SH00S998");

#------------------------------------------------------------------
# etc
#------------------------------------------------------------------
define("B7_CHPMNG",				"B7SEM003");
define("B7_SUBMNG",				"B7SEM004");
define("B7_SLCMNG",				"B7SEM005");
define("D6_INSPECTION",				"D6SEM005");
define("MIN_MGZN_ROW",				"1");
define("MAX_MGZN_ROW",				"10");
define("TXT_CRACK",				"Hairline Crack");
define("TXT_BP2",				"BP2 Control");
define("ID_CLS_LOTID",				1);
define("CD_CNT_DVS_RSV",			"HOLD_RSV");
define("CMT_MOLDRSVHOLD",			"MOLD TIME NG");
define("UVLIMIT_DAYS",				30);
define("PM_TESTER",				"PM00S0000001");
define("PM_FIXTURE",				"PM00S0000002");
define("PM_OK1OK2",				"PM21S0000001");
define("PM_CHILDPARTNO",				"PM21S0000002");

#------------------------------------------------------------------
# E9
#------------------------------------------------------------------
define("E9_MANUAL_TFR_PROCESS",			"E911S300");			# MANUAL TRANSFER PROCESS
define("E9_UVIRD",				"E911S060");
define("E9_MOLDCURE",				"E911S210");
define("E9_WASHDRY",				"E911S260");
define("E9_PASTECURE2",				"E911S850");
define("E9_PCKVI",				"E911S590");
define("E9_BAKING",				"E911S630");
define("E9_PACKING",				"E911S680");
define("E9_JIG",				"E911S270");
define("E9_QC_GATE",			serialize(array("E911S530")));
define("E9_PIC_PRSL_TEST",	serialize(array(
	"E921S018"			# PICTURE PERUSAL STEP

	))
	);

# disabled step(E9) in this program
define("E9_NG",			serialize(array(
	"E911S020",
	"E911S030",
	"E911S090",
	"E911S120",
	"E911S130",
	"E911S140",
	"E911S150",
	"E911S290", # ROM ASSIGNMENT
	"E911S866", # ROM ASSIGNMENT 2
	"E911S670",
	"E911S400",
	"E911S470",
	"E911S480",
	"E911S490",
	"E911S500",
	"E911S540",
	"E911S550",
	"E911S610",
	"E911S620",
	"E911S350",
	"E911S360",
	"E911S160"
)));

define("PACK_PCS",                    serialize(array(
        0 => "",
        1 => "Y",
        2 => "N"
)));

define("E9_PCS_PACKING", serialize(array(
	'E911S680', #PACKING
)));

define("E9_WAFER_MOUNTING", serialize(array(
	'E921S006', # ST21S0000006 Wafer Mounting
)));

define("E9_F0_TEST", serialize(array(
	'E911S310', # ST21S0000006 Wafer Mounting
	'E911S320'
)));
#------------------------------------------------------------------
# E8
#------------------------------------------------------------------
define("E8_WASHDRY",			"E811S260");

#------------------------------------------------------------------
# AW
#------------------------------------------------------------------
define("AW_BP2_CONTROL",                        	"AW11S0000008");
define("AW_MTL_CONSUMPTION",                       	"AW00S0000011");
define("AW_PHYSICAL_ADJ",				"AW00S0000056");
define("AW_CHIP_QTY_PER_TRAY",				"AW00S0000057");
define("AW_AUTO_TRF_STP_CD",				"AW00S0000062");	#AUTO TRANSFER OUT 
define("AW_AUTO_TRF_QTY",				"AW00S0000063");	#AUTO TRANSFER OUT 
define("AW_AUTO_TRF_SECTION",				"AW00S0000064");	#AUTO TRANSFER OUT 
define("AW_WP_SEAL_CD",                                  "AW00S0000045");

define("E0_GOLD_WIRE",                                  "E000S010");


#------------------------------------------------------------------
#------------------------------------------------------------------
# material management
#------------------------------------------------------------------
define("PGM_MTMNG",					"PS00S04000030");
#------------------------------------------------------------------
# for material hold
#------------------------------------------------------------------
define("CUS_MTMNG",					"CUSEM997");
define("CMT_THAW",					"MATERIAL THAWING TIME NG");
define("CMT_LIFE",					"MATERIAL LIFE TIME NG");
define("CMT_EXP",					"MATERIAL EXPIRED TIME NG");
#------------------------------------------------------------------
# for SPACE
#------------------------------------------------------------------
define("SPC_WARN_ABN",			"ABN");
define("SPC_WARN_PCS",			"PCS");
define("SPC_WARN_MBN",			"MBN");
define("SPC_WARN_CON",			"CON");
define("SPC_WARN_ABNPCS",		"ABNPCS");
define("SPC_ERRCD_NRM",			"xxxxx1");
define("SPC_ERRCD_ABN",			"xxxxx2");
define("SPC_ERRCD_PCS",			"xxxxx3");
define("SPC_ERRCD_ABNPCS",		"xxxxx4");
define("SPC_ERRCD_BP2",			"xxxxx5");
define("CU_ABNPCS",			"CUSEM007");
define("CU_MBN",			"CUSEM005");
define("CU_AUTO",			"CUSEM998");


### for Bind No
define("BIND_CNT_DVS",			"WIP_TN");
define("BIND_PRFX",			"WIP");
define("WIPNOTE_HINA",			"PS00S03000060");
define("LSI_DVSN",                      "ABSEM31"); # LSI
define("TR_DVSN",                       "ABSEM41"); # TR
define("BGA_DVSN",                      "ABSEM11"); # BGA
define("LD_DVSN",                       "ABSEM49"); # LD

#******************************************************************
#
# FUNCTIONS
#
#******************************************************************
#==================================================================
# convert form data
#==================================================================
function cnv_formstr($w_req)
{
	reset($w_req);
	while(list($key, $val) = each($w_req)){
		if(is_array($val)){
			$w_arr = cnv_formstr($val);
			$w_scr[$key] = $w_arr;
		} else {
			if(get_magic_quotes_gpc()){
				$val = stripslashes($val);
			}
			$w_scr[$key] = $val;
		}
	}

	return $w_scr;
}
###################################################################
#####                                                         #####
##### FIRST PROCESS                                           #####
#####                                                         #####
###################################################################
#==================================================================
# initialize
#==================================================================
function main_init()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	set_init(1);
	scr_mode_chg(1);

	return 0;
}

###################################################################
#####                                                         #####
##### MODE1                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode1
#==================================================================
function main_md1()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	reset_sealing();
	switch($gw_scr['s_act']){
	case "CHECK":
		main_md1_chk();
		break;
	case "ERASE":
		main_init();
		break;
	}

	return 0;
}
#==================================================================
# mode1 [Check] process
#==================================================================
function main_md1_chk()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	# for warning message
	$w_warn = array();

	#------------------------------------------------------------------
	# input check
	#------------------------------------------------------------------
	$w_rtn = check_input(1);
	if($w_rtn != 0){
		return 4000;
	}

	# convert if specified PCL label format
	$gw_scr['s_hdn_lot_id'] = $gw_scr['s_lot_id'];
	if(substr($gw_scr['s_lot_id'], 0, 2) == "B "){
		$w_arr = explode(" ", $gw_scr['s_lot_id']);
		$gw_scr['s_hdn_lot_id'] = $w_arr[1];
	}

	#------------------------------------------------------------------
	# get user name
	#------------------------------------------------------------------
	$w_rtn = cs_xgn_man($gw_scr['s_usr_id'], $w_usr_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_usr_id'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# get lot_bas_tbl info
	#------------------------------------------------------------------
	$w_rtn = xgt_lot($gw_scr['s_hdn_lot_id'], $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_hdn_lot_id'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check lot state
	#------------------------------------------------------------------
	$w_rtn = ioot_st_check($w_lot_bas['LOT_ST_DVS']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_hdn_lot_id'], __LINE__);
		return 4000;
	}
	

	#------------------------------------------------------------------
        # Check Lot is Valid Division or not
        #------------------------------------------------------------------
        if($w_lot_bas['DVSN_CD_PRC'] != constant('BGA_DVSN')) {

                if($w_lot_bas['DVSN_CD_PRC'] == constant('LSI_DVSN') || 
                  $w_lot_bas['DVSN_CD_PRC'] == constant('TR_DVSN')){          # If LSI AND TR
                        list($g_msg, $g_err_lv) = msg("err_dvsn_lsi");
                }else if($w_lot_bas['DVSN_CD_PRC'] == constant('LD_DVSN')){     # If LD
                        list($g_msg, $g_err_lv) = msg("err_dvsn_ld");
                }else{                                                          # If invalid
                        list($g_msg, $g_err_lv) = msg("err_dvsn_not_valid");
                }
                $g_msg = xpt_err_msg($g_msg, trim($w_stpcls2), __LINE__);
                return 4000;
        }

	#------------------------------------------------------------------
        # Checking Backfill
        #------------------------------------------------------------------
        $w_web_err_cd = "";
        $w_web_err_nm = "";
        $w_web_err_msg = "";
        $w_rtn = chk_backfill($gw_scr['s_usr_id'],
                                                $w_lot_bas['LOT_ID'],
                                                "Y",
                                                $w_lot_bas['EQU_CD'],
                                                $w_lot_bas['CHP_QTY'],
                                                "",
                                                $gw_scr['s_prg_id'],
                                                $w_web_err_cd,
                                                $w_web_err_nm,
                                                $w_web_err_msg);
        if($w_rtn != 0) return 4000;
        ###
        if($w_web_err_cd == "0"){
                list($g_msg, $g_err_lv) = msg("err_Err_backfill");
                $g_msg = xpt_err_msg($g_msg, $w_web_err_nm, __LINE__);
                return 4000;
        }

        if($w_web_err_cd == "2"){
                list($g_msg, $g_err_lv) = msg("err_Warn_backfill");
                $g_msg = xpt_err_msg($g_msg, $w_web_err_nm, __LINE__);
                $w_warn[] = $g_msg;
        }

	#Training Validation Checking
        $w_rtn = cs_xck_train_validate($gw_scr['s_usr_id'], $w_lot_bas['LOT_ID'], $w_lot_bas['EQU_CD'], $w_lot_bas['STP_CD'], $w_allow);
        if ($w_rtn != 0) {
                $g_err_lv = 0;
                $g_msg = xpt_err_msg($g_msg, $gw_scr['s_usr_id'], __LINE__);
                return 4000;
        }else {
                if(!$w_allow){
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, $gw_scr['s_urs_id'], __LINE__);
                        return 4000;
                }
        }


	#------------------------------------------------------------------
	# check allowed step
	#------------------------------------------------------------------
	# get stp_cls
	$w_rtn = xgt_stp_cls($w_lot_bas['STP_CD'], $w_stpcls2, $dmy);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['STP_CD']), __LINE__);
		return 4000;
	}
	if(in_array(trim($w_stpcls2), unserialize(constant('E9_NG')))){
		list($g_msg, $g_err_lv) = msg("err_Disabled");
		$g_msg = xpt_err_msg($g_msg, trim($w_stpcls2), __LINE__);
		return 4000;
	}
	if (in_array(trim($w_stpcls2), unserialize(constant("E9_PCS_PACKING")))) {
                //new code
                $gw_scr['edit_enable'] = false;
		$gw_scr['s_is_packing'] = true;
        }
	# can be specified 'B(space)' only in packing step.
	if(substr($gw_scr['s_lot_id'], 0, 2) == "B "
	&& trim($w_stpcls2) != constant("E9_PACKING")
	){
		list($g_msg, $g_err_lv) = msg("err_Inp_Tag");
		$g_msg = xpt_err_msg($g_msg, itm("LotID"), __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# get next process info
	#------------------------------------------------------------------
	$w_rtn = get_next_process(trim($w_lot_bas['RT_CD']),
							  trim($w_lot_bas['PRD_CD']),
							  trim($w_lot_bas['STP_CD']),
							  $w_next_dat);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# get process flow info
	#------------------------------------------------------------------
	$w_rtn = get_prcflwinf($w_lot_bas['PRC_CD'], $w_lot_bas['STP_NO'], $w_prcflw);
	if($w_rtn != 0){
		return 4000;
	}
	$w_rtn = get_prcflwinf($w_next_dat['PRC_CD'], $w_next_dat['STP_NO'], $w_nxtprcflw);
	if($w_rtn != 0){
		return 4000;
	}
	if(count($w_prcflw) == 0){
		list($g_msg, $g_err_lv) = msg("err_PrcFlw");
		$g_msg = xpt_err_msg($g_msg, trim($w_lot_bas['PRC_CD']), __LINE__);
		return 4000;
	}
	if(count($w_nxtprcflw) == 0){
		list($g_msg, $g_err_lv) = msg("err_PrcFlw");
		$g_msg = xpt_err_msg($g_msg, trim($w_next_dat['PRC_CD']), __LINE__);
		return 4000;
	}



	#-------------------------------------------------------------------
	# Wafer Mounting Step (expiry date)
	#-------------------------------------------------------------------
	$w_lot_exp_dts = null;
	$w_wfr_mnt_flg = 0;
	if (in_array(trim($w_stpcls2), unserialize(constant("E9_WAFER_MOUNTING")))) {
		
        $w_rtn = get_wafer_mount_expiry_date($w_lot_exp_dts);
		if ($w_rtn != 0) {
		    $g_err_lv = 0;
		    $g_msg = xpt_err_msg($g_msg, $w_lot_exp_dts, __LINE__);
		    return 4000;
		}
		$w_wfr_mnt_flg = 1;
	}

	#Wafer mounting step End

	#Get f0-test Track Out Date
	// $w_rtn = get_lotinf($w_lot_bas['LOT_ID'],  constant("CE_LTINF"), constant("CT_F0_TEST_TRACKOUT"), $w_lot_f0_trkin_inf);
	// if($w_rtn != 0){
	// 	$g_err_lv = 0;
	// 	$g_msg = xpt_err_msg($g_msg, "", __LINE__);
	// 	return 4000;
	// }
	// if(count($w_lot_f0_trkin_inf)>0){
	// 	$w_rtn = cs_xpt_ccd_f0_test__is_expire($w_lot_bas['LOT_ID'], constant("CT_F0_TEST_TRACKOUT"), $w_expiry_status);
	// 	if($w_rtn != 0){
	// 		$g_err_lv = 0;
	// 		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
	// 		return 4000;
	// 	}

	// 	if(!$w_expiry_status){
	// 		list($g_msg, $g_err_lv) = msg("err_F0_test_expired");
 //            $g_msg = xpt_err_msg($g_msg, trim($w_stpcls2), __LINE__);
 //            return 4000;
	// 	}
	// }

	# F0-TEST Expiry Checking END

	#-------------------------------------------------------------------
	# OK 1/ OK 2 Checking
	#-------------------------------------------------------------------
	
	$w_f0_test_flg = 0;
	$w_ok_flg = 0;
	if (in_array(trim($w_stpcls2), unserialize(constant("E9_F0_TEST")))) {
		$w_f0_test_flg = 1;
		#check ok ok control.

		$w_ok_flg = 1;
        
	}

	# OK1 Ok2 Checking End

	#-------------------------------------------------------------
    # PICTURE PERUSAL - DATA LOADING
    #--------------------------------------------------------------

	#get existing qty
	$w_rtn = get_ctglog($w_lot_bas['LOT_ID'], constant("CE_LTINF"), constant("CT_PP_INPUT"), &$r_dat);

	if($w_rtn != 0) {
	    	$g_err_lv = 0;
        	$g_msg = xpt_err_msg($g_msg, $w_lot_bas['LOT_ID'], __LINE__);
            	return 4000;
        }
        if(count($r_dat) > 0){
        	$w_pct_prsal_input = trim($r_dat['CTG_DAT_TXT']);
    	}
    $w_rtn = get_ctglog($w_lot_bas['LOT_ID'], constant("CE_LTINF"), constant("CT_PP_FAIL"), &$r_dat);

	if($w_rtn != 0) {
	    	$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['LOT_ID'], __LINE__);
		return 4000;
        }

        if(count($r_dat) > 0){
        	$w_pct_prsal_fail = trim($r_dat['CTG_DAT_TXT']);
        }
    
     $w_rtn = get_ctglog($w_lot_bas['LOT_ID'], constant("CE_LTINF"), constant("CT_PP_YIELD"), &$r_dat);

	if($w_rtn != 0) {
	    	$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['LOT_ID'], __LINE__);
		return 4000;
        }

        if(count($r_dat) > 0){
        	$w_pct_prsal_yield = trim($r_dat['CTG_DAT_TXT']);
    	}


		$w_powerEye_yield = 0;

		$w_rtn = getBUYield($w_lot_bas["PRD_CD"],$w_lot_bas["STP_CD"],$yld_buff);
		if($w_rtn == 0){
			$w_powerEye_yield = round($yld_buff / 100,4);
			
		}

	#-----------------------------------------------------------------
	# END PICTURE PERUSAL
	#-----------------------------------------------------------------

	#-------------------------------------------------------------------
	# QC Gate
	#-------------------------------------------------------------------
		
	$w_smp_flg = 0;
	
	if (in_array(trim($w_stpcls2), unserialize(constant("E9_QC_GATE")))) {
		$w_f0_test_flg = 1;
		#check ok ok control.

		$w_smp_flg = 1;
        
	}

	$w_pp_flg = 0;
	if (in_array(trim($w_stpcls2), unserialize(constant("E9_PIC_PRSL_TEST")))) {
		$w_pp_flg = 1;
		#check if perusalstep

	
	}
	

	# QC Gate Checking End

	#Wipe Protect Seal Check

	$w_wp_seal_flg = 0;
	$w_rtn = check_wp_seal_flag($w_lot_bas['PRD_CD'], $w_is_wp_flg);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	if($w_is_wp_flg){
		$w_wp_seal_flg = 1;
	}

	#Wipe Protect Seal  END
	

	#------------------------------------------------------------------
	# get substrate qty / physical qty
	#------------------------------------------------------------------
	$w_sub_flg = 0;
	$w_nxt_sub_flg = 0;
	### if current step is substarte manage
	if($w_prcflw['BLC_CLS_3'] == constant("B7_SUBMNG")){
		$w_sub_flg = 1;
		#------------------------------------------------------------------
		# get substrate qty
		#------------------------------------------------------------------
		$w_rtn = get_lotinf($gw_scr['s_hdn_lot_id'],
							constant("CE_LTINF"),
							constant("CT_SUBQTY"),
							$w_subinf);
		if($w_rtn != 0) return 4000;

		if(count($w_subinf) == 0){
			list($g_msg, $g_err_lv) = msg("err_NotDatLotInf");
			$g_msg = xpt_err_msg($g_msg, itm("SubQty"), __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# get physical qty (might not need)
		#------------------------------------------------------------------
		$w_rtn = get_lotinf($gw_scr['s_hdn_lot_id'],
							constant("CE_LTINF"),
							constant("CT_PHYQTY"),
							$w_phyinf);
		if($w_rtn != 0) return 4000;

		### if next step is substarte manage, set flag
		if($w_nxtprcflw['BLC_CLS_3'] == constant("B7_SUBMNG") || $w_nxtprcflw['BLC_CLS_3'] == constant("B7_SLCMNG")){
			$w_nxt_sub_flg = 1;
		}
	}
	#------------------------------------------------------------------
	# get dummy bonding qty if current step is first inspection.
	#------------------------------------------------------------------
	$w_dmybndqty = "";
	$w_rtn = get_prcmstinf($w_lot_bas['PRC_CD'], $w_prcmstinf);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRC_CD'], __LINE__);
		return 4000;
	}
	$gw_scr['s_dum_flg'] = 0;
	if($w_prcmstinf['PRC_CLS_4'] == constant("D6_INSPECTION") && $w_lot_bas['STP_NO'] == 1){
		#------------------------------------------------------------------
		# get physical qty 
		#------------------------------------------------------------------
		$w_rtn = get_lotinf($gw_scr['s_hdn_lot_id'],
							constant("CE_LTINF"),
							constant("CT_PHYQTY"),
							$w_phyqty_inf);
		if($w_rtn != 0) return 4000;
		$w_dmybndqty = $w_phyqty_inf['CTG_DAT_VAL'] - $w_lot_bas['CHP_QTY'];
		if($w_phyqty_inf['CTG_DAT_VAL']) {
			$gw_scr['s_dum_flg'] = 1;
		}
	}
	#------------------------------------------------------------------
	# get slice qty 
	#------------------------------------------------------------------
	$w_sl_flg = 0;
	$w_sl_qty = "";
	### if current step is slice manage
	if($w_prcflw['BLC_CLS_3'] == constant("B7_SLCMNG")){
		$w_sl_flg = 1;
		$w_sl_qty = $w_lot_bas['SL_QTY'];
	}
	
	#------------------------------------------------------------------
	# check SPC
	#------------------------------------------------------------------
	$w_rtn = chk_spc_equ($gw_scr['s_hdn_lot_id'], $w_spc_equinf);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# check trace time
	#------------------------------------------------------------------
	$w_rtn = cs_xck_trc_time("IOOT", $w_lot_bas, $w_trc_chk,$w_trc_inf);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	} 

	### result 'NG'
	$w_expire_flg = 0;
	$w_postcu_flg = 0;
	$w_pastec_flg = 0;
	$w_warn_flg = 0;
	if($w_trc_chk > 0) {
		for($i=0; $i<$w_trc_chk;$i++){
			if($w_trc_inf[$i][3] == 4){
				$w_expire_flg = 1;
				#if current step is 'Post mold cure'
				if($w_stpcls2 == constant("E9_MOLDCURE") && (in_array(trim($w_trc_inf[$i][0]), array( 'ST11S0000017','ST11S0000090' )))) {
					# NOT show warning. but hold reserve info will be registered when execute after IOOT.
					# other step
					$w_pastec_flg = 1;
				} else {
					# show warning that this Lot will be HOLD
					$w_postcu_flg = 1;
					$w_warn_flg = 1;
				}
			}
		}
	}
	if($w_warn_flg != 0) {
             # show warning that this Lot will be HOLD
             list($w_msg, $w_lv) = msg("warn_TrcTime_NG");
             $w_msg = xpt_err_msg($w_msg, $gw_scr['s_hdn_lot_id'], __LINE__);
             $w_warn[] = $w_msg;
	}
	#------------------------------------------------------------------
	# check magazine management step
	#------------------------------------------------------------------
    	$w_rtn = cs_xck_jig_srch(trim($w_lot_bas['PRC_CD']),
							 trim($w_lot_bas['STP_CD']),
							 trim($w_lot_bas['PRD_CD']),
							 constant("JI_JIG"),
							 $w_prt_grp_b, $w_prt_grp_a, $w_jig_chg_id);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	# if magazine management step
	$w_mgzn_flg = 0;
	$w_no_mgz = 0;
	if($w_prt_grp_a != ""){
		#------------------------------------------------------------------
		# get magazine ID
		#------------------------------------------------------------------
		$w_rtn = cs_xck_jig_get_lot(trim($gw_scr['s_hdn_lot_id']), constant("JI_JIG"), "2", $w_prt_grp_b,
                                    $w_prt_grp_a, $w_jig_chg_id, $w_mag_id_b);
        	if($w_rtn != 0){
            		$g_err_lv = 3;
            		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
#           		return 4000;
			$w_no_mgz = 1;	
        	} 
	
		$w_mgzn_flg = 1;

        	### hold(not change)
        	if($w_prt_grp_a != "" && $w_prt_grp_b != "" && $w_jig_chg_id == "HOLD"){
			if($w_no_mgz == 1){
                		$w_mgzn_flg = 0;
			}
        	}

	
	}

	#------------------------------------------------------------------
	# get reject category
	#------------------------------------------------------------------
	$w_rtn = xgt_ctg($w_lot_bas['PRD_CD'],
					 $w_lot_bas['STP_CD'],
					 array(1 => constant("CE_CHP_BAD")),
					 $w_list_chp_bad_ctg_cd,
					 $w_list_chp_bad_lst_no,
					 $w_list_chp_bad_ctg_nm,
					 $w_list_chp_bad_ctg_dvs,
					 $w_list_chp_bad_num_flg,
					 $w_chp_bad_cnt, null, 1);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# get other Lot info
	#------------------------------------------------------------------
	### io block name
	$w_rtn = xgn_cd($w_lot_bas['IO_BLC_CD'], 1, $w_io_blc_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['IO_BLC_CD'], __LINE__);
		return 4000;
	}
	# equipmet name
	$w_rtn = xgn_cd($w_lot_bas['EQU_CD'], 1, $w_equ_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_equ_cd'], __LINE__);
		return 4000;
	}
	### product name
	$w_rtn = xgn_prd($w_lot_bas['PRD_CD'], $w_prd_nm, $dmy);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRD_CD'], __LINE__);
		return 4000;
	}
	### package name
	$w_rtn = xgn_pkg($w_lot_bas['PRD_CD'], 1, $w_pkg_cd, $w_pkg_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRD_CD'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check FIFO
	#------------------------------------------------------------------
	### get last update datetime
	global $g_low_dts;
	$w_last_dts = "";
	if($w_lot_bas['OUT_DTS_B'] != $g_low_dts){
		$w_last_dts = $w_lot_bas['OUT_DTS_B'];
	} elseif ($w_lot_bas['UPD_DTS'] != $g_low_dts){
		$w_last_dts = $w_lot_bas['UPD_DTS'];
	} else {
		$w_last_dts = $w_lot_bas['CRT_DTS'];
	}
	### check FIFO
	$w_rtn = cs_xck_fifo_lot($w_fifo_lot,
							 $w_lot_bas['PRD_CD'],
							 $w_lot_bas['PRC_CD'],
							 $w_lot_bas['IO_BLC_CD'],
							 $w_last_dts);
	if($w_rtn != 0){
		if(count($w_fifo_lot) > 0){
			$w_warn[] = xpt_err_msg($g_msg, implode("/", $w_fifo_lot), "");
		} else {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	#------------------------------------------------------------------
	# check material control
	#------------------------------------------------------------------
	$w_rtn = cs_xck_prt_ctrl($w_lot_bas['PRD_CD'], $w_lot_bas['STP_CD'], $w_prt_ctrl,
					$dmy, $dmy, $dmy, $dmy, $dmy, $dmy, $dmy);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

        #------------------------------------------------------------------
        # Check lot need physical adjustment
        #------------------------------------------------------------------
	$is_need_physical_adj = "0";	
	if(constant('E9_JIG') == $w_stpcls2) {
        	$w_rtn = check_physical_adj_flg($w_lot_bas['PRD_CD'], $is_need_physical_adj);
	        if($w_rtn != 0){
        	        $g_err_lv = 0;
                	$g_msg = xpt_err_msg($g_msg, "", __LINE__);
	                return 4000;
        	}
	}

	

	#------------------------------------------------------------------
	# set screen array variable
	#------------------------------------------------------------------
	$gw_scr['s_usr_nm']      		= trim($w_usr_nm);
	$gw_scr['s_upd_lev']     		= trim($w_lot_bas['UPD_LEV']);
	$gw_scr['s_sub_flg']     		= $w_sub_flg;
	$gw_scr['s_wfr_mnt_flg']		= $w_wfr_mnt_flg;
	$gw_scr['s_nxt_sub_flg'] 		= $w_nxt_sub_flg;
	$gw_scr['s_mgzn_flg']    		= $w_mgzn_flg;
	$gw_scr['s_expire_flg']  		= $w_expire_flg;
	$gw_scr['s_pastec_flg']  		= $w_pastec_flg;	
	$gw_scr['s_postcu_flg']  		= $w_postcu_flg;
	$gw_scr['s_lot_exp_dts']		= $w_lot_exp_dts;
	$gw_scr['s_sl_flg']     		= $w_sl_flg;
	$gw_scr['s_stp_nm']     		= trim($w_io_blc_nm);
	$gw_scr['s_equ_nm']     		= trim($w_equ_nm);
	$gw_scr['s_prd_nm']     		= trim($w_prd_nm);
	$gw_scr['s_rnk_ptn']    		= trim($w_lot_bas['RNK_PTN']);
	$gw_scr['s_pkg_nm']     		= trim($w_pkg_nm);
	$gw_scr['s_lot_no_str'] 		= trim($w_lot_bas['LOT_NO']);
	$gw_scr['s_inp_chp_qty'] 		= trim($w_lot_bas['CHP_QTY']);
	$gw_scr['s_inp_sub_qty'] 		= trim($w_subinf['CTG_DAT_VAL']);
	$gw_scr['s_inp_phy_qty'] 		= trim($w_phyinf['CTG_DAT_VAL']);
	$gw_scr['s_inp_sl_qty'] 		= trim($w_sl_qty);
	$gw_scr['s_is_need_physical_adj'] 	= $is_need_physical_adj;
	$gw_scr['s_dmybndqty'] 			= $w_dmybndqty;	
	$gw_scr['s_chp_bad_cnt']          	= $w_chp_bad_cnt;
	$gw_scr['s_list_chp_bad_ctg_nm']  	= $w_list_chp_bad_ctg_nm;
	$gw_scr['s_list_chp_bad_ctg_cd']  	= $w_list_chp_bad_ctg_cd;
	$gw_scr['s_list_chp_bad_ctg_dvs'] 	= $w_list_chp_bad_ctg_dvs;
	$gw_scr['s_list_chp_bad_num_flg'] 	= $w_list_chp_bad_num_flg;
	$gw_scr['s_list_chp_bad_ctg_qty'] 	= $w_list_chp_bad_ctg_qty;
	$gw_scr['s_rej_chp_qty'] 		= $w_rej_chp_qty;
	$gw_scr['s_stp_cd'] 			= trim($w_lot_bas['STP_CD']);
	$gw_scr['s_stp_cls_2'] 			= trim($w_stpcls2);
	$gw_scr['s_prd_cd'] 			= trim($w_lot_bas['PRD_CD']);
	$gw_scr['s_equ_cd'] 			= trim($w_lot_bas['EQU_CD']);
	$gw_scr['s_prt_ctrl'] 			= $w_prt_ctrl;
	$gw_scr['s_spc_equinf'] 		= $w_spc_equinf;
	$gw_scr['s_lp_cd'] 	 		= trim($w_lbl_cd);
	$gw_scr['s_lp_nm']  			= trim($w_lbl_nm);


	#---------------------------------------------------------------------------------------------------------------
	# Example for Winston
	#
	# OK1/OK2 Exmple
	$gw_scr['s_f0_test_flg'] = $w_f0_test_flg; # Active
	$gw_scr['s_ok_flg'] = $w_ok_flg; # Active
	#$gw_scr['s_ok_flg'] = 0; # In-Active	

	# Sample Qty Example
        $gw_scr['s_smp_flg'] = $w_smp_flg; # Active
	#$gw_scr['s_smp_flg'] = 0; # In-Active
        $gw_scr['s_pp_flg'] = $w_pp_flg;
       $gw_scr['s_pp_input_qty']     	= $w_pct_prsal_input;
	$gw_scr['s_pp_fail_qty']     	= $w_pct_prsal_fail;
	$gw_scr['s_pp_yield']     	= $w_pct_prsal_yield;

	
	#SCRATCH CHIP CHECK"

    $w_rtn = get_scr_chp_par_mst(trim($w_lot_bas['STP_CD']),$sc_arr);
    if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	if(count($sc_arr) > 0){
		$gw_scr['s_sc_count'] = count($sc_arr);
		$i = 1;
		// var_dump($sc_arr);
		foreach($sc_arr as $row){
			#SC Example

		

		$gw_scr['s_sc_ctg_cd'][$i] = $row['PAR_TXT'];  // PAR_MST.CTG_DAT_TXT
		$gw_scr['s_sc_label_nm'][$i] = $row['NM_FLL']; // NM_FLL from NM_MST based on ctg_cd ( PAR_MST.CTG_DAT_TX)
		
	        

	       $i++;
		}
	}


	# End of Scratch / Chip Check
	#-----------------------------------------------------------------------------------------------------------------

	$gw_scr['s_wp_seal_flg'] = $w_wp_seal_flg;
	if($w_wp_seal_flg == 1){
		$gw_scr['edit_enable'] = true;
		
	}


	#------------------------------------------------------------------
	# if receive the hold info from SPC or equipment state info,
	# show warning message
	#------------------------------------------------------------------
	if($w_spc_equinf != ""){
		list($w_warn[], $w_lv) = msg("err_warn_".$w_spc_equinf);
	}

	if(count($w_warn) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_warn);
	}

	
	

	scr_mode_chg(2);

	return 0;
}

###################################################################
#####                                                         #####
##### MODE2                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode2
#==================================================================
function main_md2()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "CHECK":
		main_md2_chk();
		break;
	case "REDISP":
		main_md2_redisp();
		break;
	case "ERASE":
		set_init(2);
		break;
	case "BACK":
		set_init(2, 1);
		scr_mode_chg(1);
		reset_sealing();
		break;
	}

	return 0;
}

#new code
function reset_sealing() {
	global $gw_scr;

	$gw_scr['edit_enable'] = false;
        $gw_scr['s_wp_seal_flg'] = false;
        $gw_scr['s_ppcs_val'] = 0;
}

function set_sealing() {
	global $gw_scr;
	
	if($gw_scr['s_wp_seal_flg']) {
               $gw_scr['edit_enable'] = true;
               
        }
}
#==================================================================
# mode2 [Check] process
#==================================================================
function main_md2_chk()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_warn = array();

	if($gw_scr['s_is_packing']) {
		// new code
	        $gw_scr['edit_enable'] = true;
        	$gw_scr['s_ppcs_val'] = $gw_scr['s_pack_pcs'];
	} 
	#------------------------------------------------------------------
	# input check
	#------------------------------------------------------------------
	$w_rtn = check_input(2);
	if($w_rtn != 0){
		return 4000;
	}

	#------------------------------------------------------------------
	# get lot_bas_tbl info
	#------------------------------------------------------------------
	$w_rtn = xgt_lot($gw_scr['s_hdn_lot_id'], $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_hdn_lot_id'], __LINE__);
		return 4000;
	}

	
	


	#------------------------------------------------------------------
	# check input material info
	#------------------------------------------------------------------
	if ($gw_scr['s_prt_ctrl'] == "1") {
		$w_rtn = main_exe_usemat($w_lot_bas['LOT_ID'], $gw_scr['s_stp_cd'],
				$gw_scr['s_prd_cd'], 1);
		if ($w_rtn != 0)
			return 4000;
	}
	
	#------------------------------------------------------------------
	# Pass Qty + Reject Qty = Input Qty
	#------------------------------------------------------------------
	### chip qty
	$w_chk_chp_qty  = $gw_scr['s_pas_chp_qty'] + $gw_scr['s_rej_chp_qty'];
	if($w_chk_chp_qty != $gw_scr['s_inp_chp_qty']){
		list($g_msg, $g_err_lv) = msg("err_Sum_PasRej");
		$g_msg = xpt_err_msg($g_msg, itm("ChpQty"), __LINE__);
		return 4000;
	}
	### substrate qty
	if($gw_scr['s_sub_flg'] == "1" && $gw_scr['s_nxt_sub_flg'] == "1"){
		$w_chk_sub_qty  = $gw_scr['s_pas_sub_qty'] + $gw_scr['s_rej_sub_qty'];
		if($w_chk_sub_qty != $gw_scr['s_inp_sub_qty']){
			list($g_msg, $g_err_lv) = msg("err_Sum_PasRej");
			$g_msg = xpt_err_msg($g_msg, itm("SubQty"), __LINE__);
			return 4000;
		}
	}
	### slice qty
	if($gw_scr['s_sl_flg'] == "1"){
		$w_chk_sl_qty  = $gw_scr['s_pas_sl_qty'] + $gw_scr['s_rej_sl_qty'];
		if($w_chk_sl_qty != $gw_scr['s_inp_sl_qty']){
			list($g_msg, $g_err_lv) = msg("err_Sum_PasRej");
			$g_msg = xpt_err_msg($g_msg, itm("SliceQty"), __LINE__);
			return 4000;
		}
	}

	#OK1 OK2 F0 Test Validation
	
	if($gw_scr['s_ok_flg'] == "1"){
		
		
		$w_ok1_qty =  trim($gw_scr['s_ok_qty'][1]);
		$w_ok1_prd =  trim($gw_scr['s_ok_prd'][1]);

		$w_ok2_qty =  trim($gw_scr['s_ok_qty'][2]);
		$w_ok2_prd =  trim($gw_scr['s_ok_prd'][2]);

		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		// if Ok1 Qty is Inputed, OK1 Part Name must be input.
		if($w_ok1_qty != "" && $w_ok1_prd == ""){
			$g_msg = xpt_err_msg($g_msg, "OK1 ".itm("PrdNm"), __LINE__);
			return 4000;	
		}

		// if Ok1 part name is Inputed, OK1 qty must be input.
		if($w_ok1_qty == "" && $w_ok1_prd != ""){
			$g_msg = xpt_err_msg($g_msg, "OK1 ".itm("InpQty"), __LINE__);
			return 4000;	
		}

		// if Ok2 Qty is Inputed, OK2 Part Name must be input.
		if($w_ok2_qty != "" && $w_ok2_prd == ""){
			$g_msg = xpt_err_msg($g_msg, "OK2 ".itm("PrdNm"), __LINE__);
			return 4000;	
		}

		// if Ok2 part name is Inputed, OK2 qty must be input.
		if($w_ok2_qty == "" && $w_ok2_prd != ""){
			$g_msg = xpt_err_msg($g_msg, "OK2 ".itm("InpQty"), __LINE__);
			return 4000;	
		}


		$isOK1_input = false;
		if($w_ok1_qty != "" && $w_ok1_prd != ""){
			$isOK1_input = true;
		}

		$isOK2_input = false;
		if($w_ok2_qty != "" && $w_ok2_prd != ""){
			$isOK2_input = true;
		}

		if(!$isOK1_input && !$isOK2_input){
			list($g_msg, $g_err_lv) = msg("err_OK_bothNEC");
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;	
		}

		if($isOK1_input){
			#Check OK 1 Qty must be qty and must be greater than 0. 
			if(!check_num($w_ok1_qty)){
				list($g_msg, $g_err_lv) = msg("err_Inp_Num");
				$g_msg = xpt_err_msg($g_msg, "OK1 ".itm("InpQty"), __LINE__);
				return 4000;	
			}
			if($w_ok1_qty <= 0 ){
				list($g_msg, $g_err_lv) = msg("err_gr_zero");
				$g_msg = xpt_err_msg($g_msg, "OK1 ".itm("InpQty"), __LINE__);
				return 4000;
			}
			#Check OK 1 Part Name must be valild Product name (Based on PRD_MST), IF OK1 Part Name is not blank.
			$w_rtn = chk_prd_mst_exist($w_ok1_prd, $r_prd_chk);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, $w_ok1_prd, __LINE__);
				return 4000;
			}
			if(!$r_prd_chk){
				list($g_msg, $g_err_lv) = msg("err_ok_prd_invalid");
				$g_msg = xpt_err_msg($g_msg, "OK1 ".itm("PrdNm")."/".$w_ok1_prd, __LINE__);
				return 4000;
			}


		}
		if($isOK2_input){
			#Check OK 2 Qty must be qty and must be greater than 0. 
			if(!check_num($w_ok2_qty)){
				list($g_msg, $g_err_lv) = msg("err_Inp_Num");
				$g_msg = xpt_err_msg($g_msg, "OK2 ".itm("InpQty"), __LINE__);
				return 4000;	
			}
			if($w_ok2_qty <= 0 ){
				list($g_msg, $g_err_lv) = msg("err_gr_zero");
				$g_msg = xpt_err_msg($g_msg, "OK2 ".itm("InpQty"), __LINE__);
				return 4000;
			}
			#Check OK 2 Part Name must be valild Product name (Based on PRD_MST), IF OK2 Part Name is not blank.
			$w_rtn = chk_prd_mst_exist($w_ok1_prd, $r_prd_chk);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, $w_ok2_prd, __LINE__);
				return 4000;
			}
			if(!$r_prd_chk){
				list($g_msg, $g_err_lv) = msg("err_ok_prd_invalid");
				$g_msg = xpt_err_msg($g_msg, "OK2 ".itm("PrdNm")."/".$w_ok2_prd, __LINE__);
				return 4000;
			}
		}

		#Must be OK1 QTY + OK2 Qty = Lot QTY  ( If OK2 QTY is blank, assume as 0 )
		$totalOK_qty = $w_ok1_qty + $w_ok2_qty;
		if($totalOK_qty != $w_lot_bas['CHP_QTY']){
			list($g_msg, $g_err_lv) = msg("err_ok_total_qty");
			$g_msg = xpt_err_msg($g_msg, $totalOK_qty, __LINE__);
			return 4000;
		}

		$gw_scr['isOk1_input_flg'] = ($isOK1_input?'1':'0');
		$gw_scr['isOk2_input_flg'] = ($isOK2_input?'1':'0');
		#PENDING
		#User selected OK1 part name must be correct part name, Need to check based on route. ( Find way how to check )
		#User selected OK2 part name must be correct part name, Need to check based on route. ( Find way how to check )


		#OK / ok2 and child lot checking


			#get trackin data: prgram, fixture, tester
			$w_rtn = get_ctglog($w_lot_bas['LOT_ID'], constant("CE_LTINF"), constant("CT_TEST_PGM"), &$r_dat);

			if($w_rtn != 0) {
		    	$g_err_lv = 0;
	        	$g_msg = xpt_err_msg($g_msg, $w_lot_bas['LOT_ID'], __LINE__);
	            	return 4000;
	        }
	        if(count($r_dat) > 0){
	        	$w_ctg_prgram = trim($r_dat['CTG_DAT_TXT']);
	    	}

			$w_rtn = get_ctglog($w_lot_bas['LOT_ID'], constant("CE_LTINF"), constant("CT_TEST_FIXTURE"), &$r_dat);

			if($w_rtn != 0) {
		    	$g_err_lv = 0;
	        	$g_msg = xpt_err_msg($g_msg, $w_lot_bas['LOT_ID'], __LINE__);
	            	return 4000;
	        }
	        if(count($r_dat) > 0){
	        	$w_ctg_fixture = trim($r_dat['CTG_DAT_TXT']);
	    	}

	    	$w_rtn = get_ctglog($w_lot_bas['LOT_ID'], constant("CE_LTINF"), constant("CT_TEST_TESTER"), &$r_dat);

			if($w_rtn != 0) {
		    	$g_err_lv = 0;
	        	$g_msg = xpt_err_msg($g_msg, $w_lot_bas['LOT_ID'], __LINE__);
	            	return 4000;
	        }
	        if(count($r_dat) > 0){
	        	$w_ctg_tester = trim($r_dat['CTG_DAT_TXT']);
	    	}

			#END: get trackin data: prgram, fixture, tester

			$w_rtn = get_rcporgmstinf($w_lot_bas['STP_CD'], $w_lot_bas['PRD_CD'],
					$w_rcpinf);
			if ($w_rtn != 0) {
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
			if (count($w_rcpinf) == 0) {
				list($g_msg, $g_err_lv) = msg("err_Program");
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
			
			$w_bln_check = FALSE;
			for($w_pgm_cnt=0; $w_pgm_cnt < count($w_rcpinf);$w_pgm_cnt++){
				if(
					$w_ctg_prgram == trim($w_rcpinf[$w_pgm_cnt]['RCP_NM'])
					&& $w_ctg_tester == trim($w_rcpinf[$w_pgm_cnt]['TESTER'])
					&& $w_ctg_fixture == trim($w_rcpinf[$w_pgm_cnt]['FIXTURE'])				
				){
					$w_subbincheck_1 = false;
					$w_subbincheck_2 = false;
					if(trim($w_rcpinf[$w_pgm_cnt]['OK1OK2']) == "OK1"){
						

						if($isOK1_input && ($w_ok1_prd != trim($w_rcpinf[$w_pgm_cnt]['CHILDPARTNO']))	){
							list($g_msg, $g_err_lv) = msg("err_OK1_Program");
							$g_msg = xpt_err_msg($g_msg, "", __LINE__);
							return 4000;	
						}
					}
					if(trim($w_rcpinf[$w_pgm_cnt]['OK1OK2']) == "OK2"){
						
						if($isOK2_input && ($w_ok2_prd != trim($w_rcpinf[$w_pgm_cnt]['CHILDPARTNO'])	)){
							list($g_msg, $g_err_lv) = msg("err_OK2_Program");
							$g_msg = xpt_err_msg($g_msg, "", __LINE__);
							return 4000;	
						}
					}

					if(trim($w_rcpinf[$w_pgm_cnt]['OK1OK2']) == "BOTH"){
						
						if($isOK1_input && ($w_ok1_prd != trim($w_rcpinf[$w_pgm_cnt]['CHILDPARTNO']))	){
							list($g_msg, $g_err_lv) = msg("err_OK1_Program");
							$g_msg = xpt_err_msg($g_msg, "", __LINE__);
							return 4000;	
						}
						if($isOK2_input && ($w_ok2_prd != trim($w_rcpinf[$w_pgm_cnt]['CHILDPARTNO'])	)){
							list($g_msg, $g_err_lv) = msg("err_OK2_Program");
							$g_msg = xpt_err_msg($g_msg, "", __LINE__);
							return 4000;	
						}
					}
					
				}
			}
			
		

	}
	# END OK1 OK2 Validation

	# QC GATE VALIDATION PENDING
	if($gw_scr['s_smp_flg'] == "1"){
		if(trim($gw_scr['s_input'][1]) == "" || 
			trim($gw_scr['s_output'][1]) == "" || 
			trim($gw_scr['s_fail'][1]) == "" ){
			

			list($g_msg, $g_err_lv) = msg("err_Nec_Input_SMP");
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;	
		}

		
		if(!check_num(trim($gw_scr['s_input'][1]))){
			list($g_msg, $g_err_lv) = msg("err_Inp_Num");
			$g_msg = xpt_err_msg($g_msg, itm("SmpInput"), __LINE__);
			return 4000;
		}
		if(!check_num(trim($gw_scr['s_output'][1]))){
			list($g_msg, $g_err_lv) = msg("err_Inp_Num");
			$g_msg = xpt_err_msg($g_msg, itm("SmpOutput"), __LINE__);
			return 4000;
		}
		if(!check_num(trim($gw_scr['s_fail'][1]))){
			list($g_msg, $g_err_lv) = msg("err_Inp_Num");
			$g_msg = xpt_err_msg($g_msg, itm("SmpFail"), __LINE__);
			return 4000;
		}

		// Input qty can't greater than lot qty.
		// Output qty can't greater than lot qty.
		// Fail qty can't greater than lot qty.
		if(trim($gw_scr['s_input'][1]) > $w_lot_bas['CHIP_QTY'] || 
			trim($gw_scr['s_output'][1]) > $w_lot_bas['CHIP_QTY'] || 
			trim($gw_scr['s_fail'][1]) > $w_lot_bas['CHIP_QTY'] ){
			list($g_msg, $g_err_lv) = msg("err_smp_qty");
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}
	# END QC GATE VALIDATION PENDING

	# SCRATCH / CHIP QTY CHECK (Based on step code)
	$w_rtn = get_scr_chp_par_mst(trim($w_lot_bas['STP_CD']),$sc_arr);
    if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	if(count($sc_arr) > 0){
		$gw_scr['s_sc_count'] = count($sc_arr);
		$i = 1;
		// var_dump($sc_arr);
		foreach($sc_arr as $row){
			$w_sc_input_qty = trim($gw_scr['s_sc_input_qty'][$i]);

			

			if($w_sc_input_qty!= ""){
				# If Qty is not blank, 
				## Qty must be integer.
				## Qty must greater than 0
				## Qty can't greater than lot qty.
				if(!check_num($w_sc_input_qty)){
					list($g_msg, $g_err_lv) = msg("err_Inp_Num");
					$g_msg = xpt_err_msg($g_msg, $gw_scr['s_sc_label_nm'][$i], __LINE__);
					return 4000;
				}
				if($w_sc_input_qty <= 0 ){
					list($g_msg, $g_err_lv) = msg("err_gr_zero");
					$g_msg = xpt_err_msg($g_msg, $gw_scr['s_sc_label_nm'][$i], __LINE__);
					return 4000;
				}
				if($w_sc_input_qty > $w_lot_bas['CHIP_QTY'] ){
					list($g_msg, $g_err_lv) = msg("err_sc_qty");
					$g_msg = xpt_err_msg($g_msg, $gw_scr['s_sc_label_nm'][$i], __LINE__);
					return 4000;
				}
			}
		

			$i++;
		}
	}
	# END SCRATCH / CHIP QTY CHECK (Based on step code)

	# WIPE & PROTECT SEAL Check
	if($gw_scr['s_wp_seal_flg'] == "1"){
		#All seal must be "Y"
		if(trim($gw_scr['s_seal_all']) != 1 || 
			trim($gw_scr['s_seal_orien']) != 1 || 
			trim($gw_scr['s_seal_orien']) != 1 ){
			

			list($g_msg, $g_err_lv) = msg("err_Seal_ALL_Y");
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;	
		}
	}

	# END WIPE & PROTECT SEAL Check

	#------------------------------------------------------------------
	# Reject Qty = total qty of Reject Details
	#------------------------------------------------------------------
	$badcnt = 0;				# for check hairline crack
	$w_baddtl = array();			# for check hairline crack
	$w_sum_chp_baddtl = 0;
	for($i=1; $i<=$gw_scr['s_chp_bad_cnt']; $i++){
		if($gw_scr['s_list_chp_bad_ctg_qty'][$i] == "") continue;
		if($gw_scr['s_list_chp_bad_ctg_qty'][$i] == "0") continue;
		$w_sum_chp_baddtl += $gw_scr['s_list_chp_bad_ctg_qty'][$i];

		$badcnt++;
		$w_baddtl[$badcnt] = array
		(
			"PRD_CD"	=> trim($w_lot_bas['PRD_CD']),
			"STP_CD"	=> trim($w_lot_bas['STP_CD']),
			"CTG_CD"	=> trim($gw_scr['s_list_chp_bad_ctg_cd'][$i]),
		);
	}
	if($gw_scr['s_rej_chp_qty'] != $w_sum_chp_baddtl){
		list($g_msg, $g_err_lv) = msg("err_Eql_BadQty");
		$g_msg = xpt_err_msg($g_msg, itm("ChpQty"), __LINE__);
		return 4000;
	}
	
	#------------------------------------------------------------------
	# check magazine
	#------------------------------------------------------------------
	if($gw_scr['s_mgzn_flg'] == "1"){
		### duplicate input check
		for($i=1; $i<= $gw_scr['s_h_disp_row']; $i++){
			if($gw_scr['s_list_mgzn_id'][$i] == ""){
				continue;
			}
			for($j=$i+1; $j<= $gw_scr['s_h_disp_row']; $j++){
				if($gw_scr['s_list_mgzn_id'][$j] == ""){
					continue;
				}
				if($gw_scr['s_list_mgzn_id'][$i] == $gw_scr['s_list_mgzn_id'][$j]){
					list($g_msg, $g_err_lv) = msg("err_Inp_Dup");
					$w_tg = get_tg(itm("MgznID"), $gw_scr['s_list_mgzn_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
			}
		}

		$cnt = 0;
		$w_arr_mgznid = array();
		for($i=1; $i<= $gw_scr['s_h_disp_row']; $i++){
			if($gw_scr['s_list_mgzn_id'][$i] == ""){
				continue;
			}
			$cnt++;
			$w_arr_mgznid[$cnt] = $gw_scr['s_list_mgzn_id'][$i];
		}

		### check magazine ID for Track-Out
		$w_rtn = cs_xck_jig_chk_out(trim($w_lot_bas['PRC_CD']),
									trim($w_lot_bas['STP_CD']),
									trim($w_lot_bas['PRD_CD']),
									trim($gw_scr['s_hdn_lot_id']),
									constant("JI_JIG"),
									constant("SH_JIG"),
									$w_arr_mgznid);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

        #--------------------------------------------------------------------------------
        # check no of full tray and balance qty of tray, if proudct is need to do adjust
        #--------------------------------------------------------------------------------
	if( $gw_scr['s_is_need_physical_adj'] == "1") { # Product Need To Do Adjustment At PACK PREPARATION

		# Tray No is Blank checking
		if(! (isset($gw_scr['s_tray_no']) 
			&& trim($gw_scr['s_tray_no']) != "")) {
			list($g_msg, $g_err_lv) = msg("err_tray_blank");
	                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}

		# Tray No is number checking
		if(! (check_num($gw_scr['s_tray_no']))) {
			list($g_msg, $g_err_lv) = msg("err_tray_number");
	                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	
                # Tray no can't be 0
                if( trim($gw_scr['s_tray_no']) == 0) {
                        list($g_msg, $g_err_lv) = msg("err_tray_zero");
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
                }
	
		# Balance of tray blank checking	
		if(! (isset($gw_scr['s_bal_tray_qty'])
			&& trim($gw_scr['s_bal_tray_qty']) != "" )) {
			list($g_msg, $g_err_lv) = msg("err_bal_tray_blank");
	                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return false;
		}

		# Balance of tray number checking
		if(! (check_num($gw_scr['s_bal_tray_qty']))){
			list($g_msg, $g_err_lv) = msg("err_bal_tray_number");
	                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
		
		$w_rtn = get_chip_qty_per_tray($w_lot_bas['PRD_CD'], $w_chip_qty_per_tray);
                if($w_rtn != 0){
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
                }

                # Chip qty per tray should not be blank or 0
                if($w_chip_qty_per_tray <= 0 || $w_chip_qty_per_tray == " ") {
                        list($g_msg, $g_err_lv) = msg("err_chip_qty_pre_tray");
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
                }

	}

	#------------------------------------------------------------------
	# check SPACE
	#------------------------------------------------------------------
	### bar or ring qty
	$w_in_bar_or_ring_qty  = "";
	$w_out_bar_or_ring_qty = "";
	### total of reject details for chip
	$w_arr_rjct_chp_qty = array();
	for($i=1; $i<=$gw_scr['s_chp_bad_cnt']; $i++){
		$w_ctgcd = $gw_scr['s_list_chp_bad_ctg_cd'][$i];
		$w_arr_rjct_chp_qty[$w_ctgcd] = ($gw_scr['s_list_chp_bad_ctg_qty'][$i] == "")?("0"):($gw_scr['s_list_chp_bad_ctg_qty'][$i]);
	}
	### total of reject details for bar
	$w_arr_rjct_bar_qty = array();

	### P-test program
	$w_pken_prg_id = "";

	### pilot judge
	$w_plt_jdg = array();

	$w_rtn = chk_space($w_lot_bas['LOT_ID'],
						"Y",
						$w_lot_bas['EQU_CD'],
						$w_pken_prg_id,
						$gw_scr['s_usr_id'],
						$w_lot_bas['CHP_QTY'],
						$gw_scr['s_pas_chp_qty'],
						$w_in_bar_or_ring_qty,
						$w_out_bar_or_ring_qty,
						$w_arr_rjct_chp_qty,
						$w_arr_rjct_bar_qty,
						$w_plt_jdg,
						$w_spc_err_cd,
						$w_spc_err_nm,
						$w_spc_err_msg);
	if($w_rtn != 0) return 4000;

	### abend if error code is not normal or ABN/PCS/MBN
	if($w_spc_err_cd != constant("SPC_ERRCD_NRM")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABN")
	&& $w_spc_err_cd != constant("SPC_ERRCD_PCS")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABNPCS")
	){
		list($g_msg, $g_err_lv) = msg("err_Err_Space");
		$g_msg = xpt_err_msg($g_msg, $w_spc_err_cd, __LINE__);
		return 4000;
	}

	### show warning
	$w_msg = "";
	if($w_spc_err_cd == constant("SPC_ERRCD_ABN")){
		list($w_msg, $w_lv) = msg("err_jdg_ABN");
	} elseif($w_spc_err_cd == constant("SPC_ERRCD_PCS")) {
		list($w_msg, $w_lv) = msg("err_jdg_PCS");
	} elseif($w_spc_err_cd == constant("SPC_ERRCD_ABNPCS")) {
		list($w_msg, $w_lv) = msg("err_jdg_ABNPCS");
	}
	if($w_msg != ""){
		$w_warn[] = $w_msg;
	}


	#Add in warning for the ABN on track-out
	$w_arr_space_msg_buff = explode(" ",$w_spc_err_msg);
	if( $w_arr_space_msg_buff[4] == "100000"){
		#check if there is a ABN violation
		if($w_arr_space_msg_buff[8] != 0){
			list($w_msg, $w_lv) = msg("warn_ABN_Exec");
			$w_warn[] = $w_msg;
		}
	}
        #------------------------------------------------------------------
        # check Backfill
        #------------------------------------------------------------------
	### total of reject details for bar
        $w_arr_rjct_bar_qty = array();

        ### P-test program
        $w_pken_prg_id = "";

        ### pilot judge
        $w_plt_jdg = array();

        $w_rtn = chk_backfill_out($w_lot_bas['LOT_ID'],
                                                "Y",
                                                $w_lot_bas['EQU_CD'],
                                                $w_pken_prg_id,
                                                $gw_scr['s_usr_id'],
                                                $w_lot_bas['CHP_QTY'],
                                                $gw_scr['s_pas_chp_qty'],
                                                $w_in_bar_or_ring_qty,
                                                $w_out_bar_or_ring_qty,
                                                $w_arr_rjct_chp_qty,
                                                $w_arr_rjct_bar_qty,
                                                $w_plt_jdg,
                                                $w_web_err_cd,
                                                $w_web_err_nm,
                                                $w_web_err_msg);
        if($w_rtn != 0) return 4000;
	###
        if($w_web_err_cd == "0"){
                list($g_msg, $g_err_lv) = msg("err_Err_backfill");
                $g_msg = xpt_err_msg($g_msg, $w_web_err_nm, __LINE__);
                return 4000;
        }

        if($w_web_err_cd == "2"){
                list($g_msg, $g_err_lv) = msg("err_Warn_backfill");
                $g_msg = xpt_err_msg($g_msg, $w_web_err_nm, __LINE__);
                $w_warn[] = $g_msg;
        }

	#------------------------------------------------------------------
	# check Hairline Crack
	#------------------------------------------------------------------
	### only Packing VI step
	if($gw_scr['s_stp_cls_2'] == constant("E9_PCKVI")){
		$w_rtn = chk_hairline_crk($w_lot_bas, $w_baddtl, $w_crk_flg);
		if($w_rtn != 0) return 4000;
	}

	if($w_crk_flg == "1"){
		list($w_msg, $w_lv) = msg("warn_Crack");
		$w_warn[] = $w_msg;
	}

	#------------------------------------------------------------------
	# check metal weight
	#------------------------------------------------------------------
	### only Baking step
	if($gw_scr['s_stp_cls_2'] == constant("E9_BAKING")){
		$w_rtn = get_lotinf_magz($gw_scr['s_hdn_lot_id'],
							constant("CE_LTINF"),
							constant("CT_METAL_WGHT"),
							$w_wgtinf);
		if($w_rtn != 0) return 4000;
		if(!$w_wgtinf){
			list($g_msg, $g_err_lv) = msg("err_Get_MetalWght");
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}

		### error if input value does not match to registered value
		if($gw_scr['s_metal_wght'] != trim($w_wgtinf['CTG_DAT_TXT'])){
			list($g_msg, $g_err_lv) = msg("err_Mch_MetalWght");
			$g_msg = xpt_err_msg($g_msg, $gw_scr['s_metal_wght'], __LINE__);
			return 4000;
		}
	}
	
	if($gw_scr['s_stp_cls_2']  == constant("E9_MOLDCURE")
        && $gw_scr['s_expire_flg'] == "1" && $gw_scr['s_pastec_flg'] == "1"
        ){
		list($g_msg, $g_err_lv) = msg("warn_Hold_Reserv");
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_lot_id'], __LINE__);
	}

	
	
	$gw_scr['s_crk_flg']  = $w_crk_flg;
	$gw_scr['s_disp_row'] = $gw_scr['s_h_disp_row'];
	$gw_scr['s_lock_flg'] = 1;

	
		#------------------------------------------------------------------
		# get Printer Destination name
		#------------------------------------------------------------------
		$w_rtn = xgt_lp2_cd($gw_scr['s_lp_cd'], $dmy, $dmy, $w_lp_nm);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $gw_scr['s_lp_cd'], __LINE__);
			return 4000;
		}

		$gw_scr['s_lp_nm']             = trim($w_lp_nm);
	

	if(count($w_warn) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_warn);
	} else {
		if($g_msg == ""){
			list($g_msg, $g_err_lv) = msg("guid_Execute");
		}
	}
	$g_msg = xpt_err_msg($g_msg, "", "");

	scr_mode_chg(3);

	return 0;
}

#-----------------------------------------------------------
# NEW: Get related gold wire part group code
#-----------------------------------------------------------
function get_gold_wire_prt_grp_cd_by_prd($w_prd_cd, $w_stp_cd, &$r_dat) {
                global $g_msg;
                global $g_err_lv;
                global $gw_scr;

                $r_dat = array();
                $i = 0;
                $w_e0_gold_wire = constant("E0_GOLD_WIRE");
                $w_sql = <<<_SQL

SELECT
        *
FROM
        prt_org_mst pom,
        prt_bas_mst pbm
WHERE
        pom.prd_cd = '{$w_prd_cd}' AND
        pom.stp_Cd = '{$w_stp_cd}' AND
        pom.PRT_GRP_CD = '{$w_e0_gold_wire}' AND
        pom.PRT_CD = pbm.PRT_CD AND
        pbm.prt_grp_cd = '{$w_e0_gold_wire}' AND
        pom.DEL_FLG = '0' AND
        pbm.DEL_FLG = '0'

_SQL;
                # ask Paul on WIP.PRT_ST_DVS = 'WT'
                $w_stmt = db_res_set($w_sql);
                $w_rtn  = db_do($w_stmt);
                if($w_rtn != 0){
                                list($g_msg, $g_err_lv) = msg("err_Sel");
                                $g_msg = xpt_err_msg($g_msg, "equ_prt_tbl", __LINE__);
                                return 4000;
                }

                while ($w_row = db_fetch_row($w_stmt)) {
                           $r_dat    = $w_row;

                }
                db_res_free($w_stmt);

                return 0;

}



#-----------------------------------------------------------
# NEW: Get the current charging material based on equ
#-----------------------------------------------------------
function get_charging_material($w_equ_cd, &$r_dat) {
                global $g_msg;
                global $g_err_lv;
                global $gw_scr;

                $r_dat = array();
                $i = 0;

                $w_sql = <<<_SQL

select * from equ_prt_tbl where equ_cd = '{$w_equ_cd}' and no_use_flg = '0' order by crt_dts desc

_SQL;
                # ask Paul on WIP.PRT_ST_DVS = 'WT'
                $w_stmt = db_res_set($w_sql);
                $w_rtn  = db_do($w_stmt);
                if($w_rtn != 0){
                                list($g_msg, $g_err_lv) = msg("err_Sel");
                                $g_msg = xpt_err_msg($g_msg, "equ_prt_tbl", __LINE__);
                                return 4000;
                }

                while ($w_row = db_fetch_row($w_stmt)) {
                           $r_dat    = $w_row;

                }
                db_res_free($w_stmt);

                return 0;

}

#------------------------------------------------------------------
# delete calculated physical qty if already exists
#-----------------------------------------------------------------
function del_cal_physical_qty($w_usr_id, $w_lot_id)
{
        global $g_msg;
        global $g_err_lv;
        global $g_cpu_dts;

        $w_ctgdvs = constant("CE_LTINF");
        $w_ctgcd  = constant("CT_CALCULATED_PHYSICAL_QTY");

        $w_upd = array
        (
                "DEL_FLG"               => "1",
                "UPD_DTS"               => $g_cpu_dts,
                "USR_ID_UPD"    => $w_usr_id,
                "UPD_LEV"               => "2",
        );

        $w_whr = <<<_SQL
LOT_ID = '{$w_lot_id}'
AND CTG_DVS_CD = '{$w_ctgdvs}'
AND CTG_CD = '{$w_ctgcd}'
AND DEL_FLG = '0'
_SQL;

        $w_rtn = db_update_large("CTG_LOG", $w_upd, $w_whr);
        if($w_rtn != 0){
                list($g_msg, $g_err_lv) = msg("err_Upd");
                $g_msg = xpt_err_msg($g_msg, "CTG_LOG", __LINE__);
                return 4000;
        }

        return 0;
}

#-----------------------------------------------------------
# NEW: Get chip qty per tray with product
#-----------------------------------------------------------
function get_cal_physical_qty($w_lot_id, &$r_data){

        global $g_msg;
        global $g_err_lv;
        global $gw_scr;

        $w_ctgdvs = constant("CE_LTINF");
        $w_ctgcd  = constant("CT_CALCULATED_PHYSICAL_QTY");
	$r_data = 0;

        $w_sql = <<<_SQL
SELECT
        COUNT(*) C
FROM
        CTG_LOG
WHERE
        DEL_FLG = '0' AND
	LOT_ID = '{$w_lot_id}' AND 
	CTG_DVS_CD = '{$w_ctgdvs}' AND 
	CTG_CD = '{$w_ctgcd}' 

_SQL;
        $w_stmt = db_res_set($w_sql);
        $w_rtn  = db_do($w_stmt);
        if($w_rtn != 0){
                list($g_msg, $g_err_lv) = msg("err_Sel");
                $g_msg = xpt_err_msg($g_msg, "PRD_INF_MST", __LINE__);
                return 4000;
        }

        while ($w_row = db_fetch_row($w_stmt)) {
                $r_data = trim($w_row['C']);
        }

        db_res_free($w_stmt);

        return 0;

}

function chk_prd_mst_exist($w_prd_nm, &$r_exist){

        global $g_msg;
        global $g_err_lv;
        global $gw_scr;

        
	$r_data = 0;
	$r_exist = false;

        $w_sql = <<<_SQL
SELECT
        COUNT(*) C
FROM
        PRD_MST
WHERE
        DEL_FLG = '0' AND
	PRD_NM = '{$w_prd_nm}'

_SQL;
        $w_stmt = db_res_set($w_sql);
        $w_rtn  = db_do($w_stmt);
        if($w_rtn != 0){
                list($g_msg, $g_err_lv) = msg("err_Sel");
                $g_msg = xpt_err_msg($g_msg, "PRD_MST", __LINE__);
                return 4000;
        }

        while ($w_row = db_fetch_row($w_stmt)) {
                $r_data = trim($w_row['C']);
        }

        if($r_data>0)
        	$r_exist = true;
        
        db_res_free($w_stmt);

        return 0;

}
#-----------------------------------------------------------
# NEW: Check Product Need to do physical adjustment
#-----------------------------------------------------------
function check_physical_adj_flg($w_prd_cd, &$r_need_adj){

	global $g_msg;
	global $g_err_lv;
	global $gw_scr;
	
	$w_aw_physical_adj = constant("AW_PHYSICAL_ADJ");
	$w_dat = "";
	$r_need_adj = "0";

	$w_sql = <<<_SQL
SELECT 
	TXT_DAT 
FROM 
	PRD_INF_MST 
WHERE
	DEL_FLG = '0' AND
	PRD_CD = '$w_prd_cd' AND
	DAT_CD = '$w_aw_physical_adj'
_SQL;
	$w_stmt = db_res_set($w_sql);
	$w_rtn  = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "equ_prt_tbl", __LINE__);
		return 4000;
	}

	while ($w_row = db_fetch_row($w_stmt)) {
		$r_dat = $w_row['TXT_DAT'];
	}
	
	if(trim($r_dat) == "Y") {
		$r_need_adj = "1";
	}
	
	db_res_free($w_stmt);

	return 0;

}

#-----------------------------------------------------------
# NEW: Get chip qty per tray with product
#-----------------------------------------------------------
function get_chip_qty_per_tray($w_prd_cd, &$r_qty){

        global $g_msg;
        global $g_err_lv;
        global $gw_scr;

        $w_aw_chip_qty_per_tray = constant("AW_CHIP_QTY_PER_TRAY");
        $r_qty = 0;

        $w_sql = <<<_SQL
SELECT
        NUM_DAT
FROM
        PRD_INF_MST
WHERE
        DEL_FLG = '0' AND
        PRD_CD = '$w_prd_cd' AND
        DAT_CD = '$w_aw_chip_qty_per_tray'
_SQL;
        $w_stmt = db_res_set($w_sql);
        $w_rtn  = db_do($w_stmt);
        if($w_rtn != 0){
                list($g_msg, $g_err_lv) = msg("err_Sel");
                $g_msg = xpt_err_msg($g_msg, "PRD_INF_MST", __LINE__);
                return 4000;
        }

        while ($w_row = db_fetch_row($w_stmt)) {
                $r_qty = trim($w_row['NUM_DAT']);
        }

        if($r_qty == "") {
                $r_qty = 0;
        }

        db_res_free($w_stmt);

        return 0;

}

#-----------------------------------------------------------
# Get Scratch Chip Par Mst
#-----------------------------------------------------------
function get_scr_chp_par_mst($w_stp_cd,&$r_dat){

        global $g_msg;
        global $g_err_lv;
        global $gw_scr;

        $r_dat = array();
        $w_par_cls_d = constant("P0_SCRATCH_CHIP");
        $r_qty = 0;

        $w_sql = <<<_SQL
SELECT
        PM.PAR_TXT,
        NM.NM_FLL
FROM
        PAR_MST PM,
        NM_MST NM
WHERE
		PM.PAR_ID = '$w_stp_cd' AND
		PM.DEL_FLG =0 AND
		NM.DEL_FLG =0 AND 
		CAST(PM.PAR_TXT AS CHAR(20)) = NM.CD AND 
		PM.PAR_CLS_CD  = '$w_par_cls_d'
_SQL;
        $w_stmt = db_res_set($w_sql);
        $w_rtn  = db_do($w_stmt);
        if($w_rtn != 0){
                list($g_msg, $g_err_lv) = msg("err_Sel");
                $g_msg = xpt_err_msg($g_msg, "PAR_MST", __LINE__);
                return 4000;
        }

        while ($w_row = db_fetch_row($w_stmt)) {
      
                $r_dat[] = $w_row;
        }

        db_res_free($w_stmt);

        return 0;

}


#==================================================================
# mode2 [Reload] process
#==================================================================
function main_md2_redisp()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# trim
	#------------------------------------------------------------------
	$gw_scr['s_disp_row'] = trim($gw_scr['s_disp_row']);

	#------------------------------------------------------------------
	# require check
	#------------------------------------------------------------------
	if($gw_scr['s_disp_row'] == ""){
		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		$g_msg = xpt_err_msg($g_msg, itm("DispRow"), __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check use numbers
	#------------------------------------------------------------------
	if(!check_num($gw_scr['s_disp_row'])){
		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
		$w_tg = get_tg(itm("DispRow"), $gw_scr['s_disp_row']);
		$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check range
	#------------------------------------------------------------------
	if($gw_scr['s_disp_row'] < constant("MIN_MGZN_ROW") ||
	   $gw_scr['s_disp_row'] > constant("MAX_MGZN_ROW")){
		list($g_msg, $g_err_lv) = msg("err_Inp_Over");
		$w_tg = get_tg(itm("DispRow"), $gw_scr['s_disp_row']);
		$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
		return 4000;
	}

	$gw_scr['s_h_disp_row'] = $gw_scr['s_disp_row'];

	return 0;
}

###################################################################
#####                                                         #####
##### MODE3                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode3
#==================================================================
function main_md3()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "EXECUTE":
		main_md3_exe();
		break;
	case "BACK":
		set_init(3, 1);
		scr_mode_chg(2);

		set_sealing();
		break;
	}

	return 0;
}

#==================================================================
# mode3 [Execute] process
#==================================================================
function main_md3_exe()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	
	$g_msg = "";
	$g_err_lv = "";
	$w_bind_no = "";
	#------------------------------------------------------------------
	# start transaction
	#------------------------------------------------------------------
	db_begin();

	#------------------------------------------------------------------
	# execute
	#------------------------------------------------------------------
	$w_rtn = main_exe($w_jdghold,
					$w_holdrsv,
					$w_spchold,
					$w_lmthold,
					$w_holdrsv_washdry,
					$w_mthd_flg,
					$w_bind_no, 
					$is_auto_trf);
	if($w_rtn != 0){
		db_rollback();
		return 4000;
	}

	#------------------------------------------------------------------
	# commit
	#------------------------------------------------------------------
	db_commit();

	#------------------------------------------------------------------
	# show warning if Lot hold due to threshold judgement 'NG'
	#------------------------------------------------------------------
	if(count($w_jdghold) > 0){
		# set pop up window info.
		$gw_scr['s_err_opn_js_flg'] = 1;
		$gw_scr['s_err_opn_lot_id'] = $w_jdghold['LOT_ID'];
		$gw_scr['s_err_opn_stp_cd'] = $w_jdghold['STP_CD'];
		$gw_scr['s_jdg_hold']       = 1;
		$gw_scr['s_jdg_rls_setday'] = $w_jdghold['SET_DAY'];
		$gw_scr['s_qul_rep_flg']    = $w_jdghold['REP_FLG'];

		# print quality report sheet
		if($gw_scr['s_qul_rep_flg'] == 1){
			if($w_rtn != 0){
				$gw_scr['s_prnt_lv']  = 0;
				$gw_scr['s_prnt_msg'] = xpt_err_msg($g_msg, $gw_scr['s_hdn_lot_id'], __LINE__);
				$g_err_lv = "";
				$g_msg    = "";
			}
		}

		list($w_msg, $w_err_lv) = msg("end_JdgNG_Hold");
		$g_msg .= "<BR>".$w_msg;
		
		if($g_err_lv !='3'){
			$g_err_lv = $w_err_lv;
		}
	}
	#------------------------------------------------------------------
	# show warning if Lot hold due to hold reserve
	#------------------------------------------------------------------
	elseif(count($w_holdrsv) > 0){
		$g_err_lv = 3;
		for($i=1; $i<=count($w_holdrsv); $i++){
			if($i >= 2) $g_msg .= "<br>";
			list($w_msg, $w_lv) = msg("end_Rsv_Hold");
			$g_msg .= $w_msg . "(" . $w_holdrsv[$i]['LOT_ID'] . ")";
			$g_msg .= "<br>";
			$g_msg .= $w_holdrsv[$i]['MSG'];

			

		}
	}
	#------------------------------------------------------------------
	# show warning if Lot hold due to SPC check
	#------------------------------------------------------------------
	elseif(count($w_spchold) > 0){
		list($w_msg, $w_err_lv) = msg("End_".$w_spchold[1]."_Hold");
		$w_msg .= xpt_err_msg($w_msg, $gw_scr['s_hdn_lot_id'], __LINE__);
		$g_msg .= '<br>'.$w_msg;
		if($g_err_lv != '3'){
			$g_err_lv = $w_err_lv;
		}
	}

        #------------------------------------------------------------------
        # show warning if regist hold reserve info
        #       due to the limit time exceeding at post mold cure stp
        #------------------------------------------------------------------
        elseif($w_holdrsv_washdry == 1 && $w_lmthold == 1){
                list($w_msg, $w_err_lv) = msg("err_TrcTime_HOLD");
                $w_msg .= xpt_err_msg($w_msg, "", __LINE__);
		$g_msg .= '<br>'.$w_msg;
		if($g_err_lv != '3'){
			$g_err_lv = $w_err_lv;	
		}
                #$w_warn[] = $g_msg;

                list($w_msg, $w_err_lv) = msg("err_TrcTime_RSV");
                $w_msg .= xpt_err_msg($w_msg, "", __LINE__);
		$g_msg .= '<br>'.$w_msg;
		if($g_err_lv != '3'){
			$g_err_lv = $w_err_lv;
		}
	
                $w_warn[] = $g_msg;

        }
	#------------------------------------------------------------------
	# show warning if Lot hold due to the limit time exceeding
	#------------------------------------------------------------------
	elseif($w_lmthold == 1){

		list($w_msg, $w_err_lv) = msg("err_TrcTime_HOLD");
                $w_msg .= xpt_err_msg($w_msg, "", __LINE__);
                $g_msg .= '<br>'.$w_msg;
                if($g_err_lv != '3'){
                        $g_err_lv = $w_err_lv;
                }

	}
	#------------------------------------------------------------------
	# show warning if regist hold reserve info
	#	due to the limit time exceeding at post mold cure stp
	#------------------------------------------------------------------
	elseif($w_holdrsv_washdry == 1){
		list($w_msg, $w_err_lv) = msg("err_TrcTime_RSV");
                $w_msg .= xpt_err_msg($w_msg, "", __LINE__);
                $g_msg .= '<br>'.$w_msg;
                if($g_err_lv != '3'){
                        $g_err_lv = $w_err_lv;
                }

	}
	#------------------------------------------------------------------
	# normal end
	#------------------------------------------------------------------
	else {
		list($w_msg, $w_err_lv) = msg("end_Execute");
		$g_msg .= '<br>'.$w_msg;
		if($g_err_lv != '3'){
			$g_err_lv = $w_err_lv;
		}
	}

	if($is_auto_trf){
		#------------------------------------------------------------------
		# print WIP Transfer Note
		#------------------------------------------------------------------
		for($i=0; $i < $gw_scr['s_prt_no']; $i++) {
			$w_rtn = cs_xpt_wip_tn($w_bind_no,constant("WIPNOTE_HINA"), $gw_scr['s_lp_cd']);
		}
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $w_bind_no, __LINE__);
		}
	}


	scr_mode_chg(4);

	return 0;
}

###################################################################
#####                                                         #####
##### MODE4                                                   #####
#####                                                         #####
###################################################################
#==================================================================
# mode4
#==================================================================
function main_md4()
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch($gw_scr['s_act']){
	case "BACK":
		main_init();
		break;
	}

	return 0;
}

#==================================================================
# execute process
#==================================================================
function main_exe(&$r_jdghold, &$r_holdrsv, &$r_spchold, &$r_lmthold, &$r_holdrsv_washdry, &$r_mthd_flg, &$r_bind_no , &$is_auto_trf = false)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;
	$w_msg10 = "";

	#------------------------------------------------------------------
	# initialize return value
	#------------------------------------------------------------------
	$r_jdghold         = array();
	$r_holdrsv         = array();
	$r_spchold         = array();
	$r_lmthold         = 0;
	$r_holdrsv_washdry = 0;
	$r_mthd_flg        = 0;

	#------------------------------------------------------------------
	# lock table
	#------------------------------------------------------------------
	$w_rtn = db_lock("CD_USE_CNT_TBL");
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# get lot_bas_tbl info
	#------------------------------------------------------------------
	$w_rtn = xgt_lot($gw_scr['s_hdn_lot_id'], $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $gw_scr['s_hdn_lot_id'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check upd_lev
	#------------------------------------------------------------------
	$w_rtn = xck_upd($gw_scr['s_upd_lev'], $w_lot_bas['UPD_LEV']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check SPACE
	#------------------------------------------------------------------
	### bar or ring qty
	$w_in_bar_or_ring_qty = "";
	$w_out_bar_or_ring_qty = "";
	### total of reject details for chip
	$w_arr_rjct_chp_qty = array();
	for($i=1; $i<=$gw_scr['s_chp_bad_cnt']; $i++){
		$w_ctgcd = $gw_scr['s_list_chp_bad_ctg_cd'][$i];
		$w_arr_rjct_chp_qty[$w_ctgcd] = ($gw_scr['s_list_chp_bad_ctg_qty'][$i] == "")?("0"):($gw_scr['s_list_chp_bad_ctg_qty'][$i]);
	}
	### total of reject details of bar
	$w_arr_rjct_bar_qty = array();

	### P-test program
	$w_pken_prg_id = "";

	### pilot judge
	$w_plt_jdg = array();

	$w_rtn = chk_space($w_lot_bas['LOT_ID'],
						"N",
						$w_lot_bas['EQU_CD'],
						$w_pken_prg_id,
						$gw_scr['s_usr_id'],
						$w_lot_bas['CHP_QTY'],
						$gw_scr['s_pas_chp_qty'],
						$w_in_bar_or_ring_qty,
						$w_out_bar_or_ring_qty,
						$w_arr_rjct_chp_qty,
						$w_arr_rjct_bar_qty,
						$w_plt_jdg,
						$w_spc_err_cd,
						$w_spc_err_nm,
						$w_spc_err_msg);
	if($w_rtn != 0) return 4000;

	### abend if error code is not normal or ABN/PCS/MBN
	if($w_spc_err_cd != constant("SPC_ERRCD_NRM")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABN")
	&& $w_spc_err_cd != constant("SPC_ERRCD_PCS")
	&& $w_spc_err_cd != constant("SPC_ERRCD_ABNPCS")
	){
		list($g_msg, $g_err_lv) = msg("err_Err_Space");
		$g_msg = xpt_err_msg($g_msg, $w_spc_err_cd, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# Re-check SPC state
	#------------------------------------------------------------------
	if($gw_scr['s_spc_equinf'] == ""){
		$w_rtn = chk_spc_equ($gw_scr['s_hdn_lot_id'], $w_spc_equinf);
		if($w_rtn != 0) return 4000;
		if($w_spc_equinf != ""){
			list($g_msg, $g_err_lv) = msg("err_Upd_".$w_spc_equinf);
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

        #------------------------------------------------------------------
        # Check Backfill
        #------------------------------------------------------------------ 
	### total of reject details of bar
        $w_arr_rjct_bar_qty = array();

        ### P-test program
        $w_pken_prg_id = "";

        ### pilot judge
        $w_plt_jdg = array();

        $w_rtn = chk_backfill_out($w_lot_bas['LOT_ID'],
                                                "N",
                                                $w_lot_bas['EQU_CD'],
                                                $w_pken_prg_id,
                                                $gw_scr['s_usr_id'],
                                                $w_lot_bas['CHP_QTY'],
                                                $gw_scr['s_pas_chp_qty'],
                                                $w_in_bar_or_ring_qty,
                                                $w_out_bar_or_ring_qty,
                                                $w_arr_rjct_chp_qty,
                                                $w_arr_rjct_bar_qty,
                                                $w_plt_jdg,
                                                $w_web_err_cd,
                                                $w_web_err_nm,
                                                $w_web_err_msg);
        if($w_rtn != 0) return 4000;
	###
        if($w_web_err_cd == "0"){
                list($g_msg, $g_err_lv) = msg("err_Err_backfill");
                $g_msg = xpt_err_msg($g_msg, $w_web_err_nm, __LINE__);
                return 4000;
        }

        if($w_web_err_cd == "2"){
                list($g_msg, $g_err_lv) = msg("err_Warn_backfill");
                $g_msg = xpt_err_msg($g_msg, $w_web_err_nm, __LINE__);
                $w_warn[] = $g_msg;
        }

	#------------------------------------------------------------------
	# IOOT prep
	#------------------------------------------------------------------
	$w_arr_ctg_dvs  = array();
	$w_arr_ctg_cd   = array();
	$w_arr_ctg_qty  = array();
	$w_arr_ctg_txt  = array();
	$w_arr_ctg_slid = array();
	$w_arr_jdg_cd   = array();
	$w_arr_jdg_val  = array();
	$ctgcnt = 0;
	### reject details for chip
	for($i=1; $i<=$gw_scr['s_chp_bad_cnt']; $i++){
		if($gw_scr['s_list_chp_bad_ctg_qty'][$i] != ""
		&& $gw_scr['s_list_chp_bad_ctg_qty'][$i] != "0"
		){
			$ctgcnt++;
			$w_arr_ctg_dvs[$ctgcnt]  = constant("CE_CHP_BAD");
			$w_arr_ctg_cd[$ctgcnt]   = $gw_scr['s_list_chp_bad_ctg_cd'][$i];
			$w_arr_ctg_qty[$ctgcnt]  = $gw_scr['s_list_chp_bad_ctg_qty'][$i];
			$w_arr_ctg_txt[$ctgcnt]  = null;
			$w_arr_ctg_slid[$ctgcnt] = " ";
			# for threshold judgement
			$w_arr_jdg_cd[$ctgcnt]  = $gw_scr['s_list_chp_bad_ctg_cd'][$i];
			$w_arr_jdg_val[$ctgcnt] = $gw_scr['s_list_chp_bad_ctg_qty'][$i];
		}
	}

	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	#
	# IOOT
	#
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	$w_pas_qty = $gw_scr['s_pas_chp_qty'];
	$w_pas_sl_qty = $w_lot_bas['SL_QTY'];
	if($gw_scr['s_sl_flg'] == "1"){
		$w_pas_sl_qty = $gw_scr['s_pas_sl_qty'];
	}
	$w_rtn = main_verb_ioot($gw_scr['s_usr_id'],
							$w_arr_ctg_dvs,
							$w_arr_ctg_cd,
							$w_arr_ctg_qty,
							$w_arr_ctg_txt,
							$w_arr_ctg_slid,
							$w_pas_sl_qty,
							$w_pas_qty,
							$w_lot_bas['LF_QTY'],
							$gw_scr['s_cmt'],
							$w_lot_bas);
	if($w_rtn != 0){
		return 4000;
	}

	$gw_scr['s_upd_lev'] = trim($w_lot_bas['UPD_LEV']);	

	#------------------------------------------------------------------
	# material consumption(MTCS)
	#------------------------------------------------------------------
	if ($gw_scr['s_prt_ctrl'] == "1") {
		$w_rtn = main_exe_usemat($w_lot_bas['LOT_ID'], $gw_scr['s_stp_cd'],
				$gw_scr['s_prd_cd']);
		if ($w_rtn != 0)
			return 4000;
	}

	#------------------------------------------------------------------
	# if UV Irradiation step, insert lot_inf_tbl
	#------------------------------------------------------------------
	if($gw_scr['s_stp_cls_2'] == constant("E9_UVIRD")){
		# if has already exists, delete(del_flg = 1)
		$w_rtn = get_lotinf($gw_scr['s_hdn_lot_id'],
							constant("CE_LTINF"),
							constant("CT_UVIRD"),
							$w_uvdat);
		if($w_rtn != 0) return 4000;

		if(count($w_uvdat) > 0){
			$w_rtn = upd_lot_inf_tbl($gw_scr['s_usr_id'],
									$gw_scr['s_hdn_lot_id'],
									constant("CE_LTINF"),
									constant("CT_UVIRD"),
									set_space($w_uvdat['SL_ID']),
									"IOOT");
			if($w_rtn != 0) return 4000;
		}

		$w_uv  = date("Y-m-d H:i:s", cnvepc($g_cpu_dts) + (60 * 60 * 24 * constant("UVLIMIT_DAYS")));
		$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								constant("CE_LTINF"),
								constant("CT_UVIRD"),
								"1",
								$w_uv,
								"",
								"IOOT");
		if($w_rtn != 0) return 4000;
	}


	# if WAFER Mount 'if Step is wafer Mounting ( ST21S0000006  )
	# Get the date from expiry date textbox and insert/update it to LOT_INF_TBL ( CTG_CD : CT00S0000099)

	if($gw_scr['s_wfr_mnt_flg'] == "1"){
		
		$w_exp_dts = $gw_scr['s_lot_exp_dts'];

		$w_rtn = get_lotinf($gw_scr['s_lot_id'],  constant("CE_LTINF"), constant("CT_EXPIRED_DATE"), $w_lot_exp_inf);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
		$w_max_exp_cnt = $w_lot_exp_inf['CTG_DAT_VAL'];
		if($w_max_exp_cnt == ''){
			$w_max_exp_cnt = 1;
		}
		if($w_max_exp_cnt > 1){
				#DELETE track-out first then do the update
				$w_upd = array
				(
					"DEL_FLG"		=> "1",
					"USR_ID_UPD"	=> $gw_scr['s_usr_id'],
					"UPD_DTS"		=> $g_cpu_dts,
					"UPD_VERB"		=> "IOOT",
					"UPD_LEV"		=> 2
				);
				$w_whr = "LOT_ID = '" . $w_lot_bas{'LOT_ID'} . "' "
						. "AND CTG_DVS_CD = '" . constant("CE_LTINF") . "' "
						. "AND CTG_CD = '" . constant("CT_EXPIRED_DATE") . "' "
						. "AND CTG_DAT_VAL = '" . ($w_max_bake_cnt - 1) . "' "
						. "AND DEL_FLG = '0'";

				$w_rtn = db_update_one("LOT_INF_TBL", $w_upd, $w_whr);
				if($w_rtn != 0){
					list($g_msg, $g_err_lv) = msg("err_Upd");
					$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
					return 4000;
				}
			}
		$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								constant("CE_LTINF"),
								constant("CT_EXPIRED_DATE"),
								"1",
								$w_exp_dts,
								"",
								"IOOT");
	} 
	# END if WAFER Mount 'if Step is wafer Mounting ( ST21S0000006  )



	#------------------------------------------------------------------
	# if Post Mold Cure or Baking step, insert lot_inf_tbl
	#------------------------------------------------------------------
	if($gw_scr['s_stp_cls_2'] == constant("E9_MOLDCURE")
	|| $gw_scr['s_stp_cls_2'] == constant("E9_BAKING")
	){
		$w_ctgcd_baking = constant("CT_BAKING1");
		if($gw_scr['s_stp_cls_2'] == constant("E9_BAKING")){
			#Normal Baking
			$w_ctgcd_baking = constant("CT_BAKING2");
			
			$w_rtn = get_lotinf($gw_scr['s_lot_id'],  constant("CE_LTINF"), constant("CT_BAKING_TIME_BAKING"), $w_lot_bkin_inf);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
			$w_max_bake_cnt = $w_lot_bkin_inf['CTG_DAT_VAL'];
			if($w_max_bake_cnt == ''){
				$w_max_bake_cnt = 1;
			}
			
			if($w_max_bake_cnt > 1){
				#DELETE track-out first then do the update
				$w_upd = array
				(
					"DEL_FLG"		=> "1",
					"USR_ID_UPD"	=> $gw_scr['s_usr_id'],
					"UPD_DTS"		=> $g_cpu_dts,
					"UPD_VERB"		=> "IOOT",
					"UPD_LEV"		=> 2
				);
				$w_whr = "LOT_ID = '" . $w_lot_bas{'LOT_ID'} . "' "
						. "AND CTG_DVS_CD = '" . constant("CE_LTINF") . "' "
						. "AND CTG_CD = '" . $w_ctgcd_baking . "' "
						. "AND CTG_DAT_VAL = '" . ($w_max_bake_cnt - 1) . "' "
						. "AND DEL_FLG = '0'";

				$w_rtn = db_update_one("LOT_INF_TBL", $w_upd, $w_whr);
				if($w_rtn != 0){
					list($g_msg, $g_err_lv) = msg("err_Upd");
					$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
					return 4000;
				}
			}
			
			$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								constant("CE_LTINF"),
								$w_ctgcd_baking,
								" ",
								$g_cpu_dts,
								$w_max_bake_cnt,
								"IOOT");
			if($w_rtn != 0) return 4000;
			
			
		}else{
			#PMC Baking
			$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								constant("CE_LTINF"),
								$w_ctgcd_baking,
								" ",
								$g_cpu_dts,
								"1",
								"IOOT");
			if($w_rtn != 0) return 4000;
		
		}
	}


	


	#------------------------------------------------------------------
	# update substrate/physical qty
	#------------------------------------------------------------------
	if($gw_scr['s_sub_flg'] == "1"){
		#------------------------------------------------------------------
		# substrate qty
		#------------------------------------------------------------------
		### get current substrate qty
		$w_rtn = get_lotinf($gw_scr['s_hdn_lot_id'],
							constant("CE_LTINF"),
							constant("CT_SUBQTY"),
							$w_subinf);
		if($w_rtn != 0) return 4000;

		if($w_subinf['CTG_DAT_VAL'] != $gw_scr['s_pas_sub_qty']){
			### update substrate qty in lot_inf_tbl(DEL_FLG=0)
			$w_rtn = upd_lot_inf_tbl($gw_scr['s_usr_id'],
									 $gw_scr['s_hdn_lot_id'],
									 constant("CE_LTINF"),
									 constant("CT_SUBQTY"),
									 set_space($w_subinf['SL_ID']),
									 "IOOT");
			if($w_rtn != 0) return 4000;

			### insert new substrate qty
			if($gw_scr['s_nxt_sub_flg'] == "1"){
				$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
										 $gw_scr['s_hdn_lot_id'],
										 constant("CE_LTINF"),
										 constant("CT_SUBQTY"),
										 set_space($w_subinf['SL_ID']),
										 "",
										 $gw_scr['s_pas_sub_qty'],
										 "IOOT");
				if($w_rtn != 0) return 4000;
			}
		}
		#------------------------------------------------------------------
		# physical qty
		#------------------------------------------------------------------
		### get current physical qty
		$w_rtn = get_lotinf($gw_scr['s_hdn_lot_id'],
							constant("CE_LTINF"),
							constant("CT_PHYQTY"),
							$w_phyinf);
		if($w_rtn != 0) return 4000;

		if($w_phyinf['CTG_DAT_VAL'] != $gw_scr['s_inp_phy_qty']){
			### update physical qty in lot_inf_tbl(DEL_FLG=1)
			if($w_phyinf){
				$w_rtn = upd_lot_inf_tbl($gw_scr['s_usr_id'],
										 $gw_scr['s_hdn_lot_id'],
										 constant("CE_LTINF"),
										 constant("CT_PHYQTY"),
										 set_space($w_phyinf['SL_ID']),
										 "IOOT");
				if($w_rtn != 0) return 4000;
			}

			### insert new physical qty
			$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
									 $gw_scr['s_hdn_lot_id'],
									 constant("CE_LTINF"),
									 constant("CT_PHYQTY"),
									 set_space($w_phyinf['SL_ID']),
									 "",
									 $gw_scr['s_inp_phy_qty'],
									 "IOOT");
			if($w_rtn != 0) return 4000;
		}
	}

	#------------------------------------------------------------------
	# BP2 summary sending if needed
	#------------------------------------------------------------------
	### Get next step, if next step is manual transfer, execute BP2 sending	
	$w_rtn = get_nxtstp_inf($w_lot_bas['PRD_CD'], $w_lot_bas['STP_CD'], $w_nxtstp_dat);
	if($w_rtn != 0){
		return 4000;
	}
	if($w_nxtstp_dat[1]['STP_CLS_2'] == constant('E9_MANUAL_TFR_PROCESS')){
	
		#checkin is after IOOT, that means lot is already finished with current step
		$w_rtn = cs_xck_exst_child($w_lot_bas
									, constant('AW_BP2_CONTROL')
									, constant('E9_MANUAL_TFR_PROCESS')
									, $w_exst_lot_bas
									, 0
									);
		if($w_rtn != 0){
			return 4000;
		}
		
		#if all children have been sent, then send summary
		#if count > 2, verify each child. if all other children are finished then send
		$w_bln_all_check = TRUE;
		if(count($w_exst_lot_bas) > 0){
			foreach ( $w_exst_lot_bas as $w_child_lot_bas){
				if($w_child_lot_bas['LOT_ID'] != $w_lot_bas['LOT_ID']){
					$w_rtn = check_VerbOnStep(
									$w_child_lot_bas['LOT_ID'],
									"IOOT",
									$w_child_lot_bas['STP_CD'],
									$w_bln_check
									);
					if($w_rtn != 0){
						list($g_msg, $g_err_lv) = msg("err_Err_BP2Fail");
						$g_msg = xpt_err_msg($g_msg,"", __LINE__);
						return 4000;
					}
					
					if(!$w_bln_check){
						$w_bln_all_check = FALSE;
					}
					
				}
			}
		}
		
		if ((count($w_exst_lot_bas) > 1 &&  $w_bln_all_check ) || (count($w_exst_lot_bas) == 1 && $w_exst_lot_bas[1]['LOT_ID'] == $w_lot_bas['LOT_ID'])) {
			
			$w_rtn = cs_xck_exst_child__TrcBck($w_lot_bas['LOT_ID'],
											$w_lot_bas['VERB_CAN'],
											$w_lot_bas['STP_CD'],
											$w_lot_bas['DTS_CAN'],
											$w_arr_child_lot);
											
			if($w_rtn != 0) return 4000;
		
			$w_rtn = cs_xck_abn_snd_summary(
							$w_lot_bas['LOT_ID'],
							"N",
							$w_lot_bas['EQU_CD'],
							$gw_scr['s_usr_id'],
							$g_cpu_dts,
							$w_lot_bas['CHP_QTY'],
							$gw_scr['s_pas_chp_qty'],
							$w_arr_child_lot,
							$w_spc_summ_err_cd,
							$w_spc_summ_err_desc,
							$w_spc_summ_reply);
					
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, $w_spc_summ_err_desc, __LINE__);
				return 4000;
			}
				
			if($w_spc_summ_err_cd != constant("SPC_ERRCD_NRM")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_ABN")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_PCS")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_ABNPCS")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_BP2")
			){
				list($g_msg, $g_err_lv) = msg("err_Err_Space");
				$g_msg = xpt_err_msg($g_msg, $w_spc_summ_err_cd , __LINE__);
				return 4000;
			}
			
			if($w_spc_summ_err_cd == constant("SPC_ERRCD_BP2")){
				#need BP2
				#update lot inf tbl
				
				foreach ( $w_arr_child_lot as $w_child_lot_buff){
				
					$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
									$w_child_lot_buff,
									constant("CE_LTINF"),
									constant("CT_BP2CTL"),
									" ",
									constant("TXT_BP2"),
									"",
									"IOOT");
					if($w_rtn != 0){
						list($g_msg, $g_err_lv) = msg("err_Err_BP2Fail");
						$g_msg = xpt_err_msg($g_msg, $w_spc_summ_reply . "--" . $w_spc_summ_err_cd, __LINE__);
						return 4000;
					}
				}
				
			}elseif($w_spc_summ_err_cd != constant("SPC_ERRCD_NRM")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_ABN")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_PCS")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_ABNPCS")
			&& $w_spc_summ_err_cd != constant("SPC_ERRCD_BP2")
			){
				list($g_msg, $g_err_lv) = msg("err_Err_BP2Unknown");
				$g_msg = xpt_err_msg($g_msg, $w_spc_summ_reply . "--" . $w_spc_summ_err_cd, __LINE__);
				return 4000;
			}

		}else{
			#do nothing
		}
	}
	
	#------------------------------------------------------------------
	# Lot close due to all reject
	#------------------------------------------------------------------
	if($w_pas_qty == 0){
		#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
		#
		# IOAB
		#
		#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
		$w_rtn = main_verb_ioab($gw_scr['s_usr_id'],
								"",
								$w_lot_bas);
		if($w_rtn != 0){
			return 4000;
		}

		#------------------------------------------------------------------
		# get magazine info
		#------------------------------------------------------------------
		$w_rtn = get_mgzn($w_lot_bas['LOT_ID'], $w_mgznid);
		if($w_rtn != 0){
			return 4000;
		}
		if(count($w_mgznid) > 0){
			#------------------------------------------------------------------
			# execution magazine control for IOAB
			#------------------------------------------------------------------
			$w_rtn = exe_mgzn_ioab($gw_scr['s_usr_id'], $w_lot_bas['LOT_ID']);
			if($w_rtn != 0){
				return 4000;
			}
		}

		list($g_msg, $g_err_lv) = msg("end_AllReject");

		### return here
		return 0;
	}

	#------------------------------------------------------------------
        # 2016-06-03
        # New : If product need to do the physical adjustment,
        #       need to calcuate based on tray and insert to CTG_LOG.
        #------------------------------------------------------------------
        if( $gw_scr['s_is_need_physical_adj'] == "1") { # Product Need To Do Adjustment At PACK PREPARATION
                $w_rtn = get_chip_qty_per_tray($w_lot_bas['PRD_CD'], $w_chip_qty_per_tray);
                if($w_rtn != 0){
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
                }

                # Chip qty per tray should not be blank or 0
                if($w_chip_qty_per_tray <= 0 || $w_chip_qty_per_tray == " ") {
                        list($g_msg, $g_err_lv) = msg("err_chip_qty_pre_tray");
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
                }

                $w_cal_physical_qty = (($gw_scr['s_tray_no'] * $w_chip_qty_per_tray ) + $gw_scr['s_bal_tray_qty']);

 		$w_rtn = get_cal_physical_qty($w_lot_bas['LOT_ID'], $w_exists_cal_physical_qty);
                if($w_rtn != 0){
                        $g_err_lv = 0;
                        $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                        return 4000;
                }

                if($w_exists_cal_physical_qty > 0) {
                        $w_rtn = del_cal_physical_qty($gw_scr['s_usr_id'], $w_lot_bas['LOT_ID']);
                        if($w_rtn != 0){
                                $g_err_lv = 0;
                                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                return 4000;
                        }
                }

                #save to ctg_log
                $w_rtn =ins_ctg_log(
                                                constant('CE_LTINF'),
                                                constant('CT_CALCULATED_PHYSICAL_QTY'),
                                                " " ,
                                                $gw_scr['s_equ_cd'],
                                                $w_cal_physical_qty,
                                                $w_lot_bas
                                                );
                if ($w_rtn != 0) {
                        return 4000;
                }
        }

	#------------------------------------------------------------------
	# regist reserve HOLD
	#	when the limit time exceeding at Post mold cure stp
	#------------------------------------------------------------------
	if($gw_scr['s_stp_cls_2']  == constant("E9_MOLDCURE")
	&& $gw_scr['s_expire_flg'] == "1" && $gw_scr['s_pastec_flg'] == "1"
	){
		$r_holdrsv_washdry = 1;
		$w_rtn = main_exe_holdrsv_washdry($gw_scr['s_usr_id'], $w_lot_bas, $w_rsv_id);
		if($w_rtn != 0) return 4000;
	}

        #-----------------------------------------------------------------
        # IOHD when exceed the limit time
        #------------------------------------------------------------------
        if($gw_scr['s_stp_cls_2']  == constant("E9_MOLDCURE")
        && $gw_scr['s_expire_flg'] == "1" && $gw_scr['s_postcu_flg'] == "1"
        ){
                $r_lmthold = 1;
		$w_rtn = main_exe_stplmt($gw_scr['s_usr_id'], $w_lot_bas);
                if($w_rtn != 0) return 4000;
                return 0;
        }
	
	#-----------------------------------------------------------------
        # IOHD when exceed the limit time for Paste Cure 2  (DAF Cure)
        #------------------------------------------------------------------
        if($gw_scr['s_stp_cls_2']  == constant("E9_PASTECURE2")
        && $gw_scr['s_expire_flg'] == "1" && $gw_scr['s_postcu_flg'] == "1"
        ){
                $r_lmthold = 1;
		$w_rtn = main_exe_stplmt($gw_scr['s_usr_id'], $w_lot_bas);
                if($w_rtn != 0) return 4000;
                return 0;
        }


	#------------------------------------------------------------------
	# insert Hairline Crack Info
	#------------------------------------------------------------------
	if($gw_scr['s_crk_flg'] == "1"){
		$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
								$gw_scr['s_hdn_lot_id'],
								constant("CE_LTINF"),
								constant("CT_CRACK"),
								" ",
								constant("TXT_CRACK"),
								"",
								"IOOT");
		if($w_rtn != 0) return 4000;
	}


	#------------------------------------------------------------------
	# search magazine control setting
	#------------------------------------------------------------------
	$w_rtn = cs_xck_jig_srch(trim($w_lot_bas['PRC_CD']),
							 trim($w_lot_bas['STP_CD']),
							 trim($w_lot_bas['PRD_CD']),
							 constant("JI_JIG"),
							 $w_prt_grp_b, $w_prt_grp_a, $w_jig_chg_id);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	### magazine control step
	if($r_prt_grp_a != ""){
		#------------------------------------------------------------------
		# get current magazine ID
		#------------------------------------------------------------------
		$w_rtn = cs_xck_jig_get_lot(trim($w_lot_bas['LOT_ID']), constant("JI_JIG"), "2", $w_prt_grp_b,
									$w_prt_grp_a, $w_jig_chg_id, $w_mag_id_b);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	$w_chk = "";
	### new
	if($w_prt_grp_a != "" && $w_prt_grp_b == "" && $w_jig_chg_id == "CHG"){
		$w_chk = "1";
	}
	### change
	if($w_prt_grp_a != "" && $w_prt_grp_b != "" && $w_jig_chg_id == "CHG"){
		$w_chk = "2";
	}
	### hold(not change)
	if($w_prt_grp_a != "" && $w_prt_grp_b != "" && $w_jig_chg_id == "HOLD"){
		$w_chk = "3";
	}
	### delete
    if($w_prt_grp_a == "" && $w_prt_grp_b != "" && $w_jig_chg_id == "CHG"){
		$w_chk = "4";
	}

	### case change or delete
	if($w_chk == "2" || $w_chk == "4"){
		#------------------------------------------------------------------
		# MTOT
		#------------------------------------------------------------------
		$w_rtn = main_verb_mtot($gw_scr['s_usr_id'], $w_lot_bas['LOT_ID']);
		if($w_rtn != 0){
			return 4000;
		}

		#------------------------------------------------------------------
		# delete magazine info(DEL_FLG=1)
		#------------------------------------------------------------------
		$w_rtn = del_mgzn($gw_scr['s_usr_id'], "IOOT", $w_lot_bas['LOT_ID']);
		if($w_rtn != 0){
			return 4000;
		}
	}
	### case new or change
	if($w_chk == "1" || $w_chk == "2"){
		for($i=1; $i<=$gw_scr['s_h_disp_row']; $i++){
			if($gw_scr['s_list_mgzn_id'][$i] == ""){
				continue;
			}

			#------------------------------------------------------------------
			# MTIN
			#------------------------------------------------------------------
			$w_rtn = main_verb_mtin($gw_scr['s_usr_id'],
									$w_lot_bas['LOT_ID'],
									$gw_scr['s_list_mgzn_id'][$i]);
			if($w_rtn != 0){
				return 4000;
			}

			#------------------------------------------------------------------
			# insert new magaine ID
			#------------------------------------------------------------------
			$w_rtn = ins_mgznid($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								$gw_scr['s_list_mgzn_id'][$i],
								"IOOT");
			if($w_rtn != 0){
				return 4000;
			}
		}
	}

	#------------------------------------------------------------------
	# threshold judgement
	#------------------------------------------------------------------
	$w_rtn = main_exe_thd_jdg($gw_scr['s_usr_id'],
							  $gw_scr['s_inp_chp_qty'],
							  $w_pas_qty,
							  $w_arr_jdg_cd,
							  $w_arr_jdg_val,
							  $w_lot_bas,
							  $w_hold_exe_flg,
							  $r_jdghold);
	if($w_rtn != 0){
		return 4000;
	}
	### if execute hold, return here
	if($w_hold_exe_flg == 1){
		return 0;
	}

	#------------------------------------------------------------------
	# SPACE
	#------------------------------------------------------------------
	$w_rtn = main_exe_spc($gw_scr['s_usr_id'],
						$w_spc_err_cd,
						$gw_scr['s_spc_equinf'],
						$w_lot_bas,
						$w_hold_exe_flg,
						$r_spchold);
	if($w_rtn != 0) return 4000;

	### if execute hold, return here
	if($w_hold_exe_flg == 1){
		return 0;
	}

	#------------------------------------------------------------------
	# IOHD when exceed the limit time
	#------------------------------------------------------------------
	if($gw_scr['s_stp_cls_2']  != constant("E9_MOLDCURE")
	&& $gw_scr['s_expire_flg'] == "1"
	){
		$r_lmthold = 1;
		$w_rtn = main_exe_stplmt($gw_scr['s_usr_id'], $w_lot_bas);
		if($w_rtn != 0) return 4000;
		return 0;
	}

	#------------------------------------------------------------------
	# material hold
	#------------------------------------------------------------------
	$w_rtn = main_exe_mthd($w_exe_mthd, $w_exp, $w_life, $w_thaw);
	if($w_rtn != 0) return 4000;

	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	#
	# IOMV/PRPT-PRPC-PRGT
	#
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	$w_iomv = 0;
	if($gw_scr['s_stp_cls_2'] != constant("E9_PACKING")
		&& $gw_scr['s_pp_flg' != '1']){ # IF PICTURE PERUSAL no IOMV
		$w_rtn = main_verb_iomv($gw_scr['s_usr_id'], "", $w_lot_bas);
		if($w_rtn != 0){
			return 4000;
		}
		$w_iomv = 1;
	}

	# Picture Perusal										
	# Check Step is Picture Perusel									
	if($gw_scr['s_pp_flg']=='1'){
		#insert PP data. ( CTG_LOG )							

	} # END Picture Perusal	
	

	#'F0 Test 'Ok1/OK2 Checking md3
	#PENDING IOPC
	if($gw_scr['s_f0_test_flg'] == '1'){
		$w_lot_id =  trim($gw_scr['s_lot_id']);






		if($gw_scr['isOk1_input_flg'] == '1' && $gw_scr['isOk2_input_flg'] == '1'){
			# if both ok1 and ok2 set
			for($ok_index = 1; $ok_index <= 2; $ok_index++){
				$w_rtn = xgt_lot($w_lot_id, $w_lot_bas);
				if ($w_rtn != 0) {
					$g_err_lv = 0;
					$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
					return 4000;
				}

				# insert "OK1" for ok1 lot in LOT_INF_TBL ( CT21S0000020 ) ( CTG_DAT_TXT = "OK1" )
			# insert "OK2" for ok2 lot in LOT_INF_TBL ( CT21S0000020 ) ( CTG_DAT_TXT = "OK2" )

				$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								constant("CE_LTINF"),
								constant("CT_OK1OK2"),
								"1",
								"OK".$ok_index,
								"",
								"IOOT");

				$w_rtn = xck_upd($w_lot_bas['UPD_LEV'], $w_upd_lev);
				if ($w_rtn != 0) {
					$g_err_lv = 0;
					$g_msg = xpt_err_msg($g_msg, "", __LINE__);
					return 4000;
				}
				
				$w_sp_lot_no_str   = $w_lot_bas['LOT_NO_STR'];
				$w_ex_lot_no_str   = $w_lot_bas['LOT_NO_STR'];

				$w_spcnt = 1;
				$w_arr_sl_qty[1] = $w_lot_bas['SL_QTY'];
				$w_arr_chp_qty[1] = $gw_scr['s_ok_qty'][$ok_index];
				$w_arr_lf_qty[1] = 0;
				$w_arr_lot_no[1] = $w_sp_lot_no_str;
				$w_arr_sec_no[1] = $w_lot_bas['SECRET_NO'];
				### IOSP
				$w_rtn = main_verb_iosp($gw_scr['s_usr_id'],
										$w_spcnt,
										$w_arr_sl_qty,
										$w_arr_chp_qty,
										$w_arr_lf_qty,
										$w_arr_lot_no,
										$w_arr_sec_no,
										$w_lot_bas,
										$w_new_lot_id,
										$w_new_upd_lev);
				if($w_rtn != 0) return 4000;

				$w_ex_lot_bas = $w_lot_bas;
				### LOT_NO_STR
				$w_upd = array
				(
					"LOT_NO"		=> $w_ex_lot_no_str,
					"LOT_NO_STR"	=> $w_ex_lot_no_str
				);
				$w_whr = "LOT_ID = '" . $w_ex_lot_bas['LOT_ID'] . "' ";
				$w_rtn = db_update_one("LOT_BAS_TBL", $w_upd, $w_whr);
				if($w_rtn != 0){
					list($g_msg, $g_err_lv) = msg("err_Upd");
					$g_msg = xpt_err_msg($g_msg, "LOT_BAS_TBL", __LINE__);
					return 4000;
				}

				### 
				$w_lot_bas = array();
				$w_rtn = xgt_lot($w_new_lot_id[1], $w_lot_bas);
				if($w_rtn != 0){
					$g_err_lv = 0;
					$g_msg = xpt_err_msg($g_msg, "", __LINE__);
					return 4000;
				}

				#insert parent lot id to "OK1" and "OK2"  lot. ( cs_xpt_ccd_f0_test.php )
				$w_rtn = cs_xpt_ccd_f0_test__insert_mother_lot_id($w_lot_bas['LOT_ID'],$w_ex_lot_bas['LOT_ID'], 'IOSP', $gw_scr['s_usr_id']);


				###  LOT_NO_STR (Verb)
				$w_lot_bas['LOT_NO_STR'] = $w_sp_lot_no_str;

				### LOT_INF_TBL
				$w_rtn = inhrt_lot_inf_tbl_for_iosp($gw_scr['s_usr_id'],
													$w_ex_lot_bas['LOT_ID'],
													$w_lot_bas['LOT_ID']);
				if($w_rtn != 0) return 4000;

				
				#IOPC for new lot
				$w_rtn = chk_pck_prd($w_lot_bas['RT_CD'],
							  $w_lot_bas['PRC_CD'],
							  $w_lot_bas['STP_CD'],
							  $gw_scr['s_fg_cd'],
							  $w_new_rt_cd);
				if($w_rtn != 0)  return 4000;
						
					


				if(trim($w_lot_bas['PRD_CD']) != $gw_scr['s_fg_cd'] || trim($w_lot_bas['RT_CD']) != trim($w_new_rt_cd)){
					$w_rtn = main_verb_iopc($gw_scr['s_usr_id'],
											$w_new_rt_cd,
											$gw_scr['s_ok_prd'][$ok_index],
											$w_lot_bas['RNK_PTN'],
											$w_lot_bas);
					if($w_rtn != 0) return 4000;
				}	

				# IOIN
				$w_rtn = main_verb_ioin($gw_scr['s_usr_id'], $gw_scr['s_equ_cd'], $w_lot_bas);
				if($w_rtn != 0) return 4000;

				# IOOT
				$w_rtn = main_verb_ioot($gw_scr['s_usr_id'], array(), array(), array(),
								array(), array(), $w_lot_bas['SL_QTY'], $w_lot_bas['CHP_QTY'],
								$w_lot_bas['LF_QTY'], null, $w_lot_bas);
				if($w_rtn != 0) return 4000;

				#------------------------------------------------------------------
		        # sleep 1 sec if have previous sequence of IOIN and IOOT
		        #------------------------------------------------------------------
		        if($w_sleep_flg){
		                xpt_1sec_dts();
		        }

				# IOMV
				$w_rtn = main_verb_iomv($gw_scr['s_usr_id'], "", $w_lot_bas);
				if($w_rtn != 0) return 4000;
			}

		}
		else { #only one of the OK's full qty split.
			$ok_index = 1;
			if($gw_scr['isOk2_input_flg'] == '1'){
				$ok_index = 2;
			}
			$w_rtn = xgt_lot($w_lot_id, $w_lot_bas);
			if ($w_rtn != 0) {
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
				return 4000;
			}
			$w_rtn = xck_upd($w_lot_bas['UPD_LEV'], $w_upd_lev);
			if ($w_rtn != 0) {
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
			
			# insert "OK1" for ok1 lot in LOT_INF_TBL ( CT21S0000020 ) ( CTG_DAT_TXT = "OK1" )
			# insert "OK2" for ok2 lot in LOT_INF_TBL ( CT21S0000020 ) ( CTG_DAT_TXT = "OK2" )

			$w_rtn = ins_lot_inf_tbl($gw_scr['s_usr_id'],
								$w_lot_bas['LOT_ID'],
								constant("CE_LTINF"),
								constant("CT_OK1OK2"),
								"1",
								"OK".$ok_index,
								"",
								"IOOT");			

			$w_sp_lot_no_str   = $w_lot_bas['LOT_NO_STR'];
			$w_ex_lot_no_str   = $w_lot_bas['LOT_NO_STR'];

			$w_spcnt = 1;
			$w_arr_sl_qty[1] = $w_lot_bas['SL_QTY'];
			$w_arr_chp_qty[1] = $gw_scr['s_ok_qty'][$ok_index];
			$w_arr_lf_qty[1] = 0;
			$w_arr_lot_no[1] = $w_sp_lot_no_str;
			$w_arr_sec_no[1] = $w_lot_bas['SECRET_NO'];
			### IOSP
			$w_rtn = main_verb_iosp($gw_scr['s_usr_id'],
									$w_spcnt,
									$w_arr_sl_qty,
									$w_arr_chp_qty,
									$w_arr_lf_qty,
									$w_arr_lot_no,
									$w_arr_sec_no,
									$w_lot_bas,
									$w_new_lot_id,
									$w_new_upd_lev);
			if($w_rtn != 0) return 4000;

			$w_ex_lot_bas = $w_lot_bas;
			### LOT_NO_STR
			$w_upd = array
			(
				"LOT_NO"		=> $w_ex_lot_no_str,
				"LOT_NO_STR"	=> $w_ex_lot_no_str
			);
			$w_whr = "LOT_ID = '" . $w_ex_lot_bas['LOT_ID'] . "' ";
			$w_rtn = db_update_one("LOT_BAS_TBL", $w_upd, $w_whr);
			if($w_rtn != 0){
				list($g_msg, $g_err_lv) = msg("err_Upd");
				$g_msg = xpt_err_msg($g_msg, "LOT_BAS_TBL", __LINE__);
				return 4000;
			}

			### 
			$w_lot_bas = array();
			$w_rtn = xgt_lot($w_new_lot_id[1], $w_lot_bas);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}

			#insert parent lot id to "OK1" and "OK2"  lot. ( cs_xpt_ccd_f0_test.php )
			$w_rtn = cs_xpt_ccd_f0_test__insert_mother_lot_id($w_lot_bas['LOT_ID'],$w_ex_lot_bas['LOT_ID'], 'IOSP', $gw_scr['s_usr_id']);

			###  LOT_NO_STR (Verb)
			$w_lot_bas['LOT_NO_STR'] = $w_sp_lot_no_str;

			### LOT_INF_TBL
			$w_rtn = inhrt_lot_inf_tbl_for_iosp($gw_scr['s_usr_id'],
												$w_ex_lot_bas['LOT_ID'],
												$w_lot_bas['LOT_ID']);
			if($w_rtn != 0) return 4000;

			#IOPC for new lot
			$w_rtn = chk_pck_prd($w_lot_bas['RT_CD'],
						  $w_lot_bas['PRC_CD'],
						  $w_lot_bas['STP_CD'],
						  $gw_scr['s_fg_cd'],
						  $w_new_rt_cd);
			
			if($w_rtn != 0)  return 4000;

			if(trim($w_lot_bas['PRD_CD']) != $gw_scr['s_fg_cd'] || trim($w_lot_bas['RT_CD']) != trim($w_new_rt_cd)){
				$w_rtn = main_verb_iopc($gw_scr['s_usr_id'],
										$w_new_rt_cd,
										$gw_scr['s_ok_prd'][$ok_index],
										$w_lot_bas['RNK_PTN'],
										$w_lot_bas);
				if($w_rtn != 0) return 4000;
			}	

	

			# IOIN
			$w_rtn = main_verb_ioin($gw_scr['s_usr_id'], $gw_scr['s_equ_cd'], $w_lot_bas);
			if($w_rtn != 0) return 4000;

			# IOOT
			$w_rtn = main_verb_ioot($gw_scr['s_usr_id'], array(), array(), array(),
							array(), array(), $w_lot_bas['SL_QTY'], $w_lot_bas['CHP_QTY'],
							$w_lot_bas['LF_QTY'], null, $w_lot_bas);
			if($w_rtn != 0) return 4000;

			#------------------------------------------------------------------
		        # sleep 1 sec if have previous sequence of IOIN and IOOT
		        #------------------------------------------------------------------
		        if($w_sleep_flg){
		                xpt_1sec_dts();
		        }

			# IOMV
			$w_rtn = main_verb_iomv($gw_scr['s_usr_id'], "", $w_lot_bas);
			if($w_rtn != 0) return 4000;

		} #end ok1 || ok2 full split

		#F0 Test Track in Date Insert
		#Need to insert the track out date to lot_inf_tbl as ref to check the expiry date in the next steps. ( cs_xpt_ccd_f0_test.php)
		$w_rtn = cs_xpt_ccd_f0_test__insert_track_out_date($w_lot_id, $g_cpu_dts, 'IOOT', $gw_scr['s_usr_id']);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		} #END F0 Test Track in Date Insert

	}
	# END 'F0 Test 'Ok1/OK2 Checking


	
	#------------------------------------------------------------------
	# if execute material hold, also device Lot hold
	#------------------------------------------------------------------
	if($w_exe_mthd == 1){
		$w_rtn = main_exe_iohd_by_mthd($w_lot_bas['LOT_ID'], $w_lot_bas['UPD_LEV'],
								$w_exp, $w_life, $w_thaw);
		if($w_rtn != 0) return 4000;

		$r_mthd_flg = 1;
		#------------------------------------------------------------------
		# not execute material hold
		#------------------------------------------------------------------
	} else {
		if($w_iomv == 1){
			#------------------------------------------------------------------
			# check hold reserve and execute Lot hold
			#------------------------------------------------------------------
			$w_rtn = cs_xexc_hold_rsv($gw_scr['s_usr_id'],
									  $w_lot_bas,
									  $w_hold_exc_flg,
									  $w_rls_set_day,
									  $w_rsn,
									  $w_infrm);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
			### if execute hold, set the return value
			if($w_hold_exc_flg == 1){
				$holdcnt = 0;
				$holdcnt++;
				$r_holdrsv[$holdcnt] = array
				(
					'LOT_ID'	=> trim($w_lot_bas['LOT_ID']),
					'MSG'		=> sprintf(itm("RsvHoldInfo"), $w_rsn, $w_infrm, $w_rls_set_day)
				);
			}
		}
	}

	# Picture PERUSAL Step
	#insert PP data. ( CTG_LOG )
	#<< CT21S0000003, CT21S0000004, CT21S0000005 >>>															

	if($gw_scr['s_pp_flg' == 1]){

		$input_qty = trim($gw_scr['s_pas_chp_qty']);
		$w_rtn =ins_ctg_log(
                                                constant('CE_LTINF'),
                                                constant('CT_PP_INPUT'),
                                                $input_qty,
                                                $gw_scr['s_equ_cd'],
                                                $input_qty,
                                                $w_lot_bas
                                                );
                if ($w_rtn != 0) {
                        return 4000;
                }

		$fail_qty = trim($gw_scr['s_rej_chp_qty']);
		$w_rtn =ins_ctg_log(
                                                constant('CE_LTINF'),
                                                constant('CT_PP_FAIL'),
                                                $input_qty,
                                                $gw_scr['s_equ_cd'],
                                                $input_qty,
                                                $w_lot_bas
                                                );
                if ($w_rtn != 0) {
                        return 4000;
                }

		$w_rtn = getBUYield($w_lot_bas["PRD_CD"],$w_lot_bas["STP_CD"],$yld_buff);
		if($w_rtn == 0){
			$w_powerEye_yield = round($yld_buff / 100,4);
			
		}
		$yield_qty = trim($w_powerEye_yield);
		$w_rtn =ins_ctg_log(
                                                constant('CE_LTINF'),
                                                constant('CT_PP_YIELD'),
                                                $input_qty,
                                                $gw_scr['s_equ_cd'],
                                                $input_qty,
                                                $w_lot_bas
                                                );
                if ($w_rtn != 0) {
                        return 4000;
                }
		

	}

	# QC Gate
	if($gw_scr['s_smp_flg']=='1'){
		#Insert Sample Qty date to CTG_LOG ( Need to create new category codes ) 

		#Do IOOT(finished), MOVE(finished), IOIN, 

		$w_rtn = main_verb_ioin($gw_scr['s_usr_id'], $gw_scr['s_equ_cd'], $w_lot_bas);
		if($w_rtn != 0) return 4000;

			$w_smp_fail_qty = trim($gw_scr['s_fail'][1]);


		#If Failure qty is greater than 0,
				#Need to show Warning Message "Need to do 100% qty check for this lot"				
			if($w_smp_fail_qty > 0){
				list($g_msg, $g_err_lv) = msg("err_Warn_smp_fail");
                $g_msg = xpt_err_msg($g_msg, $w_web_err_nm, __LINE__);
                $w_warn[] = $g_msg;	
            }					
							

		#Else Failure qty is equal "0"											
			if($w_smp_fail_qty == 0){
				
				# IOOT
				$w_rtn = main_verb_ioot($gw_scr['s_usr_id'], array(), array(), array(),
								array(), array(), $w_lot_bas['SL_QTY'], $w_lot_bas['CHP_QTY'],
								$w_lot_bas['LF_QTY'], null, $w_lot_bas);
				if($w_rtn != 0) return 4000;

				# IOMV
				$w_rtn = main_verb_iomv($gw_scr['s_usr_id'], $gw_scr['s_equ_cd'], $w_lot_bas);
				if($w_rtn != 0) return 4000;
            }										
			#Do IOOT and IOMV. ( At the 2 nd IOOT no failure )																					

	}

	# SCRATCH / CHIP QTY Execute (Based on step code)
	$w_rtn = get_scr_chp_par_mst(trim($w_lot_bas['STP_CD']),$sc_arr);
    if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	if(count($sc_arr) > 0){
		$gw_scr['s_sc_count'] = count($sc_arr);
		$i = 1;
		// var_dump($sc_arr);
		foreach($sc_arr as $row){
			$w_sc_input_qty = trim($gw_scr['s_sc_input_qty'][$i]);
			$w_sc_ctg_cd = trim($gw_scr['s_sc_ctg_cd'][$i]);
			

			if($w_sc_input_qty!= ""){
				# If Qty is not blank, 
				## Qty must be integer.
				## Qty must greater than 0
				## Qty can't greater than lot qty.
				if(!check_num($w_sc_input_qty)){
					list($g_msg, $g_err_lv) = msg("err_Inp_Num");
					$g_msg = xpt_err_msg($g_msg, $gw_scr['s_sc_label_nm'][$i], __LINE__);
					return 4000;
				}
				if($w_sc_input_qty <= 0 ){
					list($g_msg, $g_err_lv) = msg("err_gr_zero");
					$g_msg = xpt_err_msg($g_msg, $gw_scr['s_sc_label_nm'][$i], __LINE__);
					return 4000;
				}
				if($w_sc_input_qty > $w_lot_bas['CHIP_QTY'] ){
					list($g_msg, $g_err_lv) = msg("err_sc_qty");
					$g_msg = xpt_err_msg($g_msg, $gw_scr['s_sc_label_nm'][$i], __LINE__);
					return 4000;
				}

				#save to ctg_log
                $w_rtn =ins_ctg_log(
                                                constant('CE_LTINF'),
                                                $w_sc_ctg_cd,
                                                " " ,
                                                $gw_scr['s_equ_cd'],
                                                $w_sc_input_qtys,
                                                $w_lot_bas
                                                );
                if ($w_rtn != 0) {
                        return 4000;
                }

			}
		

			$i++;
		}
	}
	# END SCRATCH / CHIP QTY CHECK (Based on step code)


	# SCVE Control			
	#$$ Check Lot is SCVE Lot ( In LOT_INF_TBL with SCVE Category Code ) and step is WIPE & PROCTECT SEAL step			
	#	If Yes,		
	#			set SCVE finish to OK ( LOT_INF_TBL ) ( cs_xpt_scve__finish_scve_flag)
	
	if($gw_scr['s_wp_seal_flg']==1){
		$w_rtn = cs_xpt_scve__get_scve_lot($w_lot_bas['LOT_ID'], $w_scve_lot_id);
		if($w_rtn != 0) {        
            $g_err_lv = 0;
            $g_msg = xpt_err_msg($g_msg, $w_lot_bas['LOT_ID'], __LINE__);
            return 4000;
	    }		

		if($w_lot_bas['LOT_ID'] == $w_scve_lot_id){  
			$w_rtn = cs_xpt_scve__finish_scve_flag($w_scve_lot_id, 'IOOT', $gw_scr['w_usr_id']);
			if ($w_rtn != 0) {
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
		}
	
	}


	#END SCVE Control / Wipe protect seal

	if(count($w_warn) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_warn);
	}
		$g_msg .= "<br>". $w_msg10;
	$g_msg = xpt_err_msg($g_msg, "", "");
	
	

	return 0;
}

#======================================================================
# execution of using materials
#======================================================================
function main_exe_usemat($w_lot_id, $w_stp_cd, $w_prd_cd, $w_noexe = null) {
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$w_mcnt      = get_session_value('s_max_rows',       constant("PGM_MTMNG"));
	$w_prt_cd    = get_session_value('s_list_prt_cd',    constant("PGM_MTMNG"));
	$w_mt_lot_id = get_session_value('s_list_mt_lot_id', constant("PGM_MTMNG"));
	$w_use_qty   = get_session_value('s_list_use_qty',   constant("PGM_MTMNG"));
	$w_cls_qty   = get_session_value('s_list_cls_chkd',   constant("PGM_MTMNG"));

	$w_mtcs_flg = 0;
	for ($m = 1; $m <= $w_mcnt; $m++) {
		if ($w_prt_cd[$m]  == "") continue;
		if ($w_use_qty[$m] == "") continue;

		#---------------------------
		# get shop code
		#---------------------------
		$w_rtn = xgt_stp($w_stp_cd, $w_shp_cd);
		if ($w_rtn != 0) {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return $w_rtn;
		}

		#------------------------------------------------------------------
		# get division by main flag
		#------------------------------------------------------------------
		$w_rtn = xgt_dvsn($w_dvsn_cd, $w_fct_cd, $w_rdg_cd);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# get parts INF - for material consumption checking flag
		#------------------------------------------------------------------
		$w_rtn = get_prt_inf($w_prt_cd[$m], constant("AW_MTL_CONSUMPTION"),$w_dvsn_cd,$w_prt_inf_mst);
		if ($w_rtn != 0) {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
		
		if(is_null($w_noexe) && $w_prt_inf_mst['NUM'] != 1){
		
			#------------------------------------------------------------------
			# get parts WIP info
			#------------------------------------------------------------------
			$w_rtn = xgt_prt_wip($w_prt_cd[$m], $w_shp_cd, "", $w_mt_lot_id[$m],
					$w_prt_wip);
			if ($w_rtn != 0) {
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, "", __LINE__);
				return 4000;
			}
		
			$w_rtn = main_verb_mtcs($w_lot_id, $w_prt_cd[$m], $w_stp_cd, "",
					$w_prd_cd, $w_use_qty[$m],"", $w_prt_wip);
			if ($w_rtn != 0) {
				return 4000;
			}
			if($w_cls_qty[$m] == "true") {
                        	$w_rtn = main_verb_mtcs($w_lot_id, $w_prt_cd[$m], $w_stp_cd, "",
                                        $w_prd_cd, $w_prt_wip['QTY'],"Closing Adjustment",$w_prt_wip);
                        	if ($w_rtn != 0) {
                                	return 4000;
                        	}
			}
		}elseif(is_null($w_noexe) && $w_prt_inf_mst['NUM'] == 1){
		
			#------------------------------------------------------------------
			# get LOT_BAS_TBL
			#------------------------------------------------------------------
			$w_rtn = xgt_lot($w_lot_id, $w_lot_bas);
			if($w_rtn != 0){
				$g_err_lv = 0;
				$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
				return 4000;
			}
		
			#save to ctg_log
			$w_rtn =ins_ctg_log(
						constant('CE_LTINF'),
						constant('CT_NOCONSUMEHIST'),
						$w_prt_cd[$m] . "_" . $w_mt_lot_id[$m] ,
						$gw_scr['s_equ_cd'],
						$w_qty, 
						$w_lot_bas
						);
			if ($w_rtn != 0) {
				return 4000;
			}	
		}
		$w_mtcs_flg = 1;
	} # end for
	# abend if no input
	if ($w_mtcs_flg == 0) {
		list($g_msg, $g_err_lv) = msg("err_Inp_Mtcs");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
#
#==================================================================
function get_rcporgmstinf($w_stp_cd, $w_prd_cd, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	
	$r_dat = array();

	$w_pm_tester = constant("PM_TESTER");
	$w_pm_fixture = constant("PM_FIXTURE");
	$w_pm_ok1ok2 = constant("PM_OK1OK2");
	$w_pm_childpart = constant("PM_CHILDPARTNO");
		
	$w_sql = <<<_SQL
		SELECT NM.NM_SHT RCP_NM, ROM.RCP_CD , ROM.M_RCP_FLG,RM1.PRM_DAT_TXT TESTER,RM2.PRM_DAT_TXT FIXTURE,
			RM3.PRM_DAT_TXT OK1OK2, 
			RM4.PRM_DAT_TXT CHILDPARTNO
		FROM RCP_ORG_MST ROM , RCP_MST RM1 , RCP_MST RM2 ,
			RCP_MST RM3, RCP_MST RM4,
			NM_MST NM
		WHERE ROM.STP_CD = '{$w_stp_cd}'
		AND ROM.PKG_CD = ' '
		AND ROM.PRD_CD = '{$w_prd_cd}'
		AND (ROM.STR_DTS < '{$g_cpu_dts}' OR ROM.STR_DTS IS NULL)
		AND (ROM.END_DTS > '{$g_cpu_dts}' OR ROM.END_DTS IS NULL)
		AND ROM.DEL_FLG = '0'
		AND RM1.RCP_CD = ROM.RCP_CD
		AND RM1.DEL_FLG = '0'
		AND RM1.PRM_CD = '{$w_pm_tester}'
		AND RM2.RCP_CD = ROM.RCP_CD
		AND RM2.DEL_FLG = '0'
		AND RM2.PRM_CD = '{$w_pm_fixture}'
		AND RM3.RCP_CD = ROM.RCP_CD
		AND RM3.DEL_FLG = '0'
		AND RM3.PRM_CD = '{$w_pm_ok1ok2}'
		AND RM4.RCP_CD = ROM.RCP_CD
		AND RM4.DEL_FLG = '0'
		AND RM4.PRM_CD = '{$w_pm_childpart}'
		AND NM.CD = ROM.RCP_CD
		AND NM.DEL_FLG = '0'
		ORDER BY ROM.RCP_CD
_SQL;
#echo $w_sql;
	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "RCP_ORG_MST", __LINE__);
		return 4000;
	}
	
	$w_cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		
		$r_dat[$w_cnt] = $w_row;
		$w_cnt++;
	}
	
	
	db_res_free($w_stmt);

	return 0;
}

function getBUYield(
			$p_prd_cd,
			$p_stp_cd,
			&$p_stp_yield
){
	$w_sql =	"(SELECT "
			.   " * " 
			.   " FROM " 
			.   " YLD_MST YM " 
			.   " WHERE " 
			.   " YM.PRD_CD = '" .trim($p_prd_cd) . "' "
			.   " AND YM.STP_CD = '" .trim($p_stp_cd) . "' "
			.   " AND YM.DEL_FLG = '0' "
			.   ") UNION ("
			.   "SELECT "
			.   " * " 
			.   " FROM " 
			.   " YLD_MST YM " 
			.   " WHERE " 
			.   " YM.PRD_CD = ' '"
			.   " AND YM.STP_CD = '" . trim($p_stp_cd) . "'"
			.   " AND YM.DEL_FLG = '0' "
			.")";

	$w_rtn = xdb_op_conndb();
	$w_stmt = db_res_set($w_sql);
	$w_rtn  = db_do($w_stmt);
	if ($w_rtn) {
		return 4000;
	}
	$w_arr_ylds = array();
	$p_prd_cd_buff = "";
	while($w_row = db_fetch_row($w_stmt)){
		$w_arr_ylds[trim($w_row['PRD_CD'])][trim($w_row['STP_CD'])] = trim($w_row["YLD_1"]);
		if(trim($w_row['PRD_CD']) != ""){
			$p_prd_cd_buff = trim($w_row['PRD_CD']);
		}
	}
	db_res_free($w_stmt);
	$w_rtn = xdb_op_closedb();

	if(count($w_arr_ylds) > 0 ){
		
		$p_stp_yield = $w_arr_ylds[$p_prd_cd_buff][trim($p_stp_cd)];
		if($p_stp_yield == ""){
			$p_stp_yield = "100";
		}elseif($p_stp_yield == 0){
			$p_stp_yield = "0";
		}
		/*elseif(is_test_step($p_stp_cd) && $p_stp_yield >= 10){
			$p_stp_yield = $p_stp_yield - 10;
		}elseif(is_test_step($p_stp_cd) && $p_stp_yield < 10){
			$p_stp_yield = 0;
		}elseif((!is_test_step($p_stp_cd)) && $p_stp_yield >= 2){
			$p_stp_yield = $p_stp_yield - 2;
		}elseif((!is_test_step($p_stp_cd)) && $p_stp_yield < 2){
			$p_stp_yield = 0;
		}*/
		
	}else{
		$p_stp_yield = "100";
	}
	
	return 0;
}


#=================================================
# CTG_LOG 
#=================================================
function ins_ctg_log($w_ctg_dvs_cd, $w_ctg_cd, $w_ctg_dat_txt, $w_equ_cd, $w_qty, $w_lot_bas){
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_ins = array(
				"DEL_FLG"               => "0",
				"CTG_DVS_CD"    		=> $w_ctg_dvs_cd,
				"PRD_CD"                => $w_lot_bas['PRD_CD'],
				"PRC_CD"                => $w_lot_bas['PRC_CD'],
				"STP_NO"                => $w_lot_bas['STP_NO'],
				"PRC_CLS_4"             => $w_lot_bas['PRC_CLS_4'],
				"STP_CD"                => $w_lot_bas['STP_CD'],
				"CTG_CD"                => $w_ctg_cd,
				"LOT_ID"                => $w_lot_bas['LOT_ID'],
				"EQU_CD"                => $w_equ_cd,
				"SL_ID"                 => " ",
				"QTY"                   => $w_qty,
				"CTG_DAT_TXT"   		=> $w_ctg_dat_txt,
				"CRT_DTS"               => $g_cpu_dts,
				"USR_ID_CRT"    		=> $gw_scr['s_usr_id'],
				"UPD_DTS"               => $g_low_dts,
				"USR_ID_UPD"    		=> " ",
				"UPD_LEV"               => "1"
		);

	$w_rtn = db_insert("CTG_LOG", $w_ins);
	if ($w_rtn != 0) {
			#list($g_msg, $g_err_lv) = PSSEM01001301_msg("err_Ins_CtgLog");
			#$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			list($g_msg, $g_err_lv) = msg("err_Upd");
			$g_msg = xpt_err_msg($g_msg, "CTG_LOG", __LINE__);
			return $w_rtn;
	}

	return 0;
}

#======================================================================
# material hold
#
# $r_exe_hold		I/O		hold execute or not
# $r_exp			I/O		expire NG count
# $r_life			I/O		life time NG count
# $r_thaw			I/O		thawing time NG count
#======================================================================
function main_exe_mthd(&$r_exe_hold, &$r_exp, &$r_life, &$r_thaw)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	# return if NOT need to execute material process
	if($gw_scr['s_prt_ctrl'] != "1") return 0;

	#------------------------------------------------------------------
	# get session value from material program
	#------------------------------------------------------------------
	$w_mcnt                    = get_session_value('s_max_rows',                constant("PGM_MTMNG"));
	$w_list_prt_cd             = get_session_value('s_list_prt_cd',             constant("PGM_MTMNG"));
	$w_list_mt_lot_id          = get_session_value('s_list_mt_lot_id',          constant("PGM_MTMNG"));
	$w_list_use_qty            = get_session_value('s_list_use_qty',            constant("PGM_MTMNG"));
	$w_list_thaw_chrg_hold_flg = get_session_value('s_list_thaw_chrg_hold_flg', constant("PGM_MTMNG"));
	$w_list_thaw_time_hold_flg = get_session_value('s_list_thaw_time_hold_flg', constant("PGM_MTMNG"));
	$w_list_thaw_dts           = get_session_value('s_list_thaw_dts',           constant("PGM_MTMNG"));
	$w_list_life_hold_flg      = get_session_value('s_list_life_hold_flg',      constant("PGM_MTMNG"));
	$w_list_life_dts           = get_session_value('s_list_life_dts',           constant("PGM_MTMNG"));
	$w_list_exp_hold_flg       = get_session_value('s_list_exp_hold_flg',       constant("PGM_MTMNG"));
	$w_list_exp_dts            = get_session_value('s_list_exp_dts',            constant("PGM_MTMNG"));

	$r_exe_hold = 0;
	$r_exp      = 0;
	$r_life     = 0;
	$r_thaw     = 0;
	$w_hold_msg = array();
	for($m=1; $m<=$w_mcnt; $m++){
		if($w_list_prt_cd[$m]  == "") continue;
		if($w_list_use_qty[$m] == "") continue;
		#------------------------------------------------------------------
		# get shop code
		#------------------------------------------------------------------
		$w_rtn = xgt_stp($gw_scr['s_stp_cd'], $w_shp_cd);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# MTHD target material
		#------------------------------------------------------------------
		if($w_list_thaw_chrg_hold_flg[$m] == "1"
		|| $w_list_thaw_time_hold_flg[$m] == "1"
		|| $w_list_life_hold_flg[$m]      == "1"
		|| $w_list_exp_hold_flg[$m]       == "1"
		){
			$r_exe_hold = 1;
			# switch message by hold matters
			if($w_list_exp_hold_flg[$m] == "1"){
				$r_exp++;
				list($w_msg, $dmy) = msg("warn_Ovr_ExpTime");
				$w_hold_cmt = constant("CMT_EXP");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_list_mt_lot_id[$m], $w_list_exp_dts[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			elseif($w_list_life_hold_flg[$m] == "1"){
				$r_life++;
				list($w_msg, $dmy) = msg("warn_Ovr_LifeTime");
				$w_hold_cmt = constant("CMT_LIFE");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_list_mt_lot_id[$m], $w_list_life_dts[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			elseif($w_list_thaw_chrg_hold_flg[$m] == "1"){
				$r_thaw++;
				list($w_msg, $dmy) = msg("warn_Equ_NoCharge");
				$w_hold_cmt = constant("CMT_THAW");
				$w_srch = array("%MTLOTID%");
				$w_rplc = array($w_list_mt_lot_id[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			elseif($w_list_thaw_time_hold_flg[$m] == "1"){
				$r_thaw++;
				list($w_msg, $dmy) = msg("warn_Ovr_ChrgThaw");
				$w_hold_cmt = constant("CMT_THAW");
				$w_srch = array("%MTLOTID%", "%TIME%");
				$w_rplc = array($w_list_mt_lot_id[$m], $w_list_thaw_dts[$m]);
				$w_hold_msg[] = str_replace($w_srch, $w_rplc, $w_msg);
			}
			#------------------------------------------------------------------
			# MTHD
			#------------------------------------------------------------------
			$w_rtn = main_verb_mthd($gw_scr['s_usr_id'],
									$w_list_prt_cd[$m],
									$w_shp_cd,
									"",
									$w_list_mt_lot_id[$m],
									$w_hold_cmt);
			if($w_rtn != 0){
				return 4000;
			}
		}
	}

	if(count($w_hold_msg) > 0){
		$g_err_lv = 3;
		$g_msg = implode("<br>", $w_hold_msg);
	}

	return 0;
}

#======================================================================
# device Lot hold by MTHD
#======================================================================
function main_exe_iohd_by_mthd($w_lot_id, $w_upd_lev, $w_exp, $w_life, $w_thaw)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	#------------------------------------------------------------------
	# get LOT_BAS_TBL
	#------------------------------------------------------------------
	$w_rtn = xgt_lot($w_lot_id, $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check update level
	#------------------------------------------------------------------
	$w_rtn = xck_upd($w_upd_lev, $w_lot_bas['UPD_LEV']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# comment
	#------------------------------------------------------------------
	if($w_exp > 0){
		$w_cmt = constant("CMT_EXP");
	}
	elseif($w_life > 0){
		$w_cmt = constant("CMT_LIFE");
	}
	else {
		$w_cmt = constant("CMT_THAW");
	}

	#------------------------------------------------------------------
	# release date
	#------------------------------------------------------------------
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $g_cpu_dts);
	$w_rls_dts = date('Y-m-d', mktime($h,$i,$s,$m,($d + 3),$y));

	#------------------------------------------------------------------
	# IOHD
	#------------------------------------------------------------------
	$w_rtn = main_verb_iohd($gw_scr['s_usr_id'],
							$w_rls_dts,
							constant("CUS_MTMNG"),
							$w_cmt,
							$w_lot_bas);
	if($w_rtn != 0){
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::IOIN
#==================================================================
function main_ioin_verb($w_usr_id, $w_equ_cd, $w_cmt, &$w_lot_bas)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# check Lot state
	#------------------------------------------------------------------
	$w_rtn = ioin_st_check($w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	if($w_equ_cd == ""){
		#------------------------------------------------------------------
		# get usable equ_cd
		#------------------------------------------------------------------
		$w_rtn = xgt_use_equ($w_lot_bas, $w_equ_cd);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	#------------------------------------------------------------------
	# check equ_cd
	#------------------------------------------------------------------
	$w_rtn = ioin_equ_check($w_equ_cd, $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# IOIN
	#------------------------------------------------------------------
	$w_rtn = ioin($w_lot_bas['LOT_ID'],
				  $w_usr_id,
				  $w_lot_bas['UPD_LEV'],
				  $w_equ_cd,
				  $w_cmt,
				  $w_lot_bas);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::IOOT
#==================================================================
function main_verb_ioot($w_usr_id, $w_ctg_dvs_cd, $w_ctg_cd,
						$w_ctg_qty, $w_ctg_dat_txt, $w_ctg_slid, $w_sl_qty_ok,
						$w_chp_qty_ok, $w_lf_qty_ok, $w_cmt, &$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# check Lot state
	#------------------------------------------------------------------
	$w_rtn = ioot_st_check($w_lot_bas['LOT_ST_DVS']);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# check last io block
	# return:	$w_lot_st_dvs	lot state division
	#			$w_io_blc_cd	io block code
	#			$w_stp_cd		step code
	#			$w_stp_no		step no
	#------------------------------------------------------------------
	$w_rtn = xck_lio(
					$w_lot_bas['PRC_CD'],
					$w_lot_bas['IO_BLC_CD'],
					$w_lot_bas['PLT_DVS_CD'],
					$w_lot_st_dvs,
					$w_io_blc_cd,
					$w_stp_cd,
					$w_stp_no);

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, '', __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# set registration details into CTG_LOG
	#------------------------------------------------------------------
	$w_ctg_flg = 0;
	if(is_array($w_ctg_cd)){
		for($i=1; $i<=count($w_ctg_cd); $i++){
			$w_arr_cnt = $i;
			$w_arr_ctg_dvs_cd[$i] = $w_ctg_dvs_cd[$i];
			$w_arr_ctg_cd[$i]     = $w_ctg_cd[$i];
			$w_arr_txt[$i]        = $w_ctg_dat_txt[$i];
			$w_arr_equ_cd[$i]     = $w_lot_bas['EQU_CD'];
			$w_arr_sl_id[$i]      = $w_ctg_slid[$i];
			$w_arr_qty[$i]        = $w_ctg_qty[$i];
		}
		$w_ctg_flg = 1;
	}

	if($w_ctg_flg == 0){
		$w_arr_cnt = 0;
		$w_arr_ctg_dvs_cd = '';
		$w_arr_ctg_cd     = '';
		$w_arr_equ_cd     = '';
		$w_arr_sl_id      = '';
		$w_arr_qty        = '';
		$w_arr_txt        = '';
	}

	#------------------------------------------------------------------
	# IOOT
	#------------------------------------------------------------------
	$w_rtn = ioot(
				$w_lot_bas['LOT_ID'],				# Lot ID
				$w_usr_id,					# User ID
				$w_lot_bas['UPD_LEV'],				# Update lev
				$w_cmt,						# Comment
				$w_lot_st_dvs,					# Lot state division
				$w_sl_qty_ok,					# pass slice qty
				$w_chp_qty_ok,					# pass chip qty
				$w_lf_qty_ok,					# pass lf qty
				$w_lot_bas['SECRET_NO'],			# date code
				$w_arr_cnt,					# category count
				$w_arr_ctg_dvs_cd,				# (array)category division code
				$w_arr_ctg_cd,					# (array)category code
				$w_arr_equ_cd,					# (array)equ_cd for ctg_log
				$w_arr_sl_id,					# (array)slice ID for ctg_log
				$w_arr_qty,					# category qty
				$w_arr_txt,					# category text
				$w_lot_bas);					# [return]lot_bas_tbl

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, '', __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::Next Step Transfer(IOMV or PRPT/PRPC/PRGT)
#==================================================================
function main_verb_iomv($w_usr_id, $w_cmt, &$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	switch($w_lot_bas['LOT_ST_DVS']){
	case "OW":
		#------------------------------------------------------------------
		# get next io block
		#------------------------------------------------------------------
		$w_rtn = xgt_nio(
						$w_lot_bas['PRC_CD'],
						$w_lot_bas['IO_BLC_CD'],
						$w_lot_bas['STP_NO'],
						$w_lot_bas['PLT_DVS_CD'],
						$w_io_blc_cd,					# [return]next io block code
						$w_stp_cd,					# [return]next step code
						$w_stp_no);					# [return]next step no


		$w_nxt_verb = "IOMV";

		break;
	case "EW":
		#------------------------------------------------------------------
		# get next process
		#------------------------------------------------------------------
		$w_rtn = xgt_npr(
						$w_lot_bas['RT_CD'],
						$w_lot_bas['PRC_CD'],
						$w_lot_bas['PLT_DVS_CD'],
						$w_prc_cd,					# [return]next process code
						$w_io_blc_cd,					# [return]next io block code
						$w_stp_cd,					# [return]next step code
						$w_stp_no);					# [return]next step no

		if($w_rtn == 0){
			$w_nxt_verb = "PRPT";
		} else {
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return 4000;
		}

		break;
	}


	switch($w_nxt_verb){
	case "IOMV":
		#------------------------------------------------------------------
		# IOMV
		#------------------------------------------------------------------
		$w_rtn = iomv(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_io_blc_cd,
					$w_stp_cd,
					$w_stp_no,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		break;
	case "PRPT":
		#------------------------------------------------------------------
		# PRPT
		#------------------------------------------------------------------
		$w_rtn = prpt(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		#------------------------------------------------------------------
		# PRPC
		#------------------------------------------------------------------
		$w_rtn = prpc(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_prc_cd,
					$w_io_blc_cd,
					$w_stp_cd,
					$w_stp_no,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		#------------------------------------------------------------------
		# PRGT
		#------------------------------------------------------------------
		$w_rtn = prgt(
					$w_lot_bas['LOT_ID'],
					$w_usr_id,
					$w_lot_bas['UPD_LEV'],
					$w_cmt,
					$w_lot_bas);

		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, '', __LINE__);
			return $w_rtn;
		}

		break;

	} # end switch

	return 0;
}

#==================================================================
# VERB::IOAB
#==================================================================
function main_verb_ioab($w_usr_id,
						$w_cmt,
						&$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	$w_cus_cd = " ";

	#------------------------------------------------------
	# IOAB
	#------------------------------------------------------
	$w_rtn = ioab( 
				$w_lot_bas['LOT_ID'],				# Lot ID
				$w_usr_id,					# User ID
				$w_lot_bas['UPD_LEV'],				# Update lev.
				$w_cus_cd,					# cause code
				$w_cmt,						# comment
				$w_lot_bas);					# [return]lot_bas_tbl

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::IOHD
#==================================================================
function main_verb_iohd($w_usr_id, $w_hld_can_dts, $w_cus_cd, $w_cmt, &$w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------
	# check Lot state
	#------------------------------------------------------
	$w_rtn = iohd_st_check($w_lot_bas['LOT_ST_DVS']);
	if ($w_rtn) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# IOHD
	#------------------------------------------------------
	$w_rtn = iohd(
				$w_lot_bas['LOT_ID'],
				$w_usr_id,
				$w_lot_bas['UPD_LEV'],
				$w_hld_can_dts,
				$w_cus_cd,
				$w_cmt,
				$w_lot_bas);

	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# threshold judgement
#==================================================================
function main_exe_thd_jdg($w_usr_id,
						  $w_trt_qty,
						  $w_pas_qty,
						  $w_arr_jdg_cd,
						  $w_arr_jdg_val,
						  &$w_lot_bas,
						  &$r_hold_flg,
						  &$r_holddat)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# initialize return value
	#------------------------------------------------------------------
	$r_hold_flg = 0;
	$r_holddat  = array();

	#------------------------------------------------------------------
	# check threshold judgement
	#------------------------------------------------------------------
	$w_rtn = cs_xck_thd_jdg($w_usr_id,
							$w_lot_bas['STP_CD'],
							$w_lot_bas['PRD_CD'],
							"",
							$w_trt_qty,
							$w_pas_qty,
							$w_arr_jdg_cd,
							$w_arr_jdg_val,
							$w_lot_bas,
							$w_jdg_ng_flg,
							$w_arr_jdg_rslt);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# if judgement 'OK', return here
	#------------------------------------------------------------------
	if($w_jdg_ng_flg != 1){
		return 0;
	}

	#------------------------------------------------------------------
	# get release date
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_hold_rls($w_lot_bas, $w_hold_can_dts, $w_set_day);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# create comment
	#------------------------------------------------------------------
	$w_hold_cmt = implode(",", array
	(
		$w_arr_jdg_rslt['seq_no'][1],
		$w_arr_jdg_rslt['ctg_cd'][1],
		$w_arr_jdg_rslt['yld'][1],
		$w_arr_jdg_rslt['arith_unt'][1],
		$w_arr_jdg_rslt['ctg_val'][1],
	));

	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	#
	# IOHD
	#
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	$w_rtn = main_verb_iohd($w_usr_id,
							$w_hold_can_dts,
							constant("CU_HOLD"),
							$w_hold_cmt,
							$w_lot_bas);
	if($w_rtn != 0){
		return 4000;
	}

	#------------------------------------------------------------------
	# check whether need to print the quality report sheet
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_par_dat(constant("P0_LOTTRC"),
							constant("REP_ABN_LOT"),
							$w_lot_bas['DVSN_CD_PRC'],
							" ", " ",
							$w_arr_lst_no,
							$w_arr_par_txt,
							$w_arr_par_num,
							$w_par_cnt);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	### error if result is 2 or more
	if($w_par_cnt >= 2){
		list($g_msg, $g_err_lv) = msg("err_Rep_PluralRecord");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$w_qul_rep_flg = 1;
	if($w_arr_par_num[1] == ""){
		$w_qul_rep_flg = 0;
	}

	#------------------------------------------------------------------
	# set return value
	#------------------------------------------------------------------
	$r_hold_flg = 1;
	$r_holddat = array
	(
		'LOT_ID'		=> trim($w_lot_bas['LOT_ID']),
		'STP_CD'		=> trim($w_lot_bas['STP_CD']),
		'SET_DAY'		=> $w_set_day,
		'REP_FLG'		=> $w_qul_rep_flg,
	);

	return 0;
}


#==================================================================
# Get BU Code information
#==================================================================
function get_bu_name($w_am_cd, &$r_bu_name)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	NM_FLL
FROM
	NM_MST
WHERE
	CD = '{$w_am_cd}'
	and DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "NM_MST", __LINE__);
		return 4000;
	}

	$cnt = 0;
	$w_chkd = array();
	$w_row = db_fetch_row($w_stmt);
	$r_bu_name  = trim($w_row['NM_FLL']);

	return 0;
}


#==================================================================
# Get next step information
#==================================================================
function get_nxtstp_inf($w_prd_cd, $w_stp_cd, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	POM3.RT_CD,
	POM3.SEQ_NO_RT,
	POM3.M_RT_FLG_SCH,
	POM3.PRD_CD,
	PRD.PRD_NM,
	POM3.PRC_CD,
	POM3.STP_CD,
	POM3.STP_NO,
	POM3.IO_BLC_CD,
	POM3.SEQ_NO_RT,
	SM.STP_CLS_2
FROM
	PRD_ORG_MST POM1,
	PRD_ORG_MST POM2,
	PRD_ORG_MST POM3,
	PRD_MST     PRD,
	STP_MST	SM
WHERE
	POM1.PRD_CD = '{$w_prd_cd}'
	AND POM1.STP_CD = '{$w_stp_cd}'
	AND POM1.DEL_FLG = '0'
	AND POM2.RT_CD = POM1.RT_CD
	AND POM2.SEQ_NO_RT = POM1.SEQ_NO_RT
	AND POM2.DEL_FLG = '0'
	AND POM3.RT_CD = POM2.RT_CD
	AND POM3.SEQ_NO_RT = POM2.SEQ_NO_RT + 1
	AND POM3.IO_FLG = '1'
	AND POM3.PRD_CD = '{$w_prd_cd}'
	AND POM3.DEL_FLG = '0'
	AND PRD.PRD_CD = POM3.PRD_CD
	AND PRD.DEL_FLG = '0'
	AND POM3.STP_CD = SM.STP_CD
	and SM.DEL_FLG = '0'
ORDER BY
	POM3.M_RT_FLG_SCH DESC,
	POM3.RT_CD DESC,
	POM3.SEQ_NO_RT
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRD_ORG_MST", __LINE__);
		return 4000;
	}

	$cnt = 0;
	$w_chkd = array();
	while($w_row = db_fetch_row($w_stmt)){
		$w_rtcd  = trim($w_row['RT_CD']);
		$w_prdcd = trim($w_row['PRD_CD']);
		if($buf_rtcd != $w_rtcd
		&& !in_array($w_prdcd, $w_chkd)
		){
			$cnt++;
			$r_dat[$cnt] = array
			(
				"RT_CD"		=> trim($w_row['RT_CD']),
				"PRD_CD"	=> trim($w_row['PRD_CD']),
				"PRD_NM"	=> trim($w_row['PRD_NM']),
				"PRC_CD"	=> trim($w_row['PRC_CD']),
				"STP_NO"	=> trim($w_row['STP_NO']),
				"STP_CD"	=> trim($w_row['STP_NO']),
				"IO_BLC_CD"	=> trim($w_row['IO_BLC_CD']),
				"SEQ_NO_RT"	=> trim($w_row['SEQ_NO_RT']),
				"STP_CLS_2"	=> trim($w_row['STP_CLS_2']),
			);
			$w_chkd[] = $w_prdcd;
		}
		$buf_rtcd = $w_rtcd;
	}

	return 0;
}
#==================================================================
# SPACE
#==================================================================
function main_exe_spc($w_usr_id, $w_spc_err_cd, $w_spc_equinf, $w_lot_bas, &$r_holdexe, &$r_spchold)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$r_holdexe = 0;

	#------------------------------------------------------------------
	# get package code
	#------------------------------------------------------------------
	$w_rtn = xgn_pkg($w_lot_bas['PRD_CD'], 1, $w_pkg_cd, $w_pkg_nm);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['PRD_CD'], __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# insert NON_STD_CTG_LOG prep.
	#------------------------------------------------------------------
	$inscnt  = 0;
	$w_ins   = array();
	$w_cuscd = "";
	if($w_spc_err_cd == constant("SPC_ERRCD_ABN")
	|| $w_spc_err_cd == constant("SPC_ERRCD_ABNPCS")
	|| $w_spc_equinf == constant("SPC_WARN_ABN")
	){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM']      = constant("SPC_WARN_ABN");
		$w_ins[$inscnt]['JDGRLT']     = constant("SPC_WARN_ABN");
		$w_ins[$inscnt]['UPD_DTS']    = $g_cpu_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = $w_usr_id;

		$w_cuscd = constant("CU_ABNPCS");
		$r_spchold = array(1 => constant("SPC_WARN_ABN"));
	}

	if($w_spc_err_cd == constant("SPC_ERRCD_PCS")
	|| $w_spc_err_cd == constant("SPC_ERRCD_ABNPCS")
	|| $w_spc_equinf == constant("SPC_WARN_PCS")
	){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM'] = constant("SPC_WARN_PCS");
		$w_ins[$inscnt]['JDGRLT']     = " ";
		$w_ins[$inscnt]['UPD_DTS']    = $g_low_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = " ";

		$w_cuscd = constant("CU_ABNPCS");
		$r_spchold = array(1 => constant("SPC_WARN_PCS"));
	}

	if($w_spc_equinf == constant("SPC_WARN_MBN")){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM'] = constant("SPC_WARN_MBN");
		$w_ins[$inscnt]['JDGRLT']     = " ";
		$w_ins[$inscnt]['UPD_DTS']    = $g_low_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = " ";

		$w_cuscd = constant("CU_MBN");
		$r_spchold = array(1 => constant("SPC_WARN_MBN"));
	}

	if($w_spc_equinf == constant("SPC_WARN_CON")){
		$inscnt++;
		$w_ins[$inscnt]['ERRNM'] = constant("SPC_WARN_CON");
		$w_ins[$inscnt]['JDGRLT']     = " ";
		$w_ins[$inscnt]['UPD_DTS']    = $g_low_dts;
		$w_ins[$inscnt]['USR_ID_UPD'] = " ";

		$w_cuscd = constant("CU_AUTO");
		$r_spchold = array(1 => constant("SPC_WARN_CON"));
	}

	### case ABN+PCN
	if($w_spc_err_cd == constant("SPC_ERRCD_ABNPCS")){
		$r_spchold = array(1 => constant("SPC_WARN_ABNPCS"));
	}

	### if not SPC error, return here
	if($inscnt == 0){
		return 0;
	}

	#------------------------------------------------------------------
	# insert NON_STD_CTG_LOG
	#------------------------------------------------------------------
	for($i=1; $i<=$inscnt; $i++){
		$w_nonstd = array
		(
			"DEL_FLG"		=> "0",
			"LOT_ID"		=> $w_lot_bas['LOT_ID'],
			"STP_CD"		=> $w_lot_bas['STP_CD'],
			"PRD_CD"		=> $w_lot_bas['PRD_CD'],
			"LOT_NO_STR"		=> $w_lot_bas['LOT_NO_STR'],
			"PKG_CD"		=> $w_pkg_cd,
			"CTG_LST_NO"		=> $i,
			"CTG_CD_1"		=> constant("CT_ABNINF"),
			"VAL_UNT_FLG_1"		=> 0,
			"CTG_EXP_DVS_1"		=> " ",
			"VAL_1"			=> null,
			"CTG_RLT_1"		=> $w_ins[$i]['ERRNM'],
			"JDG_DTS_1"		=> $g_low_dts,
			"USR_ID_JDG_1"		=> " ",
			"JDG_RLT_1"		=> $w_ins[$i]['JDGRLT'],
			"CTG_CD_2"		=> " ",
			"VAL_UNT_FLG_2"		=> 0,
			"CTG_EXP_DVS_2"		=> " ",
			"VAL_2"			=> null,
			"CTG_RLT_2"		=> " ",
			"JDG_DTS_2"		=> $g_low_dts,
			"USR_ID_JDG_2"		=> " ",
			"JDG_RLT_2"		=> " ",
			"CTG_CD_3"		=> " ",
			"VAL_UNT_FLG_3"		=> 0,
			"CTG_EXP_DVS_3"		=> " ",
			"VAL_3"			=> null,
			"CTG_RLT_3"		=> " ",
			"JDG_DTS_3"		=> $g_low_dts,
			"USR_ID_JDG_3"		=> " ",
			"JDG_RLT_3"		=> " ",
			"CRT_DTS"		=> $g_cpu_dts,
			"USR_ID_CRT"		=> $w_usr_id,
			"UPD_DTS"		=> $w_ins[$i]['UPD_DTS'],
			"USR_ID_UPD"		=> $w_ins[$i]['USR_ID_UPD'],
			"UPD_LEV"		=> 1,
		);

		$w_rtn = db_insert("NON_STD_CTG_LOG", $w_nonstd);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Ins");
			$g_msg = xpt_err_msg($g_msg, "NON_STD_CTG_LOG", __LINE__);
			return 4000;
		}
	}

	#------------------------------------------------------------------
	# get hold release date
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_hold_rls($w_lot_bas, $w_hold_can_dts, $w_set_day);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# create hold comment
	#------------------------------------------------------------------
	$w_hold_cmt = "";
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	#
	# IOHD
	#
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	$w_rtn = main_verb_iohd($w_usr_id,
							$w_hold_can_dts,
							$w_cuscd,
							$w_hold_cmt,
							$w_lot_bas);
	if($w_rtn != 0) return 4000;

	$r_holdexe = 1;

	#------------------------------------------------------------------
	# delete(DEL_FLG=1) the SPC equipment state info in CTG_TBL
	#------------------------------------------------------------------
	if($w_spc_equinf != ""){
		$w_upd = array
		(
			"DEL_FLG"		=> "1",
			"USR_ID_UPD"	=> $w_usr_id,
			"UPD_DTS"		=> $g_cpu_dts,
			"UPD_LEV"		=> 2
		);
		$w_whr = "LOT_ID = '" . $w_lot_bas{'LOT_ID'} . "' "
				. "AND CTG_DVS_CD = '" . constant("CE_HOLDINF") . "' "
				. "AND CTG_CD = '" . constant("CT_ABNINF") . "' "
				. "AND CTG_DAT_TXT = '" . $w_spc_equinf . "' "
				. "AND DEL_FLG = '0'";

		$w_rtn = db_update_one("CTG_TBL", $w_upd, $w_whr);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Upd");
			$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
			return 4000;
		}
	}

	return 0;
}

#==================================================================
# IOHD when exceed the limit time
#==================================================================
function main_exe_stplmt($w_usr_id, $w_lot_bas)
{
	global $g_msg;
	global $g_err_lv;

	$w_cuscd = constant("CU_HOLD");
	#------------------------------------------------------------------
	# get release date
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_hold_rls($w_lot_bas, $w_hold_can_dts, $w_set_day);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	#------------------------------------------------------------------
	# create hold comment
	#------------------------------------------------------------------
	$w_hold_cmt = "";
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	#
	# IOHD
	#
	#-*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*--*-
	$w_rtn = main_verb_iohd($w_usr_id,
							$w_hold_can_dts,
							$w_cuscd,
							$w_hold_cmt,
							$w_lot_bas);
	if($w_rtn != 0) return 4000;

	return 0;
}

#==================================================================
# regist reserve HOLD info
#	when exceed the limit time at Post mold cure stp
#==================================================================
function main_exe_holdrsv_washdry($w_usr_id, $w_lot_bas, &$r_rsv_id)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	#------------------------------------------------------------------
	# get [E8]code of step after wash and dry
	#------------------------------------------------------------------
	
	$w_sql = "
	SELECT
		POM.*
	FROM
		PRD_ORG_MST POM
	WHERE
		POM.RT_CD = '" . trim($w_lot_bas['RT_CD']) . "'
		AND POM.DEL_FLG = '0'
	ORDER BY
		POM.SEQ_NO_RT, POM.SEQ_NO_PRC, POM.STP_NO
	
";
	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "STP_MST", __LINE__);
		return 4000;
	}
	$w_marker = 0;
	while($w_row = db_fetch_row($w_stmt)){
		if($w_marker == 1){
			$w_stpcls1 = trim($w_row['STP_CLS_1']);
			break;
		}
	
		if (trim($w_row['STP_CLS_1']) == constant('E8_WASHDRY')){
			$w_marker = 1;
		}
		
		
	}
	
	if($w_stpcls1 == ""){
		list($g_msg, $g_err_lv) = msg("err_Get_StpCls1");
		$g_msg = xpt_err_msg($g_msg, $w_lot_bas['STP_CD'], __LINE__);
		return 4000;
	}
	db_res_free($w_stmt);
	
	

	#------------------------------------------------------------------
	# get the new hold reserve ID
	#------------------------------------------------------------------
	### get the current ac_mnth
	$w_sql = <<<_SQL
SELECT DISTINCT
	AC_MNTH
FROM
	PM_ACC_TBL
WHERE
	STR_DTS <= '{$g_cpu_dts}'
	AND END_DTS >= '{$g_cpu_dts}'
	AND DVSN_CD = '{$w_lot_bas['DVSN_CD_PRC']}'
	AND DEL_FLG = '0'
ORDER BY
	AC_MNTH DESC
_SQL;
	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PM_ACC_TBL", __LINE__);
		return 4000;
	}
	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);
	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_NotExist_AcMnth");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}
	$w_acmnth = $w_row['AC_MNTH'];

	#------------------------------------------------------------------
	# increment a value for reserve HOLD ID
	#------------------------------------------------------------------
	$w_rtn = xgt_cd_cnt($w_usr_id, $w_acmnth, constant("CD_CNT_DVS_RSV"), $w_newcnt);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# new reserve HOLD ID
	#------------------------------------------------------------------
	$r_rsv_id = sprintf("%s%04s", $w_acmnth, $w_newcnt);

	#------------------------------------------------------------------
	# get the release date
	#------------------------------------------------------------------
	$w_rtn = cs_xgt_hold_rls($w_lot_bas, $w_hold_can_dts, $w_set_day);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# insert PM_RSV_TBL
	#------------------------------------------------------------------
	$w_id_cls = constant("ID_CLS_LOTID");
	$w_id     = trim($w_lot_bas['LOT_ID']);
	$w_tel    = " ";

	$w_ins = array
	(
		"DEL_FLG"		=> "0",
		"RSV_ID"		=> $r_rsv_id,
		"STP_CLS_1"		=> $w_stpcls1,
		"RSN_CD_RSV"		=> constant("CU_AUTO"),
		"ID_CLS"		=> $w_id_cls,
		"ID"			=> $w_id,
		"TEL"			=> $w_tel,
		"RSV_CAN_DTS"		=> $w_hold_can_dts,
		"CMT"			=> constant("CMT_MOLDRSVHOLD"),
		"FIN_FLG"		=> "0",
		"RSN_CD_SEL"		=> " ",
		"DEL_DTS"		=> $g_low_dts,
		"USR_ID_DEL"		=> " ",
		"CRT_DTS"		=> $g_cpu_dts,
		"USR_ID_CRT"		=> $w_usr_id,
		"UPD_DTS"		=> $g_low_dts,
		"USR_ID_UPD"		=> " ",
		"UPD_LEV"		=> 1
	);

	$w_rtn = db_insert("PM_RSV_TBL", $w_ins);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Ins");
		$g_msg = xpt_err_msg($g_msg, "PM_RSV_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# get magazine info
#==================================================================
function get_mgzn($w_lot_id, &$r_mgzn)
{
	global $g_msg;
	global $g_err_lv;

	$r_mgzn   = array();
	$w_ctgdvs = constant("CE_MAG");
	$w_ctgcd  = constant("CT_MAG");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
ORDER BY
	CTG_DAT_TXT
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$r_mgzn[$cnt] = trim($w_row['CTG_DAT_TXT']);
	}

	return 0;
}

#==================================================================
# execution magazine control for IOAB
#==================================================================
function exe_mgzn_ioab($w_usr_id, $w_lot_id)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	#------------------------------------------------------------------
	# MTOT
	#------------------------------------------------------------------
	$w_rtn = main_verb_mtot($w_usr_id, $w_lot_id);
	if($w_rtn != 0){
		return 4000;
	}

	#------------------------------------------------------------------
	# delete(DEL_FLG=1) magazine info
	#------------------------------------------------------------------
	$w_rtn = del_mgzn($w_usr_id, "IOAB", $w_lot_id);
	if($w_rtn != 0){
		return 4000;
	}

	return 0;
}

#==================================================================
# delete(DEL_FLG=1) magazine info
#==================================================================
function del_mgzn($w_usr_id, $w_upd_verb, $w_lot_id)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	$w_ctgdvs = constant("CE_MAG");
	$w_ctgcd  = constant("CT_MAG");

	$w_upd = array
	(
		"DEL_FLG"		=> "1",
		"UPD_VERB"		=> $w_upd_verb,
		"UPD_DTS"		=> $g_cpu_dts,
		"USR_ID_UPD"		=> $w_usr_id,
		"UPD_LEV"		=> "2",
	);

	$w_whr = <<<_SQL
LOT_ID = '{$w_lot_id}'
AND CTG_DVS_CD = '{$w_ctgdvs}'
AND CTG_CD = '{$w_ctgcd}'
AND DEL_FLG = '0'
_SQL;

	$w_rtn = db_update_large("LOT_INF_TBL", $w_upd, $w_whr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Upd");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	return 0;
}


#==================================================================
# get prt_information
#==================================================================
function get_prt_inf($w_prt_cd, $w_aw_cd, $w_dvsn, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat   = array();
	$w_ctgdvs = constant("CE_MAG");
	$w_ctgcd  = constant("CT_MAG");

	$w_sql = <<<_SQL
SELECT
	TXT_DAT,
	NUM_DAT
FROM
	PRT_INF_MST
WHERE
	PRT_CD = '{$w_prt_cd}'
	AND DAT_CD = '{$w_aw_cd}'
	AND DVSN_CD = '{$w_dvsn}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRT_INF_MST", __LINE__);
		return 4000;
	}

	$cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$r_dat["TXT"] = trim($w_row['TXT_DAT']);
		$r_dat["NUM"] = trim($w_row['NUM_DAT']);
	}

	return 0;
}


#==================================================================
# VERB::MTIN
#==================================================================
function main_verb_mtin($w_usr_id, $w_lot_id, $w_mt_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# get Parts WIP info
	#------------------------------------------------------------------
	$w_sql = <<<_SQL
SELECT
	*
FROM
	PRT_WIP_TBL
WHERE
	MT_LOT_ID = '{$w_mt_lot_id}'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRT_WIP_TBL", __LINE__);
		return 4000;
	}
	$w_prtwip = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	#------------------------------------------------------------------
	# check the material state
	#------------------------------------------------------------------
	$w_rtn = mtin_st_check($w_prtwip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------------------
	# MTIN
	#------------------------------------------------------------------
	$w_rtn = mtin($w_lot_id,
				  $w_mt_lot_id,
				  " ",
				  $w_usr_id,
				  $w_prtwip['UPD_LEV'],
				  "",
				  $w_prtwip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::MTOT
#==================================================================
function main_verb_mtot($w_usr_id, $w_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# get the magazine info
	#------------------------------------------------------------------
	$w_rtn = get_mgzn($w_lot_id, $w_arr_mag_id);
	if($w_rtn != 0){
		return 4000;
	}

	#------------------------------------------------------------------
	# get the parts WIP info
	#------------------------------------------------------------------
	$w_tmpsql = <<<_SQL
SELECT
	*
FROM
	PRT_WIP_TBL
WHERE
	MT_LOT_ID = '%s'
_SQL;

	#------------------------------------------------------------------
	# MTOT for all acquired magazine ID
	#------------------------------------------------------------------
	for($i=1; $i<=count($w_arr_mag_id); $i++){
		#------------------------------------------------------------------
		# get the PRT_WIP_TBL
		#------------------------------------------------------------------
		$w_sql = sprintf($w_tmpsql, $w_arr_mag_id[$i]);
		$w_stmt = db_res_set($w_sql);
		$w_rtn = db_do($w_stmt);
		if($w_rtn != 0){
			list($g_msg, $g_err_lv) = msg("err_Sel");
			$g_msg = xpt_err_msg($g_msg, "PRT_WIP_TBL", __LINE__);
			return 4000;
		}
		$w_prtwip = db_fetch_row($w_stmt);
		db_res_free($w_stmt);

		#------------------------------------------------------------------
		# check the material state
		#------------------------------------------------------------------
		$w_rtn = mtot_st_check($w_prtwip);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# get the qty of magazine ID
		#------------------------------------------------------------------
		$w_rtn = get_mgid_cnt($w_arr_mag_id[$i], $w_cnt);
		if($w_rtn != 0){
			return 4000;
		}
		#------------------------------------------------------------------
		# MTOT
		#------------------------------------------------------------------
		$w_rtn = mtot($w_lot_id,
					  $w_arr_mag_id[$i],
					  " ",
					  $w_usr_id,
					  $w_prtwip['UPD_LEV'],
					  "",
					  $w_prtwip);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, "", __LINE__);
			return 4000;
		}
	}

	return 0;
}
#=========================================================================
# VERB::MTCS
#=========================================================================
function main_verb_mtcs($w_lot_id, $w_prt_cd, $w_stp_cd, $w_equ_cd, $w_prd_cd,
		$w_qty,$w_cmt, &$r_prt_wip) {
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------
	# check the material state
	#------------------------------------------------------
	$w_rtn = mtcs_st_check($r_prt_wip['PRT_ST_DVS']);
	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# check usable by the shop
	#------------------------------------------------------
	$w_rtn = mtcs_shp_check($w_prt_cd, $w_stp_cd, $w_equ_cd, $w_prd_cd);
	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# MTCS
	#------------------------------------------------------
	$w_rtn = mtcs($w_lot_id, $w_qty, $gw_scr['s_usr_id'],
			$r_prt_wip['UPD_LEV'], " ", $w_cmt, $r_prt_wip);
	if ($w_rtn != 0) {
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# VERB::MTHD
#==================================================================
function main_verb_mthd($w_usr_id, $w_prt_cd, $w_shp_cd, $w_equ_cd, $w_mt_lot_id, $w_cmt)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------
	# get parts WIP info
	#------------------------------------------------------
	$w_rtn = xgt_prt_wip($w_prt_cd,
						$w_shp_cd,
						"",
						$w_mt_lot_id,
						$w_prt_wip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# check the material state
	#------------------------------------------------------
	$w_rtn = mthd_st_check(trim($w_prt_wip['PRT_ST_DVS']));
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_mt_lot_id, __LINE__);
		return 4000;
	}

	#------------------------------------------------------
	# MTHD
	#------------------------------------------------------
	$w_rtn = mthd($w_usr_id,
				$w_prt_wip['UPD_LEV'],
				" ",
				$w_cmt,
				$w_prt_wip);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, $w_mt_lot_id, __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# insert magazine ID
#==================================================================
function ins_mgznid($w_usr_id, $w_lot_id, $w_mgznid, $w_verb)
{
	global $g_msg;
	global $g_err_lv;

	$w_ce_mag = constant("CE_MAG");
	$w_ct_mag = constant("CT_MAG");

	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_CD = '{$w_ct_mag}'
	AND CTG_DVS_CD = '{$w_ce_mag}'
	AND CTG_DAT_TXT = '{$w_mgznid}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	$w_insflg = 1;
	if($w_row = db_fetch_row($w_stmt)){
		if($w_row['CNT'] > 0){
			$w_insflg = 0;
		}
	}
	db_res_free($w_stmt);

	if($w_insflg == 1){
		$w_rtn = ins_lot_inf_tbl($w_usr_id,
								 $w_lot_id,
								 $w_ce_mag,
								 $w_ct_mag,
								 " ",
								 $w_mgznid,
								 "",
								 $w_verb);
		if($w_rtn != 0){
			return 4000;
		}
	}

	return 0;
}

#==================================================================
# get qty of magazine ID
#==================================================================
function get_mgid_cnt($w_mgid, &$r_cnt)
{
	global $g_msg;
	global $g_err_lv;

	$r_cnt = 0;
	$w_ce_mag = constant("CE_MAG");
	$w_ct_mag = constant("CT_MAG");

	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	LOT_INF_TBL
WHERE
	CTG_CD = '{$w_ct_mag}'
	AND CTG_DVS_CD = '{$w_ce_mag}'
	AND CTG_DAT_TXT = '{$w_mgid}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	if($w_row = db_fetch_row($w_stmt)){
		$r_cnt = $w_row['CNT'];
	}
	db_res_free($w_stmt);

	return 0;
}

## FOR AUTO TRANSFER FUNCTIONS - START ##
#==================================================================
# Insert LOG BIND TABLE
#==================================================================
function ins_log_bind_tbl($w_usr_id,
						$w_bind_id,
						$w_line_no,
						$w_lot_id,
						$w_verb,
						$w_stp_cd)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	#------------------------------------------------------------------
	#
	#------------------------------------------------------------------
	$w_ins = array
	(
		'DEL_FLG'		=> '0',
		'BIND_ID'		=> $w_bind_id,
		'LINE_NO'		=> $w_line_no,
		'LOT_ID'		=> $w_lot_id,
		'VERB'			=> $w_verb,
		'STP_CD'		=> $w_stp_cd,
		'LOG_CRT_DTS'		=> $g_cpu_dts,
		'CRT_DTS'		=> $g_cpu_dts,
		'USR_ID_CRT'		=> $w_usr_id,
		'UPD_DTS'		=> $g_low_dts,
		'USR_ID_UPD'		=> ' ',
		'UPD_LEV'		=> 1,
	);
	$w_rtn = db_insert("LOG_BIND_TBL", $w_ins);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Ins");
		$g_msg = xpt_err_msg($g_msg, "LOG_BIND_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
#
#==================================================================
function ins_log_bind_inf($w_usr_id,
						$w_bind_id,
						$w_form_id,
						$w_verb)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	#------------------------------------------------------------------
	#
	#------------------------------------------------------------------
	$w_ins = array
	(
		'DEL_FLG'		=> '0',
		'BIND_ID'		=> $w_bind_id,
		'BIND_DVS'		=> $w_verb,
		'BIND_TXT_1'	=> ' ',
		'BIND_TXT_G_1'	=> ' ',
		'BIND_TXT_2'	=> ' ',
		'BIND_TXT_G_2'	=> ' ',
		'BIND_TXT_3'	=> ' ',
		'BIND_TXT_G_3'	=> ' ',
		'FORM_ID'		=> $w_form_id,
		'BIND_QTY_1'	=> 0,
		'BIND_QTY_2'	=> 0,
		'BIND_QTY_3'	=> 0,
		'CRT_DTS'		=> $g_cpu_dts,
		'USR_ID_CRT'	=> $w_usr_id,
		'UPD_DTS'		=> $g_low_dts,
		'USR_ID_UPD'	=> ' ',
		'UPD_LEV'		=> 1,
	);
	$w_rtn = db_insert("LOG_BIND_INF", $w_ins);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Ins");
		$g_msg = xpt_err_msg($g_msg, "LOG_BIND_INF", __LINE__);
		$gw_scr['s_msg']    = $g_msg;
		$gw_scr['s_err_lv'] = $g_err_lv;
		return 4000;
	}

	return 0;
}

#=======================================================
# Update LOT INFO Table
#=======================================================
function update_lot_inf_tbl($w_usr_id, $w_lot_id, $w_all_div, $w_sp_lot_id,$w_brg_qty)
{
	global $g_msg;
	global $gw_scr;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_remain_lf_qty = 0;
	#------------------------------
	# 
	#------------------------------
	$w_rtn = get_lot_inf_tbl($w_lot_id, $w_lot_inf_tbl);
	if($w_rtn != 0) {
		return $w_rtn;
	}

	#--------------------
	#
	#--------------------
	$w_secret_cnt = 0;
	$w_ctg_brg_cd = '';
	for ($i=0; $i<count($w_lot_inf_tbl); $i++) {
		$w_ctg_dvs_cd = trim($w_lot_inf_tbl[$i]['CTG_DVS_CD']);
		$w_ctg_cd     = trim($w_lot_inf_tbl[$i]['CTG_CD']);
		if (($w_ctg_dvs_cd == 'CE00S02') && ($w_ctg_cd == 'CT00S0000012')) {
			$w_ctg_brg_cd  = $w_ctg_cd;
		}
                if (($w_ctg_dvs_cd == 'CE00S02') && ($w_ctg_cd == 'CT00S0000011')) {
                        $w_ctg_brg_cd  = $w_ctg_cd;
                }
	}
	#-----------------------------------
	#
	#-----------------------------------
	$w_table = 'LOT_INF_TBL';
	
		$w_sl_id = 1;
		for ($j=0; $j<count($w_lot_inf_tbl); $j++) {

			$w_ctg_dvs_cd = trim($w_lot_inf_tbl[$j]['CTG_DVS_CD']);
			$w_ctg_cd     = trim($w_lot_inf_tbl[$j]['CTG_CD']);
			if (($w_ctg_dvs_cd == 'CE00C01') && ($w_ctg_cd == 'CT00C0000002')) {

				$w_rtn = xgt_lot($w_sp_lot_id, $w_lot_bas);
				if ($w_rtn != 0) {
					$g_err_lv = 0;
					$g_msg = xpt_err_msg($g_msg, $w_sp_lot_id, __LINE__);
					return $w_rtn;
				}

				$w_chp_qty = floor($w_lot_bas['CHP_QTY'] / $w_secret_cnt);
				$w_amari   = $w_lot_bas['CHP_QTY'] % $w_secret_cnt;
				if ($w_sl_id == 1) {
					$w_ctg_dat_val = $w_chp_qty + $w_amari;
					$w_secret_flg  = true;
				} else {
					$w_ctg_dat_val = $w_chp_qty;
				}
				$w_table = 'LOT_INF_TBL';
				$w_dat = array
					(
						'DEL_FLG'     => 0,
						'LOT_ID'      => $w_sp_lot_id,
						'CTG_DVS_CD'  => $w_ctg_dvs_cd,
						'CTG_CD'      => $w_ctg_cd,
						'SL_ID'       => $w_sl_id,
						'CTG_DAT_TXT' => $w_lot_inf_tbl[$j]['CTG_DAT_TXT'],
						'CTG_DAT_VAL' => $w_ctg_dat_val,
						'CRT_VERB'    => 'IOSP',
						'CRT_DTS'     => $g_cpu_dts,
						'USR_ID_CRT'  => $w_usr_id,
						'UPD_VERB'    => ' ',
						'UPD_DTS'     => $g_low_dts,
						'USR_ID_UPD'  => ' ',
						'UPD_LEV'     => 1
					);
				$w_sl_id++;

				$w_rtn = db_insert($w_table, $w_dat);
				if ($w_rtn != 0) {
					list($g_msg, $g_err_lv) = msg("err_Add_LotInfTbl");
					$g_msg = xpt_err_msg($g_msg, $w_sp_lot_id, __LINE__);
					return $w_rtn;
				}
			} else if ($w_ctg_cd == constant("CT_SUBSTRATE")) {
				$w_table = 'LOT_INF_TBL';
                                $w_dat = array
                                                (
                                                        'DEL_FLG'     => 0,
                                                        'LOT_ID'      => $w_sp_lot_id,
                                                        'CTG_DVS_CD'  => $w_ctg_dvs_cd,
                                                        'CTG_CD'      => $w_ctg_cd,
                                                        'SL_ID'       => $w_lot_inf_tbl[$j]['SL_ID'],
                                                        'CTG_DAT_TXT' => $w_lot_inf_tbl[$j]['CTG_DAT_TXT'],
                                                        'CTG_DAT_VAL' => $gw_scr['s_lf_qty'],
                                                        'CRT_VERB'    => 'IOSP',
                                                        'CRT_DTS'     => $g_cpu_dts,
                                                        'USR_ID_CRT'  => $w_usr_id,
                                                        'UPD_VERB'    => ' ',
                                                        'UPD_DTS'     => $g_low_dts,
                                                        'USR_ID_UPD'  => ' ',
                                                        'UPD_LEV'     => 1
                                                );

                                 $w_rtn = db_insert($w_table, $w_dat);
                                 if ($w_rtn != 0) {
                                         list($g_msg, $g_err_lv) = msg("err_Add_LotInfTbl");
                                         $g_msg = xpt_err_msg($g_msg, $w_sp_lot_id, __LINE__);
                                         return $w_rtn;
                                 }

				$w_remain_lf_qty = 0;
			} else {
				if($w_ctg_cd != constant("CT_MAGJIG")) {
					$w_table = 'LOT_INF_TBL';
					$w_dat = array
						(
							'DEL_FLG'     => 0,
							'LOT_ID'      => $w_sp_lot_id,
							'CTG_DVS_CD'  => $w_ctg_dvs_cd,
							'CTG_CD'      => $w_ctg_cd,
							'SL_ID'       => $w_lot_inf_tbl[$j]['SL_ID'],
							'CTG_DAT_TXT' => $w_lot_inf_tbl[$j]['CTG_DAT_TXT'],
							'CTG_DAT_VAL' => $w_lot_inf_tbl[$j]['CTG_DAT_VAL'],
							'CRT_VERB'    => 'IOSP',
							'CRT_DTS'     => $g_cpu_dts,
							'USR_ID_CRT'  => $w_usr_id,
							'UPD_VERB'    => ' ',
							'UPD_DTS'     => $g_low_dts,
							'USR_ID_UPD'  => ' ',
							'UPD_LEV'     => 1
						);

					$w_rtn = db_insert($w_table, $w_dat);
					if ($w_rtn != 0) {
						list($g_msg, $g_err_lv) = msg("err_Add_LotInfTbl");
						$g_msg = xpt_err_msg($g_msg, $w_sp_lot_id, __LINE__);
						return $w_rtn;
					}
				}
			}
		}
	

	#-------------------------
	# 
	#-------------------------
	if ($w_all_div) {

		$w_table = 'LOT_INF_TBL';
		$w_dat = array
			(
				'DEL_FLG'     => 1,
				'UPD_VERB'    => "'IOSP'",
				'UPD_DTS'     => "'" . $g_cpu_dts . "'",
				'USR_ID_UPD'  => "'" . $w_usr_id . "'",
				'UPD_LEV'     => "UPD_LEV + 1"
			);
		$w_where = "LOT_ID = '" . $w_lot_id . "' AND DEL_FLG = '0'";

		$w_rtn = db_update_large_2($w_table, $w_dat, $w_where);
		if ($w_rtn != 0) {
			list($g_msg, $g_err_lv) = msg("err_Del_LotInfTbl");
			$g_msg = xpt_err_msg($g_msg, $w_sp_lot_id, __LINE__);
			return $w_rtn;
		}
	} else {

		$w_table = 'LOT_INF_TBL';
		$w_dat = array
			(
				'DEL_FLG'     => 1,
				'UPD_VERB'    => "'IOSP'",
				'UPD_DTS'     => "'" . $g_cpu_dts . "'",
				'USR_ID_UPD'  => "'" . $w_usr_id . "'",
				'UPD_LEV'     => "UPD_LEV + 1"
			);
		$w_where = "LOT_ID = '" . $w_lot_id . "' AND "
				 . "CTG_DVS_CD = 'CE00S02' AND "
				 . "CTG_CD = '". $w_ctg_brg_cd ."' AND "
				 . "DEL_FLG = '0'";

		$w_rtn = db_update_large_2($w_table, $w_dat, $w_where);
		if ($w_rtn != 0) {
			list($g_msg, $g_err_lv) = msg("err_Del_LotInfTbl");
			$g_msg = xpt_err_msg($g_msg, $w_sp_lot_id, __LINE__);
			return $w_rtn;
		}

		#Get original
		for ($i=0; $i<count($w_lot_inf_tbl); $i++) {

			if(trim($w_lot_inf_tbl[$i]['CTG_DVS_CD']) == constant('CE_LOT') && trim($w_lot_inf_tbl[$i]['CTG_CD']) == constant('CT_SUBSTRATE')){
				#Update substrate quantity leh
				$w_table = 'LOT_INF_TBL';
				$w_dat = array
					(
						'DEL_FLG'     => 1,
						'UPD_VERB'    => "'IOSP'",
						'UPD_DTS'     => "'" . $g_cpu_dts . "'",
						'USR_ID_UPD'  => "'" . $w_usr_id . "'",
						'UPD_LEV'     => "UPD_LEV + 1"
					);
				$w_where = "LOT_ID = '" . $w_lot_id . "' AND DEL_FLG = '0'";
				$w_where = $w_where . " AND CTG_CD = '". constant('CT_SUBSTRATE') ."' AND CTG_DVS_CD = '".constant("CE_LOT")."'";
				
				$w_rtn = db_update_large_2($w_table, $w_dat, $w_where);
				if ($w_rtn != 0) {
					list($g_msg, $g_err_lv) = msg("err_Del_LotInfTbl");
					$g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
					return $w_rtn;
				}
				
				#Insert new Leh
				$w_table = 'LOT_INF_TBL';
				$w_dat = array
					(
						'DEL_FLG'    	=> 0,
						'LOT_ID'      	=> $w_lot_id,
						'CTG_DVS_CD'  	=> constant('CE_LOT'),
						'CTG_CD'      	=> constant('CT_SUBSTRATE'),
						'SL_ID'       	=> " ",
						'CTG_DAT_TXT' 	=> NULL,
						'CTG_DAT_VAL'	=> $w_remain_lf_qty,
						'CRT_VERB'    	=> 'IOSP',
						'CRT_DTS'     	=> $g_cpu_dts,
						'USR_ID_CRT'  	=> $w_usr_id,
						'UPD_VERB'    	=> ' ',
						'UPD_DT'     	=> $g_low_dts,
						'USR_ID_UPD'  	=> ' ',
						'UPD_LEV'     	=> 1
					);

				$w_rtn = db_insert($w_table, $w_dat);
				if ($w_rtn != 0) {
					list($g_msg, $g_err_lv) = msg("err_Add_LotInfTbl");
					$g_msg = xpt_err_msg($g_msg, $w_sp_lot_id, __LINE__);
					return $w_rtn;
				}
			}



		}
	}

	return 0;
}



#=======================================================
#
#=======================================================
function get_lot_inf_tbl($w_lot_id, &$r_lot_inf_tbl)
{
	global $g_msg;
	global $g_err_lv;

	#---------------
	# SQL
	#---------------
	$w_sql = "SELECT "
			.	"* "
			. "FROM "
			.	"LOT_INF_TBL "
			. "WHERE "
			.	"LOT_ID = '" . $w_lot_id . "' AND "
			. 	"DEL_FLG = '0'";

	#---------------
	# SQL
	#---------------
	$w_stmt = db_res_set($w_sql);

	#---------------
	# SQL
	#---------------
	$w_rtn = db_do($w_stmt);
	if ($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_LotInfTbl");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return $w_rtn;
	}

	#---------------
	#
	#---------------
	while ($w_row = db_fetch_row($w_stmt)) {
		$r_lot_inf_tbl[] = $w_row;
	}

	#--------------------
	# 
	#--------------------
	db_res_free($w_stmt);

	#---------------
	#
	#---------------
	return 0;

}
## FOR AUTO TRANSFER FUNCTIONS - END ##

#==================================================================
# insert LOT_INF_TBL
#==================================================================
function ins_lot_inf_tbl($w_usr_id,
						 $w_lot_id,
						 $w_ctg_dvs_cd,
						 $w_ctg_cd,
						 $w_sl_id,
						 $w_ctg_dat_txt,
						 $w_ctg_dat_val,
						 $w_crt_verb)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_arr = array
	(
		"DEL_FLG"		=> "0",
		"LOT_ID"		=> $w_lot_id,
		"CTG_DVS_CD"	=> $w_ctg_dvs_cd,
		"CTG_CD"		=> $w_ctg_cd,
		"SL_ID"			=> $w_sl_id,
		"CTG_DAT_TXT"	=> $w_ctg_dat_txt,
		"CTG_DAT_VAL"	=> $w_ctg_dat_val,
		"CRT_VERB"		=> $w_crt_verb,
		"CRT_DTS"		=> $g_cpu_dts,
		"USR_ID_CRT"	=> $w_usr_id,
		"UPD_VERB"		=> " ",
		"UPD_DTS"		=> $g_low_dts,
		"USR_ID_UPD"	=> " ",
		"UPD_LEV"		=> 1
	);

	$w_rtn = db_insert("LOT_INF_TBL", $w_arr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Ins");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# update(DEL_FLG=1) LOT_INF_TBL
#==================================================================
function upd_lot_inf_tbl($w_usr_id,
						 $w_lot_id,
						 $w_ctg_dvs_cd,
						 $w_ctg_cd,
						 $w_sl_id,
						 $w_upd_verb)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_upd = array
	(
		"DEL_FLG"		=> "1",
		"UPD_VERB"		=> $w_upd_verb,
		"UPD_DTS"		=> $g_cpu_dts,
		"USR_ID_UPD"	=> $w_usr_id,
	);
	$w_whr = <<<_SQL
LOT_ID = '{$w_lot_id}'
AND CTG_DVS_CD = '{$w_ctg_dvs_cd}'
AND CTG_CD = '{$w_ctg_cd}'
AND SL_ID = '{$w_sl_id}'
AND DEL_FLG = '0'
_SQL;

	$w_rtn = db_update_one("LOT_INF_TBL", $w_upd, $w_whr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Upd");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# insert CTG_TBL
#==================================================================
function ins_ctg_tbl($w_usr_id,
					 $w_lot_id,
					 $w_ctg_dvs_cd,
					 $w_ctg_cd,
					 $w_sl_id,
					 $w_ctg_dat_txt,
					 $w_ctg_dat_val)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;
	global $g_low_dts;

	$w_arr = array
	(
		"DEL_FLG"		=> "0",
		"LOT_ID"		=> $w_lot_id,
		"CTG_DVS_CD"	=> $w_ctg_dvs_cd,
		"CTG_CD"		=> $w_ctg_cd,
		"SL_ID"			=> $w_sl_id,
		"CTG_DAT_TXT"	=> $w_ctg_dat_txt,
		"CTG_DAT_VAL"	=> $w_ctg_dat_val,
		"CRT_DTS"		=> $g_cpu_dts,
		"USR_ID_CRT"	=> $w_usr_id,
		"UPD_DTS"		=> $g_low_dts,
		"USR_ID_UPD"	=> " ",
		"UPD_LEV"		=> 1
	);

	$w_rtn = db_insert("CTG_TBL", $w_arr);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Ins");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# get PRC_FLW_MST
#==================================================================
function get_prcflwinf($w_prc_cd, $w_stp_no, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	*
FROM
	PRC_FLW_MST
WHERE
	PRC_CD = '{$w_prc_cd}'
	AND STP_NO = '{$w_stp_no}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRC_FLW_MST", __LINE__);
		return 4000;
	}

	if($w_row = db_fetch_row($w_stmt)){
		foreach($w_row as $key => $val){
			$w_row[$key] = trim($w_row[$key]);
		}
		$r_dat = $w_row;
	}
	db_res_free($w_stmt);

	return 0;
}
#==================================================================
# get PRC_MST
#==================================================================
function get_prcmstinf($w_prc_cd, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	*
FROM
	PRC_MST
WHERE
	PRC_CD = '{$w_prc_cd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRC_MST", __LINE__);
		return 4000;
	}

	if($w_row = db_fetch_row($w_stmt)){
		foreach($w_row as $key => $val){
			$w_row[$key] = trim($w_row[$key]);
		}
		$r_dat = $w_row;
	}
	db_res_free($w_stmt);

	return 0;
}

#==================================================================
# check the HOLD info by SPACE or Equipment state
#==================================================================
function chk_spc_equ($w_lot_id, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat    = "";
	$w_ctgdvs = constant("CE_HOLDINF");
	$w_ctgcd  = constant("CT_ABNINF");

	$w_sql = <<<_SQL
SELECT
	CTG_DAT_TXT
FROM
	CTG_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_TBL", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if($w_row){
		$r_dat = trim($w_row['CTG_DAT_TXT']);
	}

	return 0;
}

#==================================================================
# Checking Backfill Header Only
#==================================================================
function chk_backfill($w_usr_id,
                                $w_lot_id,
                                $w_simm,
                                $w_equ_cd,
                                $w_chp_qty,
                                $w_sub_qty,
                                $w_prg_id,
                                &$r_web_err_cd, &$r_web_err_nm, &$r_web_err_msg)
{
        global $gw_scr;
        global $g_msg;
        global $g_err_lv;
        global $g_cpu_dts;

        # $w_web_req
        # This is for the web request type. It will indicate Track In or Track Out for the Web Service.
        # 0 : TRACK IN
        # 1 : TRACK OUT
	# 2 : TRACK OUT MODE1
        $w_web_req = 2;

        #------------------------------------------------------------------
        # Backfill Checking For Header Only Web Service
        #------------------------------------------------------------------
        $w_rtn = cs_xck_backfill_web_service($w_lot_id,
                                                                $w_simm,
                                                                $w_equ_cd,
                                                                $w_prg_id,
                                                                $w_usr_id,
                                                                $g_cpu_dts,
                                                                $w_chp_qty,
                                                                $w_sub_qty,
                                                                $w_web_req,
                                                                $r_web_err_cd,
                                                                $r_web_err_nm,
                                                                $r_web_err_msg);
        if($w_rtn != 0){
                $g_err_lv = 0;
                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                return 4000;
        }

        return 0;
}


#==================================================================
# BACKFILL Checking
#==================================================================
function chk_backfill_out($w_lot_id, $w_simm, $w_equ_cd, $w_pken_prg_id, $w_usr_id,
                                $w_in_chp_qty, $w_out_chp_qty, $w_in_bar_or_ring_qty, $w_out_bar_or_ring_qty,
                                $w_rjct_chp_qty, $w_rjct_bar_qty, $w_plt_jdg, &$r_web_err_cd, &$r_web_err_nm, &$r_web_err_msg)
{
        global $g_msg;
        global $g_err_lv;
        global $g_cpu_dts;

        #------------------------------------------------------------------
        # get the input info from material consumption
        #------------------------------------------------------------------
        $w_mcnt            = get_session_value('s_max_rows', constant("PGM_MTMNG"));
        $w_list_prt_cd     = get_session_value('s_list_prt_cd', constant("PGM_MTMNG"));
        $w_list_prt_alt    = get_session_value('s_list_glb_prt_cd', constant("PGM_MTMNG"));
        $w_list_mt_lot_id  = get_session_value('s_list_mt_lot_id', constant("PGM_MTMNG"));
        $w_list_use_qty    = get_session_value('s_list_use_qty', constant("PGM_MTMNG"));

        $w_arr_mat = array();
        for($i=1; $i<=$w_mcnt; $i++){
                if($w_list_prt_cd[$i]  == "") continue;
                if($w_list_use_qty[$i] == "") continue;
                $w_prtalt = $w_list_prt_alt[$i];
                $w_arr_mat[$w_prtalt] = $w_list_mt_lot_id[$i] . "_" . $w_list_use_qty[$i];
        }

        #------------------------------------------------------------------
        # check Backfill
        #------------------------------------------------------------------
        $w_rtn = cs_xck_backfill_abn_snd_lot($w_lot_id,
                                                                $w_simm,
                                                                $w_equ_cd,
                                                                $w_pken_prg_id,
                                                                $w_usr_id,
                                                                $g_cpu_dts,
                                                                $w_in_chp_qty,
                                                                $w_out_chp_qty,
                                                                $w_in_bar_or_ring_qty,
                                                                $w_out_bar_or_ring_qty,
                                                                $w_arr_mat,
                                                                $w_rjct_chp_qty,
                                                                $w_rjct_bar_qty,
                                                                $w_plt_jdg,
                                                                $r_web_err_cd,
                                                                $r_web_err_nm,
                                                                $r_web_err_msg);
        if($w_rtn != 0){
                $g_err_lv = 0;
                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                return 4000;
        }


        return 0;
}

#==================================================================
# SPACE
#==================================================================
function chk_space($w_lot_id, $w_simm, $w_equ_cd, $w_pken_prg_id, $w_usr_id,
				$w_in_chp_qty, $w_out_chp_qty, $w_in_bar_or_ring_qty, $w_out_bar_or_ring_qty,
				$w_rjct_chp_qty, $w_rjct_bar_qty, $w_plt_jdg, &$r_spc_err_cd, &$r_spc_err_nm, &$r_spc_err_msg)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	#------------------------------------------------------------------
	# get the input info from material consumption
	#------------------------------------------------------------------
	$w_mcnt            = get_session_value('s_max_rows', constant("PGM_MTMNG"));
	$w_list_prt_cd     = get_session_value('s_list_prt_cd', constant("PGM_MTMNG"));
	$w_list_prt_alt    = get_session_value('s_list_glb_prt_cd', constant("PGM_MTMNG"));
	$w_list_mt_lot_id  = get_session_value('s_list_mt_lot_id', constant("PGM_MTMNG"));
	$w_list_use_qty    = get_session_value('s_list_use_qty', constant("PGM_MTMNG"));
	### error no input

	$w_arr_mat = array();
	for($i=1; $i<=$w_mcnt; $i++){
		if($w_list_prt_cd[$i]  == "") continue;
		if($w_list_use_qty[$i] == "") continue;
		$w_prtalt = $w_list_prt_alt[$i];
		$w_arr_mat[$w_prtalt] = $w_list_mt_lot_id[$i] . "_" . $w_list_use_qty[$i];
	}

	#------------------------------------------------------------------
	# check SPACE
	#------------------------------------------------------------------
	$w_rtn = cs_xck_abn_snd_lot($w_lot_id,
								$w_simm,
								$w_equ_cd,
								$w_pken_prg_id,
								$w_usr_id,
								$g_cpu_dts,
								$w_in_chp_qty,
								$w_out_chp_qty,
								$w_in_bar_or_ring_qty,
								$w_out_bar_or_ring_qty,
								$w_arr_mat,
								$w_rjct_chp_qty,
								$w_rjct_bar_qty,
								$w_plt_jdg,
								$r_spc_err_cd,
								$r_spc_err_nm,
								$r_spc_err_msg);
	if($w_rtn != 0){
		$g_err_lv = 0;
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	return 0;
}

#==================================================================
# Check Hairline Crack
#==================================================================
function chk_hairline_crk($w_lot_bas, $w_baddtl, &$r_flg)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# search the all related Lot
	#------------------------------------------------------------------
	$w_all_rlt_lot = array(1 => trim($w_lot_bas['LOT_ID']));
	$w_rtn = get_trc_lot($w_lot_bas['LOT_ID'],
						$w_lot_bas['VERB_CAN'],
						$w_lot_bas['STP_CD'],
						$w_lot_bas['DTS_CAN'],
						$w_all_rlt_lot);
	if($w_rtn != 0) return 4000;

	#------------------------------------------------------------------
	# check the hairline crack for current reject info
	#------------------------------------------------------------------
	$w_rtn = chk_hairline_crk_parmst($w_baddtl, $w_flg);
	if($w_rtn != 0) return 4000;
	if($w_flg == 1){
		$r_flg = 1;
		return 0;
	}

	#------------------------------------------------------------------
	# check the reject info of all related Lot
	#------------------------------------------------------------------
	for($i=1; $i<=count($w_all_rlt_lot); $i++){
		$w_rtn = get_rej_ctg_inf($w_all_rlt_lot[$i], $w_rejinf);
		if($w_rtn != 0) return 4000;

		$w_rtn = chk_hairline_crk_parmst($w_rejinf, $w_flg);
		if($w_flg == 1){
			$r_flg = 1;
			return 0;
		}
	}


	return 0;
}

#==================================================================
# check the hairline crack par_mst
#==================================================================
function chk_hairline_crk_parmst($w_baddtl, &$r_flg)
{
	global $g_msg;
	global $g_err_lv;

	$r_flg = 0;

	for($i=1; $i<=count($w_baddtl); $i++){
		$w_prdcd  = $w_baddtl[$i]['PRD_CD'];
		$w_stpcd  = $w_baddtl[$i]['STP_CD'];

		$w_partxt = $w_baddtl[$i]['CTG_CD'] . "_Y";
		### Product Level
		$w_parid = "PD" ."_". substr($w_prdcd, 5) ."_". substr($w_stpcd, 5);
		$w_rtn = chk_hairline_crk_parmst_exe($w_parid, $w_partxt, $w_flg);
		if($w_rtn != 0) return 4000;
		if($w_flg == 1){
			$r_flg = 1;
			return 0;
		}

		### Package Level
		$w_rtn = xgn_pkg($w_prdcd, 1, $w_pkgcd, $_);
		if($w_rtn != 0){
			$g_err_lv = 0;
			$g_msg = xpt_err_msg($g_msg, $w_prdcd, __LINE__);
			return 4000;
		}
		$w_parid = "PG" . "_". substr($w_pkgcd, 5) . "_" . substr($w_stpcd, 5);
		$w_rtn = chk_hairline_crk_parmst_exe($w_parid, $w_partxt, $w_flg);
		if($w_rtn != 0) return 4000;
		if($w_flg == 1){
			$r_flg = 1;
			return 0;
		}

		### Step Level
		$w_parid = "ST" . "_". substr($w_stpcd, 5);
		$w_rtn = chk_hairline_crk_parmst_exe($w_parid, $w_partxt, $w_flg);
		if($w_rtn != 0) return 4000;
		if($w_flg == 1){
			$r_flg = 1;
			return 0;
		}
	}

	return 0;
}

#==================================================================
# check par_mst for Wafer Mounting Expiry
#==================================================================
function get_wafer_mount_expiry_date(&$r_expiry_dts)
{
	global $g_msg;
	global $g_err_lv;
	global $g_cpu_dts;

	#------------------------------------------------------------------
	# SQL for check wafer mount expiry
	#------------------------------------------------------------------
	$par_cls_cd = constant("P0_WFR_EXP_LIMIT");

	$w_sql = <<<_SQL
SELECT
	PAR_NUM
FROM
	PAR_MST
WHERE
	PAR_CLS_CD = '{$par_cls_cd}' 
	AND PAR_ID = 'LIMIT(MONTH)'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PAR_MST", __LINE__);
		return 4000;
	}
	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	$w_expiry_month_add = $w_row['PAR_NUM'];
	// echo "w expi add ". $w_expiry_month_add;
	#------------------------------------------------------------------
	# new expiry date date
	#------------------------------------------------------------------
	 list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $g_cpu_dts);

	// $str = "+".$w_expiry_month_add." months";

	// $r_expiry_dts = date('Y-m-d H:i:s', strtotime($str, strtotime($g_cpu_dts)));

	

	// echo "MK TIME <pre>:". "mktime($h,$i,$s,($m + $w_expiry_month_add),$d,$y)";
	 $r_expiry_dts = date('Y-m-d h:i:s', mktime($h,$i,$s,($m + $w_expiry_month_add),$d,$y));
	// echo "exp dts ". $r_expiry_dts;

		

	return 0;
}

#==================================================================
# check par_mst for hairline crack
#==================================================================
function chk_hairline_crk_parmst_exe($w_parid, $w_partxt, &$r_flg)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# SQL for check hairline crack
	#------------------------------------------------------------------
	$r_flg = 0;

	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	PAR_MST
WHERE
	PAR_ID = '{$w_parid}'
	AND DVSN_CD = 'ABSEM11'
	AND PAR_TXT = '{$w_partxt}'
	AND PAR_NUM = 4
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PAR_MST", __LINE__);
		return 4000;
	}
	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if($w_row['CNT'] >= 1){
		$r_flg = 1;
	}

	return 0;
}
#==================================================================
# get related Lot
#==================================================================
function get_trc_lot($w_lot_id, $w_verb, $w_stp_cd, $w_dts, &$r_arr_lot)
{
	global $g_msg;
	global $g_err_lv;

	$w_sch_lot_id = $w_lot_id;
	$w_sch_verb   = $w_verb;
	$w_sch_stp_cd = $w_stp_cd;
	$w_sch_dts    = $w_dts;

	$cnt = 0;
	while(1){
		#-=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=-
		# preventing an infinite loop
		$cnt++;
		if($cnt >= 500){
			list($g_msg, $g_err_lv) = msg("err_Unexpected");
			$w_tg = get_tg($w_lot_id, $w_verb, $w_dts);
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		#-=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=--=-

		#------------------------------------------------------------------
		# search VERB : IOSP
		#------------------------------------------------------------------
		if($w_sch_verb == "IOSP"){
			### search the parent Lot
			$w_rtn = get_prnlot_iosp($w_sch_lot_id, $w_sch_dts, $w_prn_lot_id);
			if($w_rtn != 0) return 4000;
			### search the next past log info
			$w_rtn = get_nxt_past_loginf($w_prn_lot_id, $w_sch_verb, $w_sch_dts, $w_sch_stp_cd, $w_dat,
											null, $w_sch_lot_id);
			if($w_rtn != 0) return 4000;

			### set the related Lot
			if(!in_array($w_prn_lot_id, $r_arr_lot)){
				$r_arr_lot[] = $w_prn_lot_id;
			}

			$w_sch_lot_id = $w_prn_lot_id;
			$w_sch_verb   = $w_dat['VERB_CAN'];
			$w_sch_dts    = $w_dat['DTS_CAN'];

		}
		#------------------------------------------------------------------
		# search VERB : IOMG
		#------------------------------------------------------------------
		elseif($w_sch_verb == "IOMG"){
			### search all child Lot at the same merge
			$w_rtn = get_rltlot_iomg($w_sch_lot_id, $w_sch_dts, $w_arr_rlt_lot);
			if($w_rtn != 0) return 4000;

			### recursive call for all child Lot
			for($i=1; $i<=count($w_arr_rlt_lot); $i++){
				if(!in_array($w_arr_rlt_lot[$i], $r_arr_lot)){
					$r_arr_lot[] = $w_arr_rlt_lot[$i];
				}

				$w_rtn = get_nxt_past_loginf($w_arr_rlt_lot[$i], $w_sch_verb, $w_sch_dts, $w_sch_stp_cd, $w_dat);
				if($w_rtn != 0) return 4000;

				$w_rtn = get_trc_lot($w_arr_rlt_lot[$i],
									$w_dat['VERB_CAN'],
									$w_sch_stp_cd,
									$w_dat['DTS_CAN'],
									$r_arr_lot);
				if($w_rtn != 0) return 4000;
			}

			### when end the recursive call, break here
			break;
		}
		#------------------------------------------------------------------
		# search VERB : other
		#------------------------------------------------------------------
		else {
			#------------------------------------------------------------------
                        # break point
                        #------------------------------------------------------------------
                        if($w_sch_verb == "PDCR"
                        || $w_sch_verb == "IOCR"
                        || $w_sch_verb == "IOMI"
                        || $w_sch_verb == "IOSM"
                        ){
                                break;
                        }

			### search next past log info
			$w_rtn = get_nxt_past_loginf($w_sch_lot_id,
										$w_sch_verb,
										$w_sch_dts,
										$w_sch_stp_cd,
										$w_dat, 1);
			if($w_rtn != 0) return 4000;

			$w_sch_verb   = $w_dat['VERB_CAN'];
			$w_sch_dts    = $w_dat['DTS_CAN'];
			$w_sch_stp_cd = $w_dat['STP_CD'];

			#------------------------------------------------------------------
			# break point
			#------------------------------------------------------------------
			if($w_sch_verb == "PDCR"
			|| $w_sch_verb == "IOCR"
			|| $w_sch_verb == "IOMI"
			|| $w_sch_verb == "IOSM"
			){
				break;
			}
		}
	}
}

#==================================================================
# get next past log info
#==================================================================
function get_nxt_past_loginf($w_lot_id, $w_verb, $w_dts, $w_stp_cd, &$r_dat,
						$w_t_flg = null, $w_lot_id_t = null)
{
	global $g_msg;
	global $g_err_lv;

	$w_whr_stp = "AND STP_CD = '" . $w_stp_cd . "' ";
	if(!is_null($w_t_flg)){
		$w_whr_stp = "AND STP_CD_T = '" . $w_stp_cd . "' ";
	}
	if(!is_null($w_lot_id_t)){
		$w_whr_lott = "AND LOT_ID_T = '" . $w_lot_id_t . "' ";
	}

	$w_sql = <<<_SQL
SELECT
	STP_CD,
	VERB_CAN,
	DTS_CAN
FROM
	LOT_LOG
WHERE
	LOT_ID = '{$w_lot_id}'
	AND VERB = '{$w_verb}'
	{$w_whr_stp}
	{$w_whr_lott}
	AND CRT_DTS = '{$w_dts}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_LOG", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_Get_Log");
		$w_tg = get_tg($w_lot_id, $w_verb, $w_dts, $w_stp_cd);
		$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
		return 4000;
	}

	$r_dat['STP_CD']   = trim($w_row['STP_CD']);
	$r_dat['VERB_CAN'] = trim($w_row['VERB_CAN']);
	$r_dat['DTS_CAN']  = trim($w_row['DTS_CAN']);

	return 0;
}

#==================================================================
# get parent Lot ID for IOSP
#==================================================================
function get_prnlot_iosp($w_lot_id, $w_dts, &$r_prn_lot_id)
{
	global $g_msg;
	global $g_err_lv;

	#------------------------------------------------------------------
	# search for child Lot
	#------------------------------------------------------------------
	$w_sql = <<<_SQL
SELECT
	LOT_ID_PRN
FROM
	LOT_SP_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CRT_DTS = '{$w_dts}'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_SP_TBL", __LINE__);
		return 4000;
	}
	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);
	### if get the result, set return variable and return function
	if($w_row){
		$r_prn_lot_id = trim($w_row['LOT_ID_PRN']);
		return 0;
	}

	#------------------------------------------------------------------
	# search for parent Lot (for all qty separated)
	#------------------------------------------------------------------
	$w_sql = <<<_SQL
SELECT
	COUNT(*) AS CNT
FROM
	LOT_SP_TBL
WHERE
	LOT_ID_PRN = '{$w_lot_id}'
	AND CRT_DTS = '{$w_dts}'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_SP_TBL", __LINE__);
		return 4000;
	}
	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	### abend if cannot find
	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_Get_PrntLot_SP");
		$w_tg = get_tg($w_lot_id, $w_dts);
		$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
		return 4000;
	}

	$r_prn_lot_id = $w_lot_id;

	return 0;
}

#==================================================================
# get the all child Lot at the same merge
#==================================================================
function get_rltlot_iomg($w_lot_id, $w_dts, &$r_arr_lot)
{
	global $g_msg;
	global $g_err_lv;

	$w_sql = <<<_SQL
SELECT
	*
FROM
	LOT_MG_TBL
WHERE
	LOT_ID_T = '{$w_lot_id}'
	AND CRT_DTS = '{$w_dts}'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_MG_TBL", __LINE__);
		return 4000;
	}

	$cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		$cnt++;
		$r_arr_lot[$cnt] = trim($w_row['LOT_ID']);
	}
	db_res_free($w_stmt);

	return 0;
}

#==================================================================
# get the reject category info
#==================================================================
function get_rej_ctg_inf($w_lot_id, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();
	$w_ctgdvs = constant("CE_CHP_BAD");

	$w_sql = <<<_SQL
SELECT
	*
FROM
	CTG_LOG
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND DEL_FLG = '0'
ORDER BY
	PRD_CD,
	STP_CD,
	CTG_CD
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_LOG", __LINE__);
		return 4000;
	}

	$cnt = 0;
	while($w_row = db_fetch_row($w_stmt)){
		if($w_row['QTY'] == 0 || is_null($w_row['QTY'])) continue;

		$cnt++;
		$r_dat[$cnt] = array
		(
			"PRD_CD"	=> trim($w_row['PRD_CD']),
			"STP_CD"	=> trim($w_row['STP_CD']),
			"CTG_CD"	=> trim($w_row['CTG_CD'])
		);
	}
	db_res_free($w_stmt);

	return 0;
}



#==================================================================
# get LOT_INF_TBL
#==================================================================
function get_lotinf($w_lot_id, $w_ctgdvs, $w_ctgcd, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	*
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	if($w_row = db_fetch_row($w_stmt)){
		foreach($w_row as $key => $val){
			$w_row[$key] = trim($w_row[$key]);
		}
		$r_dat = $w_row;
	}
	db_res_free($w_stmt);

	return 0;
}

#==================================================================
# get LOT_INF_TBL _Magazine
#==================================================================
function get_lotinf_magz($w_lot_id, $w_ctgdvs, $w_ctgcd, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	*
FROM
	LOT_INF_TBL
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
	ORDER BY CRT_DTS DESC
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "LOT_INF_TBL", __LINE__);
		return 4000;
	}

	if($w_row = db_fetch_row($w_stmt)){
		foreach($w_row as $key => $val){
			$w_row[$key] = trim($w_row[$key]);
		}
		$r_dat = $w_row;
	}
	db_res_free($w_stmt);

	return 0;
}

#==================================================================
# get next step info
#==================================================================
function get_next_process($w_rt_cd, $w_prd_cd, $w_stp_cd, &$r_next_dat)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	$r_next_dat = array();

	$w_sql = <<<_SQL
SELECT
	POM2.RT_CD AS RT_CD,
	POM2.PRD_CD_FIN AS PRD_CD_FIN,
	MIN(POM2.SEQ_NO_RT) AS SEQ_NO_RT
FROM
	PRD_ORG_MST POM1,
	PRD_ORG_MST POM2
WHERE
	POM1.RT_CD = '{$w_rt_cd}'
	AND POM1.PRD_CD = '{$w_prd_cd}'
	AND POM1.STP_CD = '{$w_stp_cd}'
	AND POM1.DEL_FLG = '0'
	AND POM1.RT_CD = POM2.RT_CD
	AND POM1.PRD_CD_FIN = POM2.PRD_CD_FIN
	AND POM2.DEL_FLG = '0'
	AND POM1.SEQ_NO_RT < POM2.SEQ_NO_RT
	AND POM2.IO_FLG = '1'
GROUP BY
	POM2.RT_CD, POM2.PRD_CD_FIN
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRD_ORG_MST", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_NextProcessInfo");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$w_sql = <<<_SQL
SELECT
	PRD_CD,
	PRC_CD,
	STP_NO,
	STP_CD
FROM
	PRD_ORG_MST
WHERE
	RT_CD = '{$w_row['RT_CD']}'
	AND PRD_CD_FIN = '{$w_row['PRD_CD_FIN']}'
	AND SEQ_NO_RT = '{$w_row['SEQ_NO_RT']}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "PRD_ORG_MST", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	if(!$w_row){
		list($g_msg, $g_err_lv) = msg("err_NextProcessInfo");
		$g_msg = xpt_err_msg($g_msg, "", __LINE__);
		return 4000;
	}

	$r_next_dat['PRD_CD'] = trim($w_row['PRD_CD']);
	$r_next_dat['PRC_CD'] = trim($w_row['PRC_CD']);
	$r_next_dat['STP_NO'] = trim($w_row['STP_NO']);
	$r_next_dat['STP_CD'] = trim($w_row['STP_CD']);

	return 0;
}

#==================================================================
# input check
#==================================================================
function check_input($w_mode)
{
	global $gw_scr;
	global $g_msg;
	global $g_err_lv;

	switch ($w_mode) {
	#------------------------------------------------------------------
	# MODE1
	#------------------------------------------------------------------
	case 1:
		#------------------------------------------------------------------
		# trim & upper
		#------------------------------------------------------------------
		$gw_scr['s_usr_id'] = strtoupper(trim($gw_scr['s_usr_id']));
		$gw_scr['s_lot_id'] = strtoupper(trim($gw_scr['s_lot_id']));

		#------------------------------------------------------------------
		# required
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		if($gw_scr['s_usr_id'] == ""){
			$g_msg = xpt_err_msg($g_msg, itm("UsrId"), __LINE__);
			return 4000;
		}
		if($gw_scr['s_lot_id'] == ""){
			$g_msg = xpt_err_msg($g_msg, itm("LotID"), __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# tag
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Inp_Tag");
		$w_tg = substr($gw_scr['s_usr_id'], 0, 2);
		if($w_tg != constant("TG_MA")){
			$w_tg = get_tg(itm("UsrId"));
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# prohibited characters
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
		if(!check_eisu($gw_scr['s_usr_id'])){
			$w_tg = get_tg(itm("UsrId"), $gw_scr['s_usr_id']);
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if(substr($gw_scr['s_lot_id'], 0, 2) == "LT"){
			if(!check_err_lot($gw_scr['s_lot_id'])){
				$w_tg = get_tg(itm("LotID"), $gw_scr['s_lot_id']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		} elseif(substr($gw_scr['s_lot_id'], 0, 2) == "B ") {
			if(!preg_match("/^[A-Z0-9\.\$\/\+\<\>\- ]+$/", $gw_scr['s_lot_id'])){
				$w_tg = get_tg(itm("LotID"), $gw_scr['s_lot_id']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		break;

	#------------------------------------------------------------------
	# MODE2
	#------------------------------------------------------------------
	case 2:
		#------------------------------------------------------------------
		# trim & upper
		#------------------------------------------------------------------
		$gw_scr['s_pas_chp_qty']  = trim($gw_scr['s_pas_chp_qty']);
		$gw_scr['s_pas_sub_qty']  = trim($gw_scr['s_pas_sub_qty']);
		$gw_scr['s_inp_phy_qty']  = trim($gw_scr['s_inp_phy_qty']);
		$gw_scr['s_rej_chp_qty']  = trim($gw_scr['s_rej_chp_qty']);
		$gw_scr['s_rej_sub_qty']  = trim($gw_scr['s_rej_sub_qty']);
		$gw_scr['s_pas_sl_qty']  = trim($gw_scr['s_pas_sl_qty']);
		$gw_scr['s_rej_sl_qty']  = trim($gw_scr['s_rej_sl_qty']);
		for($i=1; $i<=$gw_scr['s_chp_bad_cnt']; $i++){
			$gw_scr['s_list_chp_bad_ctg_qty'][$i] = trim($gw_scr['s_list_chp_bad_ctg_qty'][$i]);
		}
		if($gw_scr['s_mgzn_flg'] == "1"){
			for($i=1; $i<= $gw_scr['s_h_disp_row']; $i++){
				$gw_scr['s_list_mgzn_id'][$i] = strtoupper(trim($gw_scr['s_list_mgzn_id'][$i]));
			}
		}
		$gw_scr['s_metal_wght']   = strtoupper(trim($gw_scr['s_metal_wght']));
		$gw_scr['s_cmt'] = trim($gw_scr['s_cmt']);

		#------------------------------------------------------------------
		# required
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Nec_Input");
		if($gw_scr['s_pas_chp_qty'] == ""){
			$w_tg = get_tg(itm("PasQty"), itm("ChpQty"));
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if($gw_scr['s_chp_bad_cnt'] > 0){
			if($gw_scr['s_rej_chp_qty'] == ""){
				$w_tg = get_tg(itm("RjctQty"), itm("ChpQty"));
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_sub_flg'] == "1" && $gw_scr['s_nxt_sub_flg'] == "1"){
			if($gw_scr['s_pas_sub_qty'] == ""){
				$w_tg = get_tg(itm("PasQty"), itm("SubQty"));
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
			if($gw_scr['s_chp_bad_cnt'] > 0){
				if($gw_scr['s_rej_sub_qty'] == ""){
					$w_tg = get_tg(itm("RjctQty"), itm("SubQty"));
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
			}
		}
		if($gw_scr['s_sub_flg'] == "1" && $gw_scr['s_nxt_sub_flg'] != "1"){
			if($gw_scr['s_inp_phy_qty'] == ""){
				$g_msg = xpt_err_msg($g_msg, itm("PhyQty"), __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_sl_flg'] == "1"){
			if($gw_scr['s_pas_sl_qty'] == ""){
				$w_tg = get_tg(itm("PasQty"), itm("SliceQty"));
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
			if($gw_scr['s_chp_bad_cnt'] > 0){
				if($gw_scr['s_rej_sl_qty'] == ""){
					$w_tg = get_tg(itm("RjctQty"), itm("SliceQty"));
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
			}
		}

		// new code for checking gold wire is charging
                // check the lot need gold wire
                $w_rtn = get_gold_wire_prt_grp_cd_by_prd(trim($gw_scr['s_prd_cd']), trim($gw_scr['s_stp_cd']), $w_mat_info);
                if(count($w_mat_info)> 0){

                        // get material id that inside the equ
                        $w_rtn = get_charging_material(trim($gw_scr['s_equ_cd']), $w_charge_info);

                        if(count($w_charge_info) <= 0){
                                list($g_msg, $g_err_lv) = msg("err_no_charging");
                                $g_msg = xpt_err_msg($g_msg, "", __LINE__);
                                return 4000;
                        }

                }

		if($gw_scr['s_mgzn_flg'] == "1"){
			$w_inp_flg = 0;
			for($i=1; $i<= $gw_scr['s_h_disp_row']; $i++){
				if($gw_scr['s_list_mgzn_id'][$i] != ""){
					$w_inp_flg = 1;
				}
			}
			if($w_inp_flg == 0){
				$g_msg = xpt_err_msg($g_msg, itm("MgznID"), __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_stp_cls_2']  == constant("E9_BAKING")
		&& $gw_scr['s_metal_wght'] == ""
		){
			$g_msg = xpt_err_msg($g_msg, itm("MtlWght"), __LINE__);
			return 4000;
		}

		#------------------------------------------------------------------
		# prohibited charcters
		#------------------------------------------------------------------
		list($g_msg, $g_err_lv) = msg("err_Inp_Char");
		if(!check_num($gw_scr['s_pas_chp_qty'])){
			$w_tg = get_tg(itm("PasQty"), itm("ChpQty"), $gw_scr['s_pas_chp_qty']);
			$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
			return 4000;
		}
		if($gw_scr['s_rej_chp_qty'] != ""){
			if(!check_num($gw_scr['s_rej_chp_qty'])){
				$w_tg = get_tg(itm("RjctQty"), itm("ChpQty"), $gw_scr['s_rej_chp_qty']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_inp_phy_qty'] != ""){
			if(!check_num($gw_scr['s_inp_phy_qty'])){
				$w_tg = get_tg(itm("PhyQty"), $gw_scr['s_inp_phy_qty']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_pas_sub_qty'] != ""){
			if(!check_num($gw_scr['s_pas_sub_qty'])){
				$w_tg = get_tg(itm("PasQty"), itm("SubQty"), $gw_scr['s_pas_sub_qty']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_rej_sub_qty'] != ""){
			if(!check_num($gw_scr['s_rej_sub_qty'])){
				$w_tg = get_tg(itm("RjctQty"), itm("SubQty"), $gw_scr['s_rej_sub_qty']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_pas_sl_qty'] != ""){
			if(!check_num($gw_scr['s_pas_sl_qty'])){
				$w_tg = get_tg(itm("PasQty"), itm("SliceQty"), $gw_scr['s_pas_sl_qty']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		if($gw_scr['s_rej_sl_qty'] != ""){
			if(!check_num($gw_scr['s_rej_sl_qty'])){
				$w_tg = get_tg(itm("RjctQty"), itm("SliceQty"), $gw_scr['s_rej_sl_qty']);
				$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
				return 4000;
			}
		}
		for($i=1; $i<=$gw_scr['s_chp_bad_cnt']; $i++){
			if($gw_scr['s_list_chp_bad_ctg_qty'][$i] != ""){
				if(!check_num($gw_scr['s_list_chp_bad_ctg_qty'][$i])){
					$w_tg = get_tg(itm("RjctDtlChp"), $gw_scr['s_list_chp_bad_ctg_qty'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
			}
		}
		if($gw_scr['s_mgzn_flg'] == "1"){
			for($i=1; $i<= $gw_scr['s_h_disp_row']; $i++){
				if(!check_err_code($gw_scr['s_list_mgzn_id'][$i])){
					$w_tg = get_tg(itm("MgznID"), $gw_scr['s_list_mgzn_id'][$i]);
					$g_msg = xpt_err_msg($g_msg, $w_tg, __LINE__);
					return 4000;
				}
			}
		}
		if(!check_err_cmt($gw_scr['s_cmt'])){
			$g_msg = xpt_err_msg($g_msg, itm("Cmt"), __LINE__);
			return 4000;
		}
		break;
	}

	$g_msg    = "";
	$g_err_lv = "";

	return 0;
}

#==================================================================
# convert to unix time
#==================================================================
function cnvepc($w_dts)
{
	list($y,$m,$d,$h,$i,$s) = preg_split("/[\-: ]/", $w_dts);
	return mktime($h,$i,$s,$m,$d,$y);
}

#==================================================================
# initialize
#==================================================================
function set_init($w_mode, $w_rtn = 0)
{
	global $gw_scr;
	global $g_page_stp;
	
	### MODE1
	if($w_mode == 1){
		$gw_scr['s_usr_id'] = "";
		$gw_scr['s_lot_id']     = "";
		$gw_scr['s_prt_no'] = 2;
		$gw_scr['s_sc_count'] = 0;

	}

	### MODE2
	if($w_mode <= 2){
		$gw_scr['s_lp_cd']  = "";
		$gw_scr['s_lp_nm']  = "";
		$gw_scr['s_hdn_lot_id'] = "";
		$gw_scr['s_inp_phy_qty'] = "";
		$gw_scr['s_pas_chp_qty'] = "";
		$gw_scr['s_pas_sub_qty'] = "";
		$gw_scr['s_pas_sl_qty'] = "";
		$gw_scr['s_rej_chp_qty'] = "";
		$gw_scr['s_rej_sub_qty'] = "";
		$gw_scr['s_rej_sl_qty'] = "";
		$gw_scr['s_dmybndqty'] = "";
		$gw_scr['s_metal_wght']  = "";

		$gw_scr['s_pp_input_qty']     	= "";
		$gw_scr['s_pp_fail_qty']     	= "";
		$gw_scr['s_pp_yield']     	= "";

		$gw_scr['s_list_chp_bad_ctg_qty'] = array();

		$gw_scr['s_list_mgzn_id'] = array();
		$gw_scr['s_cmt'] = "";


		$gw_scr['s_wfr_mnt_flg'] = "";
		$gw_scr['s_f0_test_flg'] = "";
		$gw_scr['s_ok_flg'] = "";
	    $gw_scr['s_smp_flg'] = "";
	    $gw_scr['s_pp_flg'] = "";
	    $gw_scr['s_wp_seal_flg'] = "";

		if($w_mode == 1 || $w_rtn == 1){
			$gw_scr['s_usr_nm'] 		= "";
			$gw_scr['s_upd_lev']     	= "";
			$gw_scr['s_sub_flg']     	= "";
			$gw_scr['s_nxt_sub_flg'] 	= "";
			$gw_scr['s_mgzn_flg']    	= "";
			$gw_scr['s_crk_flg']     	= "";
			$gw_scr['s_expire_flg']  	= "";
			$gw_scr['s_pastec_flg']  	= "";
			$gw_scr['s_postcu_flg']  	= "";
			$gw_scr['s_disp_row']    	= constant("DEF_MGZN_ROW");
			$gw_scr['s_h_disp_row']  	= constant("DEF_MGZN_ROW");
			$gw_scr['s_chp_bad_cnt'] 	= 0;
			$gw_scr['s_stp_nm']        	= "";
			$gw_scr['s_equ_nm']        	= "";
			$gw_scr['s_prd_nm']        	= "";
			$gw_scr['s_pkg_nm']        	= "";
			$gw_scr['s_lot_no_str']    	= "";
			$gw_scr['s_inp_chp_qty']   	= "";
			$gw_scr['s_pas_chp_qty']  	= "";
			$gw_scr['s_rej_chp_qty']   	= "";
			$gw_scr['s_inp_sub_qty']   	= "";
			$gw_scr['s_pas_sub_qty']  	= "";
			$gw_scr['s_rej_sub_qty']   	= "";
			$gw_scr['s_inp_sl_qty']   	= "";
			$gw_scr['s_pas_sl_qty']  	= "";
			$gw_scr['s_rej_sl_qty']   	= "";
			$gw_scr['s_dmybndqty'] 		= "";
			$gw_scr['s_chp_bad_cnt'] 	= "";
			$gw_scr['s_list_chp_bad_ctg_nm']  = array();
			$gw_scr['s_list_chp_bad_ctg_cd']  = array();
			$gw_scr['s_list_chp_bad_ctg_dvs'] = array();
			$gw_scr['s_list_chp_bad_num_flg'] = array();
		}
		$gw_scr['s_stp_cd'] 	= "";
		$gw_scr['s_stp_cls_2'] 	= "";
		$gw_scr['s_equ_cd'] 	= "";
		$gw_scr['s_prd_cd'] 	= "";
		$gw_scr['s_prt_ctrl'] 	= "";
		$gw_scr['s_spc_equinf'] = "";
		$gw_scr['s_prt_no'] 	= 2;
		$g_page_stp = "";
	}

	### MODE2
	if($w_mode <= 3){
		if($w_mode == 1 || $w_mode == 2 || $w_rtn == 1){
			$gw_scr['s_lock_flg']       = "";
			$gw_scr['s_err_opn_js_flg'] = "";
			$gw_scr['s_err_opn_lot_id'] = "";
			$gw_scr['s_err_opn_stp_cd'] = "";
		}
	}

	return 0;
}

#==================================================================
# Verify if Finished with step
#==================================================================
function check_VerbOnStep($w_lot_id,
									$w_verb,
									$w_stp_cd,
									&$r_bln_check
									)
{
	global $g_msg;
	global $g_err_lv;
	$r_bln_check = FALSE;

	$w_sql = <<<_SQL
SELECT
	count(*) as COUNTA
FROM
	LOT_LOG
WHERE
	LOT_ID = '{$w_lot_id}'
	AND VERB = '{$w_verb}'
	AND STP_CD = '{$w_stp_cd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		$g_msg = cs_xck_exst_child_msg("err_Sel");
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);
	db_res_free($w_stmt);

	#echo $w_sql;
	
	if($w_row['COUNTA'] > 0){
		$r_bln_check = TRUE;
	}


	return 0;
}

#==================================================================
# get CTG_LOG
#==================================================================
function get_ctglog($w_lot_id, $w_ctgdvs, $w_ctgcd, &$r_dat)
{
	global $g_msg;
	global $g_err_lv;

	$r_dat = array();

	$w_sql = <<<_SQL
SELECT
	*
FROM
	CTG_LOG
WHERE
	LOT_ID = '{$w_lot_id}'
	AND CTG_DVS_CD = '{$w_ctgdvs}'
	AND CTG_CD = '{$w_ctgcd}'
	AND DEL_FLG = '0'
_SQL;

	$w_stmt = db_res_set($w_sql);
	$w_rtn = db_do($w_stmt);
	if($w_rtn != 0){
		list($g_msg, $g_err_lv) = msg("err_Sel");
		$g_msg = xpt_err_msg($g_msg, "CTG_LOG", __LINE__);
		return 4000;
	}

	$w_row = db_fetch_row($w_stmt);

	$r_dat = $w_row;
	
	db_res_free($w_stmt);

	return 0;
}

function check_wp_seal_flag($w_prd_cd, &$r_is_wp_seal_flg) {

        global $g_msg;
        global $g_err_lv;

        $r_is_wp_seal_flg = false;

        $w_aw_wp_seal_cd = constant("AW_WP_SEAL_CD");

        $w_sql = "
                SELECT
                        TXT_DAT
                FROM
                        PRD_INF_MST
                WHERE
                        DEL_FLG = '0'
                        AND PRD_CD = '{$w_prd_cd}'
                        AND DAT_CD = '{$w_aw_wp_seal_cd}'
        ";

        $w_stmt = db_res_set($w_sql);
        $w_rtn = db_do($w_stmt);
        if($w_rtn != 0){
                $g_err_lv = 0;
                $g_msg = cs_xpt_sni_msg("err_Sel");
                $g_msg = xpt_err_msg($g_msg, $w_lot_id, __LINE__);
                return 4000;
        }
        while($w_row = db_fetch_row($w_stmt)){
                if(trim($w_row['TXT_DAT']) == "1" ) {
                	$r_is_wp_seal_flg = true;
                }
        }

        db_res_free($w_stmt);
        return 0;

}

#==================================================================
# screen setting(before disp)
#==================================================================
function scr_bf_setting()
{
	global $gw_scr;
	global $g_mode;

	return;
}
#==================================================================
# screen setting(after disp)
#==================================================================
function scr_af_setting()
{
	global $gw_scr;
	global $g_mode;

	return;
}
#==================================================================
# set space
#==================================================================
function set_space($w_var)
{
	$w_rtn = $w_var;
	if($w_rtn == ""){
		$w_rtn = " ";
	}
	return $w_rtn;
}
#==================================================================
# Array re-index from 1
#==================================================================
function rearray(&$arr)
{
	if(isset($arr[0])){
		$tmp = array();
		$cnt = 0;
		for($i=0; $i<count($arr); $i++){
			$cnt++;
			$tmp[$cnt] = $arr[$i];
		}
		$arr = $tmp;
	}
	return;
}
#==================================================================
# serialize
#==================================================================
function userialize($w_arr)
{
	return bin2hex(serialize($w_arr));
}
#==================================================================
# unserialize
#==================================================================
function uunserialize($w_serial)
{
	return unserialize(pack("H*", $w_serial));
}
#==================================================================
# put an escape character($) if include wild card of SQL
#==================================================================
function str_escape($str){
	return str_replace(array('%', '_', '*'), array('$%', '$_', ''), $str);
}
#==================================================================
# set optional info in error message
#==================================================================
function get_tg()
{
	$w_arr = func_get_args();
	return implode("/", $w_arr);
}
#==================================================================
# simplified Lang function call
#==================================================================
function itm($var)
{
	return PS00S01002310_item($var);
}
function msg($var)
{
	return PS00S01002310_msg($var);
}
#******************************************************************
#******************************************************************
#******************************************************************
#******************************************************************
#******************************************************************
#
# MAIN START
#
#******************************************************************
#==================================================================
# DB connect
#==================================================================
$w_rtn = xdb_op_conndb();
if ($w_rtn != 0) {
	$g_err_lv = 0;
	$g_msg = xpt_err_msg($g_msg, "", __LINE__);
	return;
}
#==================================================================
# session
#==================================================================
if($gw_scr['s_act'] != "DOWNLOAD"){
if($gw_scr['s_rtn_flg']){
	get_session_convert();
}
# get the elements in session mode
get_session_mode();
}

#==================================================================
# authentification
#==================================================================
if($gw_scr['s_act'] != "DOWNLOAD"){
$refe_flg=1;
require_once (getenv("GPRISM_HOME") . "/renzheng.php");
$bak_s_renzheng_t = $gw_scr['s_renzheng_t'];
$bak_s_renzheng   = $gw_scr['s_renzheng'];
}
#==================================================================
# process of each mode
#==================================================================
### screen setting befor disp
scr_bf_setting();
### check the function exists
$w_func = "main_md" . $g_mode;
if(function_exists($w_func)){
	$w_func();
} else {
	main_init();
}

$gw_scr['s_renzheng']   = $bak_s_renzheng;
$gw_scr['s_renzheng_t'] = $bak_s_renzheng_t;
$gw_scr['s_opt_pack_pcs'] = unserialize(constant("PACK_PCS"));
scr_af_setting();
get_screen(1, null, 1);

#==================================================================
# DB close
#==================================================================
xdb_op_closedb();
?>
